<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FoCo After Dark â€“ Nightlife Pass</title>
  <link rel="icon" type="image/png" href="foco-logo.png" />
  <link rel="preload" href="foco-logo.png?v=4" as="image" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="foco-logo.png" />
  <!-- GSAP for advanced animations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" defer></script>
  <!-- lightweight canvas particles will be initialized by app JS when allowed -->
  <style>
    /* Global styles */
    :root {
      /* HD / vivid color upgrades */
      --accent-cyan-2: #00f0ff;
      --accent-magenta-2: #ff2fb8;
      --glass-opa: 0.34;
      --glass-blur: 10px;
      --card-border: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      --hd-shadow: 0 30px 70px rgba(2,6,23,0.75), 0 0 60px rgba(34,211,238,0.06);
      --text-bright: #f8fbff;
      --bg-deep: #010818;
      --bg-card: rgba(8, 14, 30, 0.94);
      --bg-card-alt: rgba(6, 15, 32, 0.92);
      --bg-panel: rgba(2, 6, 23, 0.75);
      --border-soft: rgba(120, 146, 194, 0.35);
      --border-strong: rgba(34, 211, 238, 0.4);
      --text-primary: #f8fafc;
      --text-secondary: #cbd5f5;
      --text-muted: #7c8aa6;
      --accent-cyan: #22d3ee;
      --accent-green: #22c55e;
      --accent-magenta: #f472b6;
      --accent-amber: #fbbf24;
      --glow-cyan: rgba(34, 211, 238, 0.45);
      --glow-magenta: rgba(244, 114, 182, 0.35);
      --accent-primary-live: #22d3ee;
      --accent-secondary-live: #22c55e;
      --accent-border-live: rgba(34, 211, 238, 0.4);
      --accent-glow-live: rgba(34, 211, 238, 0.35);
      --accent-surface-live: rgba(34, 211, 238, 0.12);
      --accent-shadow-live: 0 25px 60px rgba(1, 4, 12, 0.75), 0 0 35px rgba(34, 211, 238, 0.35);
      --radius-card: 24px;
      --radius-pill: 999px;
      --font-base: "Inter", "SF Pro Display", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      --shadow-card: 0 25px 60px rgba(1, 4, 12, 0.75);
      --shadow-neon: 0 0 35px rgba(34, 211, 238, 0.35);
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      font-family: var(--font-base);
      background:
        radial-gradient(circle at 25% -10%, rgba(34, 211, 238, 0.25), transparent 55%),
        radial-gradient(circle at 80% 0%, rgba(244, 114, 182, 0.28), transparent 60%),
        linear-gradient(180deg, #010410, #010818 45%, #000000);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 18px 12px 48px;
      overflow-y: auto;
      position: relative;
    }
    /* High-def glass card used in CEO and Venues panels */
    .card-hd {
      background: linear-gradient(180deg, rgba(8,12,24,var(--glass-opa)), rgba(2,6,18,0.48));
      border: 1px solid rgba(255,255,255,0.04);
      backdrop-filter: blur(var(--glass-blur)) saturate(1.12);
      -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(1.12);
      box-shadow: var(--hd-shadow);
      border-radius: calc(var(--radius-card) - 6px);
      transition: box-shadow 260ms ease, background 260ms ease;
    }
    .card-hd:hover { box-shadow: 0 30px 80px rgba(2,6,23,0.75), 0 0 60px rgba(34,211,238,0.06); }
    .card-hd.no-tilt,
    .card-hd.no-tilt:hover {
      transform: none !important;
      box-shadow: var(--hd-shadow);
      transition: none;
    }

    /* Polished HD buttons */
    .btn-hd {
      border-radius: 14px;
      padding: 10px 14px;
      font-weight: 700;
      letter-spacing: 0.1em;
      border: none;
      cursor: pointer;
      transition: transform 220ms cubic-bezier(.2,.9,.2,1), box-shadow 220ms ease, opacity 220ms ease;
    }
    .btn-hd.primary {
      background: linear-gradient(90deg, var(--accent-cyan-2), var(--accent-magenta-2));
      color: #06121a;
      box-shadow: 0 8px 36px rgba(0,240,255,0.12), 0 0 28px rgba(255,47,184,0.06);
    }
    .btn-hd.ghost {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.06);
      color: var(--text-bright);
    }

    /* Shimmer CTA */
    .cta-shimmer {
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }
    .cta-shimmer::after {
      content: "";
      position: absolute;
      top: -60%;
      left: -60%;
      width: 60%;
      height: 220%;
      background: linear-gradient(120deg, rgba(255,255,255,0.05), rgba(255,255,255,0.35), rgba(255,255,255,0.05));
      transform: rotate(18deg);
      filter: blur(0.5px);
      opacity: 0.6;
      animation: shimmerSweep 2.8s ease-in-out infinite;
      pointer-events: none;
      z-index: 1;
    }
    @keyframes shimmerSweep {
      0% { left: -70%; opacity: 0.0; }
      20% { opacity: 0.5; }
      50% { left: 120%; opacity: 0.6; }
      100% { left: 120%; opacity: 0.0; }
    }

    /* Smooth entrance animation for lists and portal children */
    .smooth-enter > * {
      opacity: 0; transform: translateY(10px) scale(0.995); transition: transform 420ms cubic-bezier(.2,.8,.2,1), opacity 420ms ease;
    }
    .smooth-enter.revealed > * { opacity: 1; transform: translateY(0) scale(1); }

    /* High contrast tweaks for CEO/Venue titles */
    .portal-title {
      font-size: 18px; letter-spacing: 0.04em; color: var(--text-bright); font-weight: 800;
      text-shadow: 0 0 10px rgba(0,240,255,0.08), 0 6px 30px rgba(0,0,0,0.6);
    }
    body.theme-magenta {
      background:
        radial-gradient(circle at 20% -10%, rgba(244, 114, 182, 0.35), transparent 55%),
        radial-gradient(circle at 80% 0%, rgba(139, 92, 246, 0.25), transparent 60%),
        linear-gradient(180deg, #0b0614, #0a0d1f 45%, #080914);
    }
    body.theme-gold {
      background:
        radial-gradient(circle at 20% -10%, rgba(251, 191, 36, 0.28), transparent 55%),
        radial-gradient(circle at 78% 0%, rgba(20, 184, 166, 0.22), transparent 60%),
        linear-gradient(180deg, #0b0f17, #0c121e 45%, #0b0f17);
    }
    /* Global background image behind all screens */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: url("assets/landing.jpg") center/cover no-repeat;
      /* Slight blur for depth, boost brightness/contrast/saturation for vibrancy */
      filter: blur(0.6px) brightness(0.95) contrast(1.25) saturate(1.35);
      opacity: 0.82;
      pointer-events: none;
      z-index: -1;
    }

    /* Subtle watermark/logo above the background but beneath the app content */
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      background: url("foco-logo.png") center/500px no-repeat;
      opacity: 0.04;
      filter: blur(0.5px);
      pointer-events: none;
      z-index: 0;
    }
    #app {
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }

    .screen {
      display: none;
      background: var(--bg-card);
      border-radius: var(--radius-card);
      padding: 24px;
      box-shadow: var(--shadow-card), var(--shadow-neon);
      border: 1px solid var(--border-soft);
      width: 100%;
      margin: 0 auto 22px;
      position: relative;
      overflow: hidden;
    }
    .screen.active {
      display: block;
    }
    #staffLoginScreen,
    #staffPortalScreen {
      background: linear-gradient(160deg, rgba(6, 12, 24, 0.97), rgba(8, 14, 28, 0.95));
      box-shadow:
        0 0 35px rgba(34, 211, 238, 0.25),
        0 24px 45px rgba(0, 0, 0, 0.65);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    .app-title {
      font-size: 21px;
      font-weight: 600;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-primary);
    }
    /* CEO issued codes list */
    .ceo-issued-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 200px;
      overflow: auto;
      margin-top: 8px;
      padding-top: 8px;
    }
    .ceo-issued-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(11,19,40,0.6);
      border: 1px solid rgba(148,163,184,0.06);
      font-size: 13px;
      color: #e6eefb;
    }
    .ceo-issued-code {
      font-family: 'Courier New', monospace;
      font-weight: 700;
      color: var(--accent-magenta);
      letter-spacing: 0.12em;
    }
    .ceo-issued-meta {
      font-size: 12px;
      color: #9ca3af;
      margin-left: 8px;
    }
    .ceo-issued-actions button {
      margin-left: 8px;
    }
    .app-title span {
      color: var(--accent-cyan);
    }
    .tagline {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 18px;
      line-height: 1.5;
      text-shadow: 0 0 10px rgba(34, 211, 238, 0.35), 0 0 18px rgba(244, 114, 182, 0.25);
    }
    #landingTagline {
      color: #a5f3fc;
      font-weight: 700;
      letter-spacing: 0.04em;
      animation: pulseTagline 3.6s ease-in-out infinite;
      text-shadow:
        0 0 12px rgba(34, 211, 238, 0.6),
        0 0 20px rgba(244, 114, 182, 0.45),
        0 0 28px rgba(34, 211, 238, 0.35);
    }
    @keyframes pulseTagline {
      0%, 100% { transform: translateY(0); opacity: 1; }
      50% { transform: translateY(-1px); opacity: 0.9; text-shadow: 0 0 16px rgba(34,211,238,0.75), 0 0 26px rgba(244,114,182,0.55); }
    }
    .global-footer {
      width: 100%;
      text-align: center;
      padding: 16px 12px 24px;
      color: var(--accent-magenta);
      font-size: 12px;
      letter-spacing: 0.04em;
      background: transparent;
      position: relative;
      z-index: 2;
      font-weight: 700;
      text-shadow: 0 0 10px rgba(244,114,182,0.75), 0 0 22px rgba(168,85,247,0.25);
    }

    .btn {
      width: 100%;
      margin-top: 10px;
      padding: 10px 14px;
      border-radius: var(--radius-pill);
      border: none;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }
    .btn-primary {
      background: linear-gradient(120deg, var(--accent-cyan), var(--accent-green));
      color: #020617;
      box-shadow: 0 0 12px var(--glow-cyan), 0 0 26px rgba(34, 197, 94, 0.65);
      animation: glowPulse 3.4s ease-in-out infinite;
    }
    /* Enhanced neon interactions */
    .btn-primary {
      transition: transform 0.14s cubic-bezier(.2,.8,.2,1), box-shadow 0.14s ease;
      will-change: transform, box-shadow;
    }
    .btn-primary:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 0 28px rgba(34,211,238,0.95), 0 0 48px rgba(244,114,182,0.6); }
    .btn-primary:active { transform: translateY(1px) scale(.995); }

    .ceo-issued-item { transform-origin: center; transition: transform 220ms ease, box-shadow 220ms ease; }
    .ceo-issued-item.pop { transform: translateY(-6px) scale(1.02); box-shadow: 0 14px 40px rgba(34,211,238,0.12); }

    /* Footer breathing neon pulse */
    .global-footer { animation: footerPulse 4.2s ease-in-out infinite; }
    @keyframes footerPulse {
      0%,100% { text-shadow: 0 0 10px rgba(244,114,182,0.7), 0 0 22px rgba(168,85,247,0.25); transform: translateY(0); }
      50% { text-shadow: 0 0 24px rgba(244,114,182,1), 0 0 36px rgba(168,85,247,0.4); transform: translateY(-1px); }
    }

    /* Parallax CSS hooks */
    :root { --parallax-x: 0; --parallax-y: 0; }
    body::before { transform: translate3d(calc(var(--parallax-x) * 12px), calc(var(--parallax-y) * 8px), 0) scale(1.02); transition: transform 220ms linear; }

    /* Respect user preference for reduced motion */
    @media (prefers-reduced-motion: reduce) {
      .btn-primary, .ceo-issued-item, .global-footer, body::before {
        animation: none !important;
        transition: none !important;
      }
      .btn-primary:hover, .btn-primary:active { transform: none !important; box-shadow: none !important; }
      .ceo-issued-item.pop { transform: none !important; box-shadow: none !important; }
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 18px rgba(34, 211, 238, 0.9), 0 0 32px rgba(34, 197, 94, 0.95);
    }
    .btn-primary:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      animation: none;
    }
    .btn-secondary {
      background: var(--bg-panel);
      color: var(--text-secondary);
      border: 1px solid var(--border-soft);
    }
    .btn-danger {
      background: linear-gradient(90deg, #ef4444, #f97316);
      color: #fff;
      border: 1px solid rgba(239,68,68,0.4);
      box-shadow: 0 8px 28px rgba(239,68,68,0.25);
    }
    .btn-danger:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 32px rgba(249,115,22,0.35);
    }
    .btn-secondary:hover {
      background: rgba(15, 23, 42, 1);
      transform: translateY(-1px);
    }
    .ceo-reset-card {
      margin-top: 12px;
      padding: 16px 14px;
      border: 1px dashed rgba(248,113,113,0.35);
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(30,41,59,0.82), rgba(15,23,42,0.95));
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .ceo-reset-card .meta-note {
      font-size: 12px;
      color: #fca5a5;
      opacity: 0.9;
    }
    .ceo-reset-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 6px 10px;
      margin-top: 10px;
    }
    .ceo-reset-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(248,113,113,0.08);
      border: 1px solid rgba(248,113,113,0.25);
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 12px;
      color: #fecaca;
    }
    .ceo-reset-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    .pill-ghost {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.8);
      color: #cbd5e1;
      font-size: 11px;
      cursor: pointer;
    }
    .ceo-chat-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #ceoChatInput {
      min-height: 140px;
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.9);
      color: #e2e8f0;
      padding: 10px;
      font-size: 13px;
    }
    #ceoChatHistory {
      border: 1px solid rgba(148,163,184,0.25);
      border-radius: 12px;
      padding: 8px;
      background: rgba(15,23,42,0.85);
    }
    .ceo-member-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px;
      border-radius: 12px;
      background: rgba(15,23,42,0.7);
      border: 1px solid rgba(148,163,184,0.2);
    }
    .ceo-member-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .ceo-member-name {
      font-weight: 600;
      color: #e2e8f0;
    }
    .ceo-member-sub {
      font-size: 12px;
      color: #94a3b8;
    }
    @keyframes glowPulse {
      0%, 100% {
        box-shadow:
          0 0 10px rgba(6, 182, 212, 0.9),
          0 0 22px rgba(34, 197, 94, 0.75);
      }
      50% {
        box-shadow:
          0 0 16px rgba(6, 182, 212, 1),
          0 0 32px rgba(34, 197, 94, 0.95);
      }
    }
    @keyframes qrGlow {
      0%, 100% {
        box-shadow: 0 0 16px rgba(6, 182, 212, 0.45);
      }
      50% {
        box-shadow: 0 0 26px rgba(59, 130, 246, 0.65);
      }
    }
    @keyframes qrShimmer {
      0% {
        transform: translate(-120%, -10%) rotate(20deg);
        opacity: 0;
      }
      50% {
        opacity: 0.85;
      }
      100% {
        transform: translate(160%, 10%) rotate(20deg);
        opacity: 0;
      }
    }

    .small {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 6px;
      text-align: center;
    }
    /* Staff portal simplified + stronger accents */
    #staffPortalScreen {
      --staff-primary: #7dd3fc;
      --staff-secondary: #38bdf8;
      --staff-surface: rgba(8, 13, 24, 0.92);
      --staff-border: rgba(148, 163, 184, 0.28);
      --staff-border-strong: rgba(125, 211, 252, 0.45);
      --staff-glow: rgba(56, 189, 248, 0.2);
      --staff-glow-strong: rgba(56, 189, 248, 0.35);
      --staff-text: #e2e8f0;
      --staff-muted: #94a3b8;
    }
    #staffPortalScreen .app-title {
      text-align: center;
      margin-bottom: 4px;
    }
    #staffPortalScreen .tagline {
      text-align: center;
      margin-bottom: 12px;
    }
    .staff-meta-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 8px;
    }
    .staff-meta-row .meta-note {
      color: var(--staff-muted);
    }
    #staffPortalScreen .btn-primary {
      background: linear-gradient(120deg, var(--staff-primary), var(--staff-secondary));
      border: 1px solid var(--staff-border-strong);
      color: #001018;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4), 0 0 14px var(--staff-glow);
    }
    #staffPortalScreen .btn-secondary {
      border: 1px solid var(--staff-border);
      color: var(--staff-text);
      background: rgba(8, 13, 24, 0.9);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.32);
    }
    #staffPortalScreen input,
    #staffPortalScreen select,
    #staffPortalScreen textarea {
      border: 1px solid var(--staff-border);
      background: rgba(8, 13, 24, 0.94);
      color: var(--staff-text);
      box-shadow: none;
    }
    #staffPortalScreen label {
      color: var(--staff-text);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 11px;
    }
    #staffPortalScreen .small {
      color: var(--staff-muted);
    }
    .staff-perks-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
    }
    .staff-perk-row {
      display: grid;
      grid-template-columns: minmax(200px, 2fr) minmax(140px, 1fr) minmax(140px, 1fr) auto;
      gap: 10px;
      padding: 12px;
      border-radius: 14px;
      background: rgba(8, 13, 24, 0.92);
      border: 1px solid var(--staff-border);
    }
    .staff-perk-row .perk-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .staff-perk-row .perk-field input,
    .staff-perk-row .perk-field select {
      width: 100%;
    }
    .staff-perk-row .staff-perk-label {
      min-height: 48px;
      font-size: 15px;
      padding: 12px 14px;
    }
    .staff-perk-row .staff-perk-standard,
    .staff-perk-row .staff-perk-vip {
      min-height: 48px;
      font-size: 15px;
      padding: 12px 12px;
    }
    #staffPerksCard {
      min-height: 360px;
    }
    .staff-perk-row .perk-limit {
      max-width: 140px;
    }
    .staff-perk-row .perk-remove {
      align-self: flex-end;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--staff-border);
      background: rgba(8, 13, 24, 0.9);
      color: var(--staff-text);
      font-size: 12px;
      cursor: pointer;
    }
    @media (max-width: 720px) {
      .staff-perk-row {
        grid-template-columns: 1fr;
      }
      .staff-perk-row .perk-remove {
        justify-self: flex-end;
      }
    }
    .staff-perks-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .staff-sticky-bar {
      position: sticky;
      top: 8px;
      z-index: 8;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      margin-bottom: 10px;
      background: rgba(8, 13, 24, 0.94);
      border: 1px solid var(--staff-border);
      border-radius: 16px;
      box-shadow: 0 12px 26px rgba(0,0,0,0.4);
    }
    .staff-logout-top {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      padding: 10px 18px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--staff-primary), var(--staff-secondary));
      border: 2px solid var(--staff-border-strong);
      outline: 2px solid rgba(226, 232, 240, 0.22);
      outline-offset: 2px;
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.4), 0 0 12px var(--staff-glow);
      color: #e2e8f0;
      font-weight: 700;
      letter-spacing: 0.04em;
      min-width: 210px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .staff-logout-top:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 28px rgba(0, 0, 0, 0.45), 0 0 16px var(--staff-glow);
    }
    .venue-chip {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.75);
      color: var(--staff-text);
      border: 1px solid var(--staff-border);
      font-weight: 700;
      letter-spacing: 0.02em;
      box-shadow: none;
    }
    .sticky-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .staff-accent-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 6px 0 12px;
      align-items: center;
    }
    .staff-accent-row .accent-chip {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.28);
      outline: 2px solid rgba(148,163,184,0.18);
      outline-offset: 2px;
      color: #e2e8f0;
      font-weight: 700;
      background: rgba(10, 16, 30, 0.9);
      box-shadow: 0 6px 14px rgba(0,0,0,0.28);
      transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
    }
    .staff-accent-row .accent-chip.active {
      border-color: var(--staff-border-strong);
      box-shadow: 0 10px 20px var(--staff-glow);
      transform: translateY(-1px);
    }
    .chip {
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid var(--staff-border);
      background: rgba(10, 16, 30, 0.9);
      color: var(--staff-text);
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 6px 14px rgba(0,0,0,0.28);
    }
    .chip.ghost:hover {
      border-color: var(--staff-border-strong);
      color: var(--staff-text);
    }
    .kpi-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }
    .kpi-chip {
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(10, 16, 30, 0.9);
      border: 1px solid var(--staff-border);
      font-size: 12px;
      color: var(--staff-text);
      box-shadow: none;
    }
    .staff-board {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    @media (min-width: 960px) {
      .staff-board {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 14px;
      }
      #verifyCard,
      #staffRadar {
        grid-column: span 2;
      }
      #alertCard,
      #staffMessageCard,
      #staffMore {
        grid-column: span 2;
      }
    }
    .audience-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .audience-toggle .pill {
      flex: 1;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--staff-border);
      background: rgba(15,23,42,0.8);
      color: var(--staff-text);
      font-weight: 700;
      letter-spacing: 0.01em;
    }
    .audience-toggle .pill.active {
      border-color: var(--staff-border-strong);
      background: linear-gradient(120deg, rgba(34,211,238,0.35), rgba(14,165,233,0.35));
      color: var(--staff-text);
      box-shadow: 0 12px 26px var(--staff-glow-strong);
    }
    .recent-actions {
      margin-top: 10px;
      font-size: 12px;
      color: #cbd5f5;
    }
    .recent-actions .action-item {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 0;
      border-bottom: 1px solid rgba(148,163,184,0.15);
    }
    .recent-actions .action-item:last-child {
      border-bottom: none;
    }
    .codes-list .code-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(11,18,35,0.85);
      border: 1px solid rgba(148,163,184,0.25);
      margin-bottom: 6px;
      color: #e2e8f0;
    }
    .codes-list .code-row button {
      border-radius: 10px;
      padding: 6px 10px;
    }
    /* Staff portal refinements */
    #memberIdForm .btn-primary {
      background: linear-gradient(120deg, #22d3ee, #0ea5e9);
      box-shadow: 0 10px 24px rgba(34,211,238,0.32);
      border: none;
    }
    #alertDetail {
      min-height: 120px;
      background: rgba(11,18,35,0.8);
      border: 1px solid rgba(103, 232, 249, 0.25);
      color: #e2e8f0;
    }
    .linkish {
      color: #22d3ee;
      cursor: pointer;
      text-decoration: underline;
    }
    .linkish-btn {
      background: none;
      border: none;
      padding: 0;
      font: inherit;
      color: inherit;
      cursor: pointer;
    }
    .hero-highlight {
      margin: 18px 0 20px;
      padding: 18px;
      border-radius: 26px;
      border: 1px solid var(--border-strong);
      background: radial-gradient(circle at 20% 20%, rgba(34, 211, 238, 0.25), transparent 55%),
        var(--bg-card-alt);
      box-shadow: 0 20px 45px rgba(2, 132, 199, 0.25);
      display: flex;
      flex-direction: column;
      gap: 14px;
      position: relative;
      overflow: hidden;
    }
    .hero-highlight::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, rgba(34, 211, 238, 0.05), transparent 70%);
      pointer-events: none;
    }
    .pitch-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 12px;
      padding: 10px 14px;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(2, 6, 23, 0.75);
      font-size: 13px;
      gap: 10px;
    }
    .pitch-toggle button {
      width: auto;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(6, 182, 212, 0.2);
      border: 1px solid rgba(6, 182, 212, 0.65);
      color: #67e8f9;
      letter-spacing: 0.08em;
      cursor: pointer;
      text-transform: uppercase;
      font-size: 11px;
    }
    .hero-point {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      position: relative;
      overflow: hidden;
    }
    .alerts-card {
      border: 1px solid var(--border-strong);
      border-radius: 20px;
      padding: 16px;
      margin: 12px 0 18px;
      background: linear-gradient(135deg, rgba(8, 47, 73, 0.85), rgba(15, 23, 42, 0.85));
      box-shadow: 0 12px 30px rgba(2, 132, 199, 0.25);
      position: relative;
      overflow: hidden;
    }
    .alerts-card h4 {
      margin-bottom: 10px;
      font-size: 12px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--accent-magenta);
    }
    .alerts-card ul {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .alerts-card li {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      font-size: 12px;
      position: relative;
    }
    .alerts-card li:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }
    .alerts-card li::before {
      content: "";
      position: absolute;
      left: -3px;
      top: 0;
      bottom: 0;
      width: 3px;
      border-radius: 4px;
      background: linear-gradient(180deg, var(--accent-magenta), transparent);
      opacity: 0.6;
    }
    .alerts-meta {
      font-size: 10px;
      letter-spacing: 0.18em;
      color: var(--accent-cyan);
      text-transform: uppercase;
    }
    .alert-timer {
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.08em;
      color: #f43f5e;
      text-shadow: 0 0 8px rgba(244, 63, 94, 0.8);
      display: inline-block;
      margin-top: 4px;
    }
    .hero-point-icon {
      width: 32px;
      height: 32px;
      border-radius: 12px;
      background: linear-gradient(135deg, #22d3ee, #a855f7);
      color: #0f172a;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      box-shadow: 0 8px 20px rgba(34, 211, 238, 0.35);
    }
    .hero-point strong {
      display: block;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #fef3c7;
      font-size: 11px;
      margin-bottom: 2px;
    }
    .hero-point p {
      margin: 0;
      font-size: 13px;
      color: #e2e8f0;
      line-height: 1.4;
    }
    .hero-animated {
      position: relative;
      overflow: hidden;
    }
    .hero-animated::after {
      content: "";
      position: absolute;
      inset: -40%;
      background: radial-gradient(circle at 20% 20%, rgba(34, 211, 238, 0.12), transparent 35%), radial-gradient(circle at 80% 60%, rgba(244, 114, 182, 0.12), transparent 35%);
      filter: blur(12px);
      opacity: 0.8;
      animation: heroGlow 8s ease-in-out infinite alternate;
      pointer-events: none;
    }
    .hero-point.neon-card {
      background: linear-gradient(135deg, rgba(11, 19, 40, 0.9), rgba(10, 26, 56, 0.9));
      border: 1px solid rgba(103, 232, 249, 0.25);
      box-shadow: 0 15px 35px rgba(0, 7, 20, 0.65), 0 0 18px rgba(34, 211, 238, 0.25);
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      border-radius: 16px;
      padding: 14px 12px;
      overflow: hidden;
    }
    .hero-point.neon-card::before {
      content: "";
      position: absolute;
      inset: -25%;
      background: radial-gradient(circle at 30% 30%, rgba(34, 211, 238, 0.25), transparent 40%), radial-gradient(circle at 70% 60%, rgba(244, 114, 182, 0.2), transparent 45%);
      filter: blur(16px);
      opacity: 0.9;
      z-index: 0;
      transition: opacity 0.25s ease, transform 0.25s ease;
    }
    .hero-point.neon-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 40px rgba(0, 7, 20, 0.7), 0 0 22px rgba(244, 114, 182, 0.35);
      background: linear-gradient(135deg, rgba(14, 26, 50, 0.95), rgba(12, 32, 64, 0.95));
    }
    .hero-point.neon-card:hover::before {
      opacity: 1;
      transform: scale(1.04);
    }
    .hero-point-icon.pulse {
      animation: pulseGlow 2.8s ease-in-out infinite;
    }
    @keyframes heroGlow {
      0% { transform: scale(1); opacity: 0.8; }
      100% { transform: scale(1.08); opacity: 1; }
    }
    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 10px rgba(34, 211, 238, 0.55); }
      50% { box-shadow: 0 0 22px rgba(244, 114, 182, 0.75); }
    }
    #landingScreen {
      position: relative;
    }
    #landingScreen.active .landing-wrapper {
      animation: landingFloat 12s ease-in-out infinite;
    }
    #landingScreen.active .brand-logo-img {
      animation: logoBreathe 6.5s ease-in-out infinite;
    }
    #landingScreen.active .app-title {
      animation: titleGlow 7s ease-in-out infinite;
      text-shadow: 0 0 18px rgba(34, 211, 238, 0.35), 0 0 30px rgba(244, 114, 182, 0.25);
    }
    #landingScreen.active #landingTagline {
      animation: taglineDrift 9s ease-in-out infinite;
    }
    #landingScreen .hero-point {
      opacity: 0;
      transform: translateY(10px);
    }
    #landingScreen.active .hero-point {
      animation: heroRise 0.9s ease forwards;
    }
    #landingScreen.active .hero-point:nth-child(1) { animation-delay: 0.1s; }
    #landingScreen.active .hero-point:nth-child(2) { animation-delay: 0.25s; }
    #landingScreen.active .hero-point:nth-child(3) { animation-delay: 0.4s; }
    #landingScreen.active #landingGetPassBtn {
      animation: ctaPulse 3.2s ease-in-out infinite;
    }
    .landing-wrapper {
      position: relative;
    }
    .landing-wrapper .landing-strobe {
      position: absolute;
      inset: -45%;
      background: conic-gradient(from 0deg, rgba(34, 211, 238, 0.38), transparent 20%, rgba(244, 114, 182, 0.3), transparent 45%, rgba(56, 189, 248, 0.22), transparent 68%, rgba(34, 211, 238, 0.32), transparent 100%);
      mix-blend-mode: screen;
      filter: blur(16px);
      opacity: 0.55;
      animation: strobeSpin 18s linear infinite, strobePulse 5.4s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }
    .landing-wrapper > :not(.landing-strobe) {
      position: relative;
      z-index: 1;
    }
    #landingScreen.active .landing-wrapper::before {
      content: "";
      position: absolute;
      inset: -60%;
      background: linear-gradient(120deg, rgba(34, 211, 238, 0.1), transparent 55%, rgba(244, 114, 182, 0.12));
      transform: rotate(12deg);
      opacity: 0.6;
      animation: wrapperSheen 14s ease-in-out infinite;
      pointer-events: none;
    }
    #landingScreen.active .landing-wrapper::after {
      content: "";
      position: absolute;
      inset: 8px;
      border-radius: 22px;
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: inset 0 0 30px rgba(14, 165, 233, 0.08);
      pointer-events: none;
    }
    @keyframes landingAurora {
      0% { transform: translate3d(0, 0, 0) scale(1); opacity: 0.65; }
      50% { transform: translate3d(-3%, 2%, 0) scale(1.04); opacity: 0.85; }
      100% { transform: translate3d(2%, -2%, 0) scale(1.06); opacity: 0.75; }
    }
    @keyframes orbFloat {
      0% { transform: translate3d(0, 0, 0) scale(0.95); }
      50% { transform: translate3d(8px, -10px, 0) scale(1.05); }
      100% { transform: translate3d(-6px, 6px, 0) scale(0.98); }
    }
    @keyframes landingFloat {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }
    @keyframes logoBreathe {
      0%, 100% { filter: drop-shadow(0 0 14px rgba(34, 211, 238, 0.65)); transform: scale(1); }
      50% { filter: drop-shadow(0 0 24px rgba(244, 114, 182, 0.65)); transform: scale(1.03); }
    }
    @keyframes strobeSpin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @keyframes strobePulse {
      0%, 100% { opacity: 0.45; }
      50% { opacity: 0.75; }
    }
    @keyframes titleGlow {
      0%, 100% { letter-spacing: 0.08em; }
      50% { letter-spacing: 0.12em; }
    }
    @keyframes taglineDrift {
      0%, 100% { opacity: 0.95; transform: translateY(0); }
      50% { opacity: 1; transform: translateY(-2px); }
    }
    @keyframes heroRise {
      0% { opacity: 0; transform: translateY(12px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    @keyframes ctaPulse {
      0%, 100% { box-shadow: 0 16px 36px rgba(34, 211, 238, 0.35); transform: translateY(0); }
      50% { box-shadow: 0 18px 46px rgba(244, 114, 182, 0.35); transform: translateY(-2px); }
    }
    @keyframes wrapperSheen {
      0% { opacity: 0.3; transform: translate3d(-2%, 0, 0) rotate(12deg); }
      50% { opacity: 0.7; transform: translate3d(3%, -2%, 0) rotate(12deg); }
      100% { opacity: 0.35; transform: translate3d(-1%, 2%, 0) rotate(12deg); }
    }
    @keyframes starDrift {
      0% { transform: translate3d(0, 0, 0); }
      50% { transform: translate3d(2%, -2%, 0); }
      100% { transform: translate3d(-2%, 2%, 0); }
    }
    @keyframes starTwinkle {
      0%, 100% { opacity: 0.45; }
      50% { opacity: 0.75; }
    }
    @keyframes asterismFloat {
      0%, 100% { transform: translate3d(0, 0, 0) scale(1); }
      50% { transform: translate3d(6px, -4px, 0) scale(1.02); }
    }
    @media (prefers-reduced-motion: reduce) {
      #landingScreen.active .landing-wrapper,
      #landingScreen.active .brand-logo-img,
      #landingScreen.active .app-title,
      #landingScreen.active #landingTagline,
      #landingScreen.active .hero-point,
      #landingScreen.active #landingGetPassBtn,
      .landing-bg::before,
      .landing-stars::before,
      .landing-stars::after,
      .landing-asterism,
      .landing-orbs span,
      #landingScreen.active .landing-wrapper::before,
      .landing-wrapper .landing-strobe {
        animation: none !important;
      }
      #landingScreen .hero-point {
        opacity: 1;
        transform: none;
      }
    }
    .hero-carousel,
    .hero-slide,
    .hero-slide.active {
      display: none !important;
    }
    .hero-slide p {
      font-size: 13px;
      color: #e2e8f0;
      line-height: 1.4;
    }
    .insta-cta-wrap {
      text-align: center;
      display: flex;
      justify-content: center;
      margin-top: 8px;
    }
    .insta-cta {
      margin: 6px auto 0;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 14px;
      background: linear-gradient(120deg, rgba(34, 211, 238, 0.18), rgba(236, 72, 153, 0.18));
      border: 1px solid rgba(103, 232, 249, 0.35);
      box-shadow: 0 10px 24px rgba(8, 47, 73, 0.35);
    }
    .insta-cta.insta-cta-small {
      padding: 5px 9px;
      gap: 8px;
      font-size: 13px;
      border-radius: 14px;
    }
    .insta-cta svg {
      width: 20px;
      height: 20px;
      filter: drop-shadow(0 0 10px rgba(16, 185, 129, 0.55));
    }
    .insta-cta.insta-cta-small svg {
      width: 20px;
      height: 20px;
    }
    .insta-cta svg rect {
      fill: rgba(34, 211, 238, 0.3);
      stroke: #c7d2fe;
      stroke-width: 1.7;
    }
    .insta-cta svg circle {
      stroke: #e0f2fe;
    }
    .insta-cta svg circle:last-of-type {
      fill: #22d3ee;
    }
    .insta-cta.insta-cta-small svg rect {
      fill: rgba(34, 211, 238, 0.42);
      stroke: #f8fafc;
      stroke-width: 1.9;
    }
    .insta-cta a {
      color: #a5f3fc;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-decoration: none;
      font-size: 13px;
    }
    .insta-cta a:hover {
      color: #a855f7;
    }
    .testimonial-bar {
      margin-top: 10px;
      padding: 12px 14px;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(2, 6, 23, 0.85);
      font-size: 12px;
      color: #94a3b8;
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: center;
      text-align: center;
    }
    .demo-badge {
      margin-top: 8px;
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #facc15;
      text-align: center;
    }
    @keyframes fadeSlide {
      from {
        opacity: 0;
        transform: translateY(4px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .testimonial-bar strong {
      color: #fef3c7;
      letter-spacing: 0.12em;
    }
    .landing-live-count {
      margin: 10px auto 14px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(59, 130, 246, 0.35);
      background: rgba(8, 15, 30, 0.75);
      color: #e2e8f0;
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      box-shadow: 0 12px 28px rgba(8, 47, 73, 0.45);
    }
    .landing-live-count strong {
      font-size: 14px;
      color: #a5f3fc;
      letter-spacing: 0.08em;
    }

    /* Auth form */
    .field {
      margin-bottom: 10px;
    }
    .field label {
      display: block;
      font-size: 12px;
      margin-bottom: 4px;
      color: #cbd5f5;
    }
    .field input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: rgba(15, 23, 42, 0.9);
      color: #f9fafb;
      font-size: 14px;
      box-sizing: border-box;
      min-width: 0;
    }
    .field input[type="datetime-local"],
    #alertExpires {
      width: 100%;
      max-width: 100%;
      display: block;
      box-sizing: border-box;
      min-width: 0;
    }
    .field select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(12, 30, 52, 0.92));
      color: #f9fafb;
      font-size: 13px;
      box-shadow: 0 0 10px rgba(34, 211, 238, 0.18);
    }
    /* Mobile-friendly date input */
    @supports (-webkit-touch-callout: none) {
      input[type="date"] {
        -webkit-appearance: none;
        appearance: none;
        padding: 12px 14px;
        border-radius: 10px;
        font-size: 14px;
      }
      input[type="datetime-local"] {
        -webkit-appearance: none;
        appearance: none;
        padding: 12px 14px;
        border-radius: 10px;
        font-size: 14px;
      }
      input[type="date"]::-webkit-date-and-time-value {
        text-align: left;
      }
    }
    .remember-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 6px 0 12px;
      color: #cbd5f5;
      font-size: 12px;
    }
    .remember-row input {
      width: auto;
      accent-color: var(--accent-cyan);
      transform: translateY(1px);
    }

    .error {
      color: #f97373;
      font-size: 12px;
      margin-top: 6px;
      min-height: 16px;
    }

    /* Nightlife pass styling */
    .pass-card {
      position: relative;
      border-radius: 28px;
      padding: 20px 14px 16px;
      background: linear-gradient(135deg, rgba(7, 11, 24, 0.92), rgba(12, 30, 52, 0.95));
      overflow: hidden;
      border: 1px solid var(--accent-border-live, var(--border-soft));
      box-shadow: var(--accent-shadow-live, 0 25px 55px rgba(0, 3, 15, 0.85));
    }
    .pass-card::after {
      content: "";
      position: absolute;
      inset: -40%;
      background: conic-gradient(from 90deg, color-mix(in srgb, var(--accent-primary-live) 55%, transparent), transparent 35%, color-mix(in srgb, var(--accent-secondary-live) 50%, transparent), transparent 70%);
      animation: slowSpin 14s linear infinite;
      pointer-events: none;
    }
    .pass-inner {
      position: relative;
      z-index: 1;
    }
    @keyframes slowSpin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .pass-card.intro {
      animation: passIntro 0.65s ease;
    }
    /* Pulse band ties the pass UI together */
    .pulse-band {
      position: relative;
      margin: 10px 0 14px;
      padding: 14px 16px;
      border-radius: 18px;
      background: linear-gradient(135deg, color-mix(in srgb, var(--vibe-primary, #22d3ee) 18%, rgba(10, 17, 32, 0.92)), rgba(5, 12, 26, 0.9));
      border: 1px solid color-mix(in srgb, var(--vibe-primary, #22d3ee) 35%, rgba(103, 232, 249, 0.25));
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.55), 0 0 32px var(--vibe-glow, var(--accent-glow-live, rgba(103, 232, 249, 0.16)));
      overflow: hidden;
    }
    .pulse-band::after {
      content: "";
      position: absolute;
      inset: -35%;
      background: conic-gradient(from 0deg, rgba(34, 211, 238, 0.16), transparent 35%, rgba(244, 114, 182, 0.14), transparent 70%);
      animation: pulseAura 16s linear infinite;
      pointer-events: none;
      filter: blur(12px);
    }
    .pulse-content {
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .pulse-head {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
      flex-wrap: wrap;
    }
    .pulse-chip {
      padding: 6px 10px;
      border-radius: 12px;
      background: var(--accent-surface-live, rgba(103, 232, 249, 0.15));
      border: 1px solid var(--accent-border-live, rgba(103, 232, 249, 0.35));
      color: var(--accent-primary-live, #a5f3fc);
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }
    .pulse-id {
      font-size: 12px;
      letter-spacing: 0.16em;
      color: #e2e8f0;
      opacity: 0.85;
      cursor: pointer;
    }
    .pulse-thread {
      position: relative;
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 6px;
      align-items: end;
      min-height: 28px;
    }
    .pulse-thread span {
      display: block;
      height: var(--pulse-height, 14px);
      border-radius: 10px;
      background: linear-gradient(180deg, color-mix(in srgb, var(--vibe-primary, var(--accent-primary-live)) 90%, transparent), color-mix(in srgb, var(--vibe-secondary, var(--accent-secondary-live)) 70%, transparent));
      box-shadow: 0 8px 18px var(--vibe-glow, var(--accent-glow-live, rgba(34, 211, 238, 0.35)));
      opacity: 0.7;
      transition: height 280ms ease, opacity 280ms ease;
      transform-origin: bottom;
      animation: pulseWave var(--pulse-speed, 1.8s) ease-in-out infinite, pulseGlow 3.6s ease-in-out infinite;
      animation-delay: var(--pulse-delay, 0s);
    }
    .pulse-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      color: #cbd5f5;
      font-size: 12px;
    }
    .pulse-strong {
      font-weight: 700;
      color: #e0f2fe;
    }
    .pulse-subtle {
      opacity: 0.82;
    }
    @keyframes pulseAura { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes pulseWave {
      0% { transform: scaleY(0.82); }
      45% { transform: scaleY(1.12); }
      70% { transform: scaleY(0.94); }
      100% { transform: scaleY(0.82); }
    }
    @keyframes pulseGlow {
      0% { filter: drop-shadow(0 0 8px rgba(34, 211, 238, 0.18)); }
      50% { filter: drop-shadow(0 0 16px rgba(244, 114, 182, 0.22)); }
      100% { filter: drop-shadow(0 0 10px rgba(34, 211, 238, 0.18)); }
    }
    @keyframes passIntro {
      0% { opacity: 0; transform: translateY(14px) scale(0.985); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }
    /* Screen transitions */
    .screen {
      position: relative;
    }
    .screen.screen-in {
      animation: screenIn 320ms ease;
    }
    @keyframes screenIn {
      0% { opacity: 0; transform: translateY(12px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .pass-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
      gap: 8px;
      flex-wrap: wrap;
    }
    .pass-brand {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      min-width: 0;
    }
    .pass-brand img {
      flex-shrink: 0;
    }
    .status-pill {
      background: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid color-mix(in srgb, var(--accent-primary-live) 75%, rgba(255,255,255,0.12));
      color: var(--accent-primary-live);
      background: linear-gradient(
        to right,
        color-mix(in srgb, var(--accent-primary-live) 45%, transparent),
        color-mix(in srgb, var(--accent-secondary-live) 22%, transparent)
      );
      box-shadow: 0 0 12px var(--accent-glow-live);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 600;
      white-space: nowrap;
      cursor: pointer;
      max-width: 70vw;
      overflow: hidden;
      text-overflow: ellipsis;
      flex-shrink: 1;
      justify-self: flex-end;
      margin-left: auto;
      margin-top: 4px;
    }
    .status-pill.vip-status {
      border-color: rgba(250, 204, 21, 0.95);
      color: #fef9c3;
      background: linear-gradient(
        to right,
        rgba(250, 204, 21, 0.6),
        rgba(250, 204, 21, 0.25)
      );
      box-shadow: 0 0 12px rgba(250, 204, 21, 0.8);
    }
    .status-pill.ceo {
      border-color: rgba(250, 204, 21, 0.9);
      color: #fde68a;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(24, 24, 27, 0.9));
      box-shadow: 0 0 20px rgba(250, 204, 21, 0.5);
    }

    .user-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 6px 0 10px;
    }
    .username-row {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 2px;
      font-size: 12px;
      color: #cbd5f5;
    }
    .pass-id-row {
      margin-top: 6px;
    }
    .pass-id-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(125, 211, 252, 0.45);
      background: rgba(8, 14, 28, 0.7);
      color: #e2e8f0;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
    }
    .username-chip {
      padding: 4px 8px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.35);
      color: #e2e8f0;
      font-weight: 600;
    }
    .username-edit {
      border: 1px solid rgba(34, 211, 238, 0.55);
      background: rgba(34, 211, 238, 0.14);
      color: #a5f3fc;
      border-radius: 8px;
      padding: 2px 6px;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: box-shadow 160ms ease, transform 160ms ease;
    }
    .username-edit:hover {
      box-shadow: 0 0 10px rgba(34, 211, 238, 0.35);
      transform: translateY(-1px);
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 10%, #a855f7, #0ea5e9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 18px;
      color: #020617;
      box-shadow: 0 0 16px rgba(59, 130, 246, 0.8);
      position: relative;
    }
    .avatar::after {
      content: attr(data-flair);
      position: absolute;
      top: -6px;
      right: -6px;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.85);
      color: #fef08a;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.35);
      opacity: 0;
      transform: scale(0.9);
      transition: opacity 0.2s ease, transform 0.2s ease;
    }
    .avatar[data-flair]:after {
      opacity: 1;
      transform: scale(1);
    }
    /* Background textures */
    body.bg-default {
      background: radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.08), transparent 35%), radial-gradient(circle at 80% 0%, rgba(16, 185, 129, 0.08), transparent 30%), #0b1220;
    }
    body.bg-mesh {
      background: radial-gradient(circle at 30% 30%, rgba(244, 114, 182, 0.12), transparent 35%), radial-gradient(circle at 70% 10%, rgba(34, 211, 238, 0.14), transparent 40%), radial-gradient(circle at 50% 80%, rgba(251, 191, 36, 0.12), transparent 45%), #0a0f1d;
    }
    body.bg-grid {
      background:
        linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px),
        radial-gradient(circle at 20% 20%, rgba(34, 211, 238, 0.08), transparent 25%),
        radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.08), transparent 25%),
        #0c1324;
      background-size: 28px 28px, 28px 28px, 100% 100%, 100% 100%, auto;
    }
    body.bg-bokeh {
      background:
        radial-gradient(circle at 15% 20%, rgba(59, 130, 246, 0.18), transparent 25%),
        radial-gradient(circle at 80% 25%, rgba(244, 114, 182, 0.18), transparent 22%),
        radial-gradient(circle at 40% 75%, rgba(34, 211, 238, 0.14), transparent 30%),
        #0a1020;
      backdrop-filter: blur(0.2px);
    }
    .user-name {
      font-size: 14px;
      font-weight: 600;
    }
    .user-tier {
      font-size: 11px;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .meta-row {
      display: flex;
      justify-content: space-between;
      margin: 4px 0 10px;
      gap: 10px;
    }
    .meta-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .meta-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #6b7280;
    }
    .meta-value {
      font-size: 12px;
    }

    .qr-wrapper {
      margin: 6px 0 10px;
      padding: 10px;
      border-radius: 18px;
      background:
        radial-gradient(circle at 15% 0%, rgba(56, 189, 248, 0.18), transparent 55%),
        radial-gradient(circle at 85% 100%, rgba(236, 72, 153, 0.21), transparent 55%);
      border: 1px solid rgba(148, 163, 184, 0.4);
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .qr-text {
      font-size: 11px;
      color: #9ca3af;
    }
    .qr-text strong {
      display: block;
      font-size: 12px;
      color: #e5e7eb;
    }
    .pass-code {
      display: inline-block;
      margin-top: 6px;
      font-size: 12px;
      letter-spacing: 0.12em;
      color: var(--accent-primary-live);
    }
    .qr-image-shell {
      width: 120px;
      height: 120px;
      border-radius: 20px;
      border: 2px solid var(--accent-border-live, rgba(148, 163, 184, 0.5));
      background:
        radial-gradient(circle at top, color-mix(in srgb, var(--accent-primary-live) 35%, transparent), rgba(2, 6, 23, 0.9));
      box-shadow: 0 0 16px var(--accent-glow-live, rgba(6, 182, 212, 0.5));
      position: relative;
      overflow: hidden;
      flex-shrink: 0;
      animation: qrGlow 6s ease-in-out infinite;
    }
    .offline-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 6px 0 10px;
      font-size: 11px;
      color: #9ca3af;
    }
    .offline-badge {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(34, 211, 238, 0.5);
      color: #0f172a;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 10px;
      background: linear-gradient(120deg, rgba(34, 211, 238, 0.9), rgba(16, 185, 129, 0.8));
      box-shadow: 0 0 12px rgba(16, 185, 129, 0.4);
    }
    .offline-badge.syncing {
      background: rgba(15, 23, 42, 0.8);
      color: #67e8f9;
      border-color: rgba(59, 130, 246, 0.4);
      box-shadow: none;
    }
    .community-stats {
      margin: 10px 0 16px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 10px;
    }
    .community-stat {
      flex: 1;
      border-radius: 18px;
      border: 1px solid var(--border-soft);
      padding: 12px;
      background: linear-gradient(180deg, rgba(13, 21, 38, 0.95), rgba(6, 14, 30, 0.9));
      box-shadow: 0 8px 24px rgba(1, 4, 12, 0.65);
      position: relative;
      overflow: hidden;
    }
    .community-stat::after {
      content: "";
      position: absolute;
      inset: -30%;
      background: radial-gradient(circle, rgba(34, 211, 238, 0.15), transparent 70%);
      animation: statGlow 8s linear infinite;
      pointer-events: none;
    }
    .community-stat span {
      display: block;
      font-size: 10px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #94a3b8;
      margin-bottom: 3px;
    }
    .community-stat strong {
      font-size: 14px;
      color: #f8fafc;
    }
    @keyframes statGlow {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .vip-member-deal {
      margin: 8px 0 12px;
      border-radius: 18px;
      border: 1px solid rgba(250, 204, 21, 0.45);
      padding: 14px;
      background: linear-gradient(120deg, rgba(250, 204, 21, 0.15), rgba(26, 20, 5, 0.92));
      color: #fef9c3;
      display: none;
      box-shadow: 0 14px 30px rgba(250, 204, 21, 0.25);
    }
    .vip-member-deal strong {
      display: block;
      font-size: 13px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    .vip-member-deal span {
      display: block;
      color: #fde68a;
      font-size: 12px;
    }
    .qr-image-shell::after {
      content: "";
      position: absolute;
      top: -20%;
      left: -120%;
      width: 80%;
      height: 140%;
      background: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.55), transparent);
      transform: rotate(20deg);
      animation: qrShimmer 4.2s linear infinite;
    }
    .qr-image {
      width: 100%;
      height: 100%;
      border-radius: inherit;
      object-fit: cover;
      display: block;
    }
    @media (prefers-reduced-motion: reduce) {
      .btn-primary,
      .qr-image-shell,
      .qr-image-shell::after {
        animation: none;
      }
    }

    .divider {
      height: 1px;
      border-radius: 999px;
      background: linear-gradient(
        to right,
        transparent,
        rgba(148, 163, 184, 0.7),
        transparent
      );
      margin: 6px 0 8px;
    }

    .perks-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .perks {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
    }
    .perk-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .perk-dot {
      width: 4px;
      height: 4px;
      border-radius: 999px;
      background: #22d3ee;
      box-shadow: 0 0 8px rgba(34, 211, 238, 0.9);
    }

    .city-tag {
      font-size: 10px;
      color: #6b7280;
      text-align: right;
      margin-top: 4px;
    }

    .top-right-logout {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #94a3b8;
      padding: 4px 6px;
    }
    .user-mini {
      color: #a5f3fc;
      text-shadow: 0 0 8px rgba(34, 211, 238, 0.35);
      font-weight: 700;
      letter-spacing: 0.04em;
    }
    .logout-link {
      color: #f97373;
      cursor: pointer;
      text-decoration: underline;
    }
    .refresh-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      margin-left: 6px;
      border-radius: 50%;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.7);
      color: #67e8f9;
      font-weight: 800;
      font-size: 13px;
      box-shadow: 0 0 12px rgba(103, 232, 249, 0.35);
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .refresh-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 16px rgba(103, 232, 249, 0.5);
    }
    /* Hide landing refresh when landing screen not active */
    #landingScreen:not(.active) .refresh-btn {
      display: none !important;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.35);
    }
    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(120deg, #67e8f9, #22c55e, #facc15);
      box-shadow: 0 0 10px rgba(103, 232, 249, 0.6);
      transition: width 0.35s ease;
    }

    .pass-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 6px;
    }
    .spray-tag {
      flex: 1;
      text-align: center;
      font-family: "Segoe Script", "Pacifico", "Brush Script MT", cursive;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #67e8f9;
      text-shadow:
        -1px -1px 0 #fff,
        1px -1px 0 #fff,
        -1px 1px 0 #fff,
        1px 1px 0 #fff,
        0 0 5px rgba(103, 232, 249, 0.85),
        0 0 10px rgba(34, 197, 94, 0.55),
        0 0 14px rgba(250, 204, 21, 0.45),
        0 0 18px rgba(109, 40, 217, 0.35);
      filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.25));
      opacity: 0.98;
      transform: rotate(-0.5deg);
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      pointer-events: none;
      user-select: none;
    }
    .nav-dropdown {
      position: relative;
      z-index: 4;
    }
    .nav-toggle {
      background: linear-gradient(120deg, #0ea5e9, #22c55e);
      color: #021526;
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 700;
      letter-spacing: 0.08em;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(14, 165, 233, 0.35);
      position: relative;
    }
    .nav-menu {
      position: absolute;
      top: 46px;
      left: 0;
      min-width: 230px;
      border-radius: 14px;
      background: rgba(7, 11, 24, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.45);
      overflow: hidden;
      display: none;
      backdrop-filter: blur(8px);
    }
    .nav-menu.active {
      display: block;
    }
    .nav-item {
      width: 100%;
      text-align: left;
      padding: 12px 14px;
      background: transparent;
      border: none;
      color: #e2e8f0;
      font-weight: 600;
      letter-spacing: 0.06em;
      cursor: pointer;
    }
    .nav-item.pending {
      background: linear-gradient(90deg, rgba(34, 211, 238, 0.16), rgba(59, 130, 246, 0.08));
      color: #67e8f9;
      box-shadow: inset 2px 0 0 rgba(34, 211, 238, 0.7), 0 0 20px rgba(34, 211, 238, 0.25);
    }
    .nav-item.pending::after {
      content: "â€¢";
      color: #f472b6;
      margin-left: 6px;
      text-shadow: 0 0 12px rgba(244,114,182,0.8);
      font-size: 16px;
      vertical-align: middle;
    }
    .nav-item:hover {
      background: rgba(255, 255, 255, 0.06);
      color: #67e8f9;
    }
    .nav-item.danger {
      color: #fca5a5;
    }
    .nav-accent {
      margin-top: 10px;
      padding: 8px 6px 2px;
      border-top: 1px solid var(--border-soft);
    }
    .nav-accent-title {
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    .nav-accent-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .accent-chip {
      flex: 1 1 80px;
      border: 1px solid var(--border-soft);
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(15, 23, 42, 0.7);
      color: var(--text-secondary);
      font-size: 11px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .accent-chip:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 12px var(--glow-cyan);
    }
    .accent-chip.active {
      border-color: var(--accent-cyan);
      color: var(--text-primary);
      box-shadow: 0 0 14px var(--glow-cyan);
    }
    .accent-chip[data-accent="cyan"] {
      background: linear-gradient(120deg, rgba(34, 211, 238, 0.18), rgba(34, 197, 94, 0.1));
      border-color: rgba(34, 211, 238, 0.5);
      color: #a5f3fc;
    }
    .accent-chip[data-accent="magenta"] {
      background: linear-gradient(120deg, rgba(244, 114, 182, 0.22), rgba(139, 92, 246, 0.14));
      border-color: rgba(244, 114, 182, 0.5);
      color: #f9a8d4;
    }
    .accent-chip[data-accent="gold"] {
      background: linear-gradient(120deg, rgba(251, 191, 36, 0.22), rgba(14, 165, 233, 0.12));
      border-color: rgba(251, 191, 36, 0.45);
      color: #fcd34d;
    }
    .accent-chip[data-accent="jade"] {
      background: linear-gradient(120deg, rgba(16, 185, 129, 0.25), rgba(14, 165, 233, 0.18));
      border-color: rgba(52, 211, 153, 0.45);
    }
    .accent-chip[data-accent="electric"] {
      background: linear-gradient(120deg, rgba(124, 58, 237, 0.25), rgba(34, 211, 238, 0.18));
      border-color: rgba(124, 58, 237, 0.45);
    }
    .accent-chip[data-accent="ember"] {
      background: linear-gradient(120deg, rgba(249, 115, 22, 0.25), rgba(244, 63, 94, 0.18));
      border-color: rgba(249, 115, 22, 0.45);
    }
    .accent-chip[data-accent="ceo"] {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.24), rgba(148, 212, 255, 0.32));
      border-color: rgba(208, 234, 255, 0.75);
      box-shadow: 0 0 20px rgba(148, 212, 255, 0.45), inset 0 0 16px rgba(255, 255, 255, 0.28);
      color: #f8fcff;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.45);
    }
    .ceo-only { display: none; }
    body.ceo-active .ceo-only { display: inline-flex; }

    body.theme-ceo {
      background:
        radial-gradient(circle at 18% -10%, rgba(255, 255, 255, 0.15), transparent 55%),
        radial-gradient(circle at 80% 0%, rgba(148, 212, 255, 0.28), transparent 65%),
        linear-gradient(185deg, #02040a, #05070f 52%, #010203 100%);
      color: #f8fafc;
    }
    body.theme-ceo .card-hd {
      border-color: rgba(208, 234, 255, 0.3);
      box-shadow: 0 30px 90px rgba(0, 0, 0, 0.82), 0 0 55px rgba(148, 212, 255, 0.22);
      background: linear-gradient(165deg, rgba(12, 18, 28, 0.92), rgba(2, 4, 10, 0.88));
    }
    body.theme-ceo .btn {
      text-transform: uppercase;
      letter-spacing: 0.1em;
      border-color: rgba(208, 234, 255, 0.4);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35), 0 0 18px rgba(148, 212, 255, 0.28);
      background: linear-gradient(120deg, rgba(255, 255, 255, 0.12), rgba(148, 212, 255, 0.18));
      color: #e5f2ff;
    }
    body.theme-ceo .btn.btn-secondary {
      border-color: rgba(103, 232, 249, 0.5);
    }
    body.theme-ceo .status-pill {
      border-color: rgba(208, 234, 255, 0.9);
      color: #f8fcff;
      background: linear-gradient(120deg, rgba(255, 255, 255, 0.38), rgba(148, 212, 255, 0.3));
      box-shadow: 0 0 24px rgba(148, 212, 255, 0.6);
    }
    body.theme-ceo .ceo-card,
    body.theme-ceo .ceo-pass-banner,
    body.theme-ceo .venues-card,
    body.theme-ceo .staff-radar {
      border-color: rgba(208, 234, 255, 0.35);
      background: linear-gradient(155deg, rgba(8, 12, 22, 0.95), rgba(0, 2, 6, 0.9));
      box-shadow: 0 30px 90px rgba(0, 0, 0, 0.8), 0 0 50px rgba(148, 212, 255, 0.22);
    }
    body.theme-ceo .portal-title {
      color: #e5f2ff;
      text-shadow: 0 0 18px rgba(148, 212, 255, 0.45);
    }

    @media (max-width: 540px) {
      .pass-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .status-pill {
        margin-left: 0;
        max-width: 100%;
        align-self: flex-start;
      }
    }
    .achievements-block {
      margin-top: 10px;
      padding: 8px 6px;
      border-top: 1px solid var(--border-soft);
    }
    .achievement {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      padding: 6px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.25);
      color: #e5e7eb;
      font-size: 12px;
      opacity: 0.7;
    }
    .achievement.unlocked {
      border-color: var(--accent-cyan);
      box-shadow: 0 0 14px var(--glow-cyan);
      opacity: 1;
    }
    .achievement-icon {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display: grid;
      place-items: center;
      background: rgba(34, 211, 238, 0.15);
      border: 1px solid rgba(34, 211, 238, 0.35);
      font-size: 14px;
    }
    .achievement.unlocked .achievement-icon {
      background: rgba(34, 211, 238, 0.25);
      border-color: var(--accent-cyan);
    }
    .pill-new {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 32px;
      padding: 2px 8px;
      margin-left: 6px;
      border-radius: 999px;
      background: linear-gradient(120deg, #22d3ee, #f472b6);
      color: #0b1222;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      box-shadow: 0 0 12px rgba(34, 211, 238, 0.35);
      opacity: 0;
      transform: translateY(-2px);
      transition: opacity 0.2s ease, transform 0.2s ease;
    }
    .pill-new.active {
      opacity: 1;
      transform: translateY(0);
    }
    .badge-row .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(34, 211, 238, 0.1);
      border: 1px solid var(--border-soft);
      font-size: 11px;
      letter-spacing: 0.04em;
    }
    .badge-row .badge.review { color: #f472b6; border-color: rgba(244, 114, 182, 0.4); }
    .badge-row .badge.streak { color: #fbbf24; border-color: rgba(251, 191, 36, 0.4); }
    .reward-ready {
      color: #facc15 !important;
      text-shadow: 0 0 6px rgba(250, 204, 21, 0.7);
      border-color: rgba(250, 204, 21, 0.4) !important;
    }

    /* Membership selection cards */
    .membership-card {
      background: rgba(15, 23, 42, 0.92);
      padding: 18px;
      margin-bottom: 16px;
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 0 20px rgba(0, 207, 255, 0.25);
    }
    .membership-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 6px;
      color: #22d3ee;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }
    .membership-title.vip {
      color: #f472b6;
    }
    .membership-price {
      color: #e5e7eb;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .membership-perks {
      list-style: none;
      padding-left: 0;
      margin-bottom: 14px;
      color: #cbd5e1;
      font-size: 13px;
    }
    #paymentElement,
    #voucherPaymentElement {
      background: rgba(15,23,42,0.85);
      border: 1px solid rgba(148,163,184,0.35);
      border-radius: 14px;
      padding: 14px;
      box-shadow: inset 0 0 0 1px rgba(34,211,238,0.12), 0 12px 28px rgba(15,23,42,0.55);
    }
    .membership-perks li {
      margin-bottom: 4px;
    }

    .ceo-pass-banner {
      display: none;
      margin: 8px 0 12px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(250, 204, 21, 0.5);
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(2, 6, 23, 0.8));
      color: #fef9c3;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .ceo-pass-banner.active {
      display: flex;
    }
    .ceo-pass-banner strong {
      letter-spacing: 0.18em;
      text-transform: uppercase;
    }
    .black-card-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 80;
      backdrop-filter: blur(4px);
    }
    .black-card-modal.active {
      display: flex;
    }
    .black-card {
      width: 380px;
      height: 260px;
      border-radius: 28px;
      background: radial-gradient(circle at 25% 20%, rgba(255, 255, 255, 0.05), transparent 40%),
        radial-gradient(circle at 80% 10%, rgba(79, 209, 197, 0.15), transparent 45%),
        linear-gradient(135deg, #070a12 0%, #0d111c 40%, #0c0f1a 100%);
      border: 1px solid rgba(250, 204, 21, 0.35);
      box-shadow:
        0 0 25px rgba(250, 204, 21, 0.2),
        0 25px 60px rgba(2, 6, 23, 0.9),
        inset 0 0 40px rgba(0, 255, 255, 0.08);
      position: relative;
      color: #fefcf3;
      padding: 24px;
      font-family: "Helvetica Neue", sans-serif;
      overflow: hidden;
      backdrop-filter: blur(6px);
    }
    .black-card::before,
    .black-card::after {
      content: "";
      position: absolute;
      inset: -25%;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(250, 204, 21, 0.16), transparent 60%);
      filter: blur(10px);
      z-index: 0;
    }
    .black-card::after {
      inset: -30% auto auto -10%;
      background: radial-gradient(circle, rgba(79, 209, 197, 0.16), transparent 60%);
    }
    .black-card-content {
      position: relative;
      z-index: 1;
      height: 100%;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 14px;
    }
    .black-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
    }
    .black-card-logo {
      width: 72px;
      height: 72px;
      border-radius: 16px;
      background: rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(103, 232, 249, 0.4);
      box-shadow: 0 0 20px rgba(103, 232, 249, 0.25);
      display: grid;
      place-items: center;
      overflow: hidden;
    }
    .black-card-logo img {
      width: 64px;
      height: 64px;
      object-fit: cover;
    }
    .black-card-title {
      text-align: right;
      text-transform: uppercase;
      letter-spacing: 0.24em;
      font-size: 11px;
      color: #fef9c3;
    }
    .black-card-body {
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: linear-gradient(120deg, rgba(250, 204, 21, 0.08), rgba(103, 232, 249, 0.05));
      padding: 16px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: inset 0 0 25px rgba(0, 0, 0, 0.25);
    }
    .black-card .name {
      font-size: 22px;
      letter-spacing: 0.16em;
      font-weight: 700;
      margin-top: 2px;
      margin-bottom: 2px;
    }
    .black-card .code {
      font-size: 16px;
      letter-spacing: 0.34em;
      color: #d9f99d;
    }
    .black-card-close {
      position: absolute;
      top: 18px;
      right: 22px;
      color: #f87171;
      cursor: pointer;
      z-index: 2;
      font-size: 18px;
    }
    @keyframes cardSpin {
      0% { transform: rotateY(0deg); }
      50% { transform: rotateY(15deg); }
      100% { transform: rotateY(0deg); }
    }

    /* Payment screen */
    .payment-card {
      background: rgba(15, 23, 42, 0.92);
      padding: 18px;
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 0 25px rgba(0, 207, 255, 0.25);
      margin-bottom: 12px;
    }
    .saved-card {
      margin-bottom: 14px;
      padding: 12px;
      border-radius: 14px;
      border: 1px dashed rgba(148, 163, 184, 0.4);
      background: rgba(2, 6, 23, 0.85);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #cbd5f5;
      gap: 10px;
    }
    .saved-card button {
      width: auto;
      padding: 6px 12px;
      border-radius: 999px;
      background: linear-gradient(120deg, rgba(6, 182, 212, 0.9), rgba(59, 130, 246, 0.85));
      border: none;
      color: #02101d;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      cursor: pointer;
    }
    .payment-summary {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-bottom: 12px;
      color: #e5e7eb;
    }
    .payment-summary span {
      font-weight: 600;
      color: #22d3ee;
    }
    .payment-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
    }
    .payment-grid .field {
      margin-bottom: 0;
    }
    .payment-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .success-msg {
      display: none;
      margin-top: 10px;
      text-align: center;
      color: #4ade80;
      font-weight: 600;
      letter-spacing: 0.08em;
    }
    .success-msg.visible {
      display: block;
    }

    /* Brand logo */
    .brand-logo {
      display: flex;
      justify-content: center;
      margin-bottom: 16px;
    }
    .brand-logo-landing {
      margin-bottom: 22px;
    }
    .landing-wrapper {
      position: relative;
      overflow: hidden;
      border-radius: 24px;
      padding: 22px 20px;
      background: rgba(8, 14, 32, 0.8);
      border: 1px solid rgba(103, 232, 249, 0.25);
      box-shadow: 0 25px 60px rgba(1, 4, 12, 0.7), 0 0 26px rgba(34, 211, 238, 0.25);
      backdrop-filter: blur(6px);
    }
    .landing-bg {
      position: fixed;
      inset: 0;
      z-index: -2;
      overflow: hidden;
    }
    .landing-bg::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(5, 12, 28, 0.55), rgba(5, 12, 28, 0.85));
      pointer-events: none;
    }
    .landing-bg::before {
      content: "";
      position: absolute;
      inset: -20%;
      background:
        radial-gradient(circle at 20% 30%, rgba(34, 211, 238, 0.35), transparent 45%),
        radial-gradient(circle at 80% 60%, rgba(244, 114, 182, 0.28), transparent 50%),
        radial-gradient(circle at 45% 85%, rgba(59, 130, 246, 0.2), transparent 55%);
      mix-blend-mode: screen;
      opacity: 0.8;
      animation: landingAurora 18s ease-in-out infinite;
      pointer-events: none;
    }
    .landing-bg img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: brightness(0.55);
    }
    .landing-logo-overlay {
      z-index: 2;
    }
    .landing-stars {
      position: absolute;
      inset: 0;
      z-index: 1;
      pointer-events: none;
      mix-blend-mode: screen;
    }
    .landing-stars::before,
    .landing-stars::after {
      content: "";
      position: absolute;
      inset: -10%;
      background-image:
        radial-gradient(1px 1px at 20% 30%, rgba(255, 255, 255, 0.7) 0, transparent 2px),
        radial-gradient(1px 1px at 80% 70%, rgba(34, 211, 238, 0.6) 0, transparent 2px),
        radial-gradient(1px 1px at 45% 80%, rgba(244, 114, 182, 0.45) 0, transparent 2px),
        radial-gradient(1px 1px at 60% 20%, rgba(255, 255, 255, 0.6) 0, transparent 2px);
      background-size: 180px 180px;
      opacity: 0.55;
      animation: starDrift 48s linear infinite, starTwinkle 7s ease-in-out infinite;
    }
    .landing-stars::after {
      background-size: 240px 240px;
      opacity: 0.35;
      animation-duration: 70s, 9s;
      animation-delay: -6s, -3s;
    }
    .landing-asterism {
      position: absolute;
      width: 150px;
      height: 90px;
      opacity: 0.55;
      background-image:
        radial-gradient(circle at 8% 30%, rgba(255, 255, 255, 0.85) 1px, transparent 2px),
        radial-gradient(circle at 40% 12%, rgba(255, 255, 255, 0.7) 1px, transparent 2px),
        radial-gradient(circle at 72% 54%, rgba(255, 255, 255, 0.8) 1px, transparent 2px),
        radial-gradient(circle at 92% 20%, rgba(255, 255, 255, 0.6) 1px, transparent 2px),
        linear-gradient(120deg, transparent 0 46%, rgba(255, 255, 255, 0.18) 47%, rgba(255, 255, 255, 0.18) 49%, transparent 50%),
        linear-gradient(20deg, transparent 0 54%, rgba(255, 255, 255, 0.18) 55%, rgba(255, 255, 255, 0.18) 57%, transparent 58%);
      filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0.35));
      animation: asterismFloat 20s ease-in-out infinite;
    }
    .landing-asterism.a1 {
      top: 12%;
      right: 10%;
      transform: rotate(12deg);
      animation-delay: -4s;
    }
    .landing-asterism.a2 {
      bottom: 18%;
      left: 8%;
      transform: rotate(-8deg);
      opacity: 0.45;
      animation-delay: -9s;
    }
    .landing-asterism.a3 {
      top: 46%;
      left: 62%;
      transform: rotate(18deg);
      opacity: 0.5;
      animation-delay: -12s;
    }
    .landing-orbs {
      position: absolute;
      inset: 0;
      z-index: 3;
      pointer-events: none;
    }
    .landing-orbs span {
      position: absolute;
      width: 140px;
      height: 140px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(34, 211, 238, 0.38), rgba(34, 211, 238, 0));
      filter: blur(2px);
      opacity: 0.7;
      animation: orbFloat 16s ease-in-out infinite;
    }
    .landing-orbs span:nth-child(1) {
      top: 14%;
      left: 8%;
      animation-delay: -2s;
    }
    .landing-orbs span:nth-child(2) {
      top: 52%;
      right: 6%;
      width: 180px;
      height: 180px;
      background: radial-gradient(circle, rgba(244, 114, 182, 0.32), rgba(244, 114, 182, 0));
      animation-delay: -6s;
    }
    .landing-orbs span:nth-child(3) {
      bottom: 8%;
      left: 24%;
      width: 120px;
      height: 120px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.28), rgba(59, 130, 246, 0));
      animation-delay: -10s;
    }
    .brand-logo-payment {
      margin-bottom: 14px;
    }
    .brand-logo-img {
      width: 140px;
      max-width: 70%;
      display: block;
      margin: 0 auto;
      filter: drop-shadow(0 0 14px rgba(6, 182, 212, 0.7));
      border-radius: 50%;
      border: 2px solid rgba(6, 182, 212, 0.4);
      padding: 4px;
      background: radial-gradient(circle, rgba(15, 23, 42, 0.9), rgba(2, 6, 23, 0.95));
    }
    .brand-logo-img.small {
      width: 95px;
    }

    /* Redemption CTA & modal */
    .redeem-row {
      margin: 10px 0 16px;
    }
    .secondary-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }
    .beta-switcher {
      display: none;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
      padding: 12px;
      border-radius: 16px;
      border: 1px dashed rgba(250, 204, 21, 0.5);
      background: rgba(250, 204, 21, 0.08);
    }
    .beta-switcher.active {
      display: flex;
    }
    .beta-switcher-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .beta-pill {
      color: #facc15;
    }
    .beta-note {
      color: #fde68a;
    }
    .beta-switcher-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .beta-switcher-buttons .btn {
      flex: 1;
      min-width: 140px;
      font-size: 11px;
    }
    .ceo-log-btn {
      width: 100%;
      margin-top: 8px;
      font-size: 12px;
      letter-spacing: 0.08em;
    }
    .review-btn {
      background: rgba(250, 204, 21, 0.12);
      border: 1px solid rgba(250, 204, 21, 0.5);
      color: #fef08a;
      font-size: 12px;
    }
    .review-stars {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin: 12px 0;
    }
    .review-star {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 1px solid rgba(250, 204, 21, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #fde68a;
      cursor: pointer;
      transition: background 0.15s ease;
    }
    .review-star.filled {
      background: radial-gradient(circle, rgba(250, 204, 21, 0.85), rgba(202, 138, 4, 0.7));
      color: #0f172a;
    }
    .review-list {
      max-height: 300px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .review-summary {
      font-size: 12px;
      color: #cbd5f5;
      margin-bottom: 8px;
    }
    .review-card {
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 12px;
      background: rgba(15, 23, 42, 0.85);
    }
    .review-card strong {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: #fef3c7;
    }
    .review-card span {
      font-size: 12px;
      color: #94a3b8;
    }
    .how-it-works {
      margin: 14px 0;
      padding: 14px;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(2, 6, 23, 0.85);
    }
    .how-it-works h4 {
      font-size: 13px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #a5f3fc;
      margin-bottom: 8px;
      text-align: center;
    }
    .how-it-works ol {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
      color: #e2e8f0;
    }
    .redeem-btn {
      background: rgba(34, 197, 94, 0.12);
      border: 1px solid rgba(34, 197, 94, 0.5);
      color: #bbf7d0;
      font-size: 13px;
      letter-spacing: 0.08em;
    }
    .redeem-btn:hover {
      background: rgba(34, 197, 94, 0.22);
    }
    .add-vouchers-btn {
      background: rgba(6, 182, 212, 0.12);
      border: 1px solid rgba(6, 182, 212, 0.45);
      color: #99f6e4;
      font-size: 13px;
      letter-spacing: 0.08em;
    }
    .perk-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .perk-option {
      flex: 1;
      min-width: calc(50% - 8px);
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(2, 6, 23, 0.9);
      padding: 10px;
      text-align: left;
      font-size: 12px;
      color: #e0f2fe;
      cursor: pointer;
      transition: border 0.15s ease, transform 0.15s ease;
    }
    .perk-option:hover {
      transform: translateY(-1px);
    }
    .perk-option.selected {
      border-color: rgba(34, 197, 94, 0.8);
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.4);
    }
    .perk-option.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .perk-label {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .perk-remaining {
      font-size: 11px;
      color: #93c5fd;
    }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.8);
      backdrop-filter: blur(2px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }
    .modal-backdrop.active {
      display: flex;
    }
    .modal-card {
      width: calc(100% - 28px);
      max-width: 420px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 18px;
      box-shadow: 0 0 30px rgba(0, 207, 255, 0.3);
    }
    .toggle-pill {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 6px;
    }
    .toggle-option {
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(4, 10, 24, 0.9);
      color: #cbd5f5;
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 11px;
      letter-spacing: 0.05em;
    }
    .toggle-option.active {
      border-color: rgba(14,165,233,0.8);
      color: #0ea5e9;
      box-shadow: 0 8px 20px rgba(14,165,233,0.28);
    }
    .pitch-card {
      text-align: center;
      max-width: 360px;
    }
    .pitch-card h3 {
      margin-bottom: 8px;
    }
    .pitch-card p {
      font-size: 13px;
      color: #cbd5f5;
      margin-bottom: 14px;
    }
    .pitch-meter {
      font-size: 11px;
      letter-spacing: 0.18em;
      color: #67e8f9;
      margin-bottom: 8px;
      text-transform: uppercase;
    }
    .pitch-actions {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-top: 12px;
    }
    .receipt-overlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.82);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
      padding: 20px;
    }
    .receipt-overlay.active {
      display: flex;
    }
    .receipt-card {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 18px;
      width: 100%;
      max-width: 360px;
      color: #f8fafc;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.35);
    }
    .receipt-card h4 {
      margin-bottom: 6px;
      font-size: 16px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .receipt-card ul {
      list-style: none;
      margin: 12px 0;
      padding: 0;
      border-top: 1px solid rgba(148, 163, 184, 0.25);
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
    }
    .receipt-card li {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 13px;
    }
    .receipt-card button {
      margin-top: 12px;
      width: 100%;
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .modal-title {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .modal-close {
      background: none;
      border: none;
      color: #f472b6;
      font-weight: 600;
      cursor: pointer;
    }
    .modal-field {
      margin-bottom: 14px;
    }
    .modal-field label {
      display: block;
      font-size: 12px;
      margin-bottom: 6px;
      color: #9ca3af;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .modal-field select {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.85);
      color: #f9fafb;
      font-size: 13px;
    }
    .credit-info {
      font-size: 13px;
      color: #fbbf24;
      margin-bottom: 14px;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    .modal-actions .btn-secondary {
      width: auto;
      padding: 8px 16px;
      font-size: 11px;
    }
    .redeem-success {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
      background: radial-gradient(circle at top, rgba(1, 8, 24, 0.86), rgba(0, 0, 0, 0.85));
      backdrop-filter: blur(8px);
      padding: 24px;
    }
    .redeem-success.active {
      display: flex;
    }
    .success-card {
      width: calc(100% - 48px);
      max-width: 440px;
      border-radius: 32px;
      padding: 32px 28px 26px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      align-items: center;
      background: linear-gradient(145deg, rgba(6, 12, 28, 0.98), rgba(4, 16, 36, 0.95));
      border: 1px solid rgba(56, 189, 248, 0.35);
      box-shadow:
        0 0 45px rgba(34, 211, 238, 0.45),
        0 0 85px rgba(236, 72, 153, 0.4);
      position: relative;
      overflow: hidden;
    }
    .success-card > *:not(.confetti-layer) {
      position: relative;
      z-index: 1;
    }
    .confetti-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      border-radius: 32px;
      z-index: 0;
    }
    .confetti-piece {
      position: absolute;
      width: 6px;
      height: 14px;
      border-radius: 2px;
      opacity: 0.9;
      animation: confettiFall 1.8s ease-in forwards;
    }
    @keyframes confettiFall {
      0% {
        transform: translateY(-20px) rotate(0deg);
        opacity: 1;
      }
      70% {
        opacity: 1;
      }
      100% {
        transform: translateY(140px) rotate(360deg);
        opacity: 0;
      }
    }
    .qr-display {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 120px;
      height: 120px;
      border-radius: 28px;
      padding: 18px;
      background: radial-gradient(circle at 30% 30%, rgba(34, 211, 238, 0.18), transparent 60%), rgba(8, 12, 28, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: inset 0 0 30px rgba(59, 130, 246, 0.3);
    }
    .qr-logo-shell {
      width: 100%;
      height: 100%;
      border-radius: 24px;
      background: repeating-linear-gradient(135deg, rgba(3, 9, 20, 0.85) 0, rgba(3, 9, 20, 0.85) 16px, rgba(7, 16, 36, 0.85) 16px, rgba(7, 16, 36, 0.85) 32px);
      border: 1px solid rgba(59, 130, 246, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      box-shadow: 0 0 20px rgba(34, 211, 238, 0.4);
    }
    .qr-logo-shell::after {
      content: "";
      position: absolute;
      inset: 12px;
      border: 1px dashed rgba(148, 163, 184, 0.25);
      border-radius: 18px;
    }
    .qr-logo {
      width: 80px;
      height: auto;
      filter: drop-shadow(0 0 12px rgba(34, 211, 238, 0.75));
    }
    .success-copy {
      flex: 1;
      text-align: center;
      color: #d6e0ff;
    }
    .success-title {
      font-size: 15px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: #fdf4ff;
      margin-bottom: 6px;
    }
    .success-detail {
      font-size: 13px;
      color: #cbd5f5;
      line-height: 1.5;
    }

    /* Venues */
    .venues-btn {
      background: rgba(59, 130, 246, 0.15);
      border: 1px solid rgba(59, 130, 246, 0.5);
      color: #bfdbfe;
      font-size: 13px;
      margin-bottom: 8px;
    }
    #venuesScreen {
      position: relative;
      max-width: 540px;
      margin: 0 auto;
    }
    #venuesScreen.screen.active {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #venuesScreen .app-title,
    #venuesScreen .tagline {
      text-align: center;
    }
    .venues-card {
      margin: 14px auto 0;
      width: 100%;
      background: rgba(2, 6, 23, 0.8);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 18px;
      box-shadow: 0 0 30px rgba(0, 207, 255, 0.2);
    }
    .featured-venues h4 {
      font-size: 13px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #fef3c7;
      margin-bottom: 10px;
      text-align: center;
    }
    .featured-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
      margin-bottom: 16px;
    }

    /* Night Wheel */
    .night-wheel {
      margin: 14px 0;
      padding: 14px;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: radial-gradient(circle at 20% 10%, rgba(34, 211, 238, 0.18), transparent 55%), rgba(2, 6, 23, 0.92);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
    }
    .night-wheel h4 {
      margin: 0 0 6px;
      font-size: 14px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #a5f3fc;
    }
    .night-wheel p {
      margin: 0 0 10px;
      color: #cbd5f5;
      font-size: 12px;
    }
    .night-wheel-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .night-wheel-result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.3);
      color: #e2e8f0;
      font-size: 12px;
      line-height: 1.45;
    }
    .vibe-menu {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }
    .vibe-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .vibe-btn {
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.85);
      color: #e2e8f0;
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 11px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, border 0.15s ease;
      box-shadow: 0 0 10px rgba(34, 211, 238, 0.18);
    }
    .vibe-btn:hover {
      transform: translateY(-1px);
    }
    .vibe-btn.active {
      border-color: rgba(34, 211, 238, 0.7);
      box-shadow: 0 0 14px rgba(34, 211, 238, 0.35);
      color: #0b1222;
      background: linear-gradient(120deg, rgba(34, 211, 238, 0.85), rgba(244, 114, 182, 0.35));
    }
    .vibe-flirty { background: linear-gradient(120deg, rgba(244, 114, 182, 0.22), rgba(139, 92, 246, 0.2)); border-color: rgba(244, 114, 182, 0.45); }
    .vibe-blacking { background: linear-gradient(120deg, rgba(15, 23, 42, 0.8), rgba(124, 58, 237, 0.25)); border-color: rgba(124, 58, 237, 0.4); color: #c7d2fe; }
    .vibe-social { background: linear-gradient(120deg, rgba(34, 211, 238, 0.2), rgba(34, 197, 94, 0.18)); border-color: rgba(34, 211, 238, 0.45); }
    .vibe-casual { background: linear-gradient(120deg, rgba(251, 191, 36, 0.2), rgba(56, 189, 248, 0.16)); border-color: rgba(251, 191, 36, 0.4); color: #fef9c3; }
    .featured-card {
      padding: 14px;
      border-radius: 18px;
      background: radial-gradient(circle at 20% 20%, rgba(250, 204, 21, 0.35), transparent 60%), rgba(8, 12, 26, 0.95);
      border: 1px solid rgba(250, 204, 21, 0.4);
      text-align: left;
      position: relative;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .featured-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 18px 35px rgba(250, 204, 21, 0.35);
    }
    .featured-card strong {
      display: block;
      font-size: 14px;
      color: #fef9c3;
    }
    .featured-card span {
      font-size: 12px;
      color: #e2e8f0;
    }
    .featured-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(6, 182, 212, 0.2);
      color: #a5f3fc;
      font-size: 10px;
      letter-spacing: 0.1em;
      margin-bottom: 6px;
    }
    .venues-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .venues-category {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 18px;
      padding: 14px;
      border: 1px solid rgba(148, 163, 184, 0.25);
    }
    .venues-category h4 {
      font-size: 13px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #a5f3fc;
      margin-bottom: 10px;
      text-align: center;
    }
    .venues-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
    }
    .venue-btn {
      width: 100%;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.85);
      color: #e2e8f0;
      font-size: 13px;
      text-align: left;
      cursor: pointer;
      transition: border 0.15s ease, transform 0.15s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .venue-btn:hover {
      transform: translateY(-1px);
      border-color: rgba(59, 130, 246, 0.6);
    }
    .venue-btn.active {
      border-color: rgba(34, 197, 94, 0.8);
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.4);
    }
    .venue-detail {
      margin-top: 16px;
      padding: 16px;
      border-radius: 18px;
      background: rgba(2, 6, 23, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }
    .venue-detail h5 {
      margin-bottom: 6px;
      font-size: 15px;
      color: #f0abfc;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .venue-detail p {
      margin: 4px 0;
      font-size: 13px;
      color: #e2e8f0;
    }
    .venue-detail span {
      display: block;
      font-size: 12px;
      color: #94a3b8;
    }
    .venue-detail-overlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.8);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
      padding: 20px;
    }
    .venue-detail-overlay.active {
      display: flex;
    }
    .staff-gate-overlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.88);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 60;
      padding: 20px;
    }
    .staff-gate-overlay.active {
      display: flex;
    }
    .app-lock-overlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.9);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 80;
      padding: 20px;
    }
    .app-lock-overlay.active {
      display: flex;
    }
    .app-lock-card {
      width: 100%;
      max-width: 420px;
      border-radius: 22px;
      background: rgba(15, 23, 42, 0.97);
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 0 32px rgba(15, 23, 42, 0.65);
      padding: 22px;
      text-align: center;
    }
    .app-lock-card h4 {
      margin: 0 0 8px;
      font-size: 16px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #f97316;
    }
    .app-lock-card p {
      margin: 0 0 16px;
      color: #cbd5f5;
      font-size: 13px;
    }
    .staff-gate-card {
      width: 100%;
      max-width: 420px;
      border-radius: 22px;
      background: rgba(15, 23, 42, 0.97);
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 0 30px rgba(45, 212, 191, 0.25);
      padding: 20px;
    }
    .staff-gate-card h4 {
      margin: 0 0 6px;
      font-size: 16px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #67e8f9;
    }
    .staff-gate-card p {
      margin: 0 0 12px;
      color: #cbd5f5;
      font-size: 13px;
    }
    .venue-detail-card {
      width: 100%;
      max-width: 420px;
      border-radius: 24px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 0 30px rgba(0, 207, 255, 0.3);
      padding: 20px;
      position: relative;
    }
    .venue-detail-card h5 {
      font-size: 18px;
      margin-bottom: 8px;
      color: #f0abfc;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .venue-detail-card p {
      font-size: 14px;
      margin: 6px 0;
    }
    .venue-detail-card span {
      font-size: 12px;
      color: #94a3b8;
    }
    .venue-rating-pill {
      padding: 2px 8px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: #fcd34d;
      font-weight: 700;
      font-size: 11px;
      box-shadow: 0 0 10px rgba(250, 204, 21, 0.25);
    }
    .venue-rating-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .venue-stars {
      display: inline-flex;
      gap: 4px;
    }
    .venue-stars button {
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.85);
      color: #fcd34d;
      border-radius: 6px;
      width: 32px;
      height: 28px;
      font-size: 14px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, border 0.15s ease;
    }
    .venue-stars button:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 12px rgba(250, 204, 21, 0.35);
      border-color: rgba(250, 204, 21, 0.7);
    }
    .venue-detail-close {
      position: absolute;
      top: 10px;
      right: 12px;
      border: none;
      background: none;
      color: #f472b6;
      font-size: 18px;
      cursor: pointer;
    }
    @media screen and (max-width: 520px) {
      body {
        align-items: flex-start;
        padding: 10px;
      }
      #app {
        max-width: 100%;
        padding: 4px 6px 18px;
      }
      .screen {
        border-radius: 18px;
        padding: 16px;
        margin-bottom: 14px;
      }
      .pass-card,
      .membership-card,
      .payment-card,
      .support-card,
      .venues-card {
        padding: 16px;
        border-radius: 18px;
      }
      .modal-card {
        width: calc(100% - 20px);
        max-width: 360px;
        margin: 0 auto;
      }
      .perk-grid {
        flex-direction: column;
      }
      .perk-option {
        min-width: 100%;
      }
      .beta-switcher-buttons {
        flex-direction: column;
      }
      .beta-switcher-buttons .btn {
        min-width: 100%;
      }
      .app-title {
        font-size: 20px;
      }
      .tagline {
        font-size: 12px;
      }
      .user-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .venues-card {
        margin: 10px auto 0;
      }
      .venue-detail-card {
        max-width: 90%;
      }
    }
    .back-btn {
      width: auto;
      padding: 8px 18px;
      font-size: 11px;
      margin-top: 10px;
    }
    .support-btn {
      background: rgba(248, 113, 113, 0.1);
      border: 1px solid rgba(248, 113, 113, 0.5);
      color: #fecaca;
      font-size: 13px;
    }
    .support-card {
      margin-top: 14px;
      background: rgba(15, 23, 42, 0.92);
      border-radius: 20px;
      border: 1px solid rgba(248, 113, 113, 0.4);
      padding: 18px;
      box-shadow: 0 0 25px rgba(248, 113, 113, 0.25);
      width: 100%;
      max-width: 520px;
      margin-left: auto;
      margin-right: auto;
    }
    .confirm-card {
      margin-top: 14px;
      background: rgba(15, 23, 42, 0.92);
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 18px;
      box-shadow: 0 0 18px rgba(6, 182, 212, 0.25);
    }
    .support-form .field textarea {
      min-height: 160px;
      resize: vertical;
      background: rgba(2, 6, 23, 0.85);
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: #f9fafb;
      padding: 12px;
      font-size: 13px;
      box-shadow: inset 0 0 12px rgba(8, 145, 178, 0.2);
    }
    .support-success {
      display: none;
      margin-top: 12px;
      padding: 11px 16px;
      border-radius: 18px;
      background: linear-gradient(120deg, rgba(14, 165, 233, 0.9), rgba(45, 212, 191, 0.9));
      color: #04121f;
      font-weight: 600;
      text-align: center;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      box-shadow: 0 0 16px rgba(14, 165, 233, 0.35);
    }
    .support-success.visible {
      display: block;
      animation: glowPulse 3s ease-in-out infinite;
    }
    #supportScreen.screen.active {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    .ceo-card {
      margin-top: 16px;
      background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(15,23,42,0.8));
      border-radius: 28px;
      padding: 20px;
      border: 1px solid rgba(250, 204, 21, 0.5);
      box-shadow: 0 0 40px rgba(250, 204, 21, 0.25);
      color: #fef9c3;
    }
    .ceo-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin: 12px 0 18px;
    }
    .ceo-metric-card {
      padding: 10px;
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.3);
      text-align: center;
    }
    .ceo-metric-card strong {
      display: block;
      font-size: 20px;
      color: #fef3c7;
    }
    .ceo-metric-card span {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #e0e7ff;
    }
    .ceo-card h3 {
      font-size: 22px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      margin-bottom: 10px;
    }
    .ceo-card p {
      font-size: 14px;
      color: #e0e7ff;
      margin-bottom: 12px;
    }
    .ceo-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 16px;
    }
    .ceo-logs {
      margin-top: 16px;
      border-top: 1px solid rgba(148,163,184,0.35);
      padding-top: 12px;
      max-height: 220px;
      overflow-y: auto;
    }
    .ceo-log-row {
      padding: 10px;
      border-radius: 14px;
      background: rgba(15,23,42,0.6);
      margin-bottom: 8px;
      border: 1px solid rgba(148,163,184,0.3);
      font-size: 12px;
    }
    .staff-form {
      margin-top: 16px;
      background: rgba(8, 13, 24, 0.94);
      border-radius: 20px;
      border: 1px solid var(--staff-border);
      padding: 18px;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4);
    }
    .staff-more {
      margin-top: 12px;
      border-radius: 16px;
      border: 1px solid var(--staff-border);
      background: rgba(8, 13, 24, 0.92);
      overflow: hidden;
      box-shadow: 0 12px 22px rgba(0,0,0,0.4);
    }
    .staff-more summary {
      cursor: pointer;
      padding: 12px 14px;
      color: #e2e8f0;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(12, 18, 32, 0.9);
      border-bottom: 1px solid rgba(148,163,184,0.3);
      justify-content: center;
      letter-spacing: 0.02em;
    }
    .staff-more summary::-webkit-details-marker { display: none; }
    .staff-more[open] summary {
      border-bottom: 1px solid rgba(148,163,184,0.3);
    }
    .staff-more .more-body {
      padding: 12px 14px 14px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .staff-radar {
      margin: 14px 0 6px;
      padding: 14px;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(8, 13, 24, 0.96), rgba(8, 12, 24, 0.9));
      border: 1px solid var(--staff-border);
      box-shadow: 0 14px 26px rgba(0, 0, 0, 0.45);
      overflow: hidden;
      --radar-hue: 185;
      --radar-sweep-opacity: 0.55;
      --radar-grid-opacity: 0.22;
      --radar-ping-glow: 0.45;
    }
    .staff-radar .radar-display {
      position: relative;
      height: 220px;
      border-radius: 14px;
      background: radial-gradient(circle at 50% 50%, rgba(103, 232, 249, 0.1), rgba(5, 10, 22, 0.95));
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 12px 26px rgba(0,0,0,0.4), inset 0 0 18px rgba(34,211,238,0.16);
    }
    .radar-graffiti {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      font-size: 30px;
      font-weight: 900;
      letter-spacing: 0.08em;
      color: rgba(255,255,255,0.75);
      text-shadow: 0 0 8px rgba(34,211,238,0.35);
      filter: drop-shadow(0 0 8px rgba(34,211,238,0.25));
      animation: graffitiGlow 4.2s ease-in-out infinite;
    }
    @keyframes graffitiGlow {
      0% { transform: scale(1) rotate(-1deg); opacity: 0.88; }
      50% { transform: scale(1.02) rotate(1deg); opacity: 1; text-shadow: 0 0 14px rgba(34,211,238,0.5); }
      100% { transform: scale(1) rotate(-1deg); opacity: 0.9; }
    }
    .radar-grid {
      position: absolute;
      inset: 0;
      background-image:
        radial-gradient(circle at 50% 50%, rgba(103, 232, 249, 0.25) 0, rgba(103, 232, 249, 0.25) 1px, transparent 1px),
        radial-gradient(circle at 50% 50%, rgba(103, 232, 249, 0.16) 0, rgba(103, 232, 249, 0.16) 1px, transparent 1px);
      background-size: 60px 60px, 120px 120px;
      opacity: 0.3;
    }
    .radar-sweep {
      position: absolute;
      inset: -60%;
      background: conic-gradient(
        from 90deg,
        hsla(var(--radar-hue, 185), 95%, 70%, var(--radar-sweep-opacity, 0.35)),
        rgba(103, 232, 249, 0) 45%
      );
      animation: radarSweep 6s linear infinite;
      filter: blur(6px) drop-shadow(0 0 12px rgba(34,211,238,0.35));
      opacity: var(--radar-sweep-opacity, 0.8);
      mix-blend-mode: screen;
    }
    .radar-pings span {
      position: absolute;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 1px solid hsla(var(--radar-hue, 185), 90%, 70%, 0.95);
      box-shadow: 0 0 12px hsla(var(--radar-hue, 185), 90%, 70%, var(--radar-ping-glow, 0.65));
      animation: ping 2.6s ease-out infinite;
    }
    .staff-radar .radar-copy {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .radar-title {
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-size: 12px;
      color: var(--staff-text);
      text-shadow: 0 0 12px var(--staff-glow);
    }
    .radar-mood {
      color: var(--staff-muted);
      font-size: 13px;
    }
    .radar-count {
      color: var(--staff-text);
      font-weight: 700;
      font-size: 14px;
      text-shadow: 0 0 12px var(--staff-glow);
    }
    .radar-list {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      min-height: 22px;
    }
    .radar-chip {
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(103, 232, 249, 0.28);
      color: #e2e8f0;
      font-size: 12px;
      letter-spacing: 0.04em;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.45);
    }
    .radar-chip strong {
      color: #a5f3fc;
      margin-right: 6px;
    }
    .radar-empty {
      color: #94a3b8;
      font-size: 12px;
    }
    .staff-footnote {
      margin-top: 18px;
      text-align: center;
      font-size: 11px;
      letter-spacing: 0.06em;
      color: rgba(203, 213, 225, 0.8);
      text-transform: uppercase;
    }
    @keyframes radarSweep {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    @keyframes ping {
      0% { transform: scale(0.6); opacity: 1; }
      80% { transform: scale(3); opacity: 0; }
      100% { transform: scale(3.2); opacity: 0; }
    }
    .staff-ticker {
      margin-top: 14px;
      border: 1px solid var(--staff-border);
      border-radius: 18px;
      padding: 12px 14px;
      background: rgba(8, 13, 24, 0.92);
      box-shadow: 0 12px 22px rgba(0,0,0,0.4);
    }
    .staff-ticker-header {
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.2em;
      color: #67e8f9;
      margin-bottom: 8px;
    }
    .staff-ticker-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .staff-ticker-list li {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      font-size: 12px;
      color: #cbd5f5;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      padding-bottom: 6px;
    }
    .staff-ticker-list li:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }
    .staff-ticker-list .time {
      font-size: 11px;
      color: #94a3b8;
      white-space: nowrap;
    }
    .staff-ticker-list .empty {
      justify-content: center;
      color: #94a3b8;
      border-bottom: none;
    }
    .vip-deal-card {
      margin-top: 14px;
      padding: 14px;
      border-radius: 18px;
      border: 1px solid var(--staff-border);
      background: rgba(8, 13, 24, 0.94);
      box-shadow: 0 12px 24px rgba(0,0,0,0.4);
    }
    .vip-deal-card textarea {
      width: 100%;
      min-height: 70px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 8px;
      background: rgba(2, 6, 23, 0.85);
      color: #f9fafb;
      resize: vertical;
    }
    .vip-deal-preview {
      margin-top: 10px;
      font-size: 12px;
      color: #94a3b8;
      border-top: 1px solid rgba(148, 163, 184, 0.25);
      padding-top: 8px;
    }
    .staff-msg-unread {
      border-color: var(--staff-border-strong) !important;
      box-shadow: 0 0 16px var(--staff-glow);
    }
    .staff-log {
      margin-top: 12px;
      max-height: 260px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .staff-filter {
      font-size: 12px;
      color: #94a3b8;
      margin-bottom: 8px;
    }
    .tier-modal {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 16px;
      backdrop-filter: blur(2px);
    }
    .onboarding-overlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.85);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
      padding: 20px;
    }
    .onboarding-overlay.active {
      display: flex;
    }
    .onboarding-card {
      background: linear-gradient(145deg, rgba(8, 47, 73, 0.95), rgba(15, 23, 42, 0.95));
      border-radius: 24px;
      padding: 18px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      width: 100%;
      max-width: 360px;
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.35);
      text-align: center;
    }
    .onboarding-card h3 {
      font-size: 18px;
      margin-bottom: 8px;
    }
    .onboarding-card p {
      font-size: 13px;
      color: #cbd5f5;
      margin-bottom: 14px;
    }
    .onboarding-steps {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #67e8f9;
      margin-bottom: 10px;
      display: block;
    }

    .tier-modal.active {
      display: flex;
    }
    .tier-card {
      width: 100%;
      max-width: 400px;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 22px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 20px;
      text-align: center;
      box-shadow: 0 0 30px rgba(0, 207, 255, 0.25);
    }
    .tier-card h4 {
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin-bottom: 10px;
    }
    .tier-card p {
      font-size: 13px;
      color: #94a3b8;
      margin-bottom: 14px;
    }
    .log-row {
      padding: 10px;
      border-radius: 14px;
      background: rgba(2, 6, 23, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.3);
      font-size: 12px;
    }
    .log-row strong {
      display: block;
      font-size: 13px;
      color: #f0abfc;
    }
    .log-meta {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      color: #94a3b8;
    }
    .status-pill-sm {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .status-pill-sm.pending {
      background: rgba(250, 204, 21, 0.15);
      color: #fde68a;
    }
    .status-pill-sm.verified {
      background: rgba(34, 197, 94, 0.18);
      color: #bbf7d0;
    }
    .analytics-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .analytics-section {
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 16px;
      padding: 12px;
      background: rgba(15, 23, 42, 0.85);
    }
    .analytics-section h5 {
      margin-bottom: 6px;
      font-size: 13px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #a5f3fc;
    }
    .analytics-section ul {
      margin: 0;
      padding-left: 16px;
      color: #e2e8f0;
      font-size: 13px;
      line-height: 1.5;
    }
  </style>
</head>
  <body>
      <div id="app">
        <!-- LANDING SCREEN -->
        <div id="landingScreen" class="screen active">
          <div class="landing-bg">
            <img id="landingSlide" src="assets/landing.jpg" alt="FoCo nightlife" loading="eager" />
            <div class="landing-stars" aria-hidden="true">
              <span class="landing-asterism a1"></span>
              <span class="landing-asterism a2"></span>
              <span class="landing-asterism a3"></span>
            </div>
            <img src="foco-logo.png" alt="FoCo After Dark logo" class="landing-logo-overlay" style="position:absolute;inset:0;object-fit:contain;opacity:0.18;mix-blend-mode:screen;pointer-events:none;filter:drop-shadow(0 0 18px rgba(34,211,238,0.5));" />
            <div class="landing-orbs" aria-hidden="true">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
          <div class="landing-wrapper">
            <div class="landing-strobe" aria-hidden="true"></div>
        <div class="brand-logo brand-logo-landing" style="position:relative;">
          <img src="foco-logo.png" alt="FoCo After Dark neon logo" class="brand-logo-img" />
          <button id="landingRefreshBtn" class="refresh-btn" title="Refresh" style="position:absolute;top:-8px;right:-8px;">âŸ³</button>
        </div>
          <div class="app-title"><span>FoCo</span> After Dark 21+</div>
          <div class="tagline" id="landingTagline">
            Nightlife, gamified. Unlock perks, flash your pass, and collect rewards while you move through the city.
          </div>
          <div class="landing-live-count">
            <span>Current users</span>
            <strong id="currentUsersCount">0</strong>
          </div>
      <div class="hero-highlight hero-animated">
        <div class="hero-point neon-card">
          <div class="hero-point-icon pulse">1</div>
          <div>
            <strong>Pulse of Old Town</strong>
            <p>Glowing floors, packed dance rooms, and VIP lanes at Fort Collinsâ€™ hotspots.</p>
          </div>
        </div>
        <div class="hero-point neon-card">
          <div class="hero-point-icon pulse">2</div>
          <div>
            <strong>Monthly venue perks</strong>
            <p>Venues set the perks each month. Choose where youâ€™re at, redeem instantly, and keep the line moving.</p>
          </div>
        </div>
        <div class="hero-point neon-card">
          <div class="hero-point-icon pulse">3</div>
          <div>
            <strong>Built with venues</strong>
            <p>Live analytics for bars, verified scans for staff, and premium offers for members.</p>
          </div>
        </div>
      </div>
      <button id="landingGetPassBtn" class="btn btn-primary">
        Get the Nightlife Pass Â· 21+
      </button>
      <button id="addToHomeBtn" class="btn btn-primary cta-shimmer" style="margin-top:18px;margin-bottom:18px;background:linear-gradient(120deg,#22d3ee,#f472b6);color:#0b1222;font-weight:800;letter-spacing:0.06em;box-shadow:0 12px 32px rgba(34,211,238,0.35),0 0 28px rgba(244,114,182,0.35);border:none;">
        Add to Home Screen
      </button>
      <p class="small" style="margin-top:14px;">
        Already a member?
        <span id="landingLoginLink" class="linkish">Log in</span>
      </p>
      <p class="small" style="margin-top:12px;margin-bottom:4px;">
        Venue portal?
        <button id="landingStaffLogin" class="linkish linkish-btn" type="button">Log in as venue staff</button>
      </p>
      <div class="insta-cta-wrap">
        <div class="insta-cta">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <rect x="3" y="3" width="18" height="18" rx="5" ry="5" stroke="url(#igGradient)" stroke-width="1.6" fill="rgba(15,23,42,0.35)"/>
            <defs>
              <linearGradient id="igGradient" x1="3" y1="3" x2="21" y2="21" gradientUnits="userSpaceOnUse">
                <stop stop-color="#22d3ee"/><stop offset="1" stop-color="#ec4899"/>
              </linearGradient>
            </defs>
            <circle cx="12" cy="12" r="4.2" stroke="url(#igGradient)" stroke-width="1.6"/>
            <circle cx="17" cy="7" r="1.2" fill="#22d3ee"/>
          </svg>
          <a href="https://www.instagram.com/focoafterdark/" target="_blank" rel="noopener">Add us on Instagram</a>
        </div>
      </div>
      </div>
    </div>

    <!-- AUTH SCREEN -->
  <div id="authScreen" class="screen">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:4px;">
        <div>
          <div class="app-title"><span>FoCo</span> After Dark</div>
          <div class="tagline" id="authModeText">Create your account to get the Nightlife Pass.</div>
        </div>
      </div>

      <form id="authForm">
        <div class="field signup-only" id="firstNameField">
          <label for="firstName">First name</label>
          <input id="firstName" type="text" autocomplete="given-name" />
        </div>
        <div class="field signup-only" id="lastNameField">
          <label for="lastName">Last name</label>
          <input id="lastName" type="text" autocomplete="family-name" />
        </div>
        <div class="field signup-only" id="usernameField">
          <label for="username">Username (public)</label>
          <input id="username" type="text" autocomplete="nickname" placeholder="yourhandle" />
        </div>
        <div class="field">
        <label for="authEmail" id="authEmailLabel">Email</label>
        <input id="authEmail" type="text" required />
        </div>
        <div class="field">
          <label for="authPassword">Password</label>
          <input id="authPassword" type="password" required minlength="6" />
        </div>
        <div class="remember-row">
          <input type="checkbox" id="rememberMe" />
          <label for="rememberMe" style="cursor:pointer;">Remember me on this device</label>
        </div>
        <p class="small" style="text-align:left;margin:-2px 0 16px;">
          <span id="forgotPasswordLink" class="linkish" role="button" tabindex="0">Forgot your password?</span>
        </p>
        <div class="field signup-only" id="birthDateField">
          <label for="birthDate">Birthdate (21+ required)</label>
          <input id="birthDate" type="date" />
          <p class="small" style="margin-top:4px;text-align:left;">
            You must be 21 or older to activate a FoCo After Dark pass.
          </p>
        </div>
        <div class="field signup-only" id="genderField">
          <label for="genderSelect">Gender</label>
          <select id="genderSelect">
            <option value="" disabled selected>Select an option</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="prefer_not_say">Prefer not to say</option>
          </select>
        </div>
        <div class="error" id="authError"></div>
        <button type="submit" class="btn btn-primary" id="authSubmitBtn">
          Continue
        </button>
      </form>

      <div class="modal-backdrop" id="signupConfirmModal">
        <div class="modal-card">
          <div class="modal-title">Confirm your details</div>
          <p style="font-size:13px;color:#e2e8f0;line-height:1.4;">
            By continuing, you confirm that all information you provide is accurate and truthful. You certify that you are 21 years of age or older, and you understand that a matching ID is required by the venue. Providing false information may result in account removal.
          </p>
          <div class="modal-actions" style="margin-top:12px;">
            <button type="button" class="btn btn-secondary" id="signupBackBtn">Back</button>
            <button type="button" class="btn btn-primary" id="signupConfirmBtn">Confirm</button>
          </div>
        </div>
      </div>

      <div class="modal-backdrop" id="forgotPasswordModal">
        <div class="modal-card">
          <div class="modal-title">Reset your password</div>
          <p style="font-size:13px;color:#e2e8f0;">Enter the email you used to sign up. We'll send you a reset link.</p>
          <form id="forgotPasswordForm" class="support-form" style="margin-top:10px;">
            <div class="field">
              <label for="forgotPasswordEmail">Email</label>
              <input id="forgotPasswordEmail" type="email" placeholder="you@email.com" required />
            </div>
            <div class="payment-actions" style="margin-top:12px;">
              <button type="submit" class="btn btn-primary">Send reset email</button>
              <button type="button" class="btn btn-secondary" id="forgotPasswordCancel">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <div class="modal-backdrop" id="resetPasswordModal">
        <div class="modal-card" style="max-width:360px;margin:20vh auto;">
          <div class="modal-title">Reset your password</div>
          <p id="resetPasswordEmail" style="font-size:13px;color:#94a3b8;margin-bottom:12px;"></p>
          <form id="resetPasswordForm">
            <div class="field">
              <label for="resetPasswordInput">New password</label>
              <input id="resetPasswordInput" type="password" minlength="6" placeholder="Enter a new password" required />
            </div>
            <div class="error" id="resetPasswordError"></div>
            <div class="payment-actions" style="margin-top:14px;">
              <button type="submit" class="btn btn-primary">Save password</button>
              <button type="button" class="btn btn-secondary" id="resetPasswordCancel">Cancel</button>
            </div>
          </form>
          <div id="resetPasswordSuccess" class="support-success" style="margin-top:16px;display:none;">
            Password updated. You can log in with your new password.
            <button type="button" class="btn btn-primary" id="resetPasswordReturn" style="margin-top:10px;width:100%;">Return to login</button>
          </div>
        </div>
      </div>

      <p class="small" id="authToggleText">
        Already have an account?
        <span id="authToggleLink" class="linkish">Log in instead</span>
      </p>
      <p class="small">
        Youâ€™ll get a digital Nightlife Pass you can show at bars to unlock perks.
      </p>
      <p class="small">
        <span id="skipLoginBeta" class="linkish">Skip login (beta version)</span>
      </p>
      <button type="button" class="btn btn-secondary back-btn" id="authBackBtn" style="margin-top:8px;display:block;margin-left:auto;margin-right:auto;max-width:240px;">
        Back to start
      </button>
    </div>

    <!-- MEMBERSHIP SELECTION SCREEN -->
    <div id="membershipScreen" class="screen">
      <div class="app-title"><span>Choose</span> Your Membership</div>
      <div class="tagline">
        Pick the pass that matches your nightlife energy.
      </div>
      <div class="brand-logo">
        <img src="foco-logo.png" alt="FoCo After Dark neon logo" class="brand-logo-img small" />
      </div>
      <div class="payment-actions" style="margin-bottom:18px;">
        <button type="button" class="btn btn-secondary back-btn" id="membershipBackBtn">
          Back to start
        </button>
      </div>

      <div class="membership-card" id="standardOption">
        <div class="membership-title">STANDARD</div>
        <div class="membership-price">$5.00 / month</div>
        <ul class="membership-perks">
          <li>Monthly perks set by venues</li>
          <li>Up to 5 monthly voucher redemptions</li>
          <li>Perks refresh on your billing date</li>
        </ul>
        <button class="btn btn-primary select-membership" data-tier="standard">
          Choose Standard
        </button>
      </div>

      <div class="membership-card" id="vipOption">
      <div class="membership-title vip">VIP</div>
      <div class="membership-price">$10.00 / month</div>
        <ul class="membership-perks">
          <li>Up to 10 monthly voucher redemptions</li>
          <li>VIP-only drops & alerts</li>
          <li>Perks refresh on your billing date</li>
        </ul>
        <button class="btn btn-primary select-membership" data-tier="vip">
          Choose VIP
        </button>
      </div>
    </div>

    <!-- PAYMENT SCREEN -->
    <div id="paymentScreen" class="screen">
      <div class="app-title"><span>Confirm</span> Your Membership</div>
      <div class="tagline">
        Add your billing details to activate the Nightlife Pass.
      </div>
      <div class="brand-logo brand-logo-payment">
        <img src="foco-logo.png" alt="FoCo After Dark neon logo" class="brand-logo-img small" />
      </div>

      <div class="payment-card">
        <div class="payment-summary">
          <div>Plan: <span id="paymentPlanLabel">Standard</span></div>
          <div id="paymentPlanPrice">$5.00 / month</div>
        </div>
        <div style="font-size:11px;color:#94a3b8;margin-bottom:6px;">Secured by Stripe</div>
        <div class="saved-card" id="paymentSavedCard" style="display:none;"></div>
        <form id="paymentForm">
          <div class="field">
            <label for="cardName">Name on card</label>
            <input id="cardName" type="text" autocomplete="cc-name" />
          </div>
          <div class="field">
            <label>Card & payment method</label>
            <div id="paymentElement"></div>
          </div>
          <div class="error" id="paymentError"></div>
          <div class="payment-actions">
            <button type="submit" class="btn btn-primary" id="paymentSubmit">Start Membership</button>
            <button type="button" class="btn btn-secondary" id="skipPaymentBtn">Skip for now (Beta)</button>
            <button type="button" class="btn btn-secondary" id="paymentBackBtn">Back</button>
          </div>
        </form>
        <p class="success-msg" id="paymentSuccess">Membership Active!</p>
      </div>
    </div>

    <!-- PASS SCREEN -->
      <div id="passScreen" class="screen">
        <div class="pass-top">
          <div class="nav-dropdown">
            <button type="button" class="nav-toggle" id="navMenuToggle">Menu â–¾</button>
            <div class="nav-menu" id="navMenu">
            <button class="nav-item" data-nav="rewards" id="navRewardsItem">Rewards</button>
            <button class="nav-item" data-nav="support">Need help? Contact support</button>
            <button class="nav-item" data-nav="review">Leave a review</button>
            <button class="nav-item" data-nav="about" id="navAboutItem">About</button>
              <button class="nav-item danger" data-nav="cancelMembership">Cancel membership</button>
              <div class="nav-accent">
                <div class="nav-accent-title">Accent</div>
                <div class="nav-accent-buttons">
                  <button type="button" class="accent-chip" data-accent="cyan">Neon blue</button>
                  <button type="button" class="accent-chip" data-accent="magenta">Magenta</button>
                  <button type="button" class="accent-chip" data-accent="gold">Gold</button>
                  <button type="button" class="accent-chip" data-accent="jade">Jade pulse</button>
                  <button type="button" class="accent-chip" data-accent="electric">Electric iris</button>
                  <button type="button" class="accent-chip" data-accent="ember">Ember bloom</button>
                  <button type="button" class="accent-chip ceo-only" data-accent="ceo">CEO</button>
                </div>
              </div>
              <!-- Background options removed -->
            <div class="achievements-block">
              <div class="nav-accent-title">Achievements <span id="achievementsNewPill" class="pill-new">New</span></div>
              <div id="achievementsList" aria-live="polite"></div>
            </div>
          </div>
        </div>
        <div class="spray-tag">Fort Collins</div>
        <div class="top-right-logout">
          <span class="user-mini" id="userMiniDisplay">@member</span>
          <span id="logoutLink" class="logout-link">Log out</span>
        </div>
      </div>
      <div class="hero-carousel" id="heroCarousel"></div>
        <div class="pass-card">
          <div class="pass-inner">
          <div class="pass-header">
            <div class="pass-brand">
              <img src="foco-logo.png" alt="FoCo After Dark neon logo" class="brand-logo-img small" />
              <div>
                <div class="app-title" style="font-size:16px;margin-bottom:2px;">
                  <span>FoCo</span> After Dark
                </div>
                <div class="tagline" style="font-size:11px;margin-bottom:0;color:#67e8f9;">
                  Good nights hit harder when youâ€™re earning while you party.
                </div>
              </div>
            </div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
              <button class="status-pill" id="statusPill" type="button" title="Tap to manage membership tier">
                Active Pass
              </button>
              <div id="membershipStatusDetail" style="font-size:11px;color:#94a3b8;max-width:160px;text-align:right;"></div>
            </div>
          </div>

          <!-- Quick strip -->
          <div class="meta-row" style="margin:10px 0;gap:10px;">
            <div class="meta-group" style="flex:1;">
              <div class="meta-label">Status</div>
              <div class="meta-value" id="quickStatus">Active</div>
            </div>
            <div class="meta-group" style="flex:1;">
              <div class="meta-label">Points</div>
              <div class="meta-value" id="quickPoints">0 pts</div>
            </div>
            <div class="meta-group" style="flex:1;">
              <div class="meta-label">Spins</div>
              <div class="meta-value" id="quickSpins">Spins left this month</div>
            </div>
          </div>

          <!-- Profile summary -->
          <div class="user-row">
            <div class="avatar" id="avatarInitials" title="Tap to change color and emoji"></div>
            <div>
              <div class="user-name" id="passUserName">FoCo Member</div>
              <div class="user-tier" id="passTierText">Nightlife Pass â€¢ Member</div>
              <div class="pass-id-row">
                <span class="pass-id-chip copyable" id="passIdTop" title="Tap to copy your Pass ID">Pass ID:</span>
              </div>

              <div class="username-row">
                <span class="username-chip" id="userUsername">@member</span>
                <button type="button" class="username-edit" id="editUsernameBtn" title="Edit username">
                  âœï¸
                </button>
              </div>
              <div class="user-tagline" id="userTagline" style="font-size:11px;color:#cbd5f5;cursor:pointer;">Tap to add your vibe.</div>
              <div class="badge-row" id="profileBadges" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:4px;"></div>
            </div>
          </div>

          <div class="meta-row">
            <div class="meta-group">
              <div class="meta-label">Member Since</div>
              <div class="meta-value" id="memberSinceText">Jan 1, 2024</div>
            </div>
            <div class="meta-group">
              <div class="meta-label">Valid Until</div>
              <div class="meta-value" id="expiryText">Dec 31, 2025</div>
            </div>
            <div class="meta-group">
              <div class="meta-label">Points</div>
              <div class="meta-value" id="pointsBalance">0</div>
            </div>
          </div>

          <div class="alerts-card">
            <h4>Tonightâ€™s alerts</h4>
            <ul id="alertsList">
              <li>
                <strong>Social Underground</strong>
                <span>Glow shot hour 11pm â€“ 12am</span>
                <span class="alerts-meta">VIP venues Â· Old Town</span>
              </li>
              <li>
                <strong>Pour Brothers Tavern</strong>
                <span>$3 cocktail upgrade for pass holders</span>
                <span class="alerts-meta">Craft pours Â· Linden St</span>
              </li>
            </ul>
          </div>
          <div class="vip-member-deal" id="vipMemberDeal"></div>

          <div class="pulse-band" id="pulseBand">
            <div class="pulse-content">
              <div class="pulse-head">
                <span class="pulse-chip">FoCo Pulse</span>
                <span class="pulse-id" id="pulsePassId" title="Tap to copy">PASS ID</span>
              </div>
              <div class="pulse-thread" id="pulseThread">
                <span></span><span></span><span></span><span></span><span></span><span></span>
                <span></span><span></span><span></span><span></span><span></span><span></span>
              </div>
              <div class="vibe-menu">
                <span class="pulse-strong" id="pulsePrimary">Pick your vibe</span>
                <div class="vibe-buttons">
                  <button type="button" class="vibe-btn vibe-flirty" data-vibe="flirty">Flirty</button>
                  <button type="button" class="vibe-btn vibe-blacking" data-vibe="blacking">Blacking Out</button>
                  <button type="button" class="vibe-btn vibe-social" data-vibe="social">Social</button>
                  <button type="button" class="vibe-btn vibe-casual" data-vibe="casual">Casual</button>
                </div>
              </div>
            </div>
          </div>
          <div class="ceo-pass-banner" id="ceoPassBanner">
            <div>
              <strong>CEO BLACK CARD</strong>
              <div style="font-size:12px;color:#e0e7ff;">Unlimited VIP access + free guest passes</div>
            </div>
            <button type="button" class="btn btn-secondary" id="ceoPortalShortcut" style="width:auto;padding:6px 12px;font-size:11px;">
              Manage
            </button>
          </div>

          <div class="redeem-row" style="display:flex;flex-direction:column;gap:8px;">
            <button type="button" class="btn redeem-btn" id="redeemTrigger">
              Redeem a perk
            </button>
          </div>
          <div class="secondary-actions" id="memberActionButtons">
            <button type="button" class="btn review-btn" id="rewardsTrigger">
              Rewards
            </button>
            <button type="button" class="btn btn-secondary" id="manageBillingBtn">
              Manage billing / card
            </button>
            <button type="button" class="btn support-btn" id="supportTrigger">
              Need help? Contact support
            </button>
            <button type="button" class="btn review-btn" id="leaveReviewBtn">
              Leave a review
            </button>
          </div>
          <div class="beta-switcher" id="ceoBetaSwitcher">
            <div class="beta-switcher-header">
              <span class="beta-pill">Beta test controls</span>
              <span class="beta-note" id="ceoPreviewLabel">Live CEO view</span>
            </div>
            <div class="beta-switcher-buttons">
              <button type="button" class="btn btn-secondary" id="ceoPreviewStandard">Preview Standard (beta)</button>
              <button type="button" class="btn btn-secondary" id="ceoPreviewVip">Preview VIP (beta)</button>
              <button type="button" class="btn btn-secondary" id="ceoPreviewReturn">Return to CEO (beta)</button>
            </div>
          </div>
          <div class="ceo-reset-card" id="ceoResetCard">
            <div style="flex:1;">
              <strong>Reset beta data</strong>
              <div class="meta-note">Choose what to wipe. CEO remains untouched. â€œAI smart selectâ€ applies a safe preset.</div>
              <div class="ceo-reset-grid" id="betaResetGrid">
                <label class="ceo-reset-toggle"><input type="checkbox" class="beta-reset-toggle" data-key="members" checked /> Stats & perks</label>
                <label class="ceo-reset-toggle"><input type="checkbox" class="beta-reset-toggle" data-key="redemptions" checked /> Redemptions log</label>
                <label class="ceo-reset-toggle"><input type="checkbox" class="beta-reset-toggle" data-key="alerts" checked /> Member alerts</label>
                <label class="ceo-reset-toggle"><input type="checkbox" class="beta-reset-toggle" data-key="vipDeals" checked /> VIP deals</label>
                <label class="ceo-reset-toggle"><input type="checkbox" class="beta-reset-toggle" data-key="closeouts" checked /> Close-out reports</label>
                <label class="ceo-reset-toggle"><input type="checkbox" class="beta-reset-toggle" data-key="freeMemberships" checked /> Free memberships</label>
                <label class="ceo-reset-toggle"><input type="checkbox" class="beta-reset-toggle" data-key="anonUsers" /> Beta logins (anonymous accounts)</label>
              </div>
              <div class="ceo-reset-actions">
                <span class="pill-ghost" id="betaResetSelectAll">Select all</span>
                <span class="pill-ghost" id="betaResetSmart">AI smart select</span>
              </div>
            </div>
            <button type="button" class="btn btn-danger" id="betaResetBtn">Reset</button>
          </div>
          <div class="ceo-reset-card" id="ceoChatCard" style="margin-top:10px;">
            <div class="ceo-chat-body" style="flex:1;">
              <strong>Ask HQ (AI)</strong>
              <div class="meta-note">CEO-only assistant. Ask product, ops, or rollout questions.</div>
              <div class="field" style="margin-top:2px;">
                <label for="ceoChatInput" style="font-size:12px;color:#cbd5f5;">Prompt</label>
                <textarea id="ceoChatInput" rows="4"></textarea>
              </div>
              <div class="ceo-reset-actions" style="margin-top:2px;">
                <span class="pill-ghost" id="ceoChatPresetRollout">Rollout steps</span>
                <span class="pill-ghost" id="ceoChatPresetIssues">Triage issues</span>
              </div>
              <div id="ceoChatHistory" style="max-height:200px;overflow:auto;font-size:12px;display:flex;flex-direction:column;gap:6px;"></div>
            </div>
            <button type="button" class="btn btn-primary" id="ceoChatSend">Send</button>
          </div>
          <div class="ceo-reset-card" id="ceoSystemHealthCard" style="margin-top:10px;display:none;">
            <div style="flex:1;">
              <strong>System status</strong>
              <div class="meta-note">Last nightly email and version health.</div>
              <div id="ceoSystemHealth" class="meta-note" style="margin-top:6px;font-size:12px;color:#cbd5f5;">Loadingâ€¦</div>
            </div>
          </div>
          <div class="ceo-reset-card" id="ceoLaunchCard" style="margin-top:10px;display:none;">
            <div style="flex:1;">
              <strong>Launch mode</strong>
              <div class="meta-note">Toggle beta vs. live experience for all users.</div>
              <div id="ceoLaunchStatus" class="meta-note" style="margin-top:6px;font-size:12px;color:#cbd5f5;">Loadingâ€¦</div>
            </div>
            <button type="button" class="btn btn-secondary" id="ceoLaunchToggle">Toggle</button>
          </div>
          <div class="ceo-reset-card" id="ceoAppLockCard" style="margin-top:10px;display:none;">
            <div style="flex:1;">
              <strong>App lock</strong>
              <div class="meta-note">Lock the app for everyone except the CEO.</div>
              <div id="ceoAppLockStatus" class="meta-note" style="margin-top:6px;font-size:12px;color:#cbd5f5;">Loadingâ€¦</div>
            </div>
            <button type="button" class="btn btn-danger" id="ceoAppLockToggle">Lock app</button>
          </div>
          <div class="ceo-reset-card" id="ceoMembersCard" style="margin-top:10px;display:none;">
            <div style="flex:1;">
              <strong>Member analytics</strong>
              <div class="meta-note">Active accounts by tier & gender. Pause access instantly.</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;margin:6px 0;">
                <span class="pill-ghost" data-ceo-filter="all">All</span>
                <span class="pill-ghost" data-ceo-filter="vip">VIP</span>
                <span class="pill-ghost" data-ceo-filter="paused">Paused</span>
                <span class="pill-ghost" data-ceo-filter="past_due">Past due</span>
              </div>
              <div id="ceoMembersTotals" class="meta-note" style="margin-top:6px;font-size:12px;color:#cbd5f5;"></div>
              <div id="ceoMembersList" style="margin-top:8px;display:flex;flex-direction:column;gap:8px;max-height:210px;overflow:auto;"></div>
            </div>
            <button type="button" class="btn btn-secondary" id="ceoMembersRefresh">Refresh</button>
          </div>
          <button type="button" class="btn btn-secondary ceo-log-btn" id="ceoRedemptionBtn">
            View live venue redemptions
          </button>
          <button type="button" class="btn btn-secondary ceo-log-btn" id="ceoReviewBtn">
            View reviews
          </button>
          <div class="pitch-toggle" id="ceoPitchToggle">
            <div>
              <strong>Pitch mode</strong>
              <div style="font-size:11px;color:#94a3b8;">Instant deck for venue walk-throughs.</div>
            </div>
            <button type="button" id="pitchModeBtn">Open deck</button>
          </div>

          <div class="how-it-works" id="howItWorks">
            <h4>How it works</h4>
            <ol>
              <li><strong>Share your Pass ID.</strong> Staff types the code.</li>
              <li><strong>Pick a venue perk.</strong> Choose what the bar is offering tonight.</li>
              <li><strong>Staff verifies.</strong> Once confirmed, your balance updates instantly.</li>
            </ol>
          </div>

          <div class="qr-wrapper">
            <div class="qr-image-shell">
              <img id="passQrImage" class="qr-image" alt="FoCo After Dark pass QR" />
            </div>
            <div class="qr-text">
              <strong>Show this at the bar.</strong>
              This digital pass proves youâ€™re a FoCo After Dark member. Bars can verify you in seconds.
            <span class="pass-code copyable" id="passCodeText" title="Tap to copy your Pass ID">Pass ID:</span>
            </div>
          </div>
          <div class="offline-indicator">
            <span class="offline-badge syncing" id="offlineBadge">Syncing</span>
            <span id="offlineCopy">QR cached for instant scans.</span>
          </div>
          <div class="community-stats" id="communityStats">
            <div class="community-stat">
              <span>Total redemptions</span>
              <strong id="statRedemptions">0</strong>
            </div>
            <div class="community-stat">
              <span>Venues visited</span>
              <strong id="statVenuesVisited">0</strong>
            </div>
            <div class="community-stat">
              <span>Average savings</span>
              <strong id="statAvgSavings">$0.00 avg</strong>
            </div>
            <div class="community-stat">
              <span>Vouchers left</span>
              <strong id="statVouchersLeft">0</strong>
            </div>
            <div class="community-stat">
              <span>Logins</span>
              <strong id="statLoginCount">0</strong>
            </div>
            <div class="community-stat">
              <span>Nights active</span>
              <strong id="statActiveDays">0</strong>
            </div>
          </div>
          <div class="meta-note" id="voucherBalanceNote"></div>
          <div class="featured-venues" id="passFeaturedVenues">
            <h4>Featured venues</h4>
            <div class="featured-grid" id="passFeaturedGrid"></div>
          </div>

          <div class="night-wheel card-hd no-tilt">
            <h4>Night Wheel</h4>
            <p>Spin for a bar, drink special, and a little challenge. Standard: 2 spins/month Â· VIP: 4 spins/month.</p>
            <div class="night-wheel-actions">
              <button type="button" class="btn btn-primary" id="nightWheelSpin">Spin the wheel</button>
              <span class="meta-label" id="nightWheelRemaining" style="color:#cbd5f5;">Spins left this month</span>
            </div>
            <div class="night-wheel-result" id="nightWheelResult">Ready when you are.</div>
          </div>

          <div class="divider"></div>
          <div class="perks-title">Included perks</div>
          <ul class="perks" id="perksList">
            <!-- Filled by JS -->
          </ul>

          <div class="city-tag">
            Fort Collins â€¢ After Dark
          </div>
          <div class="insta-cta-wrap">
            <div class="insta-cta insta-cta-small">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <rect x="3" y="3" width="18" height="18" rx="5" ry="5" stroke="url(#igGradient)" stroke-width="1.6" fill="rgba(15,23,42,0.35)"/>
                <circle cx="12" cy="12" r="4.2" stroke="url(#igGradient)" stroke-width="1.6"/>
                <circle cx="17" cy="7" r="1.2" fill="#22d3ee"/>
              </svg>
              <a href="https://www.instagram.com/focoafterdark/" target="_blank" rel="noopener">Tag us on Instagram</a>
            </div>
          </div>
        </div>
      </div>

      <div class="testimonial-bar" id="testimonialBar">
        <strong id="testimonialQuote">"Best nightlife pass."</strong>
        <span id="testimonialSource">â€“ Ava S., VIP member</span>
      </div>

      <div class="modal-backdrop" id="redeemModal">
        <div class="modal-card">
          <div class="modal-header">
            <div class="modal-title">Redeem a perk</div>
            <button class="modal-close" id="redeemClose" type="button">Close</button>
          </div>
          <div class="modal-field">
            <label>Choose perk</label>
            <div class="perk-grid" id="redemptionOptionsGrid"></div>
            <p class="credit-info small" id="redeemPerksHint" style="display:none;">Loading venue perks...</p>
          </div>
          <div class="modal-field">
            <label for="redeemVenueSelect">Venue</label>
            <select id="redeemVenueSelect">
              <option value="" selected disabled>Select venue</option>
            </select>
          </div>
          <p class="credit-info" id="creditInfo">
            Select a perk to redeem.
          </p>
          <p class="credit-info small" id="redeemVoucherBalance" style="margin-top:6px;"></p>
          <div class="modal-actions">
            <button class="btn btn-secondary" type="button" id="redeemConfirm">Confirm</button>
          </div>
        </div>
      </div>
      <div class="redeem-success" id="redeemSuccess">
        <div class="success-card">
          <div class="confetti-layer" id="confettiLayer"></div>
          <div class="qr-display">
            <div class="qr-logo-shell">
              <img src="foco-logo.png" alt="FoCo After Dark logo" class="qr-logo" />
            </div>
          </div>
          <div class="success-copy">
            <div class="success-title" id="redeemSuccessTitle">Show this QR</div>
            <p class="success-detail">
              Unique code: <span id="redeemCode" class="copyable" title="Tap to copy code">ABC123</span><br />
              Give staff your voucher code.
              <span id="redeemVenueHint" style="display:none;margin-top:6px;color:#9ca3af;">Redeeming at Venue</span>
              <span id="redeemStatusLine" style="display:block;margin-top:6px;color:#cbd5f5;">Waiting for venue verificationâ€¦</span>
            </p>
            <button type="button" class="pill-ghost" id="redeemPendingClose" style="margin-top:10px;display:none;align-self:flex-start;">
              Confirm
            </button>
          </div>
          <button type="button" class="btn btn-primary" id="redeemSuccessBack" style="width:100%;margin-top:4px;">
            Back to pass
          </button>
        </div>
      </div>
    </div>
  </div>
  <div id="scanConfirmScreen" class="screen">
    <div class="app-title"><span>FoCo</span> Pass Scan</div>
    <div class="tagline">
      QR captured. Confirm the memberâ€™s pass before letting them in.
    </div>
    <div class="confirm-card">
      <p id="scanConfirmStatus" style="font-size:15px;color:#e5e7eb;">Checking pass statusâ€¦</p>
      <p id="scanConfirmPassId" style="font-size:13px;color:#94a3b8;margin-top:6px;"></p>
      <button type="button" class="btn btn-primary" id="scanConfirmToStaff" style="margin-top:16px;">Open staff portal</button>
      <button type="button" class="btn btn-secondary back-btn" id="scanConfirmBack" style="margin-top:8px;">Back to start</button>
    </div>
  </div>
  <div id="venuesScreen" class="screen">
    <div class="app-title"><span>Participating</span> Venues</div>
    <div class="tagline">
      Doors where FoCo After Dark perks unlock drinks, bites, and VIP treatment.
    </div>
        <div class="venues-card card-hd no-tilt smooth-enter">
      <div class="featured-venues" id="featuredVenues">
        <h4>Featured venues</h4>
        <div class="featured-grid" id="featuredVenuesGrid"></div>
      </div>
      <div class="venues-grid">
        <div class="venues-category">
        <h4>Bars Â· Nightlife</h4>
        <ul class="venues-list">
          <li><button class="venue-btn" data-venue="bar_district">The Bar District</button></li>
          <li><button class="venue-btn" data-venue="bondi_beach">Bondi Beach Bar</button></li>
          <li><button class="venue-btn" data-venue="rec_room">Rec Room Fort Collins</button></li>
          <li><button class="venue-btn" data-venue="road_34">Road 34 Bike Bar</button></li>
          <li><button class="venue-btn" data-venue="pour_brothers">Pour Brothers Community Tavern</button></li>
          <li><button class="venue-btn" data-venue="lucky_joes">Lucky Joeâ€™s Sidewalk Saloon</button></li>
          <li><button class="venue-btn" data-venue="whiskey">The Whisk(e)y</button></li>
          <li><button class="venue-btn" data-venue="yeti">Yeti Bar & Grill</button></li>
          <li><button class="venue-btn" data-venue="drunken_monkey">The Drunken Monkey</button></li>
          <li><button class="venue-btn" data-venue="boot_grill">The Boot Grill</button></li>
          <li><button class="venue-btn" data-venue="trail_head">Trail Head Tavern</button></li>
          <li><button class="venue-btn" data-venue="steak_out">Steak-Out Saloon</button></li>
          <li><button class="venue-btn" data-venue="mo_jeaux">Mo Jeauxâ€™s Bar & Grill</button></li>
          <li><button class="venue-btn" data-venue="old_town_putt">Old Town Putt</button></li>
          <li><button class="venue-btn" data-venue="social">Social</button></li>
          <li><button class="venue-btn" data-venue="ace_gilletts">Ace Gillettâ€™s Lounge</button></li>
          <li><button class="venue-btn" data-venue="elliotts">Elliottâ€™s Martini Bar</button></li>
          <li><button class="venue-btn" data-venue="tap_handle">Tap and Handle</button></li>
          <li><button class="venue-btn" data-venue="bar_louie">Bar Louie</button></li>
          <li><button class="venue-btn" data-venue="cb_potts">C.B. & Potts</button></li>
          <li><button class="venue-btn" data-venue="intersect">Intersect Brewing</button></li>
          <li><button class="venue-btn" data-venue="maxline">Maxline Brewing</button></li>
          <li><button class="venue-btn" data-venue="odell">Odell Brewing Taproom</button></li>
          <li><button class="venue-btn" data-venue="new_belgium">New Belgium Brewing</button></li>
          <li><button class="venue-btn" data-venue="equinox">Equinox Brewing</button></li>
        </ul>
      </div>
      </div>
      <button class="btn btn-secondary back-btn" id="venuesBackBtn">Back to pass</button>
    </div>
    <!-- subtle particles canvas for luxe feel -->
    <canvas id="cardParticles" style="position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:0;opacity:0.6;mix-blend-mode:screen;"></canvas>
  </div>
  <div class="venue-detail-overlay" id="venueDetailModal">
    <div class="venue-detail-card">
      <button class="venue-detail-close" id="venueDetailClose" aria-label="Close venue details">&times;</button>
      <h5 id="venueDetailName">FoCo Venue</h5>
      <p id="venueDetailAddress">
        Tap a venue to view details.
      </p>
      <p id="venueDetailPhone"></p>
      <p id="venueDetailHours"></p>
      <div class="venue-rating-row">
        <span class="venue-rating-pill" id="venueDetailRating" style="display:none;"></span>
        <div class="venue-stars" id="venueStars">
          <button type="button" data-star="1">â˜…</button>
          <button type="button" data-star="2">â˜…</button>
          <button type="button" data-star="3">â˜…</button>
          <button type="button" data-star="4">â˜…</button>
          <button type="button" data-star="5">â˜…</button>
        </div>
      </div>
    </div>
  </div>

  <div id="staffLoginScreen" class="screen">
    <div class="app-title"><span>Venue</span> Staff Login</div>
    <div class="tagline">
      Enter your venue code and passphrase to access the staff portal.
    </div>
    <p class="small" id="scanPendingAlert" style="display:none;color:#fbbf24;margin-bottom:10px;text-align:center;">
      Scanned pass pending. Log in to verify.
    </p>
    <div class="staff-gate-overlay" id="staffGateOverlay">
      <div class="staff-gate-card">
        <h4>Staff access required</h4>
        <p>Enter the staff access code to continue.</p>
        <div class="field">
          <label for="staffGateCode">Staff access code</label>
          <input id="staffGateCode" type="text" placeholder="" autocomplete="off" />
        </div>
        <div class="error" id="staffGateError"></div>
        <div class="payment-actions" style="margin-top:10px;">
          <button type="button" class="btn btn-primary" id="staffGateAccept">Accept</button>
          <button type="button" class="btn btn-secondary" id="staffGateCancel">Back</button>
        </div>
        <p class="small" style="margin-top:8px;text-align:center;color:#94a3b8;">Code is not case sensitive.</p>
      </div>
    </div>
    <div class="staff-form">
      <form id="staffLoginForm">
        <div class="field">
          <label for="staffVenue">Venue code</label>
          <input id="staffVenue" type="text" placeholder="e.g. trail_head" />
        </div>
        <div class="field">
          <label for="staffPass">Passphrase</label>
          <input id="staffPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>
        <div class="error" id="staffLoginError"></div>
        <button type="button" class="btn btn-primary" id="staffLoginSubmit">Log in</button>
      </form>
      <p class="small" id="staffBetaHint" style="margin-top:10px;text-align:center;">
        Beta access? Use venue code â€œbetaâ€ and passphrase â€œbetastaffâ€.
      </p>
      <button type="button" class="btn btn-secondary back-btn" id="staffLoginBack" style="margin-top:12px;">
        Back to start
      </button>
    </div>
  </div>

  <div id="staffPortalScreen" class="screen">
    <div style="display:flex;justify-content:center;margin-bottom:10px;margin-top:4px;">
      <button type="button" class="staff-logout-top" id="staffLogoutTop">Log out</button>
    </div>
    <div class="app-title" id="staffPortalTitle"><span>Venue</span> Dashboard</div>
    <div class="tagline" id="staffPortalTagline">
      Track FoCo After Dark redemptions for your establishment.
    </div>
    <div class="staff-meta-row">
      <span class="venue-chip" id="staffVenueBadge">Venue</span>
      <span class="pill" id="staffVenueStatus">Live</span>
      <span class="meta-note" id="staffCloseoutStamp" style="font-size:12px;color:#94a3b8;"></span>
    </div>
    <div class="staff-sticky-bar">
      <div class="venue-chip" id="staffVenueChip">Venue</div>
      <div class="sticky-actions">
        <button type="button" class="chip ghost" data-scroll="verifyCard">Verify</button>
        <button type="button" class="chip ghost" data-scroll="alertCard">Post alert</button>
        <button type="button" class="chip ghost" data-scroll="codesCard">Codes</button>
      </div>
    </div>
    <div class="staff-accent-row">
      <span style="color:#94a3b8;font-size:12px;">Accent:</span>
      <button type="button" class="accent-chip" data-staff-accent="magenta">Magenta</button>
      <button type="button" class="accent-chip" data-staff-accent="gold">Gold</button>
      <button type="button" class="accent-chip" data-staff-accent="jade">Jade</button>
      <button type="button" class="accent-chip" data-staff-accent="ember">Ember</button>
    </div>
    <div class="kpi-row">
      <div class="kpi-chip" id="kpiScans">Scans tonight: <span>0</span></div>
      <div class="kpi-chip" id="kpiAlerts">Alerts live: <span>0</span></div>
    </div>
    <div class="staff-board">
      <!-- Card 1: Verify & lookup -->
      <div class="staff-form" id="verifyCard">
        <div class="staff-filter">Logged in as <strong id="staffVenueLabel">Venue</strong>.</div>
        <form id="verifyForm">
          <div class="field">
            <label for="verifyCode">Enter voucher code</label>
            <input id="verifyCode" type="text" placeholder="e.g. ABC123" />
          </div>
          <div class="error" id="verifyError"></div>
          <p class="support-success" id="verifySuccess">Voucher verified.</p>
          <p class="support-success" id="lastVerifiedLine" style="display:none;color:#cbd5f5;"></p>
          <div class="payment-actions" style="margin-top:8px;">
            <button type="submit" class="btn btn-primary">Verify code</button>
            <button type="button" class="btn btn-secondary" id="undoLastVerification" style="flex:0 0 auto;">Undo last</button>
          </div>
        </form>
        <form id="memberIdForm" style="margin-top:12px;">
          <div class="field">
            <label for="memberIdInput">Quick member ID lookup</label>
            <input id="memberIdInput" type="text" placeholder="Pass ID e.g. XYZ789" />
          </div>
          <div class="error" id="memberIdError"></div>
          <p class="support-success" id="memberIdResult">Member is active.</p>
          <div class="payment-actions" style="margin-top:8px;">
            <button type="submit" class="btn btn-primary">Check member ID</button>
          </div>
        </form>
      </div>

      <!-- Card 2: Live pulse -->
      <div class="staff-radar card-hd smooth-enter" id="staffRadar">
        <div class="radar-display">
          <div class="radar-grid"></div>
          <div class="radar-sweep"></div>
          <div class="radar-graffiti" id="radarGraffiti">Live Floor</div>
          <div class="radar-pings" id="radarPings"></div>
        </div>
        <div class="radar-copy">
          <div class="radar-title">Live floor pulse</div>
          <div class="radar-mood">
            <span class="radar-count" id="staffRadarCount">0 scans Â· last hour</span> Â·
            <span id="staffRadarMood">Calibrating flow</span>
          </div>
        </div>
        <div class="radar-list" id="radarList"></div>
      </div>
      <p class="support-success" id="scanPortalAlert" style="display:none;">
        Scanned pass pending. Verifying nowâ€¦
      </p>

      <!-- Card 3: Monthly perks -->
      <div class="vip-deal-card" id="staffPerksCard">
        <h4>Monthly perks</h4>
        <p class="small" style="color:#cbd5f5;margin-top:4px;">Set the perks guests can redeem at this venue. Updates go live instantly.</p>
        <div class="staff-perks-list" id="staffPerksList"></div>
        <div class="error" id="staffPerksError"></div>
        <p class="support-success" id="staffPerksSuccess">Perks updated.</p>
        <div class="staff-perks-actions">
          <button type="button" class="btn btn-secondary" id="staffAddPerkBtn">Add perk</button>
          <button type="button" class="btn btn-primary" id="staffSavePerksBtn">Save perks</button>
        </div>
      </div>

      <!-- Card 4: Tonightâ€™s alert/deal -->
      <div class="vip-deal-card" id="alertCard">
        <h4>Post tonightâ€™s alert</h4>
        <div class="audience-toggle" id="alertAudiencePills">
          <button type="button" data-audience="all" class="pill active">All members</button>
          <button type="button" data-audience="vip" class="pill">VIP only</button>
        </div>
        <form id="alertForm">
          <input id="alertAudience" type="hidden" value="all" />
          <div class="field">
            <label for="alertTitle">Alert headline</label>
            <input id="alertTitle" type="text" placeholder="e.g. Glow shot hour" />
          </div>
          <div class="field">
            <label for="alertDetail">Details</label>
            <textarea id="alertDetail" placeholder="Short details that appear on member passes."></textarea>
            <div class="small" id="alertDetailCount" style="text-align:right;margin-top:4px;color:#9ca3af;">0 / 140</div>
          </div>
          <div class="field">
            <label for="alertMeta">Location</label>
            <input id="alertMeta" type="text" placeholder="Auto-fills with this venue" />
          </div>
          <div class="field">
            <label for="alertExpires">Expires</label>
            <input id="alertExpires" type="datetime-local" step="60" />
          </div>
          <div class="error" id="alertError"></div>
          <div class="payment-actions" style="margin-top:6px;">
            <button type="submit" class="btn btn-primary">Publish</button>
          </div>
        </form>
        <p class="support-success" id="alertSuccess">Alert posted.</p>
        <div class="vip-deal-preview" id="alertPreview">No alerts scheduled yet.</div>
        <div class="vip-deal-preview" id="vipDealPreview">No VIP deal set for this venue yet.</div>
        <div class="recent-actions" id="staffRecentActions"></div>
      </div>

      <!-- Card 5: Tonightâ€™s codes -->
      <div class="vip-deal-card" id="codesCard">
        <h4>Tonightâ€™s deal codes</h4>
        <p class="small" style="color:#cbd5f5;">Generate a code for each active deal at this venue. Codes expire with the deal.</p>
        <div id="staffDealCodeList"></div>
      </div>

      <!-- Card 6: Message CEO -->
      <div class="vip-deal-card" id="staffMessageCard">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
          <h4 style="margin:0;">Message CEO</h4>
          <span class="pill" id="staffMsgBadge" style="display:none;">New</span>
        </div>
        <p class="small" style="color:#cbd5f5;margin-top:4px;">Send urgent questions to HQ. Replies appear here in real time.</p>
        <form id="staffMessageForm">
          <div class="field">
            <label for="staffMessageInput">Message</label>
            <textarea id="staffMessageInput" rows="3" placeholder="Type a quick note..."></textarea>
          </div>
          <div class="error" id="staffMessageError"></div>
          <p class="support-success" id="staffMessageSuccess" style="display:none;">Message sent.</p>
          <div class="payment-actions" style="margin-top:6px;">
            <button type="submit" class="btn btn-primary">Send to CEO</button>
          </div>
        </form>
        <div class="vip-deal-preview" id="staffMessagesList">No messages yet.</div>
        <div class="payment-actions" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
          <button type="button" class="btn btn-secondary" id="staffDeleteSelectedBtn" style="flex:1;min-width:140px;">Delete selected</button>
          <button type="button" class="btn btn-secondary" id="staffClearMessagesBtn" style="flex:1;min-width:140px;">Clear all</button>
        </div>
      </div>

      <!-- Drawer: More (logs, verifications & close-out) -->
      <details class="staff-more" id="staffMore">
        <summary>More (logs, verifications & close-out)</summary>
        <div class="more-body">
          <div class="staff-ticker-header" style="margin-top:6px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
            <span>Redemptions</span>
            <select id="staffLogRange" style="background:#0b1223;color:#e2e8f0;border:1px solid rgba(148,163,184,0.35);border-radius:10px;padding:6px 10px;font-size:13px;">
              <option value="all">All time</option>
              <option value="day">Today</option>
              <option value="week">This week</option>
              <option value="month">This month</option>
              <option value="year">This year</option>
            </select>
          </div>
          <div class="staff-log" id="staffVenueLog"></div>
          <div class="staff-ticker">
            <div class="staff-ticker-header">Recent verifications</div>
            <ul class="staff-ticker-list" id="staffTickerList">
              <li class="empty">No scans yet. Verify a pass to populate this feed.</li>
            </ul>
          </div>
          <div class="payment-actions" style="margin-top:4px;">
            <button type="button" class="btn btn-primary" id="staffCloseOutBtn" style="width:100%;">Close out for tonight</button>
          </div>
        </div>
      </details>
    </div>
    </div>
    <div class="staff-footnote">Â© 2026 Dreeboy LLC</div>
  </div>
  <div class="tier-modal" id="tierModal">
    <div class="tier-card">
      <h4 id="tierModalTitle">Manage membership</h4>
      <p id="tierModalCopy">Your membership is active.</p>
      <div class="payment-actions" style="margin-top:6px;">
        <button class="btn btn-primary" type="button" id="tierModalAction">Switch Membership</button>
        <button class="btn btn-secondary back-btn" type="button" id="tierModalCancel">Keep current plan</button>
      </div>
    </div>
  </div>

  <div id="ceoPortalScreen" class="screen">
    <div class="app-title"><span>Black</span> Card</div>
    <div class="tagline">Unlimited perks. Issue passes and control FoCo After Dark.</div>
    <div class="ceo-card card-hd smooth-enter">
      <h3>FoCo Black Card</h3>
      <p>Unlimited monthly venue perks Â· VIP-only offers Â· Instant guest access.</p>
      <div class="ceo-metrics" id="ceoMetrics">
        <div class="ceo-metric-card">
          <strong id="metricTodayRedemptions">0</strong>
          <span>todayâ€™s scans</span>
        </div>
        <div class="ceo-metric-card">
          <strong id="metricActiveVenues">0</strong>
          <span>active venues</span>
        </div>
        <div class="ceo-metric-card">
          <strong id="metricLatestRating">â€“</strong>
          <span>recent reviews avg</span>
        </div>
      </div>
      <button type="button" class="btn btn-secondary back-btn" id="ceoPortalBack" style="margin-bottom:12px;width:auto;">
        Back to member pass
      </button>
      <div class="ceo-actions">
        <button class="btn btn-secondary" id="ceoPassButton">View CEO pass</button>
        <div class="vip-deal-card card-hd">
          <h4>Generate CEO vouchers</h4>
          <p style="font-size:12px;color:#cbd5f5;">Tap to generate a one-time code and share with a guest. Codes will appear in venue redemptions as â€œCEO issuedâ€.</p>
          <div class="payment-actions" style="display:flex;flex-wrap:wrap;gap:8px;">
            <button type="button" class="btn btn-secondary" data-ceo-gen-perk="shot" style="flex:1;min-width:140px;">Shot perk voucher</button>
            <button type="button" class="btn btn-secondary" data-ceo-gen-perk="drink" style="flex:1;min-width:140px;">Drink perk voucher</button>
            <button type="button" class="btn btn-secondary" data-ceo-gen-perk="cover" style="flex:1;min-width:140px;">Line access voucher</button>
            <button type="button" class="btn btn-secondary" data-ceo-gen-perk="free_drink" style="flex:1;min-width:140px;">Free drink voucher</button>
          </div>
            <p class="support-success" id="ceoGenSuccess" style="display:none;margin-top:8px;">Code generated.</p>
            <div id="ceoIssuedList" style="margin-top:12px;display:flex;flex-direction:column;gap:8px;max-height:160px;overflow:auto;padding-top:6px;border-top:1px dashed rgba(148,163,184,0.08);"></div>
        </div>
        <div class="vip-deal-card card-hd">
          <h4>Grant free membership</h4>
          <p style="font-size:12px;color:#cbd5f5;">Turn an existing member into a free, unlimited account. Enter their Pass ID.</p>
          <div class="field">
            <label for="freePassIdInput">Pass ID</label>
            <input id="freePassIdInput" type="text" placeholder="e.g. ABC123" />
          </div>
          <div class="payment-actions" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
            <button type="button" class="btn btn-secondary" id="grantFreeBtn" style="flex:1;min-width:140px;">Grant free</button>
            <button type="button" class="btn btn-secondary" id="revokeFreeBtn" style="flex:1;min-width:140px;">Revoke free</button>
          </div>
          <p class="support-success" id="freeMemberStatus" style="display:none;">Updated.</p>
        </div>
        <div class="vip-deal-card card-hd">
          <h4>Free memberships issued</h4>
          <p style="font-size:12px;color:#cbd5f5;">Tap revoke to remove a free, never-expiring account.</p>
          <div id="freeMembersList" style="display:flex;flex-direction:column;gap:8px;max-height:200px;overflow:auto;"></div>
          <button type="button" class="btn btn-secondary" id="refreshFreeMembers" style="margin-top:8px;">Refresh list</button>
        </div>
        <div class="vip-deal-card card-hd" id="ceoInboxCard">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
            <h4 style="margin:0;">Venue messages</h4>
            <span class="pill" id="ceoMsgBadge" style="display:none;">New</span>
          </div>
          <p style="font-size:12px;color:#cbd5f5;">Live messaging between venue staff and CEO.</p>
          <form id="ceoReplyForm">
            <input type="hidden" id="ceoReplyTarget" />
            <div class="field">
              <label for="ceoReplyInput">Reply</label>
              <textarea id="ceoReplyInput" rows="3" placeholder="Select a message to reply"></textarea>
            </div>
            <div class="error" id="ceoReplyError"></div>
            <p class="support-success" id="ceoReplySuccess" style="display:none;">Reply sent.</p>
            <div class="payment-actions" style="margin-top:6px;gap:8px;flex-wrap:wrap;">
              <button type="submit" class="btn btn-primary" style="flex:1;min-width:140px;">Send reply</button>
              <button type="button" class="btn btn-secondary" id="ceoClearMessages" style="flex:1;min-width:140px;">Clear all</button>
            </div>
          </form>
          <div class="vip-deal-preview" id="ceoMessagesList">No messages yet.</div>
        </div>
      </div>
      <div class="ceo-logs" style="margin-top:14px;">
        <h4 style="font-size:13px;letter-spacing:0.08em;text-transform:uppercase;margin-bottom:6px;">Venue redemptions (live)</h4>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px;">
          <select id="ceoVenueFilter" style="flex:1;min-width:180px;background:#0b1223;color:#e2e8f0;border:1px solid rgba(148,163,184,0.35);border-radius:10px;padding:8px 10px;font-size:13px;">
            <option value="all">All venues</option>
          </select>
          <select id="ceoVenueRange" style="width:150px;background:#0b1223;color:#e2e8f0;border:1px solid rgba(148,163,184,0.35);border-radius:10px;padding:8px 10px;font-size:13px;">
            <option value="day">Today</option>
            <option value="week">This week</option>
            <option value="month" selected>This month</option>
            <option value="year">This year</option>
            <option value="all">All time</option>
          </select>
        </div>
        <div id="ceoVenueLog"></div>
      </div>
      <div class="ceo-logs" style="margin-top:14px;">
        <h4 style="font-size:13px;letter-spacing:0.08em;text-transform:uppercase;margin-bottom:6px;">Close-out reports</h4>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px;">
          <select id="ceoCloseOutVenue" style="flex:1;min-width:180px;background:#0b1223;color:#e2e8f0;border:1px solid rgba(148,163,184,0.35);border-radius:10px;padding:8px 10px;font-size:13px;">
            <option value="all">All venues</option>
          </select>
          <select id="ceoCloseOutRange" style="width:150px;background:#0b1223;color:#e2e8f0;border:1px solid rgba(148,163,184,0.35);border-radius:10px;padding:8px 10px;font-size:13px;">
            <option value="day">Today</option>
            <option value="week">This week</option>
            <option value="month" selected>This month</option>
            <option value="year">This year</option>
            <option value="all">All time</option>
          </select>
        </div>
        <div id="ceoCloseOutList" class="staff-log"></div>
      </div>
      <button type="button" class="btn btn-secondary ceo-log-btn" id="ceoPortalReviewsBtn" style="margin-top:12px;">
        View reviews
      </button>
      <button type="button" class="btn btn-secondary ceo-log-btn" id="ceoAnalyticsBtn">
        Analytics
      </button>
    </div>
  </div>

  <div class="tier-modal" id="voucherModal">
    <div class="tier-card" id="voucherStepPacks">
      <h4>Add more vouchers</h4>
      <p>Choose an instant add-on pack. Purchases refresh your bonus balance immediately.</p>
      <div id="voucherOptions"></div>
      <div class="payment-actions" style="margin-top:8px;">
        <button class="btn btn-secondary back-btn" id="voucherCancel">Cancel</button>
      </div>
    </div>
    <div class="tier-card" id="voucherStepPayment" style="display:none;">
      <h4 id="voucherPaymentTitle">Confirm purchase</h4>
      <p id="voucherPaymentCopy">Secure checkout powered by Stripe.</p>
      <div class="saved-card" id="voucherSavedCard" style="display:none;"></div>
      <form id="voucherPaymentForm">
        <div class="field">
          <label>Card & payment method</label>
          <div id="voucherPaymentElement"></div>
        </div>
        <div class="meta-note" id="voucherStripeNote" style="margin-top:8px;">Secured by Stripe.</div>
        <div class="error" id="voucherPaymentError"></div>
        <div class="payment-actions" style="margin-top:8px;">
          <button type="button" class="btn btn-primary" id="voucherChargeOnFile">Continue</button>
          <button type="button" class="btn btn-secondary" id="voucherBackBtn">Back</button>
        </div>
      </form>
    </div>
  </div>

  <div class="black-card-modal" id="ceoCardModal">
    <div class="black-card">
      <div class="black-card-close" id="ceoCardClose">âœ•</div>
      <div class="black-card-content">
        <div class="black-card-header">
          <div class="black-card-logo">
            <img src="foco-logo.png" alt="FoCo After Dark logo" />
          </div>
          <div class="black-card-title">FoCo Black Card</div>
        </div>
        <div class="black-card-body">
          <div style="font-size:12px;letter-spacing:0.22em;text-transform:uppercase;color:#e2e8f0;">Executive Access</div>
          <div class="name">Adrian White</div>
          <div class="code" id="ceoCardCode">000000</div>
          <div style="font-size:12px;letter-spacing:0.12em;color:#9ca3af;text-transform:uppercase;">Never Expires Â· Priority Entry</div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="pitchDeckModal">
    <div class="modal-card pitch-card">
      <div class="pitch-meter" id="pitchMeter">Slide 1 of 3</div>
      <h3 id="pitchTitle">FoCo After Dark</h3>
      <p id="pitchBody">Invite-only nightlife perks for people who actually go out.</p>
      <div class="pitch-actions">
        <button type="button" class="btn btn-secondary" id="pitchPrevBtn">Back</button>
        <button type="button" class="btn btn-primary" id="pitchNextBtn">Next</button>
      </div>
      <button type="button" class="btn btn-secondary" id="pitchCloseBtn" style="margin-top:10px;">
        Close deck
      </button>
    </div>
  </div>

  <div class="modal-backdrop" id="reviewModal">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">Leave a review</div>
        <button class="modal-close" id="reviewClose" type="button">Close</button>
      </div>
      <p style="font-size:13px;color:#94a3b8;">Tap to rate your FoCo After Dark experience.</p>
      <div class="review-stars" id="reviewStars">
        <button type="button" class="review-star" data-star="1">â˜…</button>
        <button type="button" class="review-star" data-star="2">â˜…</button>
        <button type="button" class="review-star" data-star="3">â˜…</button>
        <button type="button" class="review-star" data-star="4">â˜…</button>
        <button type="button" class="review-star" data-star="5">â˜…</button>
      </div>
      <textarea id="reviewNotes" placeholder="Optional feedback" style="width:100%;min-height:80px;border-radius:14px;border:1px solid rgba(148,163,184,0.4);background:rgba(15,23,42,0.85);color:#f9fafb;padding:10px;"></textarea>
      <div class="modal-actions" style="margin-top:12px;">
        <button class="btn btn-secondary" type="button" id="submitReviewBtn">Submit</button>
      </div>
      <p class="support-success" id="reviewSuccess">Thanks for the review!</p>
    </div>
  </div>

  <div id="reconnectBanner" style="display:none;position:fixed;top:8px;left:50%;transform:translateX(-50%);background:rgba(15,23,42,0.95);color:#e2e8f0;padding:8px 14px;border-radius:999px;font-size:12px;z-index:9999;box-shadow:0 10px 30px rgba(0,0,0,0.35);border:1px solid rgba(148,163,184,0.3);">
    Reconnectingâ€¦
  </div>

  <div class="modal-backdrop" id="addToHomeOverlay">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">Add to Home Screen</div>
        <button class="modal-close" id="addToHomeClose" type="button">Close</button>
      </div>
      <div style="font-size:13px;color:#cbd5f5;line-height:1.5;display:flex;flex-direction:column;gap:10px;">
        <div><strong>iPhone/iPad (Safari)</strong></div>
        <ol style="padding-left:18px;display:flex;flex-direction:column;gap:6px;">
          <li>Tap the <strong>Share</strong> icon.</li>
          <li>Scroll if needed, tap <strong>More</strong>.</li>
          <li>Select <strong>Add to Home Screen</strong>, then tap Add.</li>
        </ol>
        <div><strong>Android/Chrome</strong></div>
        <ol style="padding-left:18px;display:flex;flex-direction:column;gap:6px;">
          <li>Tap the <strong>â‹®</strong> menu.</li>
          <li>Select <strong>Add to Home screen</strong>.</li>
          <li>Confirm to install.</li>
        </ol>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="usernameModal">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">Edit username</div>
        <button class="modal-close" id="usernameClose" type="button">Close</button>
      </div>
      <p style="font-size:13px;color:#94a3b8;margin:0 0 10px;">Use 3â€“10 characters. Letters, numbers, underscores, and spaces only.</p>
      <div class="field">
        <label for="usernameEditInput">Username</label>
        <input id="usernameEditInput" type="text" maxlength="10" autocomplete="nickname" />
      </div>
      <div class="error" id="usernameEditError"></div>
      <div class="modal-actions" style="margin-top:12px;">
        <button type="button" class="btn btn-secondary" id="usernameCancel">Cancel</button>
        <button type="button" class="btn btn-primary" id="usernameSave">Save</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="aboutModal">
    <div class="modal-card" style="max-height:80vh;overflow:auto;">
      <div class="modal-header">
        <div class="modal-title" style="color:var(--accent-magenta);">About Â· Legal</div>
        <button class="modal-close" id="aboutClose" type="button">Close</button>
      </div>
      <div style="font-size:13px;color:#cbd5f5;line-height:1.45;">
        <p style="margin-bottom:8px;font-weight:700;color:#e6eefb;">Important â€” Please read before using FoCo After Dark in Fort Collins, CO</p>

        <h4 style="margin-bottom:6px;color:var(--accent-cyan);font-size:13px;">Age requirement</h4>
        <p>You must be 21 years of age or older to redeem alcoholic beverage vouchers in Fort Collins, Colorado. Venues may require a valid government-issued photo ID at redemption.</p>

        <h4 style="margin-top:10px;margin-bottom:6px;color:var(--accent-cyan);font-size:13px;">Responsible service</h4>
        <p>Vouchers are subject to venue policies and Colorado law. Do not serve alcohol to persons who are visibly intoxicated. Venue staff retain the right to refuse service in accordance with state and local regulations.</p>

        <h4 style="margin-top:10px;margin-bottom:6px;color:var(--accent-cyan);font-size:13px;">Voucher terms</h4>
        <ul style="margin-left:18px;color:#cbd5f5;">
          <li>Vouchers are one-time use unless otherwise stated.</li>
          <li>Vouchers have no cash value and are non-transferable where prohibited.</li>
          <li>Vouchers may require venue confirmation and proof of age at redemption.</li>
          <li>Dreeboy LLC and participating venues reserve the right to revoke or invalidate vouchers for fraud or misuse.</li>
        </ul>

        <h4 style="margin-top:10px;margin-bottom:6px;color:var(--accent-cyan);font-size:13px;">Service availability & realtime updates</h4>
        <p>FoCo After Dark relies on internet connectivity, device capability, and third-party services (including Firebase and payment processors). While we design for near real-time sync, delivery can be delayed by network conditions, device power settings, or platform constraints. We do not guarantee uninterrupted service or zero-latency delivery.</p>

        <h4 style="margin-top:10px;margin-bottom:6px;color:var(--accent-cyan);font-size:13px;">Beta features & changes</h4>
        <p>During beta, features, pricing, perks, and availability may change without notice. Some data or features may reset or be removed when the product launches live.</p>

        <h4 style="margin-top:10px;margin-bottom:6px;color:var(--accent-cyan);font-size:13px;">Billing & cancellations</h4>
        <p>Memberships renew on the billing date associated with your account. Failed charges may be retried. If you cancel, access may remain active until the end of the current billing cycle. Payment processing is handled by Stripe or other third-party processors; FoCo After Dark does not store full card numbers.</p>

        <h4 style="margin-top:10px;margin-bottom:6px;color:var(--accent-cyan);font-size:13px;">Venue responsibility</h4>
        <p>Venues control their own perks, redemption policies, and service decisions. Venue staff may refuse service, decline a redemption, or modify offers in accordance with local laws and venue policies.</p>

        <h4 style="margin-top:10px;margin-bottom:6px;color:var(--accent-cyan);font-size:13px;">Data accuracy & audit logs</h4>
        <p>We log redemption attempts, verification events, and timestamps for operational, analytics, and fraud-prevention purposes. We strive for accuracy, but logs may be delayed or incomplete due to connectivity or device issues.</p>

        <h4 style="margin-top:10px;margin-bottom:6px;color:var(--accent-cyan);font-size:13px;">App behavior (PWA)</h4>
        <p>When installed to a home screen, the app may cache assets for performance. Updates are delivered when the app reconnects and reloads. If the app is locked by administrators, access is restricted until unlocked by the CEO.</p>

        <h4 style="margin-top:10px;margin-bottom:6px;color:var(--accent-cyan);font-size:13px;">Liability & safety</h4>
        <p>Dreeboy LLC is not responsible for injuries, property damage, or other consequences from alcohol consumption. Use vouchers responsibly. If you or someone appears intoxicated, seek assistance and never let them drive.</p>

        <h4 style="margin-top:10px;margin-bottom:6px;color:var(--accent-cyan);font-size:13px;">Privacy Notice (In-App)</h4>
        <div style="max-height:220px;overflow:auto;padding-right:6px;border-top:1px solid rgba(148,163,184,0.04);margin-top:8px;">
          <p style="margin-top:8px;color:#cbd5f5;">This Privacy Notice explains what information FoCo After Dark (operated by Dreeboy LLC) collects, how we use it, and your choices. This in-app notice is intended to provide full disclosure of our practices (excluding internal secrets such as encryption keys or internal operational credentials).</p>

          <h5 style="margin-top:10px;color:var(--accent-cyan);font-size:13px;">Information we collect</h5>
          <ul style="margin-left:18px;color:#cbd5f5;">
            <li><strong>Account data:</strong> name, email, birthdate (to verify legal age), and profile details you provide.</li>
            <li><strong>Authentication & identifiers:</strong> Firebase UID, device identifiers, and Pass ID for your membership.</li>
            <li><strong>Redemption & audit logs:</strong> voucher codes generated, redemption attempts, timestamps, venue identifiers, and staff verification events to support operations and fraud prevention.</li>
            <li><strong>Payment info:</strong> we use third-party processors for payments and do not store full card numbers in-app; only masked card references or tokens may be kept for billing convenience.</li>
            <li><strong>Support communications:</strong> messages you send to support, including optional contact details.</li>
            <li><strong>Usage & analytics:</strong> device & browser info, interaction events, crash reports, and performance metrics to improve the product.</li>
          </ul>

          <h5 style="margin-top:10px;color:var(--accent-cyan);font-size:13px;">How we use information</h5>
          <p style="color:#cbd5f5;">We use information to operate and improve the service: to authenticate members, enable and verify voucher redemptions, prevent abuse and fraud, provide support, process payments, and analyze usage for product improvements. We may also use aggregated, de-identified data for analytics and partner reporting.</p>

          <h5 style="margin-top:10px;color:var(--accent-cyan);font-size:13px;">Sharing & third parties</h5>
          <p style="color:#cbd5f5;">We share data only as needed to provide the service: with payment processors, hosting and database providers (e.g., Firebase), analytics providers, and venues for redemption verification. We do not sell personal data. Any third party we use is contractually required to protect personal data and limit use to providing the requested services.</p>

          <h5 style="margin-top:10px;color:var(--accent-cyan);font-size:13px;">Data retention & your rights</h5>
          <p style="color:#cbd5f5;">We retain redemption and audit logs for operational and fraud-prevention purposes for a reasonable period (typically up to 3 years) unless otherwise required by law. You may request access to, correction of, or deletion of your personal data by contacting support. Deleting your account will remove your personal profile; some anonymized or aggregated logs may be retained for legal or operational reasons.</p>

          <h5 style="margin-top:10px;color:var(--accent-cyan);font-size:13px;">Security</h5>
          <p style="color:#cbd5f5;">We use industry-standard measures such as TLS for data in transit and rely on hosting providers' encryption-at-rest. Access to production systems is restricted and logged. We do not publish internal credentials or secrets in-app.</p>

          <h5 style="margin-top:10px;color:var(--accent-cyan);font-size:13px;">Children</h5>
          <p style="color:#cbd5f5;">This service is intended for adults 21+. We do not knowingly collect information from children under the legal drinking age.</p>

          <h5 style="margin-top:10px;color:var(--accent-cyan);font-size:13px;">Contact</h5>
          <p style="color:#cbd5f5;">For privacy requests or questions, email <strong>focoafterdark@gmail.com</strong> or use the in-app support form. For legal inquiries, contact Dreeboy LLC through the same address.</p>
        </div>

        <p style="margin-top:12px;font-size:12px;color:#9ca3af;">Last updated: January 13, 2026</p>
        <div style="margin-top:14px;border-top:1px solid rgba(148,163,184,0.06);padding-top:10px;text-align:center;color:var(--accent-magenta);font-weight:700;">Â© 2026 Dreeboy LLC</div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="rewardsModal">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">Rewards</div>
        <button class="modal-close" id="rewardsClose" type="button">Close</button>
      </div>
      <p style="font-size:13px;color:#cbd5f5;">Redeem perks to unlock surprise rewards.</p>
      <div class="progress-bar" style="margin:10px 0 6px;">
        <div class="progress-fill" id="rewardsProgressFill"></div>
      </div>
      <p id="rewardsProgressText" style="font-size:12px;color:#e2e8f0;margin:0 0 10px;">0 / 5 redemptions</p>
      <p id="rewardsNextText" style="font-size:13px;color:#facc15;font-weight:700;margin:0 0 12px;">Next: Free drink voucher</p>
      <div class="error" id="rewardsError"></div>
      <div class="payment-actions" style="margin-top:6px;display:flex;gap:8px;justify-content:flex-end;">
        <button type="button" class="btn btn-secondary" id="rewardsCloseBtn">Close</button>
        <button type="button" class="btn btn-primary" id="rewardsRedeemBtn" disabled>Redeem reward</button>
      </div>
    </div>
  </div>
  <div class="modal-backdrop" id="cancelMembershipModal">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">Cancel membership</div>
        <button class="modal-close" id="cancelMembershipClose" type="button">Close</button>
      </div>
      <p style="font-size:13px;color:#94a3b8;">
        Your membership will end at the close of your current billing cycle. Youâ€™ll need to create a new account to sign up again.
      </p>
      <div class="modal-actions" style="display:flex;gap:10px;justify-content:flex-end;">
        <button type="button" class="btn btn-secondary" id="cancelMembershipAbort">Keep membership</button>
        <button type="button" class="btn btn-primary" id="cancelMembershipConfirm" style="background:linear-gradient(120deg,#f43f5e,#f59e0b);">Confirm cancel</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="ceoReviewsModal">
    <div class="modal-card" style="max-height:80vh;overflow:auto;">
      <div class="modal-header">
        <div class="modal-title">Member reviews</div>
        <button class="modal-close" id="ceoReviewsClose" type="button">Close</button>
      </div>
      <div class="review-summary" id="ceoReviewAverage">Recent reviews avg: â€“</div>
      <div class="review-list" id="ceoReviewList"></div>
    </div>
  </div>

  <div class="modal-backdrop" id="ceoAnalyticsModal">
    <div class="modal-card" style="max-height:80vh;overflow:auto;">
      <div class="modal-header">
        <div class="modal-title">Analytics</div>
        <button class="modal-close" id="ceoAnalyticsClose" type="button">Close</button>
      </div>
      <div id="ceoAnalyticsContent"></div>
    </div>
  </div>

  <div class="modal-backdrop" id="ceoRedemptionModal">
    <div class="modal-card" style="max-height:80vh;overflow:auto;">
      <div class="modal-header">
        <div class="modal-title">Live venue redemptions</div>
        <button class="modal-close" id="ceoRedemptionClose" type="button">Close</button>
      </div>
      <div class="staff-log" id="ceoRedemptionList" style="margin-top:8px;"></div>
    </div>
  </div>

  <div class="modal-backdrop" id="staffCloseOutModal">
    <div class="modal-card" style="max-height:80vh;overflow:auto;">
      <div class="modal-header">
        <div class="modal-title">Close out report</div>
        <button class="modal-close" id="staffCloseOutDone" type="button">Done</button>
      </div>
      <div id="staffCloseOutSummary" style="margin-bottom:12px;"></div>
      <div class="error" id="staffCloseOutStatus" style="margin-bottom:8px;"></div>
      <div class="payment-actions" style="display:flex;gap:10px;justify-content:flex-end;">
        <button type="button" class="btn btn-secondary" id="staffCloseOutDoneFooter">Close</button>
        <button type="button" class="btn btn-primary" id="staffCloseOutSend">Send report</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="ceoCloseOutModal">
    <div class="modal-card" style="max-height:80vh;overflow:auto;">
      <div class="modal-header">
        <div class="modal-title">Close-out report</div>
        <button class="modal-close" id="ceoCloseOutClose" type="button">Close</button>
      </div>
      <div id="ceoCloseOutContent" style="margin-bottom:12px;"></div>
    </div>
  </div>

  <div class="receipt-overlay" id="receiptOverlay">
    <div class="receipt-card">
      <h4>Payment receipt</h4>
      <ul id="receiptSummary"></ul>
      <p id="receiptNote" style="font-size:12px;color:#94a3b8;">Saved to Wallet Â· auto-renews monthly</p>
      <button type="button" class="btn btn-primary" id="receiptClose">Done</button>
    </div>
  </div>
  <div class="app-lock-overlay" id="appLockOverlay">
    <div class="app-lock-card">
      <h4>Beta Closed / App Locked</h4>
      <p>The FoCo After Dark beta is temporarily locked. Please check back later.</p>
      <button type="button" class="btn btn-secondary" id="appLockCeoAccess">CEO access</button>
    </div>
  </div>

  <div id="supportScreen" class="screen">
    <div class="app-title"><span>FoCo</span> Support</div>
    <div class="tagline">
      Tell us what you needâ€”our team replies within 24 hours.
    </div>
    <div class="support-card">
      <form id="supportForm" class="support-form">
        <div class="field">
          <label for="supportFirstName">First name</label>
          <input id="supportFirstName" type="text" />
        </div>
        <div class="field">
          <label for="supportLastName">Last name</label>
          <input id="supportLastName" type="text" />
        </div>
        <div class="field">
          <label for="supportPhone">Phone number</label>
          <input id="supportPhone" type="tel" />
        </div>
        <div class="field">
          <label for="supportMessage">Message</label>
          <textarea id="supportMessage"></textarea>
        </div>
        <div class="error" id="supportError"></div>
        <div class="payment-actions">
          <button type="submit" class="btn btn-primary">Send message</button>
          <button type="button" class="btn btn-secondary back-btn" id="supportBackBtn">Back to pass</button>
        </div>
      </form>
      <p class="support-success" id="supportSuccess">Successfully submitted. Someone will reply back within 24 hours.</p>
    </div>
  </div>

  <div class="onboarding-overlay" id="onboardingOverlay">
    <div class="onboarding-card">
      <span class="onboarding-steps" id="onboardingIndicator">Step 1 of 3</span>
      <h3 id="onboardingTitle">Welcome to FoCo After Dark</h3>
      <p id="onboardingBody">Use your pass to redeem perks, flash your QR, and get green-lit instantly.</p>
      <button type="button" class="btn btn-primary" id="onboardingNext">Next</button>
      <button type="button" class="btn btn-secondary" id="onboardingSkip" style="margin-top:8px;">Skip for now</button>
    </div>
  </div>

  <footer class="global-footer">Â© 2026 Dreeboy LLC</footer>

  <!-- Firebase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signInWithCustomToken,
      setPersistence,
      browserLocalPersistence,
      browserSessionPersistence,
      updateProfile,
      signOut,
      signInAnonymously,
      sendPasswordResetEmail,
      verifyPasswordResetCode,
      confirmPasswordReset
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { getAnalytics, isSupported as analyticsIsSupported } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      deleteDoc,
      collection,
      getDocs,
      onSnapshot,
      query,
      where,
      orderBy,
      limit,
      addDoc,
      serverTimestamp,
      Timestamp,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-functions.js";

    // Your Firebase config from console
    const firebaseConfig = {
      apiKey: "AIzaSyBSkRskzE8Kj0CR-ckU3Kas1ZjFpNBZCss",
      authDomain: "foco-after-dark.firebaseapp.com",
      projectId: "foco-after-dark",
      storageBucket: "foco-after-dark.firebasestorage.app",
      messagingSenderId: "962947086594",
      appId: "1:962947086594:web:9c931c93a90992f4826a1b",
      measurementId: "G-FCLG1RNRYZ"
    };

    const app = initializeApp(firebaseConfig);
    const firebaseAuth = getAuth(app);
    const db = getFirestore(app);
    const BETA_FALLBACK_EMAIL = "beta@focoafterdark.com";
    const BETA_FALLBACK_CODE = "beta";
    let functionsClient = null;
    try {
      functionsClient = getFunctions(app, "us-central1");
    } catch (err) {
      // Functions client may not be available in older environments â€” fallback will be used.
      console.warn('Functions client unavailable', err);
    }
    let analytics = null;
    let anonPromise = null;
    let betaPassMode = localStorage.getItem("betaSkipActive") === "true";
    let staffMessagesUnsub = null;
    let ceoMessagesUnsub = null;
    let closeOutReportsUnsub = null;
    let staffRedemptionUnsubs = [];
    let staffMessagesCache = [];
    let ceoMessagesCache = [];
    let venuePerksCache = {};
    if (betaPassMode) {
      localStorage.removeItem("betaSkipActive");
      betaPassMode = false;
    }
    analyticsIsSupported()
      .then((supported) => {
        if (supported) {
          analytics = getAnalytics(app);
        }
      })
      .catch(() => {
        // Analytics isnâ€™t available (e.g. served from file:// or unsupported browser). Ignore silently.
      });
    // Avoid auto-creating anonymous accounts; sign in only when needed.

    function attachGlobalErrorHandlers() {
      const ensureBanner = () => {
        let el = document.getElementById("appErrorBanner");
        if (!el) {
          el = document.createElement("div");
          el.id = "appErrorBanner";
          el.style.position = "fixed";
          el.style.top = "12px";
          el.style.left = "50%";
          el.style.transform = "translateX(-50%)";
          el.style.background = "rgba(239, 68, 68, 0.95)";
          el.style.color = "#fff";
          el.style.padding = "10px 16px";
          el.style.borderRadius = "999px";
          el.style.fontSize = "13px";
          el.style.zIndex = "9999";
          el.style.boxShadow = "0 10px 30px rgba(0,0,0,0.35)";
          document.body.appendChild(el);
        }
        return el;
      };
      window.addEventListener("error", (event) => {
        if (!event?.message) return;
        console.error("Global error:", event);
        const banner = ensureBanner();
        const location = event.filename ? ` (${event.filename}:${event.lineno || 0})` : "";
        banner.textContent = `Error: ${event.message}${location}`;
      });
      window.addEventListener("unhandledrejection", (event) => {
        const message = event.reason?.message || event.reason || "Unhandled promise rejection";
        console.error(event);
        const banner = ensureBanner();
        banner.textContent = `Error: ${message}`;
      });
    }
    attachGlobalErrorHandlers();

    function stopIdleTimer() {
      if (idleTimer) clearTimeout(idleTimer);
      idleTimer = null;
      idleActive = false;
    }
    async function handleIdleTimeout() {
      stopIdleTimer();
      try {
        await signOut(firebaseAuth);
      } catch (err) {
        console.warn("Auto sign-out skipped:", err);
      }
      staffSession = null;
      localStorage.removeItem("staffSession");
      exitBetaPassMode();
      onboardingMembershipFlow = false;
      forceMembershipScreen = false;
      ceoSession = false;
      isCeoAccount = false;
      ceoPreviewTier = null;
      updateCeoPassUI();
      pendingMembershipTier = null;
      resetPaymentForm();
      resetSupportForm();
      applyAccentTheme("cyan");
      localStorage.removeItem(ACCENT_KEY);
      localStorage.removeItem(AVATAR_COLOR_KEY);
      localStorage.removeItem(BG_KEY);
      localStorage.removeItem(BG_KEY);
      applyBackgroundTheme("default");
      memberProfile = null;
      memberDocRef = null;
      applyRememberedEmailToForm();
      showScreen("landing");
    }
    function resetIdleTimer() {
      if (!idleActive) return;
      if (idleTimer) clearTimeout(idleTimer);
      idleTimer = setTimeout(handleIdleTimeout, IDLE_TIMEOUT_MS);
    }

    function updateMembershipStatusUI(opts = {}) {
      if (!statusPill) return;
      const status = (opts.status || memberProfile?.paymentStatus || "active").toLowerCase();
      const paused = opts.paused === true || !!memberProfile?.paused;
      statusPill.classList.remove("vip-status", "ceo", "danger");
      let text = "Active Pass";
      let detail = "";
      if (paused) {
        text = "Paused";
        statusPill.classList.add("danger");
        detail = "Your account is paused. Contact support.";
      } else if (status === "past_due") {
        text = "Past due";
        statusPill.classList.add("danger");
        detail = "Payment failed. Update billing to continue.";
      } else {
        if (memberProfile?.ceo || isCeoActive()) {
          statusPill.classList.add("ceo");
          text = "CEO";
        } else if (currentMembershipTier === "vip") {
          statusPill.classList.add("vip-status");
          text = "VIP Member";
        }
        detail = "Status: Active";
      }
      statusPill.textContent = text;
      if (document.getElementById("membershipStatusDetail")) {
        document.getElementById("membershipStatusDetail").textContent = detail;
      }
      updateQuickStrip();
    }
    function startIdleTimer() {
      stopIdleTimer();
    }
    ["mousemove", "keydown", "touchstart", "click"].forEach(evt => {
      document.addEventListener(evt, resetIdleTimer, { passive: true });
    });

    const screens = {
      landing: document.getElementById("landingScreen"),
      auth: document.getElementById("authScreen"),
      membership: document.getElementById("membershipScreen"),
      payment: document.getElementById("paymentScreen"),
      pass: document.getElementById("passScreen"),
      venues: document.getElementById("venuesScreen"),
      support: document.getElementById("supportScreen"),
      staffLogin: document.getElementById("staffLoginScreen"),
      staffPortal: document.getElementById("staffPortalScreen"),
      ceoPortal: document.getElementById("ceoPortalScreen"),
      scanConfirm: document.getElementById("scanConfirmScreen"),
    };
    let memberProfile = null;
    let staffSession = null;
    const REWARDS_KEY = "rewardsProgress";
    const BADGES_KEY = "foco_badges_v1";
    const DEAL_CODES_KEY = "dealCodesCache";
    const AVATAR_COLOR_KEY = "avatarColorLast";
    const BG_KEY = "bgTheme";
    const ACHIEVEMENTS_KEY = "achievementsMap";
    const REMEMBER_EMAIL_KEY = "rememberedEmail";
    const AVATAR_COLORS = ["#22d3ee", "#f472b6", "#fbbf24", "#a855f7", "#22c55e", "#0ea5e9", "#ef4444", "#8b5cf6"];
    const BUILD_VERSION = "2025.12.15.1";
    let ceoHealthUnsub = null;
    let settingsUnsub = null;
    let settingsPollTimer = null;
    let rewardsProgress = { count: 0, threshold: 5, available: false, rewardType: null };
    let memberDocRef = null;
    let currentPassCode = null;
    let onboardingMembershipFlow = false;
    let forceMembershipScreen = false;
    let isLaunched = false;
    let appLocked = false;
    let appLockedAt = null;
    let appLockOverride = false;
    let appLockSignoutPending = false;
    const PENDING_MEMBERSHIP_STORAGE_KEY = "pendingMembershipUser";

    // Temporarily bypass membership gating to avoid forced redirects
    function requiresMembershipSelection() {
      return false;
    }

    function withTimeout(promise, ms = 3500) {
      let timer;
      return Promise.race([
        promise,
        new Promise((_, reject) => {
          timer = setTimeout(() => reject(new Error("timeout")), ms);
        })
      ]).finally(() => clearTimeout(timer));
    }

    async function ensureFirebaseUser() {
      if (!firebaseAuth) return null;
      if (firebaseAuth.currentUser) return firebaseAuth.currentUser;
      if (betaPassMode || localStorage.getItem("betaSkipActive") === "true") {
        return null;
      }
      if (anonPromise) return anonPromise;
      anonPromise = signInAnonymously(firebaseAuth)
        .then(() => firebaseAuth.currentUser)
        .catch((err) => {
          console.warn("Anonymous sign-in failed (offline or rules)", err);
          return null;
        })
        .finally(() => {
          anonPromise = null;
        });
      return anonPromise;
    }

    function useCloudProfile() {
      const user = firebaseAuth?.currentUser;
      return !!(db && user && !betaPassMode && !user.isAnonymous);
    }

    function allowLocalCache() {
      return !useCloudProfile();
    }

    function showScreen(name) {
      if (name === "pass" && requiresMembershipSelection()) {
        name = "membership";
      }
      Object.values(screens).forEach(s => s.classList.remove("active", "screen-in"));
      screens[name].classList.add("active");
      if (screens[name]) {
        screens[name].classList.remove("screen-in");
        void screens[name].offsetWidth;
        screens[name].classList.add("screen-in");
      }
      if (name === "landing" || name === "pass") {
        updateRandomTestimonial();
      }
      if (name === "landing") {
        setLandingTagline();
        if (landingRefreshBtn) landingRefreshBtn.style.display = "inline-flex";
      } else {
        if (landingRefreshBtn) landingRefreshBtn.style.display = "none";
      }
      if (name === "auth") {
        applyRememberedEmailToForm();
      }
      if (name === "staffLogin") {
        openStaffGate();
      } else {
        closeStaffGate();
      }
      if (name === "pass") {
        triggerPassIntro();
        maybeShowOnboarding();
        startIdleTimer();
      } else {
        if (name === "staffPortal" || name === "ceoPortal" || name === "venues") {
          startIdleTimer();
          // Reveal portal contents with smooth staggered animation
          revealPortal(name);
          if (name === "staffPortal" && staffSession?.venue) {
            startStaffMessagesListener(staffSession.venue);
          }
          if (name === "ceoPortal" && isCeoAccount) {
            startCeoMessagesListener();
          }
        } else {
          stopIdleTimer();
        }
      }
    }

    // Stagger reveal for containers marked with `.smooth-enter`
    function revealPortal(name) {
      try {
        const sc = screens[name];
        if (!sc) return;
        // remove revealed from any other containers first
        document.querySelectorAll('.smooth-enter.revealed').forEach(el => el.classList.remove('revealed'));
        const containers = Array.from(sc.querySelectorAll('.smooth-enter'));
        if (window.gsap && typeof gsap === 'function') {
          containers.forEach((c, i) => {
            const kids = Array.from(c.children || []);
            gsap.killTweensOf(kids);
            gsap.fromTo(kids, { opacity: 0, y: 18, scale: 0.995 }, { opacity: 1, y: 0, scale: 1, stagger: { each: 0.04, from: 'start' }, duration: 0.58, ease: 'power3.out', delay: i * 0.08 + 0.06 });
            setTimeout(() => c.classList.add('revealed'), (i * 80) + 120);
          });
        } else {
          containers.forEach((c, i) => {
            setTimeout(() => {
              c.classList.add('revealed');
              const kids = Array.from(c.children || []);
              kids.forEach((k, j) => { k.style.transitionDelay = `${(j * 35)}ms`; });
            }, i * 80 + 60);
          });
        }
      } catch (err) {
        console.warn('revealPortal error', err);
      }
    }

    function triggerPassIntro() {
      if (!passCard) return;
      passCard.classList.remove("intro");
      // force reflow to restart animation
      void passCard.offsetWidth;
      passCard.classList.add("intro");
    }

    // Landing buttons (guarded to avoid null errors)
    const landingGetPassBtn = document.getElementById("landingGetPassBtn");
    const landingLoginLink = document.getElementById("landingLoginLink");
    const landingStaffLogin = document.getElementById("landingStaffLogin");
    if (landingGetPassBtn) {
      landingGetPassBtn.addEventListener("click", () => {
        authMode = "signup";
        updateAuthModeText();
        showScreen("auth");
      });
    }
    if (landingLoginLink) {
      landingLoginLink.addEventListener("click", () => {
        authMode = "login";
        updateAuthModeText();
        showScreen("auth");
      });
    }
    // Sticky staff shortcuts
    document.querySelectorAll("[data-scroll]").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        const targetId = btn.dataset.scroll;
        const target = targetId ? document.getElementById(targetId) : null;
        if (target) target.scrollIntoView({ behavior: "smooth", block: "start" });
      });
    });

    // Auth mode toggle
    let authMode = "signup"; // or "login"
    const authModeText = document.getElementById("authModeText");
    const authToggleText = document.getElementById("authToggleText");
    const authSubmitBtn = document.getElementById("authSubmitBtn");
    const authError = document.getElementById("authError");
    const authForm = document.getElementById("authForm");
    const authEmailLabel = document.getElementById("authEmailLabel");
    const authEmail = document.getElementById("authEmail");
    const authPassword = document.getElementById("authPassword");
    const rememberMe = document.getElementById("rememberMe");
    const firstNameInput = document.getElementById("firstName");
    const lastNameInput = document.getElementById("lastName");
    const usernameInput = document.getElementById("username");
    const birthDateInput = document.getElementById("birthDate");
    const genderSelect = document.getElementById("genderSelect");
    const signupOnlyFields = document.querySelectorAll(".signup-only");
    const signupConfirmModal = document.getElementById("signupConfirmModal");
    const signupConfirmBtn = document.getElementById("signupConfirmBtn");
    const signupBackBtn = document.getElementById("signupBackBtn");
    const forgotPasswordLink = document.getElementById("forgotPasswordLink");
    const forgotPasswordModal = document.getElementById("forgotPasswordModal");
    const forgotPasswordForm = document.getElementById("forgotPasswordForm");
    const forgotPasswordEmail = document.getElementById("forgotPasswordEmail");
    const forgotPasswordCancel = document.getElementById("forgotPasswordCancel");
    const resetPasswordModal = document.getElementById("resetPasswordModal");
    const resetPasswordEmail = document.getElementById("resetPasswordEmail");
    const resetPasswordForm = document.getElementById("resetPasswordForm");
    const resetPasswordInput = document.getElementById("resetPasswordInput");
    const resetPasswordError = document.getElementById("resetPasswordError");
    const resetPasswordCancel = document.getElementById("resetPasswordCancel");
    const resetPasswordSuccess = document.getElementById("resetPasswordSuccess");
    const resetPasswordReturn = document.getElementById("resetPasswordReturn");
    const alertForm = document.getElementById("alertForm");
    const alertTitleInput = document.getElementById("alertTitle");
    const alertDetailInput = document.getElementById("alertDetail");
    const usernameModal = document.getElementById("usernameModal");
    const usernameClose = document.getElementById("usernameClose");
    const usernameEditInput = document.getElementById("usernameEditInput");
    const usernameEditError = document.getElementById("usernameEditError");
    const usernameCancel = document.getElementById("usernameCancel");
    const usernameSave = document.getElementById("usernameSave");
    const venueStars = document.getElementById("venueStars");
    const venueDetailRating = document.getElementById("venueDetailRating");
    const vibeButtons = document.querySelectorAll(".vibe-btn");
    const alertAudience = document.getElementById("alertAudience");
    const alertMetaInput = document.getElementById("alertMeta");
    const alertExpiresInput = document.getElementById("alertExpires");
    const alertError = document.getElementById("alertError");
    const alertSuccess = document.getElementById("alertSuccess");
    const alertPreview = document.getElementById("alertPreview");
    const skipLoginBetaLink = document.getElementById("skipLoginBeta");
    const authBackBtn = document.getElementById("authBackBtn");
    if (skipLoginBetaLink) {
      skipLoginBetaLink.addEventListener("click", (e) => {
        e.preventDefault();
        enterBetaPassMode();
      });
    }
    if (authBackBtn) {
      authBackBtn.addEventListener("click", () => {
        authError.textContent = "";
        showScreen("landing");
      });
    }

    function updateAuthModeText() {
      if (authMode === "signup") {
        authModeText.textContent = "Create your account to get the Nightlife Pass.";
        authToggleText.innerHTML =
          'Already have an account? <span id="authToggleLink" class="linkish">Log in instead</span>';
        authSubmitBtn.textContent = "Create account & get pass";
        if (authEmailLabel) authEmailLabel.textContent = "Email";
        signupOnlyFields.forEach(el => {
          el.style.display = "block";
        });
      } else {
        authModeText.textContent = "Log in to access your Nightlife Pass.";
        authToggleText.innerHTML =
          'Need an account? <span id="authToggleLink" class="linkish">Sign up instead</span>';
        authSubmitBtn.textContent = "Log in";
        if (authEmailLabel) authEmailLabel.textContent = "Email or Username";
        signupOnlyFields.forEach(el => {
          el.style.display = "none";
        });
      }
      // Reattach listener because we rewrote innerHTML
      document.getElementById("authToggleLink").addEventListener("click", () => {
        authMode = authMode === "signup" ? "login" : "signup";
        updateAuthModeText();
      });
    }
    updateAuthModeText();

    function showSignupConfirmModal() {
      if (signupConfirmModal) signupConfirmModal.classList.add("active");
    }
    function hideSignupConfirmModal() {
      if (signupConfirmModal) signupConfirmModal.classList.remove("active");
    }
    function showForgotPasswordModal() {
      if (forgotPasswordModal) forgotPasswordModal.classList.add("active");
      if (forgotPasswordEmail) forgotPasswordEmail.value = authEmail.value.trim() || "";
    }
    function hideForgotPasswordModal() {
      if (forgotPasswordModal) forgotPasswordModal.classList.remove("active");
    }
    let pendingResetCode = null;
    function showResetPasswordModal(email, code) {
      pendingResetCode = code;
      if (resetPasswordEmail) resetPasswordEmail.textContent = `for ${email}`;
      if (resetPasswordInput) resetPasswordInput.value = "";
      if (resetPasswordError) resetPasswordError.textContent = "";
      if (resetPasswordSuccess) resetPasswordSuccess.style.display = "none";
      if (resetPasswordForm) resetPasswordForm.style.display = "block";
      if (resetPasswordModal) resetPasswordModal.classList.add("active");
    }
    function hideResetPasswordModal() {
      pendingResetCode = null;
      if (resetPasswordModal) resetPasswordModal.classList.remove("active");
    }
    function getPasswordResetActionSettings() {
      const origin = window.location.origin;
      return {
        url: `${origin}?mode=resetPassword`,
        handleCodeInApp: true
      };
    }
    function clearPasswordResetParams() {
      try {
        const url = new URL(window.location.href);
        ["mode", "oobCode", "continueUrl", "lang"].forEach(key => url.searchParams.delete(key));
        const query = url.searchParams.toString();
        window.history.replaceState({}, document.title, url.pathname + (query ? `?${query}` : "") + url.hash);
      } catch (err) {
        // ignore
      }
    }
    let pendingSignupData = null;
    let currentMembershipTier = null;
    let ceoSession = false;
    let ceoPreviewTier = null;
    let isCeoAccount = false;
    let isBetaAccount = false;
    function isFreeMember(profile = memberProfile) {
      return Boolean(profile?.freeMembership);
    }
    function hasVipAccess() {
      return currentMembershipTier === "vip" || isCeoActive() || isFreeMember();
    }
    if (signupBackBtn) {
      signupBackBtn.addEventListener("click", () => {
        pendingSignupData = null;
        hideSignupConfirmModal();
      });
    }
    if (signupConfirmBtn) {
      signupConfirmBtn.addEventListener("click", async () => {
        if (!pendingSignupData) {
          hideSignupConfirmModal();
          return;
        }
        hideSignupConfirmModal();
      onboardingMembershipFlow = true;
      forceMembershipScreen = true;
      showScreen("membership");
      try {
        await completeSignup(pendingSignupData);
      } catch (err) {
        console.error("Signup confirmation failed:", err);
      }
    });
  }
  if (forgotPasswordLink) {
    const openForgotModal = () => showForgotPasswordModal();
    forgotPasswordLink.addEventListener("click", openForgotModal);
    forgotPasswordLink.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        openForgotModal();
      }
    });
  }
  if (forgotPasswordCancel) {
    forgotPasswordCancel.addEventListener("click", () => {
      hideForgotPasswordModal();
    });
  }
  if (forgotPasswordModal) {
    forgotPasswordModal.addEventListener("click", (e) => {
      if (e.target === forgotPasswordModal) hideForgotPasswordModal();
    });
  }
  if (forgotPasswordForm) {
    forgotPasswordForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = forgotPasswordEmail.value.trim();
      if (!email) {
        authError.textContent = "Enter your email to reset the password.";
        return;
      }
      authError.textContent = "Sending reset linkâ€¦";
      try {
        await sendPasswordResetEmail(firebaseAuth, email, getPasswordResetActionSettings());
        hideForgotPasswordModal();
        authError.textContent = "Reset link sent. Be sure to check your inbox and your spam/junk folders.";
      } catch (err) {
        authError.textContent = formatAuthError(err);
      }
    });
  }

  if (resetPasswordCancel) {
    resetPasswordCancel.addEventListener("click", () => {
      hideResetPasswordModal();
      clearPasswordResetParams();
    });
  }
  if (resetPasswordReturn) {
    resetPasswordReturn.addEventListener("click", () => {
      hideResetPasswordModal();
      clearPasswordResetParams();
      authMode = "login";
      updateAuthModeText();
      showScreen("auth");
    });
  }
  if (resetPasswordModal) {
    resetPasswordModal.addEventListener("click", (e) => {
      if (e.target === resetPasswordModal) {
        hideResetPasswordModal();
        clearPasswordResetParams();
      }
    });
  }
  if (resetPasswordForm) {
    resetPasswordForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!pendingResetCode) return;
      const newPassword = resetPasswordInput.value.trim();
      if (!newPassword || newPassword.length < 6) {
        resetPasswordError.textContent = "Password must be at least 6 characters.";
        return;
      }
      resetPasswordError.textContent = "Saving new passwordâ€¦";
      try {
        await confirmPasswordReset(firebaseAuth, pendingResetCode, newPassword);
        resetPasswordError.textContent = "";
        resetPasswordForm.style.display = "none";
        if (resetPasswordSuccess) {
          resetPasswordSuccess.style.display = "block";
        }
      } catch (err) {
        resetPasswordError.textContent = formatAuthError(err);
      }
    });
  }

    if (alertForm) {
      alertForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (alertError) alertError.textContent = "";
        if (alertSuccess) alertSuccess.classList.remove("visible");
        if (!staffSession) {
          if (alertError) alertError.textContent = "Log in as venue staff to post an alert.";
          return;
        }
        const audience = (alertAudience?.value || "all").toLowerCase();
        const title = alertTitleInput.value.trim();
        const detail = alertDetailInput.value.trim();
        const venueName = venuesInfo[staffSession.venue]?.name || "FoCo venue";
        const metaInput = alertMetaInput.value.trim();
        const meta = metaInput || venueName;
        const expiresValue = alertExpiresInput.value;
        if (!title || !detail || !expiresValue) {
          if (alertError) alertError.textContent = "Headline, details, and expiry are required.";
          return;
        }
        const expiresIso = expiresValue.length === 16 ? `${expiresValue}:00` : expiresValue;
        const expiresDate = new Date(expiresIso);
        if (Number.isNaN(expiresDate.getTime())) {
          if (alertError) alertError.textContent = "Enter a valid expiry date (YYYY-MM-DD HH:MM).";
          return;
        }
        const venueId = staffSession.venue;
        const useLocalCache = allowLocalCache();

        if (audience === "vip") {
          // VIP-only path (previously vipDealForm)
          const localDeal = {
            venueId,
            venueName,
            title,
            detail,
            meta: meta || `VIP Â· ${venueName}`,
            expiresAt: expiresDate.toISOString(),
            updatedAt: new Date().toISOString(),
          };
          if (useLocalCache) {
            vipDealsCache[venueId] = localDeal;
            saveVipDealsToStorage(vipDealsCache);
            renderVipDealForMember();
            renderStaffVipDeal();
            refreshAlertsTicker();
            if (alertSuccess) {
              alertSuccess.textContent = "VIP deal published.";
              alertSuccess.classList.add("visible");
              setTimeout(() => alertSuccess.classList.remove("visible"), 2500);
            }
          }
          try {
            if (db) {
              await ensureFirebaseUser();
              await setDoc(doc(db, "vipDeals", venueId), {
                venueId,
                venueName,
                title,
                detail,
                meta: meta || `VIP Â· ${venueName}`,
                expiresAt: Timestamp.fromDate(expiresDate),
                updatedAt: serverTimestamp(),
              });
              await refreshVipDeals();
              if (!useLocalCache && alertSuccess) {
                alertSuccess.textContent = "VIP deal published.";
                alertSuccess.classList.add("visible");
                setTimeout(() => alertSuccess.classList.remove("visible"), 2500);
              }
            }
          } catch (err) {
            console.error("Failed to publish VIP deal", err);
            if (alertError) alertError.textContent = "Could not save VIP deal. Try again.";
          }
        } else {
          // All members alert path
          if (useLocalCache) {
            const provisionalAlert = {
              id: `local-${Date.now()}`,
              venueId,
              venueName,
              title,
              detail,
              meta,
              expiresAt: expiresDate.getTime(),
              createdAt: Date.now(),
            };
            tonightAlerts = [provisionalAlert, ...tonightAlerts];
            saveAlertsToStorage(tonightAlerts);
            refreshAlertsTicker();
            renderStaffAlertPreview();
            if (alertSuccess) {
              alertSuccess.textContent = "Alert posted for members.";
              alertSuccess.classList.add("visible");
              setTimeout(() => alertSuccess.classList.remove("visible"), 2500);
            }
          }
          try {
            if (db) {
              await ensureFirebaseUser();
              const alertDoc = doc(collection(db, "alerts"));
              await setDoc(alertDoc, {
                venueId,
                venueName,
                title,
                detail,
                meta,
                expiresAt: Timestamp.fromDate(expiresDate),
                createdAt: serverTimestamp(),
              });
              await refreshTonightAlerts();
              if (!useLocalCache && alertSuccess) {
                alertSuccess.textContent = "Alert posted for members.";
                alertSuccess.classList.add("visible");
                setTimeout(() => alertSuccess.classList.remove("visible"), 2500);
              }
            }
          } catch (err) {
            console.error("Failed to post alert (using local only):", err);
            if (alertError) alertError.textContent = "Posted locally. Cloud sync blocked.";
          }
        }

        // clear inputs
        alertTitleInput.value = "";
        alertDetailInput.value = "";
        alertMetaInput.value = "";
        alertExpiresInput.value = "";
      });
    }

  (async function handlePasswordResetFromUrl() {
    try {
      const params = new URLSearchParams(window.location.search);
      const mode = params.get("mode");
      const code = params.get("oobCode");
      if (mode === "resetPassword" && code) {
        const email = await verifyPasswordResetCode(firebaseAuth, code);
        showResetPasswordModal(email, code);
        clearPasswordResetParams();
      }
    } catch (err) {
      authError.textContent = formatAuthError(err);
      clearPasswordResetParams();
    }
  })();

    function isTwentyOneOrOlder(birthDate) {
      if (!(birthDate instanceof Date) || Number.isNaN(birthDate.getTime())) {
        return false;
      }
      const today = new Date();
      let age = today.getFullYear() - birthDate.getFullYear();
      const monthDiff = today.getMonth() - birthDate.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age -= 1;
      }
      return age >= 21;
    }

    function loadRememberedEmail() {
      const saved = localStorage.getItem(REMEMBER_EMAIL_KEY);
      if (saved && authEmail) {
        authEmail.value = saved;
        if (rememberMe) rememberMe.checked = true;
      }
    }
    function applyRememberedEmailToForm() {
      if (!authEmail || !authPassword) return;
      const saved = localStorage.getItem(REMEMBER_EMAIL_KEY);
      if (saved) {
        authEmail.value = saved;
        if (rememberMe) rememberMe.checked = true;
      } else {
        authEmail.value = "";
        if (rememberMe) rememberMe.checked = false;
      }
      authPassword.value = "";
    }
    function updateRememberedEmail(email) {
      if (email) {
        localStorage.setItem(REMEMBER_EMAIL_KEY, email);
      } else {
        localStorage.removeItem(REMEMBER_EMAIL_KEY);
      }
    }
    loadRememberedEmail();

    authForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      authError.textContent = "";
      let email = authEmail.value.trim();
      const password = authPassword.value.trim();
      const firstName = firstNameInput.value.trim();
      const lastName = lastNameInput.value.trim();
      const username = usernameInput?.value.trim();
      const birthDateValue = birthDateInput?.value;
      const genderValue = genderSelect?.value;
      let fullName = "";
      let birthDateISO = "";
      if (!email || !password) {
        authError.textContent = "Please enter email and password.";
        return;
      }
      const remember = !!(rememberMe && rememberMe.checked);
      if (isCeoCredentials(email, password)) {
        try {
          await setPersistence(firebaseAuth, remember ? browserLocalPersistence : browserSessionPersistence);
          try {
            await signInWithEmailAndPassword(firebaseAuth, email, password);
          } catch (err) {
            if (err?.code === "auth/user-not-found") {
              await createUserWithEmailAndPassword(firebaseAuth, email, password);
              try {
                await updateProfile(firebaseAuth.currentUser, { displayName: "FoCo CEO" });
              } catch (_) {}
            } else {
              throw err;
            }
          }
          updateRememberedEmail(remember ? email : null);
          if (firebaseAuth.currentUser) {
            await handleAuthenticatedUser(firebaseAuth.currentUser);
          }
        } catch (err) {
          authError.textContent = formatAuthError(err);
        }
        return;
      }
      if (authMode === "signup") {
        if (!firstName || !lastName) {
          authError.textContent = "First and last name are required for verification.";
          return;
        }
        if (!birthDateValue) {
          authError.textContent = "Enter your birthdate to continue.";
          return;
        }
        const usernameCheck = validateUsername(username);
        if (!usernameCheck.ok) {
          authError.textContent = usernameCheck.message;
          return;
        }
        if (!genderValue) {
          authError.textContent = "Please select your gender.";
          return;
        }
        const birthDate = new Date(`${birthDateValue}T00:00:00`);
        if (!isTwentyOneOrOlder(birthDate)) {
          authError.textContent = "FoCo After Dark is 21+. Please enter a valid 21+ birthdate.";
          return;
        }
        birthDateISO = birthDate.toISOString();
        fullName = `${firstName} ${lastName}`;
        pendingSignupData = { email, password, fullName, birthDateISO, gender: genderValue, username: usernameCheck.value };
        showSignupConfirmModal();
        return;
      }
      // login: allow username or email
      if (authMode === "login") {
        const raw = email.trim();
        if (!isLikelyEmail(raw)) {
          await ensureFirebaseUser(); // ensure app + rules ready for lookups
          let resolved = resolveUsernameToEmail(raw.replace(/^@/, ""));
          if (!resolved) {
            resolved = await resolveUsernameToEmailCloud(raw);
          }
          if (!resolved) {
            authError.textContent = "Enter your email or a valid username.";
            return;
          }
          email = resolved;
        } else {
          email = raw;
        }
      }
      try {
        await setPersistence(firebaseAuth, remember ? browserLocalPersistence : browserSessionPersistence);
        await signInWithEmailAndPassword(firebaseAuth, email, password);
        updateRememberedEmail(remember ? email : null);
        if (firebaseAuth.currentUser) {
          await handleAuthenticatedUser(firebaseAuth.currentUser);
        }
      } catch (err) {
        authError.textContent = formatAuthError(err);
      }
    });

    async function completeSignup(data) {
      const { email, password, fullName, birthDateISO, gender, username } = data || {};
      if (!email || !password) {
        authError.textContent = "Missing required information. Please try again.";
        return;
      }
      try {
        const remember = !!(rememberMe && rememberMe.checked);
        await setPersistence(firebaseAuth, remember ? browserLocalPersistence : browserSessionPersistence);
        updateRememberedEmail(remember ? email : null);
        const cred = await createUserWithEmailAndPassword(firebaseAuth, email, password);
        if (cred?.user) {
          if (fullName) {
            await updateProfile(cred.user, { displayName: fullName });
          }
          const profilePayload = {};
          if (birthDateISO) profilePayload.birthDate = birthDateISO;
          if (fullName) profilePayload.legalName = fullName;
          if (gender) profilePayload.gender = gender;
          if (username) profilePayload.username = username;
          if (username) profilePayload.username = username;
          if (Object.keys(profilePayload).length) {
            if (db) {
              const memberRef = doc(db, "members", cred.user.uid);
              profilePayload.memberSince = new Date().toISOString();
              await setDoc(memberRef, profilePayload, { merge: true });
            } else if (allowLocalCache()) {
              localStorage.setItem(`memberMeta_${cred.user.uid}`, JSON.stringify(profilePayload));
            }
          }
      if (username && email) {
        saveUsernameMapEntry(username, email);
        if (db) {
          const unameDoc = doc(db, "usernames", username.trim().toLowerCase());
          await setDoc(unameDoc, {
            email,
            uid: cred.user.uid,
            passCode: (memberProfile?.passCode || "").toUpperCase(),
            createdAt: serverTimestamp()
          }, { merge: true });
        }
      }
      if (onboardingMembershipFlow) {
        localStorage.setItem(PENDING_MEMBERSHIP_STORAGE_KEY, cred.user.uid);
      }
      await handleAuthenticatedUser(cred.user);
      if (onboardingMembershipFlow) {
        showScreen("membership");
      }
      showAddHomeGate();
    }
  } catch (err) {
        authError.textContent = formatAuthError(err);
        onboardingMembershipFlow = false;
        forceMembershipScreen = false;
      } finally {
        pendingSignupData = null;
      }
    }

    function clearPendingMembershipFlagForUser(uid) {
      const stored = localStorage.getItem(PENDING_MEMBERSHIP_STORAGE_KEY);
      if (stored && (!uid || stored === uid)) {
        localStorage.removeItem(PENDING_MEMBERSHIP_STORAGE_KEY);
      }
    }

    function formatAuthError(err) {
      const code = err?.code || "";
      switch (code) {
        case "auth/invalid-credential":
        case "auth/wrong-password":
          return "Email or password is incorrect. Reset it if you forgot.";
        case "auth/user-not-found":
          return "No account exists for this email. Sign up first.";
        case "auth/too-many-requests":
          return "Too many attempts. Try again in a minute.";
        default:
          return err?.message || "Something went wrong. Try again.";
      }
    }

    function persistLocalPassCode(code) {
      const uid = firebaseAuth.currentUser?.uid;
      if (!uid || !code) return;
      if (!allowLocalCache()) return;
      localStorage.setItem(`passcode_${uid}`, code);
    }

    function persistLocalProfileUpdates(updates) {
      const uid = firebaseAuth.currentUser?.uid;
      if (!uid || !updates) return;
      if (!allowLocalCache()) return;
      if (updates.tier) localStorage.setItem(`membership_${uid}`, updates.tier);
      if (updates.passCode) localStorage.setItem(`passcode_${uid}`, updates.passCode);
      if (updates.memberSince) localStorage.setItem(`memberSince_${uid}`, updates.memberSince);
    }

    function buildLocalProfile(user) {
      const allowLocal = allowLocalCache();
      const uid = user?.uid;
      const storedTier = allowLocal && uid ? localStorage.getItem(`membership_${uid}`) : null;
      const tier = storedTier || null;
      const perksTier = tier || "standard";
      const passKey = uid ? `passcode_${uid}` : null;
      let passCode = allowLocal && passKey ? localStorage.getItem(passKey) : null;
      if (!passCode) {
        passCode = generateRedemptionCode();
        if (allowLocal && passKey) localStorage.setItem(passKey, passCode);
      }
      const memberSinceKey = uid ? `memberSince_${uid}` : null;
      let memberSince = allowLocal && memberSinceKey ? localStorage.getItem(memberSinceKey) : null;
      if (!memberSince) {
        memberSince = new Date().toISOString();
        if (allowLocal && memberSinceKey) localStorage.setItem(memberSinceKey, memberSince);
      }
      return {
        tier,
        passCode,
        extraVouchers: { ...EXTRA_DEFAULTS },
        perks: { tier: perksTier, remaining: getDefaultPerkState(perksTier) },
        memberSince,
      };
    }

    function showPassLoading(message = "Syncing your passâ€¦") {
      if (offlineBadge) offlineBadge.classList.add("syncing");
      if (offlineCopy) offlineCopy.textContent = message;
    }

    function clearPassLoading() {
      if (offlineBadge) offlineBadge.classList.remove("syncing");
      if (offlineCopy) offlineCopy.textContent = "QR cached for instant scans.";
    }
    const confettiPalette = ["#22d3ee", "#f472b6", "#60a5fa", "#fbbf24"];
    let confettiInterval = null;
    function spawnConfettiPiece() {
      if (!confettiLayer) return;
      const piece = document.createElement("span");
      piece.className = "confetti-piece";
      piece.style.left = `${Math.random() * 100}%`;
      piece.style.background = confettiPalette[Math.floor(Math.random() * confettiPalette.length)];
      piece.style.animationDelay = `${Math.random() * 0.15}s`;
      piece.style.animationDuration = `${1.3 + Math.random() * 0.7}s`;
      piece.style.transform = `rotate(${Math.random() * 360}deg)`;
      piece.addEventListener("animationend", () => piece.remove());
      confettiLayer.appendChild(piece);
    }
    function startConfettiLoop() {
      if (!confettiLayer) return;
      stopConfettiLoop();
      confettiLayer.innerHTML = "";
      for (let i = 0; i < 24; i += 1) {
        spawnConfettiPiece();
      }
      confettiInterval = setInterval(() => {
        for (let i = 0; i < 6; i += 1) {
          spawnConfettiPiece();
        }
      }, 280);
    }
    function stopConfettiLoop() {
      if (confettiInterval) {
        clearInterval(confettiInterval);
        confettiInterval = null;
      }
      if (confettiLayer) confettiLayer.innerHTML = "";
    }

    async function loadMemberProfileWithTimeout(user, timeoutMs = 800) {
      if (!allowLocalCache()) {
        try {
          const profile = await withTimeout(loadMemberProfileForUser(user), timeoutMs);
          return profile;
        } catch (err) {
          console.warn("Profile load failed:", err);
          memberProfile = null;
          memberDocRef = null;
          return null;
        }
      }
      const timeoutPromise = new Promise(resolve => {
        setTimeout(() => {
          const localProfile = buildLocalProfile(user);
          memberProfile = localProfile;
          resolve(localProfile);
        }, timeoutMs);
      });
      try {
        const profile = await Promise.race([loadMemberProfileForUser(user), timeoutPromise]);
        return profile;
      } catch (err) {
        console.warn("Profile load race failed:", err);
        const fallback = buildLocalProfile(user);
        memberProfile = fallback;
        return fallback;
      }
    }

    async function handleAuthenticatedUser(user) {
      if (user?.isAnonymous) {
        if (staffSession || betaPassMode) {
          return;
        }
        isBetaAccount = false;
        showScreen("landing");
        clearPassRealtime();
        clearGlobalRealtime();
        clearPassLoading();
        return;
      }
      const isStaffAccount = user?.uid?.startsWith("staff_") || (user?.email || "").toLowerCase().startsWith("staff+");
      if (isStaffAccount) {
        return;
      }
      if (!user) {
        isBetaAccount = false;
        showScreen("landing");
        memberProfile = null;
        memberDocRef = null;
        clearPassRealtime();
        clearGlobalRealtime();
        clearPassLoading();
        return;
      }

      exitBetaPassMode();
      await loadMemberProfileWithTimeout(user);
      if (!memberProfile) {
        showToast("Unable to sync your profile. Check your connection and try again.");
        showScreen("landing");
        clearPassLoading();
        return;
      }

      const email = (user.email || "").toLowerCase();
      const passCode = (memberProfile?.passCode || "").toUpperCase();
      const isCeoProfile = email === "ceo@gmail.com";
      const isBetaProfile = email.includes("beta") || memberProfile?.tier === "beta";
      isBetaAccount = isBetaProfile;

      if (isLaunched && isBetaProfile) {
        showToast("Beta access is disabled in live mode.");
        try { await signOut(firebaseAuth); } catch (_) {}
        showScreen("landing");
        clearPassLoading();
        return;
      }

      // Force-clear any stale CEO flags/passcodes for regular users
      if (!isCeoProfile && memberProfile) {
        memberProfile.ceo = false;
        if ((memberProfile.passCode || "").toUpperCase() === CEO_PASS_ID) {
          memberProfile.passCode = "";
        }
        ceoSession = false;
        isCeoAccount = false;
        localStorage.removeItem("ceoSession");
        document.body.classList.remove("ceo-active");
      }

      applyAppLockState();
      if (appLocked && !isCeoProfile) {
        clearPassLoading();
        return;
      }

      updateLoginStatsForUser(user);

      if (isCeoProfile) {
        memberProfile = {
          ...(memberProfile || {}),
          tier: "ceo",
          ceo: true,
          passCode: passCode || CEO_PASS_ID
        };
        onboardingMembershipFlow = false;
        forceMembershipScreen = false;
        pendingMembershipTier = null;
        clearPendingMembershipFlagForUser(user.uid);
        if (allowLocalCache()) localStorage.setItem(`membership_${user.uid}`, "ceo");
        currentPassCode = memberProfile.passCode || CEO_PASS_ID;
        persistLocalPassCode(currentPassCode);
        applyMembershipToPass("ceo");
        document.body.classList.add("ceo-active");
        ensurePassCode();
        applyCachedStats();
        ensurePointsEntry();
        loadAccentTheme();
        ceoSession = true;
        isCeoAccount = true;
        localStorage.setItem("ceoSession", "true");
        maybeRecountMembers();
        updateCeoPassUI();
        renderCeoIssued();
        attachCeoReviewsRealtime();
        renderCeoReviews();
        renderPassIdentity(user);
        refreshMemberStats();
        updateMembershipStatusUI({ status: memberProfile?.paymentStatus, paused: memberProfile?.paused });
        attachRealtime();
        startCeoMessagesListener();
        attachCloseOutReportsRealtime();
        updatePointsUI();
        updateQuickStrip();
        showScreen("pass");
        clearPassLoading();
        return;
      }

      if (isBetaProfile) {
        memberProfile = { ...(memberProfile || {}), tier: "standard" };
        onboardingMembershipFlow = false;
        forceMembershipScreen = false;
        pendingMembershipTier = null;
        clearPendingMembershipFlagForUser(user.uid);
        if (allowLocalCache()) localStorage.setItem(`membership_${user.uid}`, "standard");
        applyMembershipToPass("standard");
        ensurePassCode();
        applyCachedStats();
        loadAccentTheme();
        showScreen("pass");
        clearPassLoading();
        return;
      }

      if (memberProfile?.paused) {
        updateMembershipStatusUI({ status: "paused" });
        showToast("Your account is paused. Please contact support.");
        showScreen("landing");
        clearPassLoading();
        return;
      }

      const pendingUid = localStorage.getItem(PENDING_MEMBERSHIP_STORAGE_KEY);
      let storedTier = memberProfile?.tier || (allowLocalCache() && user.uid ? localStorage.getItem(`membership_${user.uid}`) : null);
      if (memberProfile?.freeMembership) storedTier = "free";
      if (pendingUid && pendingUid === user.uid) {
        onboardingMembershipFlow = true;
      }
      const needsMembership = onboardingMembershipFlow || !storedTier;
      if (needsMembership) {
        // Default anyone missing a tier to standard and proceed
        storedTier = "standard";
        memberProfile = { ...(memberProfile || {}), tier: storedTier };
        if (user.uid) {
          if (allowLocalCache()) localStorage.setItem(`membership_${user.uid}`, storedTier);
          clearPendingMembershipFlagForUser(user.uid);
        }
      }

      clearPendingMembershipFlagForUser(user.uid);
      forceMembershipScreen = false;
      const tierToApply = storedTier || "standard";
      applyMembershipToPass(tierToApply);
      // Auto-renew membership perks monthly using stored card on file
      checkMembershipAutoRenew(storedTier || "standard");
      // Apply any pending upgrade/downgrade on the 1st of the month
      applyPendingTierIfDue();
      updateMembershipStatusUI({ status: memberProfile?.paymentStatus, paused: memberProfile?.paused });
      ensurePassCode();
      applyCachedStats();
      ensurePointsEntry();
      loadAccentTheme();
      showPassLoading();
      renderPassIdentity(user);
      refreshMemberStats();
      showFreeWelcomeToast();
      processFreeFlags(memberProfile?.passCode || currentPassCode);
      updateNightWheelUI();
      attachRealtime();
      if (memberProfile?.username && firebaseAuth.currentUser?.email) {
        saveUsernameMapEntry(memberProfile.username, firebaseAuth.currentUser.email);
      }
      clearPassLoading();

      if (!membershipSelected()) {
        showScreen("membership");
        return;
      }
      showScreen("pass");
    }

    // Pass screen elements
    const userMiniDisplay = document.getElementById("userMiniDisplay");
    const refreshBtn = document.getElementById("refreshBtn");
    const landingRefreshBtn = document.getElementById("landingRefreshBtn");
    const logoutLink = document.getElementById("logoutLink");
    const passUserName = document.getElementById("passUserName");
    const userUsername = document.getElementById("userUsername");
    const editUsernameBtn = document.getElementById("editUsernameBtn");
    const avatarInitials = document.getElementById("avatarInitials");
    const passTierText = document.getElementById("passTierText");
    const profileBadges = document.getElementById("profileBadges");
    const statusPill = document.getElementById("statusPill");
    const perksListEl = document.getElementById("perksList");
    const passQrImage = document.getElementById("passQrImage");
    const passCodeText = document.getElementById("passCodeText");
    const passIdTop = document.getElementById("passIdTop");
    const memberSinceText = document.getElementById("memberSinceText");
    const expiryText = document.getElementById("expiryText");
    const pointsBalance = document.getElementById("pointsBalance");
    const ceoPassBanner = document.getElementById("ceoPassBanner");
    const ceoPortalShortcut = document.getElementById("ceoPortalShortcut");
    const ceoVenueLog = document.getElementById("ceoVenueLog");
    const ceoVenueFilter = document.getElementById("ceoVenueFilter");
    const ceoVenueRange = document.getElementById("ceoVenueRange");
    const ceoCloseOutVenue = document.getElementById("ceoCloseOutVenue");
    const ceoCloseOutRange = document.getElementById("ceoCloseOutRange");
    const ceoCloseOutList = document.getElementById("ceoCloseOutList");
    const ceoCloseOutModal = document.getElementById("ceoCloseOutModal");
    const ceoCloseOutContent = document.getElementById("ceoCloseOutContent");
    const ceoCloseOutClose = document.getElementById("ceoCloseOutClose");
    const nightWheelSpinBtn = document.getElementById("nightWheelSpin");
    const nightWheelResult = document.getElementById("nightWheelResult");
    const nightWheelRemaining = document.getElementById("nightWheelRemaining");
    const landingTagline = document.getElementById("landingTagline");
    const addToHomeBtn = document.getElementById("addToHomeBtn");
    const currentUsersCount = document.getElementById("currentUsersCount");
    let deferredInstallPrompt = null;
    const addToHomeOverlay = document.getElementById("addToHomeOverlay");
    const addToHomeClose = document.getElementById("addToHomeClose");
    const LANDING_TAGLINES = [
      "Go out. Get rewarded.",
      "Unlock the night.",
      "Earn while you party.",
      "Your nightlife cheat code.",
      "Make your night worth more.",
      "If youâ€™re going outâ€¦ you might as well get rewarded for being bad.",
      "Where bad decisions come with perks.",
      "Youâ€™re one tap away from a better night than everyone else.",
      "Your best nights start with a little temptation.",
      "Where the wild nights pay off."
    ];
    const LANDING_SLIDES = [
      "assets/landing.jpg",
      "https://images.unsplash.com/photo-1605901309584-66bf3f02f5e3?auto=format&fit=crop&w=2000&q=80",
      "https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&w=2000&q=80",
      "https://images.unsplash.com/photo-1464375117522-1311d6a5b81f?auto=format&fit=crop&w=2000&q=80",
      "https://images.unsplash.com/photo-1496307042754-b4aa456c4a2d?auto=format&fit=crop&w=2000&q=80"
    ];
    const venuesTrigger = document.getElementById("venuesTrigger");
    const venuesBackBtn = document.getElementById("venuesBackBtn");
    const venueButtons = document.querySelectorAll(".venue-btn");
    const venueDetailModal = document.getElementById("venueDetailModal");
    const venueDetailClose = document.getElementById("venueDetailClose");
    const venueDetailName = document.getElementById("venueDetailName");
    const venueDetailAddress = document.getElementById("venueDetailAddress");
    const venueDetailPhone = document.getElementById("venueDetailPhone");
    const venueDetailHours = document.getElementById("venueDetailHours");
    const navMenuToggle = document.getElementById("navMenuToggle");
    // Visual helpers: motion & perf gating, parallax + confetti
    function prefersReducedMotion() {
      try {
        return window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      } catch (e) { return false; }
    }
    function isLowEndDevice() {
      try {
        const nav = navigator;
        if (nav && nav.connection) {
          if (nav.connection.saveData) return true;
          const et = nav.connection.effectiveType || '';
          if (['2g','slow-2g'].includes(et)) return true;
        }
        if (navigator.deviceMemory && navigator.deviceMemory < 1.5) return true;
      } catch (e) { /* ignore */ }
      return false;
    }
    function canAnimate() {
      return !prefersReducedMotion() && !isLowEndDevice();
    }

    // --- Particle system (subtle, low-overhead) ---
    function initCardParticles() {
      if (!canAnimate()) return;
      const canvas = document.getElementById("cardParticles");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      let w = 0, h = 0, dpr = Math.max(1, window.devicePixelRatio || 1);
      let particles = [];
      let rafId = null;
      function resize() {
        dpr = Math.max(1, window.devicePixelRatio || 1);
        w = Math.floor(window.innerWidth * dpr);
        h = Math.floor(window.innerHeight * dpr);
        canvas.width = w;
        canvas.height = h;
        canvas.style.width = window.innerWidth + "px";
        canvas.style.height = window.innerHeight + "px";
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }
      function createParticles() {
        particles = [];
        const count = Math.min(48, Math.floor((window.innerWidth * window.innerHeight) / 140000));
        for (let i = 0; i < count; i++) {
          particles.push({
            x: Math.random() * window.innerWidth,
            y: Math.random() * window.innerHeight,
            r: Math.random() * 18 + 2,
            vx: (Math.random() - 0.5) * 0.12,
            vy: (Math.random() - 0.5) * 0.12,
            alpha: 0.03 + Math.random() * 0.06,
            hue: 190 + Math.random() * 120
          });
        }
      }
      function step() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach((p) => {
          p.x += p.vx * (1 + Math.sin(performance.now() / 2000) * 0.2);
          p.y += p.vy * (1 + Math.cos(performance.now() / 2100) * 0.2);
          if (p.x < -50) p.x = window.innerWidth + 50;
          if (p.x > window.innerWidth + 50) p.x = -50;
          if (p.y < -50) p.y = window.innerHeight + 50;
          if (p.y > window.innerHeight + 50) p.y = -50;
          const g = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.r);
          g.addColorStop(0, `hsla(${p.hue},90%,65%,${p.alpha})`);
          g.addColorStop(1, `hsla(${p.hue},80%,55%,0)`);
          ctx.globalCompositeOperation = "screen";
          ctx.fillStyle = g;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
          ctx.fill();
        });
        rafId = requestAnimationFrame(step);
      }
      function start() {
        resize();
        createParticles();
        if (!rafId) rafId = requestAnimationFrame(step);
      }
      function stop() {
        if (rafId) {
          cancelAnimationFrame(rafId);
          rafId = null;
        }
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
      window.addEventListener("resize", () => {
        try {
          resize();
          createParticles();
        } catch (e) {}
      });
      setTimeout(() => {
        try {
          start();
        } catch (e) {
          console.warn(e);
        }
      }, 120);
      canvas._stopParticles = stop;
    }

    // --- Card tilt & micro-interactions ---
    function enableCardTilt() {
      if (!canAnimate()) return;
      const cards = Array.from(document.querySelectorAll(".card-hd:not(.no-tilt)"));
      if (!cards.length) return;
      cards.forEach((card) => {
        let raf = null;
        function onPointerMove(e) {
          const rect = card.getBoundingClientRect();
          const cx = rect.left + rect.width / 2;
          const cy = rect.top + rect.height / 2;
          const dx = (e.clientX - cx) / (rect.width / 2);
          const dy = (e.clientY - cy) / (rect.height / 2);
          const ry = dx * 10;
          const rx = -dy * 8;
          const s = 1.01;
          if (raf) cancelAnimationFrame(raf);
          raf = requestAnimationFrame(() => {
            card.style.transform = `perspective(900px) rotateX(${rx}deg) rotateY(${ry}deg) scale(${s})`;
            card.style.boxShadow = `0 ${10 + Math.abs(dy) * 12}px ${40 + Math.abs(dx) * 40}px rgba(2,6,23,0.6)`;
          });
        }
        function onEnter() {
          card.style.transition = "transform 200ms ease, box-shadow 200ms ease";
        }
        function onLeave() {
          if (raf) cancelAnimationFrame(raf);
          card.style.transition = "transform 400ms cubic-bezier(.2,.8,.2,1), box-shadow 400ms ease";
          card.style.transform = "";
          card.style.boxShadow = "";
        }
        card.addEventListener("pointermove", onPointerMove, { passive: true });
        card.addEventListener("pointerenter", onEnter);
        card.addEventListener("pointerleave", onLeave);
        card.addEventListener("click", (ev) => {
          ev.preventDefault();
          if (window.gsap && typeof gsap === "function") {
            gsap
              .timeline()
              .to(card, { duration: 0.14, scale: 1.03, rotationY: 6, ease: "power1.out" })
              .to(card, { duration: 0.38, scale: 1, rotationY: 0, ease: "elastic.out(1,0.6)" });
          } else {
            card.style.transform = "scale(1.02)";
            setTimeout(() => {
              card.style.transform = "";
            }, 380);
          }
        });
      });
    }

    function enablePointerParallax() {
      if (!canAnimate()) return;
      const logo = document.querySelector('.brand-logo-landing img');
      const bodyEl = document.body;
      if (!logo || !bodyEl) return;
      let raf = null;
      document.addEventListener('pointermove', (e) => {
        const cx = window.innerWidth / 2;
        const cy = window.innerHeight / 2;
        const dx = (e.clientX - cx) / cx;
        const dy = (e.clientY - cy) / cy;
        if (raf) cancelAnimationFrame(raf);
        raf = requestAnimationFrame(() => {
          bodyEl.style.setProperty('--parallax-x', (dx * 1.0).toFixed(3));
          bodyEl.style.setProperty('--parallax-y', (dy * 1.0).toFixed(3));
          logo.style.transform = `translate(${dx * 10}px, ${dy * 8}px) rotate(${dx * 2}deg)`;
        });
      }, { passive: true });
    }

    function burstConfetti(colors) {
      if (!canAnimate()) return;
      try {
        if (window.confetti) {
          confetti({ particleCount: 42, spread: 60, origin: { y: 0.25 }, colors: colors || ['#22d3ee','#f472b6','#fbbf24','#a855f7'] });
          return;
        }
      } catch (err) {
        // ignore
      }
      // fallback: tiny DOM sparkle
      const el = document.createElement('div');
      el.style.position = 'fixed'; el.style.left = '50%'; el.style.top = '20%'; el.style.width = '8px'; el.style.height = '8px';
      el.style.background = colors ? colors[0] : '#22d3ee'; el.style.borderRadius = '50%'; el.style.zIndex = 9999; el.style.opacity = '0.95';
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 900);
    }

    // Parallax + tilt disabled for a steady, flat UI
    // Initialize particles only (no tilt/parallax)
    (function setupVisuals() {
      if (!canAnimate()) return;
      try { initCardParticles(); } catch (e) { console.warn('particles failed', e); }
    })();
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredInstallPrompt = null; // weâ€™re handling instructions manually
      if (addToHomeBtn) addToHomeBtn.style.display = "inline-block";
    });
    if (addToHomeBtn) {
      addToHomeBtn.addEventListener("click", async () => {
        if (addToHomeOverlay) addToHomeOverlay.classList.add("active");
      });
    }
    function closeAddToHomeOverlay() {
      if (addToHomeOverlay) {
        addToHomeOverlay.classList.remove("active");
        addToHomeOverlay.style.display = "none";
        setTimeout(() => { if (addToHomeOverlay) addToHomeOverlay.style.display = ""; }, 50);
      }
    }
    if (addToHomeClose) {
      addToHomeClose.addEventListener("click", closeAddToHomeOverlay);
    }
    if (addToHomeOverlay) {
      addToHomeOverlay.addEventListener("click", (e) => {
        if (e.target === addToHomeOverlay) {
          closeAddToHomeOverlay();
        }
      });
    }
    const achievementsNewPill = document.getElementById("achievementsNewPill");
    const passCard = document.querySelector(".pass-card");
    const navMenu = document.getElementById("navMenu");
    const navItems = navMenu ? navMenu.querySelectorAll("[data-nav]") : [];
    const accentChips = navMenu ? navMenu.querySelectorAll(".accent-chip") : [];
    const cancelMembershipModal = document.getElementById("cancelMembershipModal");
    const cancelMembershipConfirm = document.getElementById("cancelMembershipConfirm");
    const cancelMembershipAbort = document.getElementById("cancelMembershipAbort");
    const cancelMembershipClose = document.getElementById("cancelMembershipClose");
    const verifyForm = document.getElementById("verifyForm");
    const verifyCodeInput = document.getElementById("verifyCode");
    const verifyError = document.getElementById("verifyError");
    const verifySuccess = document.getElementById("verifySuccess");
    const memberIdForm = document.getElementById("memberIdForm");
    const memberIdInput = document.getElementById("memberIdInput");
    const memberIdError = document.getElementById("memberIdError");
    const memberIdResult = document.getElementById("memberIdResult");
    const staffLoginForm = document.getElementById("staffLoginForm");
    const staffVenueInput = document.getElementById("staffVenue");
    const staffPassInput = document.getElementById("staffPass");
    const staffLoginError = document.getElementById("staffLoginError");
    const staffLoginSubmit = document.getElementById("staffLoginSubmit");
    const staffGateOverlay = document.getElementById("staffGateOverlay");
    const staffGateCode = document.getElementById("staffGateCode");
    const staffGateError = document.getElementById("staffGateError");
    const staffGateAccept = document.getElementById("staffGateAccept");
    const staffGateCancel = document.getElementById("staffGateCancel");
    const staffVenueLabel = document.getElementById("staffVenueLabel");
    const staffPortalTitle = document.getElementById("staffPortalTitle");
    const staffPortalTagline = document.getElementById("staffPortalTagline");
    const staffVenueLog = document.getElementById("staffVenueLog");
    const staffCloseOutBtn = document.getElementById("staffCloseOutBtn");
    const staffCloseOutModal = document.getElementById("staffCloseOutModal");
    const staffCloseOutSummary = document.getElementById("staffCloseOutSummary");
    const staffCloseOutStatus = document.getElementById("staffCloseOutStatus");
    const staffCloseOutSend = document.getElementById("staffCloseOutSend");
    const staffCloseOutDone = document.getElementById("staffCloseOutDone");
    const staffCloseOutDoneFooter = document.getElementById("staffCloseOutDoneFooter");
    const staffDealCodeList = document.getElementById("staffDealCodeList");
    const staffPerksList = document.getElementById("staffPerksList");
    const staffAddPerkBtn = document.getElementById("staffAddPerkBtn");
    const staffSavePerksBtn = document.getElementById("staffSavePerksBtn");
    const staffPerksError = document.getElementById("staffPerksError");
    const staffPerksSuccess = document.getElementById("staffPerksSuccess");
    const staffVenueMonthlyLog = document.getElementById("staffVenueMonthlyLog");
    const lastVerifiedLine = document.getElementById("lastVerifiedLine");
    const staffTickerList = document.getElementById("staffTickerList");
    const staffMessageForm = document.getElementById("staffMessageForm");
    const staffMessageInput = document.getElementById("staffMessageInput");
    const staffMessageError = document.getElementById("staffMessageError");
    const staffMessageSuccess = document.getElementById("staffMessageSuccess");
    const staffMessagesList = document.getElementById("staffMessagesList");
    const staffDeleteSelectedBtn = document.getElementById("staffDeleteSelectedBtn");
    const staffClearMessagesBtn = document.getElementById("staffClearMessagesBtn");
    const staffMsgBadge = document.getElementById("staffMsgBadge");
    const staffLogoutLink = document.getElementById("staffLogoutLink");
    const staffLoginBack = document.getElementById("staffLoginBack");
    const ceoPortalBack = document.getElementById("ceoPortalBack");
    const ceoPassButton = document.getElementById("ceoPassButton");
    const ceoGenButtons = document.querySelectorAll("[data-ceo-gen-perk]");
    const ceoGenSuccess = document.getElementById("ceoGenSuccess");
    const ceoIssuedList = document.getElementById("ceoIssuedList");
    const freePassIdInput = document.getElementById("freePassIdInput");
    const grantFreeBtn = document.getElementById("grantFreeBtn");
    const revokeFreeBtn = document.getElementById("revokeFreeBtn");
    const freeMemberStatus = document.getElementById("freeMemberStatus");
    const freeMembersList = document.getElementById("freeMembersList");
    const refreshFreeMembers = document.getElementById("refreshFreeMembers");
    const ceoMessagesList = document.getElementById("ceoMessagesList");
    const ceoReplyForm = document.getElementById("ceoReplyForm");
    const ceoReplyInput = document.getElementById("ceoReplyInput");
    const ceoReplyTarget = document.getElementById("ceoReplyTarget");
    const ceoReplyError = document.getElementById("ceoReplyError");
    const ceoReplySuccess = document.getElementById("ceoReplySuccess");
    const ceoClearMessages = document.getElementById("ceoClearMessages");
    const ceoMsgBadge = document.getElementById("ceoMsgBadge");
    const ceoVerifiedVenueLog = null;
    const metricTodayRedemptions = document.getElementById("metricTodayRedemptions");
    const metricActiveVenues = document.getElementById("metricActiveVenues");
    const metricLatestRating = document.getElementById("metricLatestRating");
    const tierModal = document.getElementById("tierModal");
    const tierModalTitle = document.getElementById("tierModalTitle");
    const tierModalCopy = document.getElementById("tierModalCopy");
    const tierModalAction = document.getElementById("tierModalAction");
    const tierModalCancel = document.getElementById("tierModalCancel");
    const supportTrigger = document.getElementById("supportTrigger");
    const supportBackBtn = document.getElementById("supportBackBtn");
    const supportForm = document.getElementById("supportForm");
    const supportError = document.getElementById("supportError");
    const supportSuccess = document.getElementById("supportSuccess");
    const supportFirstName = document.getElementById("supportFirstName");
    const supportLastName = document.getElementById("supportLastName");
    const supportPhone = document.getElementById("supportPhone");
    const supportMessage = document.getElementById("supportMessage");
    const redeemTrigger = document.getElementById("redeemTrigger");
    const redeemModal = document.getElementById("redeemModal");
    const redemptionOptionsGrid = document.getElementById("redemptionOptionsGrid");
    const redeemVenueSelect = document.getElementById("redeemVenueSelect");
    const creditInfo = document.getElementById("creditInfo");
    const redeemPerksHint = document.getElementById("redeemPerksHint");
    const buyDrinksBtn = document.getElementById("buyDrinksBtn");
    const memberActionButtons = document.getElementById("memberActionButtons");
    const voucherModal = document.getElementById("voucherModal");
    const voucherOptions = document.getElementById("voucherOptions");
    const voucherCancel = document.getElementById("voucherCancel");
    const voucherStepPacks = document.getElementById("voucherStepPacks");
    const voucherStepPayment = document.getElementById("voucherStepPayment");
    const voucherPaymentTitle = document.getElementById("voucherPaymentTitle");
    const voucherPaymentCopy = document.getElementById("voucherPaymentCopy");
    const voucherPaymentForm = document.getElementById("voucherPaymentForm");
    const voucherPaymentElement = document.getElementById("voucherPaymentElement");
    const voucherPaymentError = document.getElementById("voucherPaymentError");
    const voucherChargeOnFile = document.getElementById("voucherChargeOnFile");
    const voucherBackBtn = document.getElementById("voucherBackBtn");
    const voucherSavedCard = document.getElementById("voucherSavedCard");
    const ceoCardModal = document.getElementById("ceoCardModal");
    const ceoCardClose = document.getElementById("ceoCardClose");
    const ceoCardCode = document.getElementById("ceoCardCode");
    const ceoBetaSwitcher = document.getElementById("ceoBetaSwitcher");
    const ceoPreviewLabel = document.getElementById("ceoPreviewLabel");
    const ceoPreviewStandardBtn = document.getElementById("ceoPreviewStandard");
    const ceoPreviewVipBtn = document.getElementById("ceoPreviewVip");
    const ceoPreviewReturnBtn = document.getElementById("ceoPreviewReturn");
    const betaResetBtn = document.getElementById("betaResetBtn");
    const ceoRedemptionBtn = document.getElementById("ceoRedemptionBtn");
    const ceoRedemptionModal = document.getElementById("ceoRedemptionModal");
    const ceoRedemptionClose = document.getElementById("ceoRedemptionClose");
    const ceoRedemptionList = document.getElementById("ceoRedemptionList");
    const ceoReviewBtn = document.getElementById("ceoReviewBtn");
    const ceoPortalReviewsBtn = document.getElementById("ceoPortalReviewsBtn");
    const ceoAnalyticsBtn = document.getElementById("ceoAnalyticsBtn");
    const ceoAnalyticsModal = document.getElementById("ceoAnalyticsModal");
    const ceoAnalyticsClose = document.getElementById("ceoAnalyticsClose");
    const ceoAnalyticsContent = document.getElementById("ceoAnalyticsContent");
    const ceoResetCard = document.getElementById("ceoResetCard");
    const ceoMembersCard = document.getElementById("ceoMembersCard");
    const ceoMembersRefresh = document.getElementById("ceoMembersRefresh");
    const ceoMembersTotals = document.getElementById("ceoMembersTotals");
    const ceoMembersList = document.getElementById("ceoMembersList");
    const ceoLaunchCard = document.getElementById("ceoLaunchCard");
    const ceoLaunchStatus = document.getElementById("ceoLaunchStatus");
    const ceoLaunchToggle = document.getElementById("ceoLaunchToggle");
    const ceoAppLockCard = document.getElementById("ceoAppLockCard");
    const ceoAppLockStatus = document.getElementById("ceoAppLockStatus");
    const ceoAppLockToggle = document.getElementById("ceoAppLockToggle");
    const ceoSystemHealthCard = document.getElementById("ceoSystemHealthCard");
    const ceoSystemHealth = document.getElementById("ceoSystemHealth");
    let staffCloseoutStamp = document.getElementById("staffCloseoutStamp");
    const appLockOverlay = document.getElementById("appLockOverlay");
    const appLockCeoAccess = document.getElementById("appLockCeoAccess");
    const reconnectBanner = document.getElementById("reconnectBanner");
    const ceoChatCard = document.getElementById("ceoChatCard");
    const userTaglineEl = document.getElementById("userTagline");
    const leaveReviewBtn = document.getElementById("leaveReviewBtn");
    const reviewModal = document.getElementById("reviewModal");
    const reviewClose = document.getElementById("reviewClose");
    const reviewStars = document.querySelectorAll(".review-star");
    const reviewNotes = document.getElementById("reviewNotes");
    const submitReviewBtn = document.getElementById("submitReviewBtn");
    const reviewSuccess = document.getElementById("reviewSuccess");
    const rewardsTrigger = document.getElementById("rewardsTrigger");
    const rewardsModal = document.getElementById("rewardsModal");
    const rewardsClose = document.getElementById("rewardsClose");
    const rewardsCloseBtn = document.getElementById("rewardsCloseBtn");
    const rewardsRedeemBtn = document.getElementById("rewardsRedeemBtn");
    const rewardsProgressFill = document.getElementById("rewardsProgressFill");
    const rewardsProgressText = document.getElementById("rewardsProgressText");
    const rewardsNextText = document.getElementById("rewardsNextText");
    const rewardsError = document.getElementById("rewardsError");
    const rewardsSuccess = document.getElementById("rewardsSuccess");
    const quickStatus = document.getElementById("quickStatus");
    const quickPoints = document.getElementById("quickPoints");
    const quickSpins = document.getElementById("quickSpins");
    const FRIENDS_DISABLED = true;

    async function updateStaffCloseoutStamp() {
      if (!staffCloseoutStamp || !db) return;
      staffCloseoutStamp.textContent = "Checking close-out statusâ€¦";
      try {
        const ref = doc(db, "settings", "health");
        const snap = await getDoc(ref);
        const data = snap.exists() ? snap.data() : {};
        if (data.lastCloseoutEmail) {
          const ts = data.lastCloseoutEmail.toDate ? data.lastCloseoutEmail.toDate() : new Date(data.lastCloseoutEmail);
          staffCloseoutStamp.textContent = `Last close-out email: ${ts.toLocaleString("en-US", { timeZone: "America/Denver" })}`;
        } else {
          staffCloseoutStamp.textContent = "Last close-out email: unknown";
        }
      } catch (err) {
        console.warn("staff closeout stamp failed", err);
        staffCloseoutStamp.textContent = "Close-out status unavailable";
      }
    }
    const navRewardsItem = document.getElementById("navRewardsItem");
    const manageBillingBtn = document.getElementById("manageBillingBtn");
    const aboutModal = document.getElementById("aboutModal");
    const navAboutItem = document.getElementById("navAboutItem");
    const achievementsList = document.getElementById("achievementsList");
    const ceoDemoBtn = document.getElementById("ceoDemoBtn");
    const demoModeBadge = document.getElementById("demoModeBadge");
    const ceoChatSend = document.getElementById("ceoChatSend");
    const ceoChatInput = document.getElementById("ceoChatInput");
    const ceoChatHistory = document.getElementById("ceoChatHistory");
    const ceoChatPresetRollout = document.getElementById("ceoChatPresetRollout");
    const ceoChatPresetIssues = document.getElementById("ceoChatPresetIssues");
    const ceoReviewsModal = document.getElementById("ceoReviewsModal");
    const ceoReviewsClose = document.getElementById("ceoReviewsClose");
    const testimonialQuote = document.getElementById("testimonialQuote");
    const testimonialSource = document.getElementById("testimonialSource");
    const ceoReviewList = document.getElementById("ceoReviewList");
    const ceoReviewAverage = document.getElementById("ceoReviewAverage");
    const redeemClose = document.getElementById("redeemClose");
    const redeemConfirm = document.getElementById("redeemConfirm");
    const redeemSuccess = document.getElementById("redeemSuccess");
    const redeemSuccessBack = document.getElementById("redeemSuccessBack");
    const redeemCodeDisplay = document.getElementById("redeemCode");
    const redeemSuccessTitle = document.getElementById("redeemSuccessTitle");
    const redeemStatusLine = document.getElementById("redeemStatusLine");
    const redeemVenueHint = document.getElementById("redeemVenueHint");
    const redeemPendingClose = document.getElementById("redeemPendingClose");
    const confettiLayer = document.getElementById("confettiLayer");
    const paymentForm = document.getElementById("paymentForm");
    const paymentError = document.getElementById("paymentError");
    const paymentSuccess = document.getElementById("paymentSuccess");
    const paymentPlanLabel = document.getElementById("paymentPlanLabel");
    const paymentPlanPrice = document.getElementById("paymentPlanPrice");
    const skipPaymentBtn = document.getElementById("skipPaymentBtn");
    const cardNameInput = document.getElementById("cardName");
    const paymentElementContainer = document.getElementById("paymentElement");
    const paymentSubmitBtn = document.getElementById("paymentSubmit");
    const paymentBackBtn = document.getElementById("paymentBackBtn");
    const paymentSavedCard = document.getElementById("paymentSavedCard");
    const heroCarousel = document.getElementById("heroCarousel");
    const featuredVenuesGrid = document.getElementById("featuredVenuesGrid");
    const passFeaturedGrid = document.getElementById("passFeaturedGrid");
    const statRedemptions = document.getElementById("statRedemptions");
    const statVenuesVisited = document.getElementById("statVenuesVisited");
    const statAvgSavings = document.getElementById("statAvgSavings");
    const statVouchersLeft = document.getElementById("statVouchersLeft");
    const statLoginCount = document.getElementById("statLoginCount");
    const statActiveDays = document.getElementById("statActiveDays");
    const voucherBalanceNote = document.getElementById("voucherBalanceNote");
    const redeemVoucherBalance = document.getElementById("redeemVoucherBalance");
    const pulseBand = document.getElementById("pulseBand");
    const pulsePassId = document.getElementById("pulsePassId");
    const pulsePrimary = document.getElementById("pulsePrimary");
    const pulseThread = document.getElementById("pulseThread");
    const staffRadarCount = document.getElementById("staffRadarCount");
    const staffRadarMood = document.getElementById("staffRadarMood");
    const radarPings = document.getElementById("radarPings");
    const radarList = document.getElementById("radarList");
    const staffRadarEl = document.getElementById("staffRadar");
    const radarDisplay = staffRadarEl ? staffRadarEl.querySelector(".radar-display") : null;
    const radarGraffiti = document.getElementById("radarGraffiti");
    const scanPendingAlert = document.getElementById("scanPendingAlert");
    const scanPortalAlert = document.getElementById("scanPortalAlert");
    const scanConfirmStatus = document.getElementById("scanConfirmStatus");
    const scanConfirmPassId = document.getElementById("scanConfirmPassId");
    const scanConfirmToStaff = document.getElementById("scanConfirmToStaff");
    const scanConfirmBack = document.getElementById("scanConfirmBack");
    const offlineBadge = document.getElementById("offlineBadge");
    const offlineCopy = document.getElementById("offlineCopy");
    const onboardingOverlay = document.getElementById("onboardingOverlay");
    const onboardingTitle = document.getElementById("onboardingTitle");
    const onboardingBody = document.getElementById("onboardingBody");
    const onboardingIndicator = document.getElementById("onboardingIndicator");
    const onboardingNext = document.getElementById("onboardingNext");
    const onboardingSkip = document.getElementById("onboardingSkip");
    const pitchModeBtn = document.getElementById("pitchModeBtn");
    const ceoPitchToggle = document.getElementById("ceoPitchToggle");
    const pitchDeckModal = document.getElementById("pitchDeckModal");
    const pitchTitle = document.getElementById("pitchTitle");
    const pitchBody = document.getElementById("pitchBody");
    const pitchMeter = document.getElementById("pitchMeter");
    const pitchNextBtn = document.getElementById("pitchNextBtn");
    const pitchPrevBtn = document.getElementById("pitchPrevBtn");
    const pitchCloseBtn = document.getElementById("pitchCloseBtn");
    const alertAudiencePills = document.getElementById("alertAudiencePills");
    const alertDetailCount = document.getElementById("alertDetailCount");
    const staffRecentActions = document.getElementById("staffRecentActions");
    const staffVenueChip = document.getElementById("staffVenueChip");
    const kpiScans = document.getElementById("kpiScans");
    const kpiAlerts = document.getElementById("kpiAlerts");
    const kpiVip = document.getElementById("kpiVip");
    const staffAccentButtons = document.querySelectorAll("[data-staff-accent]");
    const alertsList = document.getElementById("alertsList");
    const chargeSavedCardBtn = document.getElementById("chargeSavedCardBtn");
    const receiptOverlay = document.getElementById("receiptOverlay");
    const receiptSummary = document.getElementById("receiptSummary");
    const receiptNote = document.getElementById("receiptNote");
    const receiptClose = document.getElementById("receiptClose");
    const receiptShareToggle = document.getElementById("receiptShareToggle");
    const receiptShareRow = document.getElementById("receiptShareRow");
    const vipDealForm = document.getElementById("vipDealForm");
    const vipDealTitle = document.getElementById("vipDealTitle");
    const vipDealDetail = document.getElementById("vipDealDetail");
    const vipDealMeta = document.getElementById("vipDealMeta");
    const vipDealExpires = document.getElementById("vipDealExpires");
    const vipDealError = document.getElementById("vipDealError");
    const vipDealSuccess = document.getElementById("vipDealSuccess");
    const vipDealPreview = document.getElementById("vipDealPreview");
    const vipMemberDeal = document.getElementById("vipMemberDeal");
    const successTimers = new WeakMap();
    if (scanConfirmToStaff) {
      scanConfirmToStaff.addEventListener("click", () => {
        showScreen("staffLogin");
      });
    }
    if (scanConfirmBack) {
      scanConfirmBack.addEventListener("click", () => {
        showScreen("landing");
      });
    }
    let pendingScanVerify = localStorage.getItem("pendingScanVerify") || null;
    (function captureVerifyParam() {
      try {
        const params = new URLSearchParams(window.location.search);
        const verifyParam = params.get("verify");
        if (verifyParam) {
          pendingScanVerify = verifyParam.toUpperCase();
          localStorage.setItem("pendingScanVerify", pendingScanVerify);
          displayScanConfirmation(pendingScanVerify);
          if (window.history.replaceState) {
            const cleanUrl = window.location.origin + window.location.pathname;
            window.history.replaceState({}, document.title, cleanUrl);
          }
        }
      } catch (err) {
        console.warn("Failed to parse QR verify param:", err);
      }
    })();
    function loadAlertsFromStorage() {
      if (!allowLocalCache()) return [];
      if (memberProfile?.alertsCache) return memberProfile.alertsCache;
      try {
        const raw = localStorage.getItem(ALERTS_STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (err) {
        return [];
      }
    }
    function saveAlertsToStorage(alerts) {
      if (!allowLocalCache()) return;
      try {
        localStorage.setItem(ALERTS_STORAGE_KEY, JSON.stringify(alerts));
        persistMemberState({ alertsCache: alerts });
      } catch (err) {
        // ignore
      }
    }
    function loadVipDealsFromStorage() {
      if (!allowLocalCache()) return {};
      if (memberProfile?.vipDealsCache) return memberProfile.vipDealsCache;
      try {
        const raw = localStorage.getItem(VIP_DEALS_STORAGE_KEY);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === "object" ? parsed : {};
      } catch (err) {
        return {};
      }
    }
    function saveVipDealsToStorage(deals) {
      if (!allowLocalCache()) return;
      try {
        localStorage.setItem(VIP_DEALS_STORAGE_KEY, JSON.stringify(deals));
        persistMemberState({ vipDealsCache: deals });
      } catch (err) {
        // ignore
      }
    }
    const ACCENT_KEY = "accentTheme";
    const CEO_PASS_ID = "DREE4695";
    const STAFF_ACCENT_PREFIX = "staffAccent_";
    const IDLE_TIMEOUT_MS = 2 * 60 * 1000;
    const STATS_CACHE_PREFIX = "statsCache_";
    let idleTimer = null;
    let idleActive = false;

    const testimonials = [
      { quote: "\"Best nightlife pass.\"", source: "â€“ Ava S., VIP member" },
      { quote: "\"Every weekend sorted in one tap.\"", source: "â€“ Liam P., FoCo resident" },
      { quote: "\"Cheaper drinks and faster linesâ€”I'm in.\"", source: "â€“ Maya R., Standard member" },
      { quote: "\"Gets me into every bar I care about.\"", source: "â€“ Noah K., VIP member" },
      { quote: "\"Finally a pass Fort Collins needed.\"", source: "â€“ Emma L., FoCo local" }
    ];
    function buildTestimonialPool() {
      const userReviews = getStoredReviews ? getStoredReviews() : [];
      const mappedUser = (userReviews || []).map(r => ({
        quote: `"${r.notes || "Great night!"}"`,
        source: `â€“ ${r.member || "FoCo member"}, ${r.stars || "5"}â˜…`
      }));
      return [...testimonials, ...mappedUser];
    }
    let featuredVenuesData = [];
    let tonightAlerts = loadAlertsFromStorage();
    let alertsCache = [...tonightAlerts];
    let dealCodes = {};
    function pruneExpiredAlerts() {
      const now = Date.now();
      const filtered = tonightAlerts.filter(alert => !alert.expiresAt || alert.expiresAt > now);
      if (filtered.length !== tonightAlerts.length) {
        tonightAlerts = filtered;
        alertsCache = [...filtered];
        saveAlertsToStorage(tonightAlerts);
        refreshAlertsTicker();
        renderStaffAlertPreview();
      }
    }
    const pitchSlides = [
      { title: "What venues get", body: "Verified 21+ guests, guaranteed spend, and analytics on every redemption. No paper punch cards." },
      { title: "Scanner companion", body: "Your staff scans or types the Pass ID. The portal records perks in secondsâ€”no POS integration needed." },
      { title: "Premium positioning", body: "FoCo promotes your venue in-app with live alerts, venue perks, and VIP drops during peak hours." },
      { title: "Revenue ready", body: "Members preload vouchers. You get paid per redemption with transparent monthly reports." }
    ];
    const simulatedScans = [
      { perk: "Drink perk voucher", member: "Demo Member", passId: "BETA321" },
      { perk: "Shot perk voucher", member: "FoCo Tester", passId: "TEST713" },
      { perk: "Line access perk", member: "VIP Preview", passId: "PREV999" }
    ];
    const PERK_PRICING = {
      drink: { regular: 12, voucher: 3 },
      shot: { regular: 5, voucher: 1 },
      cover: { regular: 10, voucher: 0 },
    };
    const MEMBERSHIP_FEES = {
      standard: 5,
      vip: 10,
    };
    const VOUCHER_LIMITS = { standard: 5, vip: 10 };
    const MAX_VOUCHER_CARRYOVER = 3;
    const VOUCHER_LIMIT_MESSAGE = "Thank you for using FoCo After Dark this month, balance will reload next month.";
    function loadRewardsProgress() {
      if (memberProfile?.rewardsProgress) return memberProfile.rewardsProgress;
      if (!allowLocalCache()) return {};
      try {
        return JSON.parse(localStorage.getItem(REWARDS_KEY) || "{}");
      } catch (err) {
        return {};
      }
    }
    function saveRewardsProgress(state) {
      rewardsProgress = { ...rewardsProgress, ...state };
      if (allowLocalCache()) {
        localStorage.setItem(REWARDS_KEY, JSON.stringify(rewardsProgress));
      }
      persistMemberState({ rewardsProgress });
      updateRewardsUI();
    }
    rewardsProgress = { ...rewardsProgress, ...loadRewardsProgress() };
    const onboardingSteps = [
      { title: "Pick your perk", copy: "Tap â€œRedeem a perkâ€ and choose a venue perk from the bar youâ€™re at." },
      { title: "Show QR + Pass ID", copy: "Your QR works offline. Staff can also type the Pass ID if scanners are busy." },
      { title: "Staff verifies", copy: "They confirm in their FoCo portal, balances sync instantly, and youâ€™re in." }
    ];
    const ONBOARDING_STORAGE_KEY = "foco_onboarding_complete";
    function loadBadgeDirectory() {
      if (memberProfile?.badgeDirectory) return memberProfile.badgeDirectory;
      if (!allowLocalCache()) return {};
      try {
        return JSON.parse(localStorage.getItem(BADGES_KEY) || "{}");
      } catch (err) {
        return {};
      }
    }
    function saveBadgeDirectory(map) {
      badgeDirectory = map || {};
      if (allowLocalCache()) {
        localStorage.setItem(BADGES_KEY, JSON.stringify(badgeDirectory));
      }
      persistMemberState({ badgeDirectory });
    }
    let staffTickerEntries = [];
    let heroSlideIndex = 0;
    let heroCarouselInterval = null;
    let pitchIndex = 0;
    let alertsRotationIndex = 0;
    let badgeDirectory = loadBadgeDirectory();
    let achievementState = {};
    function loadAchievementState() {
      if (memberProfile?.achievementState) return memberProfile.achievementState;
      if (!allowLocalCache()) return {};
      try {
        return JSON.parse(localStorage.getItem(ACHIEVEMENTS_KEY) || "{}");
      } catch (err) {
        return {};
      }
    }
    function saveAchievementState(map) {
      achievementState = map || {};
      if (allowLocalCache()) {
        localStorage.setItem(ACHIEVEMENTS_KEY, JSON.stringify(achievementState));
      }
      persistMemberState({ achievementState });
    }
    achievementState = loadAchievementState();
    function updateRandomTestimonial() {
      const pool = buildTestimonialPool();
      if (!testimonialQuote || !testimonialSource || !pool.length) return;
      const pick = pool[Math.floor(Math.random() * pool.length)];
      testimonialQuote.textContent = pick.quote;
      testimonialSource.textContent = pick.source;
    }
    function setLandingTagline() {
      if (!landingTagline) return;
      const pick = LANDING_TAGLINES[Math.floor(Math.random() * LANDING_TAGLINES.length)];
      landingTagline.textContent = pick;
    }
    function startLandingSlideshow() {
      // Static hero image (slideshow disabled)
      return;
    }
    updateRandomTestimonial();
    startLandingSlideshow();

    async function displayScanConfirmation(code) {
      if (!code || !screens.scanConfirm) return;
      if (scanConfirmPassId) scanConfirmPassId.textContent = `Pass ID: ${code}`;
      if (scanConfirmStatus) scanConfirmStatus.textContent = "Checking pass statusâ€¦";
      showScreen("scanConfirm");
      try {
        const profile = await lookupMemberProfile(code);
        if (!profile) {
          if (scanConfirmStatus) scanConfirmStatus.textContent = "Pass not found. Ask member to refresh their app.";
          return;
        }
        const tierLabel = profile.tier ? profile.tier.toUpperCase() : "MEMBER";
        if (scanConfirmStatus) {
          scanConfirmStatus.textContent = `Verified ${profile.name || "FoCo member"} â€¢ ${tierLabel}`;
        }
      } catch (err) {
        if (scanConfirmStatus) scanConfirmStatus.textContent = "Could not verify this pass. Try again.";
      }
    }

    function updatePendingScanAlerts() {
      const hasPending = Boolean(pendingScanVerify);
      if (scanPendingAlert) {
        scanPendingAlert.style.display = hasPending ? "" : "none";
        if (hasPending) {
          scanPendingAlert.textContent = `Scanned pass ${pendingScanVerify} pending verification. Log in to the staff portal.`;
        }
      }
      if (scanPortalAlert) {
        scanPortalAlert.style.display = hasPending ? "" : "none";
        if (hasPending) {
          scanPortalAlert.textContent = `Scanned pass ${pendingScanVerify} ready to verifyâ€¦`;
        }
      }
    }

    function setPendingScan(code, { autoVerify = true } = {}) {
      pendingScanVerify = code ? code.toUpperCase() : null;
      if (pendingScanVerify) {
        localStorage.setItem("pendingScanVerify", pendingScanVerify);
      } else {
        localStorage.removeItem("pendingScanVerify");
      }
      updatePendingScanAlerts();
      if (autoVerify && pendingScanVerify && staffSession) {
        handlePendingScanVerification();
      }
    }

    updatePendingScanAlerts();
    function renderHeroCarousel() {
      if (!heroCarousel) return;
      heroCarousel.innerHTML = "";
    }
    function formatFeaturedBadge(label = "") {
      const clean = String(label || "").replace(/[^a-z0-9 ]/gi, "").trim();
      if (!clean) return "Perk live";
      return clean.length > 16 ? `${clean.slice(0, 15)}â€¦` : clean;
    }
    function formatFeaturedDetail(perk = {}) {
      const label = String(perk.label || "").trim();
      const standard = Number(perk.standardQty) ? `Std ${perk.standardQty}` : "";
      const vip = Number(perk.vipQty) ? `VIP ${perk.vipQty}` : "";
      const counts = [standard, vip].filter(Boolean).join(" Â· ");
      if (label && counts) return `${label} â€¢ ${counts}`;
      return label || "Monthly perk live";
    }
    function getActiveVenuePerks(venueId) {
      if (!venueId) return [];
      const cached = venuePerksCache[venueId];
      if (Array.isArray(cached) && cached.length) return cached;
      if (!isLaunched) {
        return buildBetaVenuePerks(venueId);
      }
      return [];
    }
    function buildFeaturedVenuesFromPerks() {
      const venueIds = Object.keys(venuesInfo || {});
      const list = [];
      venueIds.forEach(venueId => {
        const perks = getActiveVenuePerks(venueId);
        if (!perks.length) return;
        const primary = perks[0];
        const info = venuesInfo[venueId] || {};
        list.push({
          venueId,
          name: info.name || getVenueDisplayName(venueId),
          badge: formatFeaturedBadge(primary.label),
          detail: formatFeaturedDetail(primary)
        });
      });
      return list;
    }
    function refreshFeaturedVenuesData() {
      const next = buildFeaturedVenuesFromPerks();
      featuredVenuesData = next;
      renderFeaturedVenuesGrid();
      renderPassFeaturedGrid();
      setHeroSlideActive(0);
    }
    function setHeroSlideActive(index) {
      if (!heroCarousel || !featuredVenuesData.length) return;
      heroSlideIndex = index % featuredVenuesData.length;
      const slides = heroCarousel.querySelectorAll(".hero-slide");
      slides.forEach((slide, idx) => {
        slide.classList.toggle("active", idx === heroSlideIndex);
      });
    }
    function renderFeaturedVenuesGrid() {
      if (!featuredVenuesGrid) return;
      if (!featuredVenuesData.length) {
        featuredVenuesGrid.innerHTML = `
          <div class="featured-card">
            <strong>No live perks yet</strong>
            <span>Venues appear here once perks are posted.</span>
          </div>
        `;
        return;
      }
      const topRatedId = getTopRatedVenueId();
      featuredVenuesGrid.innerHTML = featuredVenuesData.map(venue => {
        const badge = topRatedId && venue.venueId === topRatedId ? "Top Bar" : venue.badge;
        return `
        <div class="featured-card">
          <div class="featured-badge">${badge}</div>
          <strong>${venue.name}</strong>
          <span>${venue.detail}</span>
        </div>
      `;
      }).join("");
    }
    function renderPassFeaturedGrid() {
      if (!passFeaturedGrid) return;
      if (!featuredVenuesData.length) {
        passFeaturedGrid.innerHTML = `
          <div class="featured-card">
            <strong>No live perks yet</strong>
            <span>Venues appear here once perks are posted.</span>
          </div>
        `;
        return;
      }
      const topRatedId = getTopRatedVenueId();
      const topFour = featuredVenuesData.slice(0, 4);
      passFeaturedGrid.innerHTML = topFour.map(venue => {
        const badge = topRatedId && venue.venueId === topRatedId ? "Top Bar" : venue.badge;
        return `
        <div class="featured-card">
          <div class="featured-badge">${badge}</div>
          <strong>${venue.name}</strong>
          <span>${venue.detail}</span>
        </div>
      `;
      }).join("");
    }
    function startHeroRotation() {
      if (heroCarouselInterval) {
        clearInterval(heroCarouselInterval);
        heroCarouselInterval = null;
      }
      return;
    }
    renderHeroCarousel();

    function updateRewardsUI() {
      if (!rewardsProgress) return;
      const nextTarget = 5;
      const progressCount = rewardsProgress.available ? nextTarget : rewardsProgress.count;
      const pct = rewardsProgress.available ? 100 : Math.min(100, Math.floor((progressCount / nextTarget) * 100));
      if (rewardsProgressFill) rewardsProgressFill.style.width = `${pct}%`;
      if (rewardsProgressText) {
        if (rewardsProgress.available) {
          rewardsProgressText.textContent = "Reward ready: +$1 shot";
        } else {
          rewardsProgressText.textContent = `${progressCount} / ${nextTarget} redemptions`;
        }
      }
      if (rewardsNextText) {
        if (rewardsProgress.available) {
          rewardsNextText.textContent = "Tap Redeem reward to claim.";
        } else {
          const remaining = nextTarget - progressCount;
          rewardsNextText.textContent = `${remaining} to go Â· Next: +$1 shot voucher`;
        }
      }
      if (rewardsRedeemBtn) rewardsRedeemBtn.disabled = !rewardsProgress.available;
      if (rewardsError) rewardsError.textContent = "";
      if (rewardsTrigger) {
        rewardsTrigger.textContent = rewardsProgress.available ? "Rewards (ready)" : "Rewards";
        rewardsTrigger.classList.toggle("reward-ready", rewardsProgress.available);
      }
      if (navRewardsItem) {
        navRewardsItem.textContent = rewardsProgress.available ? "Rewards (ready)" : "Rewards";
        navRewardsItem.classList.toggle("reward-ready", rewardsProgress.available);
      }
      evaluateAchievements();
    }
    updateRewardsUI();

    function extractPassIdFromPayload(payload) {
      if (!payload) return null;
      try {
        const maybeUrl = new URL(payload);
        const verifyParam = maybeUrl.searchParams.get("verify");
        if (verifyParam) return verifyParam.toUpperCase();
      } catch (err) {
        // not a URL
      }
      if (payload.toLowerCase().startsWith("focopass:")) {
        return payload.split(":")[1]?.trim().toUpperCase() || null;
      }
      const cleaned = payload.trim().toUpperCase();
      return cleaned || null;
    }

    function normalizePerkKey(entry) {
      const key = entry?.perkKey;
      if (key && key !== "venue_perk") {
        return key === "reward_shot" ? "shot" : key;
      }
      const perkText = (entry?.venuePerkLabel || entry?.perk || "").toLowerCase();
      if (perkText.includes("shot")) return "shot";
      if (perkText.includes("line") || perkText.includes("cover")) return "cover";
      return "drink";
    }

    function oneMonthFrom(fromDate = new Date()) {
      const d = new Date(fromDate);
      const day = d.getDate();
      d.setMonth(d.getMonth() + 1);
      // If month overflowed (e.g., Jan 31 -> Mar 3), snap to last day of prior month
      if (d.getDate() < day) {
        d.setDate(0);
      }
      d.setHours(23, 59, 59, 999);
      return d;
    }

    function shiftMonth(baseDate, delta) {
      const d = new Date(baseDate);
      const day = d.getDate();
      d.setMonth(d.getMonth() + delta);
      if (d.getDate() < day) {
        d.setDate(0);
      }
      return d;
    }

    function getVoucherLimitForTier(tier) {
      if (!tier) return 0;
      if (tier === "ceo" || tier === "free") return Infinity;
      return VOUCHER_LIMITS[tier] || VOUCHER_LIMITS.standard;
    }

    function getRedemptionEntryDate(entry) {
      const raw = entry?.verifiedAt || entry?.timestamp || entry?.createdAt || null;
      if (!raw) return null;
      if (raw.toDate) return raw.toDate();
      const date = new Date(raw);
      return Number.isNaN(date.getTime()) ? null : date;
    }

    function isCountedRedemptionStatus(status, includePending = false) {
      const normalized = String(status || "").toLowerCase();
      if (normalized === "verified" || normalized === "approved" || normalized === "confirmed") return true;
      if (includePending && (normalized === "pending" || normalized === "requested")) return true;
      return false;
    }

    function getVoucherCycleWindow(billing = {}) {
      const now = new Date();
      const startIso = resolveBillingStart(billing) || memberProfile?.memberSince || null;
      let startDate = startIso ? new Date(startIso) : null;
      if (!startDate || Number.isNaN(startDate.getTime())) {
        startDate = new Date(now);
        startDate.setDate(1);
        startDate.setHours(0, 0, 0, 0);
      }
      const cycles = countBillingCycles(startDate.toISOString(), now);
      const cycleStart = shiftMonth(startDate, Math.max(0, cycles - 1));
      const cycleEnd = oneMonthFrom(cycleStart);
      const hasPrevious = cycles > 1;
      const prevStart = hasPrevious ? shiftMonth(startDate, cycles - 2) : shiftMonth(cycleStart, -1);
      const prevEnd = cycleStart;
      return {
        current: { start: cycleStart, end: cycleEnd },
        previous: { start: prevStart, end: prevEnd },
        hasPrevious
      };
    }

    function countRedemptionsInWindow(entries, window, options = {}) {
      const includePending = Boolean(options.includePending);
      if (!window) return 0;
      const start = window.start;
      const end = window.end;
      return entries.reduce((count, entry) => {
        if (!isCountedRedemptionStatus(entry.status, includePending)) return count;
        const date = getRedemptionEntryDate(entry);
        if (!date) return count;
        if (date >= start && date <= end) return count + 1;
        return count;
      }, 0);
    }

    function getVoucherTier() {
      return normalizeTierKey(currentMembershipTier)
        || normalizeTierKey(memberProfile?.tier)
        || (isCeoActive() ? "ceo" : (isFreeMember() ? "free" : "standard"))
        || "standard";
    }

    function getVoucherBalanceForTier(tierKey) {
      const tier = normalizeTierKey(tierKey) || getVoucherTier();
      const limit = getVoucherLimitForTier(tier);
      if (!Number.isFinite(limit)) {
        return { unlimited: true, remaining: Infinity, limit: Infinity, carryover: 0, usedCurrent: 0, total: Infinity };
      }
      const entries = getMemberRedemptionEntries();
      const uid = firebaseAuth.currentUser?.uid;
      const billing = uid ? loadBilling(uid) : {};
      const windowInfo = getVoucherCycleWindow(billing);
      const usedCurrent = countRedemptionsInWindow(entries, windowInfo.current, { includePending: true });
      const usedPrev = windowInfo.hasPrevious
        ? countRedemptionsInWindow(entries, windowInfo.previous, { includePending: false })
        : 0;
      const carryover = windowInfo.hasPrevious
        ? Math.min(MAX_VOUCHER_CARRYOVER, Math.max(0, limit - usedPrev))
        : 0;
      const total = limit + carryover;
      const remaining = Math.max(0, total - usedCurrent);
      return { unlimited: false, remaining, limit, carryover, usedCurrent, total };
    }

    function updateVoucherBalanceUI() {
      if (!statVouchersLeft && !voucherBalanceNote && !redeemVoucherBalance) return;
      const tier = getVoucherTier();
      const balance = getVoucherBalanceForTier(tier);
      if (balance.unlimited) {
        if (statVouchersLeft) statVouchersLeft.textContent = "Unlimited";
        if (voucherBalanceNote) voucherBalanceNote.textContent = "";
        if (redeemVoucherBalance) redeemVoucherBalance.textContent = "Unlimited vouchers available.";
        return;
      }
      if (statVouchersLeft) statVouchersLeft.textContent = `${balance.remaining}`;
      if (balance.remaining <= 0) {
        if (voucherBalanceNote) voucherBalanceNote.textContent = VOUCHER_LIMIT_MESSAGE;
        if (redeemVoucherBalance) redeemVoucherBalance.textContent = VOUCHER_LIMIT_MESSAGE;
      } else {
        if (voucherBalanceNote) voucherBalanceNote.textContent = "";
        if (redeemVoucherBalance) {
          const carry = balance.carryover ? ` (incl. ${balance.carryover} carryover)` : "";
          redeemVoucherBalance.textContent = `Vouchers left this cycle: ${balance.remaining}${carry}.`;
        }
      }
    }

    function getBillingKey(uid) {
      return `membershipBilling_${uid || "anon"}`;
    }

    function loadBilling(uid) {
      try {
        if (useCloudProfile()) {
          return memberProfile?.billing || {};
        }
        return JSON.parse(localStorage.getItem(getBillingKey(uid)) || "{}");
      } catch (err) {
        return {};
      }
    }

    function saveBilling(uid, data) {
      if (!uid || !data) return;
      if (useCloudProfile()) {
        memberProfile = memberProfile || {};
        memberProfile.billing = { ...(memberProfile.billing || {}), ...data };
        persistMemberState({ billing: memberProfile.billing });
        return;
      }
      localStorage.setItem(getBillingKey(uid), JSON.stringify(data));
    }

    function restorePerksForTier(tier) {
      if (!tier) return;
      if (!memberProfile) memberProfile = {};
      if (!memberProfile.perks) {
        memberProfile.perks = { tier, remaining: getDefaultPerkState(tier) };
      } else {
        memberProfile.perks.remaining = getDefaultPerkState(tier);
        memberProfile.perks.tier = tier;
      }
      updateMemberProfile({ perks: memberProfile.perks });
      renderRedemptionOptions();
    }

    function checkMembershipAutoRenew(tier) {
      if (!tier) return;
      if (isFreeMember()) return;
      const user = firebaseAuth.currentUser;
      const uid = user?.uid;
      if (!uid) return;
      let billing = loadBilling(uid);
      const now = new Date();
      if (!billing.tier) billing.tier = tier;
      if (!billing.nextRenewal) {
        billing.start = billing.start || now.toISOString();
        billing.nextRenewal = oneMonthFrom(new Date(billing.start)).toISOString();
        saveBilling(uid, billing);
        return;
      }
      const due = new Date(billing.nextRenewal);
      if (now >= due) {
        restorePerksForTier(tier);
        billing.lastCharge = now.toISOString();
        billing.nextRenewal = oneMonthFrom(now).toISOString();
        saveBilling(uid, billing);
        showToast(`Perks refreshed for ${tier.toUpperCase()} membership`);
      }
      updateExpiryDisplay();
    }

    function getMemberRedemptionEntries() {
      const passCode = (currentPassCode || "").toUpperCase();
      if (!passCode) return [];
      return redemptionLog.filter(entry => (entry.passId || "").toUpperCase() === passCode);
    }

    function perkSavings(key) {
      const pricing = PERK_PRICING[key] || PERK_PRICING.drink;
      const regular = Number(pricing.regular) || 0;
      const voucher = Number(pricing.voucher) || 0;
      return Math.max(0, regular - voucher);
    }

    function resolveBillingStart(billing = {}) {
      const start = billing.start || billing.lastCharge;
      if (start) return start;
      if (billing.nextRenewal) {
        const guess = new Date(billing.nextRenewal);
        if (!Number.isNaN(guess.getTime())) {
          guess.setMonth(guess.getMonth() - 1);
          return guess.toISOString();
        }
      }
      return null;
    }

    function countBillingCycles(startIso, now = new Date()) {
      if (!startIso) return 0;
      const start = new Date(startIso);
      if (Number.isNaN(start.getTime())) return 0;
      let months = (now.getFullYear() - start.getFullYear()) * 12 + (now.getMonth() - start.getMonth());
      if (now.getDate() < start.getDate()) {
        months -= 1;
      }
      return Math.max(1, months + 1);
    }

    function getMonthlyFeeForTier(tier) {
      if (!tier) return 0;
      if (tier === "ceo" || tier === "free" || tier === "issued") return 0;
      return MEMBERSHIP_FEES[tier] || 0;
    }

    function getMstDateKey(date = new Date()) {
      try {
        return new Intl.DateTimeFormat("en-CA", {
          timeZone: "America/Denver",
          year: "numeric",
          month: "2-digit",
          day: "2-digit"
        }).format(date);
      } catch (_) {
        return date.toISOString().slice(0, 10);
      }
    }

    function updateLoginStatsForUser(user) {
      if (!user || user.isAnonymous || !memberProfile) return;
      const todayKey = getMstDateKey(new Date());
      const lastKey = memberProfile.lastLoginDate || "";
      const loginCount = Number(memberProfile.loginCount || 0) + 1;
      let activeDays = Number(memberProfile.activeDays || 0);
      if (!lastKey || lastKey !== todayKey) {
        activeDays += 1;
      }
      memberProfile = { ...memberProfile, loginCount, activeDays, lastLoginDate: todayKey };
      persistMemberState({ loginCount, activeDays, lastLoginDate: todayKey });
    }

    function computeStats(entries) {
      const verified = entries.filter(entry => entry.status === "verified" && !entry.archived && !entry.betaArchived);
      const total = verified.length;
      const venuesVisited = new Set(
        verified.map(entry => (entry.venue || "").toLowerCase()).filter(Boolean)
      ).size;
      const totalSavings = verified.reduce((sum, entry) => {
        const key = normalizePerkKey(entry);
        return sum + perkSavings(key);
      }, 0);
      const tier = currentMembershipTier || memberProfile?.tier || null;
      const monthlyFee = (isCeoActive() || isFreeMember()) ? 0 : getMonthlyFeeForTier(tier);
      let feeTotal = 0;
      if (monthlyFee > 0) {
        const uid = firebaseAuth.currentUser?.uid;
        const billing = uid ? loadBilling(uid) : {};
        const start = resolveBillingStart(billing);
        const cycles = countBillingCycles(start);
        feeTotal = monthlyFee * cycles;
      }
      const netSavings = Math.max(0, totalSavings - feeTotal);
      const avg = total ? (netSavings / total) : 0;
      return { total, venuesVisited, avg };
    }

    function statsCacheKey(code) {
      return `${STATS_CACHE_PREFIX}${(code || "").toUpperCase()}`;
    }
    function saveStatsCache(code, stats) {
      if (!code || !stats) return;
      if (useCloudProfile()) return;
      try {
        localStorage.setItem(statsCacheKey(code), JSON.stringify({ ...stats, cachedAt: Date.now() }));
      } catch (_) {}
    }
    function loadStatsCache(code) {
      if (!code) return null;
      try {
        const raw = localStorage.getItem(statsCacheKey(code));
        return raw ? JSON.parse(raw) : null;
      } catch (_) {
        return null;
      }
    }
    function applyCachedStats() {
      if (useCloudProfile() && navigator.onLine) {
        return;
      }
      const code = (currentPassCode || memberProfile?.passCode || "").toUpperCase();
      const cached = loadStatsCache(code);
      if (cached && typeof cached.total === "number") {
        applyStatsToUi(cached);
      }
    }

    function applyStatsToUi({ total, venuesVisited, avg }) {
      if (statRedemptions) statRedemptions.textContent = total.toString();
      if (statVenuesVisited) statVenuesVisited.textContent = venuesVisited.toString();
      if (statAvgSavings) statAvgSavings.textContent = `$${avg.toFixed(2)} avg`;
      if (statLoginCount) statLoginCount.textContent = `${Number(memberProfile?.loginCount || 0)}`;
      if (statActiveDays) statActiveDays.textContent = `${Number(memberProfile?.activeDays || 0)}`;
      updatePulseBand({ total, venuesVisited, avg });
      updatePointsUI();
      updateQuickStrip();
      updateVoucherBalanceUI();
      const codeForCache = (currentPassCode || memberProfile?.passCode || "").toUpperCase();
      if (codeForCache) saveStatsCache(codeForCache, { total, venuesVisited, avg });
    }
    function updatePulseBand(stats = {}) {
      if (!pulseBand) return;
      const code = (currentPassCode || "").toUpperCase();
      if (pulsePassId && code) {
        pulsePassId.textContent = code;
      }
      if (pulsePrimary) {
        const total = stats.total || 0;
        const venues = stats.venuesVisited || 0;
        pulsePrimary.textContent = total ? `${total} verified â€¢ ${venues} venues` : "Ready for tonight";
      }
      if (pulseThread) {
        const bars = Array.from(pulseThread.children);
        const total = stats.total || 0;
        const palette = window.VIBES || {
          flirty: { factor: 1.15 },
          blacking: { factor: 1.6 },
          social: { factor: 1.3 },
          casual: { factor: 0.75 }
        };
        const vibeName = window.currentVibe || "social";
        const vibeConfig = (palette[vibeName] || palette.social || { factor: 1 });
        bars.forEach((bar, idx) => {
          let base = 12 + Math.sin(idx) * 4;
          switch (vibeName) {
            case "flirty": base = 22 + Math.sin(idx * 1.35) * 12; break; // playful mid bounce
            case "social": base = 30 + Math.sin(idx * 1.1) * 16; break;  // lively high energy
            case "blacking": base = 40 + Math.sin(idx * 1.55) * 22; break; // chaotic max pulse
            case "casual": base = 10 + Math.sin(idx * 0.75) * 6; break;   // relaxed low hum
            default: base = 12 + Math.sin(idx) * 4;
          }
          const spread = Math.max(10, Math.min(68, (total * 2) + base * (vibeConfig.factor || 1)));
          bar.style.setProperty("--pulse-height", `${spread}px`);
          bar.style.setProperty("--pulse-speed", `${1 + Math.random() * 0.6}s`);
          bar.style.setProperty("--pulse-delay", `${Math.random() * 0.6}s`);
          bar.style.opacity = 0.55 + (0.02 * idx);
        });
      }
      if (pulsePassId) {
        pulsePassId.onclick = async () => {
          if (!code) return;
          try {
            await navigator.clipboard.writeText(code);
            showToast("Pass ID copied");
          } catch (_) {
            showToast(code);
          }
        };
      }
    }

    // Simple toast utility
    function showToast(message, duration = 3200) {
      let toast = document.getElementById("focoToast");
      if (!toast) {
        toast = document.createElement("div");
        toast.id = "focoToast";
        toast.style.position = "fixed";
        toast.style.bottom = "18px";
        toast.style.left = "50%";
        toast.style.transform = "translateX(-50%)";
        toast.style.padding = "12px 18px";
        toast.style.borderRadius = "16px";
        toast.style.background = "rgba(20,24,38,0.92)";
        toast.style.color = "#e2e8f0";
        toast.style.fontSize = "14px";
        toast.style.letterSpacing = "0.02em";
        toast.style.boxShadow = "0 12px 32px rgba(0,0,0,0.35)";
        toast.style.border = "1px solid rgba(103,232,249,0.35)";
        toast.style.zIndex = "9999";
        toast.style.opacity = "0";
        toast.style.transition = "opacity 180ms ease";
        document.body.appendChild(toast);
      }
      toast.textContent = message;
      toast.style.opacity = "1";
      setTimeout(() => {
        toast.style.opacity = "0";
      }, duration);
    }

    async function fetchMemberRedemptionsFromCloud(passCode) {
      if (!db || !passCode) return [];
      try {
        await ensureFirebaseUser();
        const q = query(collection(db, "redemptions"), where("passId", "==", passCode));
        const snap = await getDocs(q);
        const toIso = (ts) => {
          if (!ts) return new Date().toISOString();
          if (ts.toDate) return ts.toDate().toISOString();
          return new Date(ts).toISOString();
        };
        return snap.docs.map(docSnap => {
          const data = docSnap.data() || {};
          return {
            code: (data.code || docSnap.id || "").toUpperCase(),
            perk: data.perk || data.perkKey || "Perk",
            perkKey: data.perkKey || null,
            venuePerkId: data.venuePerkId || null,
            venuePerkLabel: data.venuePerkLabel || null,
            member: data.member || "FoCo member",
            passId: (data.passId || passCode).toUpperCase(),
            venue: data.venue || null,
            requestedVenue: data.requestedVenue || null,
            ceo: !!data.ceo,
            status: data.status || "pending",
            timestamp: toIso(data.timestamp),
            verifiedAt: toIso(data.verifiedAt || data.timestamp),
          };
        });
      } catch (err) {
        console.warn("Cloud stats fetch failed", err);
        return [];
      }
    }
    function clearPassRealtime() {
      passRealtimeUnsubs.forEach(unsub => {
        try { if (typeof unsub === "function") unsub(); } catch (e) { /* ignore */ }
      });
      passRealtimeUnsubs = [];
    }
  function clearGlobalRealtime() {
    globalRealtimeUnsubs.forEach(unsub => {
      try { if (typeof unsub === "function") unsub(); } catch (e) { /* ignore */ }
    });
    globalRealtimeUnsubs = [];
  }
  function detachRealtime() {
    clearGlobalRealtime();
    clearPassRealtime();
  }
  function attachRealtime() {
    attachGlobalRealtime();
    attachPassRealtime(currentPassCode);
  }
  function reattachRealtime() {
    detachRealtime();
    attachRealtime();
    try {
      if (navigator.onLine) {
        showToast("Live updates reconnected.", 2200);
        if (reconnectBanner) reconnectBanner.style.display = "none";
      }
    } catch (_) {}
  }
  function applyVipDealsSnapshot(snapshot) {
    if (!snapshot) return;
    const nextCache = {};
    snapshot.forEach(docSnap => {
      nextCache[docSnap.id] = docSnap.data();
    });
    vipDealsCache = nextCache;
    renderVipDealForMember();
    renderStaffVipDeal();
    refreshAlertsTicker();
  }
  function applyAlertsSnapshot(snapshot) {
    if (!snapshot) return;
    const now = Date.now();
    const fetched = [];
    snapshot.forEach(docSnap => {
      const data = docSnap.data() || {};
      const expiresAtMs = data.expiresAt?.toMillis
        ? data.expiresAt.toMillis()
        : (data.expiresAt ? new Date(data.expiresAt).getTime() : null);
      if (expiresAtMs && expiresAtMs <= now) return;
      const createdAtMs = data.createdAt?.toMillis ? data.createdAt.toMillis() : Date.now();
      fetched.push({
        id: docSnap.id,
        venueId: data.venueId,
        venueName: data.venueName || venuesInfo[data.venueId]?.name || "FoCo venue",
        title: data.title || data.venueName || "FoCo alert",
        detail: data.detail || "",
        meta: data.meta || data.venueName || "",
        expiresAt: expiresAtMs,
        createdAt: createdAtMs,
      });
    });
    fetched.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
    tonightAlerts = fetched;
    alertsCache = [...fetched];
    refreshAlertsTicker();
    renderStaffAlertPreview();
    renderStaffDealCodes();
  }
  function applyVenuePerksSnapshot(snapshot) {
    if (!snapshot) return;
    const nextCache = {};
    snapshot.forEach(docSnap => {
      const data = docSnap.data() || {};
      const perks = normalizeVenuePerks(data.perks || []);
      nextCache[docSnap.id] = perks;
    });
    venuePerksCache = nextCache;
    refreshFeaturedVenuesData();
  }
  function attachGlobalRealtime() {
    if (!db) return;
    if (appLocked && !isCeoAccount) return;
    if (globalRealtimeUnsubs.length) return;
    try {
      globalRealtimeUnsubs.push(onSnapshot(collection(db, "vipDeals"), (snap) => {
        applyVipDealsSnapshot(snap);
      }));
    } catch (err) {
      console.warn("Global vipDeals listener failed", err);
    }
    try {
      globalRealtimeUnsubs.push(onSnapshot(collection(db, "alerts"), (snap) => {
        applyAlertsSnapshot(snap);
      }));
    } catch (err) {
      console.warn("Global alerts listener failed", err);
    }
    try {
      globalRealtimeUnsubs.push(onSnapshot(collection(db, "venuePerks"), (snap) => {
        applyVenuePerksSnapshot(snap);
      }));
    } catch (err) {
      console.warn("Global venuePerks listener failed", err);
    }
  }
    function attachPassRealtime(passCodeArg) {
      clearPassRealtime();
      if (!db) return;
      if (appLocked && !isCeoAccount) return;
      const uid = firebaseAuth.currentUser?.uid || null;
      // Pass code is needed for redemptions; prefer actual passCode over uid
      const code = (memberProfile?.passCode || memberProfile?.passId || currentPassCode || passCodeArg || "").toUpperCase();
      if (uid) {
        try {
          const ref = doc(db, "members", uid);
          passRealtimeUnsubs.push(onSnapshot(ref, (snap) => {
            if (snap.exists()) {
              const data = snap.data() || {};
              const mergedPass = (data.passCode || data.passId || code || currentPassCode || "").toUpperCase();
              memberProfile = { ...(memberProfile || {}), ...data, passCode: mergedPass };
              if (mergedPass && mergedPass !== currentPassCode) {
                currentPassCode = mergedPass;
                persistLocalPassCode(currentPassCode);
                setTimeout(() => reattachRealtime(), 0);
              }
              if (mergedPass) setMemberDirectoryEntry(mergedPass, memberProfile);
              if (data.accent) applyAccentTheme(data.accent);
              if (data.vibe) applyVibeStyle(data.vibe);
              if (data.freeMembership) {
                memberProfile.freeMembership = true;
                applyMembershipToPass("free");
                updateExpiryDisplay();
                renderRedemptionOptions();
                renderVipDealForMember();
                updateNightWheelUI();
                updateQuickStrip();
              }
              if (data.tier) {
              currentMembershipTier = data.tier;
              applyMembershipToPass(currentMembershipTier);
            }
            if (data.points !== undefined) {
              setPointsForPass(mergedPass, data.points, { skipPersist: true, forceLower: true });
            }
            updatePointsUI();
            renderVipDealForMember();
            renderPassIdentity(firebaseAuth.currentUser);
          }
          }));
        } catch (err) {
          console.warn("Member realtime listener failed", err);
        }
      }
      if (code) {
        try {
          passRealtimeUnsubs.push(onSnapshot(query(collection(db, "redemptions"), where("passId", "==", code)), (snap) => {
            const toIso = (ts) => {
              if (!ts) return new Date().toISOString();
              if (ts.toDate) return ts.toDate().toISOString();
              return new Date(ts).toISOString();
            };
            const entries = snap.docs.map(docSnap => {
              const data = docSnap.data() || {};
              return {
                code: (data.code || docSnap.id || "").toUpperCase(),
                perk: data.perk || data.perkKey || "Perk",
                perkKey: data.perkKey || null,
                venuePerkId: data.venuePerkId || null,
                venuePerkLabel: data.venuePerkLabel || null,
                member: data.member || "FoCo member",
                passId: (data.passId || code).toUpperCase(),
                venue: data.venue || null,
                requestedVenue: data.requestedVenue || null,
                ceo: !!data.ceo,
                status: data.status || "pending",
                timestamp: toIso(data.timestamp),
                verifiedAt: toIso(data.verifiedAt || data.timestamp),
              };
            });
            if (!entries.length) {
              redemptionLog = [];
              refreshMemberStats();
              return;
            }
            mergeRedemptionLogEntries(entries);
          }));
        } catch (err) {
          console.warn("Redemption realtime listener failed", err);
        }
        try {
          passRealtimeUnsubs.push(onSnapshot(doc(db, "freeMemberships", code), (snap) => {
            if (snap.exists()) {
              const data = snap.data() || {};
              if (data && data.active !== false) {
                memberProfile = { ...(memberProfile || {}), freeMembership: true, passCode: code, tier: "free" };
                setMemberDirectoryEntry(code, memberProfile);
                applyMembershipToPass("free");
                updateExpiryDisplay();
                renderRedemptionOptions();
                renderVipDealForMember();
                updateNightWheelUI();
                updateQuickStrip();
              }
            }
          }));
        } catch (err) {
          console.warn("Free membership realtime listener failed", err);
        }
      }
    }

    async function refreshMemberStats() {
      const localEntries = getMemberRedemptionEntries();
      // When signed in, rely on realtime snapshots to populate redemptionLog.
      // Offline/beta uses whatever local entries exist.
      applyStatsToUi(computeStats(localEntries));
      updateStreakBadge(localEntries);
      renderProfileBadges();
      evaluateAchievements(localEntries);
    }
    refreshMemberStats();


    function getActiveAlertsForMember() {
      const now = Date.now();
      const baseAlerts = tonightAlerts
        .filter(alert => !alert.expiresAt || alert.expiresAt > now)
        .sort((a, b) => (a.expiresAt || Number.MAX_SAFE_INTEGER) - (b.expiresAt || Number.MAX_SAFE_INTEGER))
        .map(alert => ({
          title: alert.title || alert.venue || "FoCo venue",
          detail: alert.detail || "",
          meta: alert.meta || alert.venue || "",
          type: "general",
          expiresAt: alert.expiresAt || null
        }));
      const isVip = hasVipAccess();
      if (isVip) {
        const vipAlerts = getActiveVipDeals().map(deal => ({
          title: deal.title || venuesInfo[deal.venueId]?.name || "VIP venue",
          detail: deal.detail || "",
          meta: deal.meta || `VIP Â· ${venuesInfo[deal.venueId]?.name || "FoCo"}`,
          type: "vip",
          expiresAt: deal.expiresAt?.toMillis ? deal.expiresAt.toMillis() : (deal.expiresAt ? new Date(deal.expiresAt).getTime() : null)
        }));
        return [...vipAlerts, ...baseAlerts];
      }
      return baseAlerts;
    }

    function renderAlertsList() {
      if (!alertsList) return;
      const activeAlerts = getActiveAlertsForMember();
      if (!activeAlerts.length) {
        alertsList.innerHTML = `
          <li class="empty">
            <span>No alerts tonight. Check back when venues post live perks.</span>
          </li>
        `;
        return;
      }
      const visible = [];
      for (let i = 0; i < Math.min(3, activeAlerts.length); i++) {
        visible.push(activeAlerts[(alertsRotationIndex + i) % activeAlerts.length]);
      }
      alertsList.innerHTML = visible.map(alert => {
        let timer = "";
        if (alert.expiresAt) {
          const diff = alert.expiresAt - Date.now();
          if (diff > 0) {
            const mins = Math.max(0, Math.floor(diff / 60000));
            const secs = Math.max(0, Math.floor((diff % 60000) / 1000));
            timer = `<span class="alert-timer">${mins.toString().padStart(2, "0")}:${secs.toString().padStart(2, "0")} left</span>`;
          }
        }
      return `
        <li>
          <strong>${alert.title}</strong>
          <span>${alert.detail}</span>
          <span class="alerts-meta">${alert.meta || ""}${alert.type === "vip" ? " â€¢ VIP" : ""}</span>
          ${timer}
        </li>
      `;
    }).join("");
    }

    function refreshAlertsTicker() {
      renderAlertsList();
      const activeCount = getActiveAlertsForMember().length;
      if (activeCount > 3) {
        if (!window.__alertsRotationHandle) {
          window.__alertsRotationHandle = setInterval(() => {
            alertsRotationIndex = (alertsRotationIndex + 1) % activeCount;
            renderAlertsList();
          }, 9000);
        }
      } else if (window.__alertsRotationHandle) {
        clearInterval(window.__alertsRotationHandle);
        window.__alertsRotationHandle = null;
      }
      if (activeCount === 0) {
        stopAlertsCountdown();
        return;
      }
      if (!window.__alertsCountdownHandle) {
        window.__alertsCountdownHandle = setInterval(() => {
          renderAlertsList();
        }, 1000);
      }
    }
    function stopAlertsCountdown() {
      if (window.__alertsCountdownHandle) {
        clearInterval(window.__alertsCountdownHandle);
        window.__alertsCountdownHandle = null;
      }
    }
    refreshAlertsTicker();
    setInterval(() => {
      pruneExpiredAlerts();
    }, 60000);
    function setOfflineReadyStatus(isReady, copyText) {
      if (!offlineBadge) return;
      offlineBadge.classList.toggle("syncing", !isReady);
      offlineBadge.textContent = isReady ? "Offline ready" : "Syncing";
      if (offlineCopy && copyText) {
        offlineCopy.textContent = copyText;
      }
    }
    setOfflineReadyStatus(false, "Syncing secure QRâ€¦");
    function formatTimeLabel(timestamp) {
      if (!timestamp) return "";
      return new Date(timestamp).toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
    }
    const tsToMillis = (ts) => {
      if (!ts) return Date.now();
      if (ts.toMillis) return ts.toMillis();
      if (typeof ts === "object" && typeof ts.seconds === "number") return ts.seconds * 1000;
      return Number(ts) || Date.now();
    };
    function getSelectedStaffMessageIds() {
      if (!staffMessagesList) return [];
      return Array.from(staffMessagesList.querySelectorAll(".staff-msg-check:checked"))
        .map(el => el.value)
        .filter(Boolean);
    }
    function renderStaffTicker() {
      if (!staffTickerList) return;
      const venueId = staffSession?.venue || null;
      const scoped = venueId
        ? staffTickerEntries.filter(item => item.venue === venueId)
        : staffTickerEntries;
      if (!scoped.length) {
        staffTickerList.innerHTML = '<li class="empty">No scans yet. Verify a pass to populate this feed.</li>';
        return;
      }
      staffTickerList.innerHTML = scoped.map(entry => `
        <li>
          <div>
            <strong>${entry.perk || "Perk redeemed"}</strong>
            <span style="display:block;color:#94a3b8;">${entry.member || "FoCo member"} â€¢ ${entry.code}</span>
          </div>
          <span class="time">${formatTimeLabel(entry.timestamp)}</span>
        </li>
      `).join("");
    }

    function renderStaffMessages(messages = []) {
      if (!staffMessagesList) return;
      const sorted = messages
        .slice()
        .sort((a, b) => {
          const aTs = tsToMillis(a.repliedAt || a.createdAtServer || a.createdAt);
          const bTs = tsToMillis(b.repliedAt || b.createdAtServer || b.createdAt);
          return bTs - aTs;
        });
      const visible = sorted.slice(0, 25);
      staffMessagesCache = visible;
      if (!visible.length) {
        staffMessagesList.innerHTML = "No messages yet.";
        if (staffMsgBadge) staffMsgBadge.style.display = "none";
        return;
      }
      const unread = visible.some(m => m.reply && !m.readByStaff);
      if (staffMsgBadge) staffMsgBadge.style.display = unread ? "inline-flex" : "none";
      staffMessagesList.innerHTML = visible
        .map(msg => {
          const created = formatTimeLabel(tsToMillis(msg.createdAt || msg.createdAtServer));
          const replyBlock = msg.reply
            ? `<div class="small" style="color:#cbd5f5;margin-top:4px;">CEO: ${msg.reply}</div>`
            : "";
          const rowClass = `staff-msg-row${msg.reply && !msg.readByStaff ? " staff-msg-unread" : ""}`;
          return `<div class="${rowClass}" data-id="${msg.id}" style="margin-bottom:8px;padding:8px;border-radius:10px;border:1px solid rgba(148,163,184,0.18);background:rgba(15,23,42,0.65);">
            <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
              <div style="font-weight:600;display:flex;gap:8px;align-items:center;">
                <input class="staff-msg-check" type="checkbox" value="${msg.id}" aria-label="Select message" />
                <span>${msg.venueName || "Your venue"}</span>
              </div>
              <span style="font-size:12px;color:#94a3b8;">${created}</span>
            </div>
            <div style="color:#e2e8f0;margin-top:4px;">${msg.message || ""}</div>
            ${replyBlock}
          </div>`;
        })
        .join("");
      staffMessagesList.querySelectorAll(".staff-msg-row").forEach(row => {
        row.addEventListener("click", async (evt) => {
          if (evt?.target?.classList?.contains("staff-msg-check")) return;
          const id = row.getAttribute("data-id");
          if (!id || !db) return;
          const msg = staffMessagesCache.find(item => item.id === id);
          if (!msg || msg.readByStaff) return;
          try {
            await updateDoc(doc(db, "staffMessages", id), { readByStaff: true });
          } catch (err) {
            console.warn("Failed to mark staff message read", err);
          }
        });
      });
    }

    function renderCeoMessages(messages = []) {
      if (!ceoMessagesList) return;
      ceoMessagesCache = messages;
      if (!messages.length) {
        ceoMessagesList.innerHTML = "No messages yet.";
        if (ceoMsgBadge) ceoMsgBadge.style.display = "none";
        return;
      }
      const unread = messages.some(m => !m.readByCeo);
      if (ceoMsgBadge) ceoMsgBadge.style.display = unread ? "inline-flex" : "none";
      ceoMessagesList.innerHTML = messages
        .map(msg => {
          const created = formatTimeLabel(tsToMillis(msg.createdAt || msg.createdAtServer));
          const reply = msg.reply ? `<div class="small" style="color:#cbd5f5;margin-top:4px;">Reply: ${msg.reply}</div>` : "";
          const cls = !msg.readByCeo ? "style=\"border:1px solid rgba(34,211,238,0.35);\"" : "";
          return `<div ${cls} class="message-row" data-id="${msg.id}" style="padding:8px;border-radius:10px;background:rgba(12,18,32,0.8);margin-bottom:8px;cursor:pointer;">
            <div style="display:flex;justify-content:space-between;gap:8px;">
              <div><strong>${msg.venueName || "Venue"}</strong><div style="color:#cbd5f5;font-size:12px;">${msg.staffUid || ""}</div></div>
              <span style="font-size:12px;color:#94a3b8;">${created}</span>
            </div>
            <div style="color:#e2e8f0;margin-top:4px;">${msg.message || ""}</div>
            ${reply}
          </div>`;
        })
        .join("");
      ceoMessagesList.querySelectorAll(".message-row").forEach(row => {
        row.addEventListener("click", async () => {
          const id = row.getAttribute("data-id");
          if (ceoReplyTarget) ceoReplyTarget.value = id;
          if (ceoReplyInput) ceoReplyInput.focus();
          if (!id || !isCeoAccount || !db) return;
          const msg = ceoMessagesCache.find(item => item.id === id);
          if (!msg || msg.readByCeo) return;
          try {
            await updateDoc(doc(db, "staffMessages", id), { readByCeo: true });
          } catch (err) {
            console.warn("Failed to mark CEO message read", err);
          }
        });
      });
    }
    function logStaffVerification(entry) {
      if (!entry) return;
      const nowTs = new Date().toISOString();
      const detail = {
        perk: entry.perk || entry.perkKey || "Perk",
        member: entry.member || entry.passId || "FoCo member",
        code: entry.code || "â€”",
        timestamp: entry.verifiedAt || nowTs,
        venue: staffSession?.venue || entry.venue || null,
        staffUser: staffSession?.venue || "staff",
      };
      staffTickerEntries.unshift(detail);
      staffTickerEntries = staffTickerEntries.slice(0, 5);
      renderStaffTicker();
      updateStaffRadar();
      if (staffRadarCount) {
        const current = parseInt((staffRadarCount.textContent || "0").split(" ")[0], 10) || 0;
        staffRadarCount.textContent = `${current + 1} scans Â· last hour`;
      }
    }
    renderStaffTicker();
let onboardingIndex = 0;
    function simulateStaffScan() {
      if (!simulatedScans.length) return;
      const template = simulatedScans[Math.floor(Math.random() * simulatedScans.length)];
      const entry = {
        perk: template.perk,
        member: template.member,
        passId: template.passId,
        code: `SIM${Math.random().toString(36).slice(2, 7).toUpperCase()}`,
        verifiedAt: new Date().toISOString(),
      };
      logStaffVerification(entry);
      showNeonSuccess(verifySuccess, `Simulated ${template.perk}`, 4600);
    }
    function updatePitchSlide() {
      if (!pitchDeckModal || !pitchSlides.length) return;
      const slide = pitchSlides[pitchIndex];
      if (pitchTitle) pitchTitle.textContent = slide.title;
      if (pitchBody) pitchBody.textContent = slide.body;
      if (pitchMeter) pitchMeter.textContent = `Slide ${pitchIndex + 1} of ${pitchSlides.length}`;
      if (pitchPrevBtn) pitchPrevBtn.disabled = pitchIndex === 0;
      if (pitchNextBtn) pitchNextBtn.textContent = pitchIndex === pitchSlides.length - 1 ? "Finish" : "Next";
    }
    function openPitchDeck() {
      pitchIndex = 0;
      updatePitchSlide();
      if (pitchDeckModal) pitchDeckModal.classList.add("active");
    }
    function closePitchDeck() {
      if (pitchDeckModal) pitchDeckModal.classList.remove("active");
    }
    function updateOnboardingStep() {
      if (!onboardingOverlay || !onboardingTitle || !onboardingBody || !onboardingIndicator || !onboardingNext) return;
      const step = onboardingSteps[onboardingIndex];
      onboardingTitle.textContent = step.title;
      onboardingBody.textContent = step.copy;
      onboardingIndicator.textContent = `Step ${onboardingIndex + 1} of ${onboardingSteps.length}`;
      onboardingNext.textContent = onboardingIndex === onboardingSteps.length - 1 ? "Let's go" : "Next";
    }
    function hideOnboarding(persist = true) {
      if (onboardingOverlay) onboardingOverlay.classList.remove("active");
      if (persist) localStorage.setItem(ONBOARDING_STORAGE_KEY, "true");
    }
    function maybeShowOnboarding(force = false) {
      if (!onboardingOverlay || !onboardingTitle) return;
      if (isCeoActive() || isCeoAccount) return;
      if (!force && localStorage.getItem(ONBOARDING_STORAGE_KEY) === "true") return;
      onboardingIndex = 0;
      updateOnboardingStep();
      onboardingOverlay.classList.add("active");
    }
    if (onboardingNext) {
      onboardingNext.addEventListener("click", () => {
        onboardingIndex += 1;
        if (onboardingIndex >= onboardingSteps.length) {
          hideOnboarding(true);
        } else {
          updateOnboardingStep();
        }
      });
    }
    if (onboardingSkip) {
      onboardingSkip.addEventListener("click", () => hideOnboarding(true));
    }
    if (pitchModeBtn) {
      pitchModeBtn.addEventListener("click", openPitchDeck);
    }
    if (pitchNextBtn) {
      pitchNextBtn.addEventListener("click", () => {
        if (pitchIndex >= pitchSlides.length - 1) {
          closePitchDeck();
          return;
        }
        pitchIndex += 1;
        updatePitchSlide();
      });
    }
    if (pitchPrevBtn) {
      pitchPrevBtn.addEventListener("click", () => {
        pitchIndex = Math.max(0, pitchIndex - 1);
        updatePitchSlide();
      });
    }
    if (pitchCloseBtn) {
      pitchCloseBtn.addEventListener("click", closePitchDeck);
    }
    if (pitchDeckModal) {
      pitchDeckModal.addEventListener("click", (e) => {
        if (e.target === pitchDeckModal) closePitchDeck();
      });
    }
    if (vipDealForm) {
      vipDealForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (vipDealError) vipDealError.textContent = "";
        if (vipDealSuccess) vipDealSuccess.classList.remove("visible");
        if (!staffSession) {
          if (vipDealError) vipDealError.textContent = "Log in as staff to publish a VIP deal.";
          return;
        }
        const title = vipDealTitle.value.trim();
        const detail = vipDealDetail.value.trim();
        const venueName = venuesInfo[staffSession.venue]?.name || "FoCo venue";
        const metaInput = vipDealMeta.value.trim();
        const meta = metaInput || `VIP Â· ${venueName}`;
        const expiresValue = vipDealExpires.value;
        if (!title || !detail || !meta || !expiresValue) {
          if (vipDealError) vipDealError.textContent = "Fill in headline, details, tag, and expiry.";
          return;
        }
        const expiresIso = expiresValue.length === 16 ? `${expiresValue}:00` : expiresValue;
        const expiresDate = new Date(expiresIso);
        if (Number.isNaN(expiresDate.getTime())) {
          if (vipDealError) vipDealError.textContent = "Enter a valid expiry date (YYYY-MM-DD HH:MM).";
          return;
        }
        const venueId = staffSession.venue;
        const useLocalCache = allowLocalCache();
        const localDeal = {
          venueId,
          venueName,
          title,
          detail,
          meta,
          expiresAt: expiresDate.toISOString(),
          updatedAt: new Date().toISOString(),
        };
        if (useLocalCache) {
          vipDealsCache[venueId] = localDeal;
          saveVipDealsToStorage(vipDealsCache);
          renderVipDealForMember();
          renderStaffVipDeal();
          refreshAlertsTicker();
        }
        vipDealTitle.value = "";
        vipDealDetail.value = "";
        if (vipDealMeta) vipDealMeta.value = "";
        vipDealExpires.value = "";
        if (useLocalCache && vipDealSuccess) {
          vipDealSuccess.textContent = "Deal updated for VIP members.";
          vipDealSuccess.classList.add("visible");
          setTimeout(() => vipDealSuccess.classList.remove("visible"), 2000);
        }
        try {
          if (db) {
            await setDoc(doc(db, "vipDeals", venueId), {
              venueId,
              venueName,
              title,
              detail,
              meta,
              expiresAt: Timestamp.fromDate(expiresDate),
              updatedAt: serverTimestamp(),
            });
            await refreshVipDeals();
            if (!useLocalCache && vipDealSuccess) {
              vipDealSuccess.textContent = "Deal updated for VIP members.";
              vipDealSuccess.classList.add("visible");
              setTimeout(() => vipDealSuccess.classList.remove("visible"), 2000);
            }
          }
        } catch (err) {
          console.error("Failed to publish VIP deal", err);
          if (vipDealError) vipDealError.textContent = "Could not save deal. Try again.";
        }
      });
    }
    if (receiptClose) {
      receiptClose.addEventListener("click", hideReceipt);
    }
    if (receiptOverlay) {
      receiptOverlay.addEventListener("click", (e) => {
        if (e.target === receiptOverlay) hideReceipt();
      });
    }

    function toggleNavMenu(forceState) {
      if (!navMenu) return;
      const isActive = typeof forceState === "boolean" ? forceState : !navMenu.classList.contains("active");
      navMenu.classList.toggle("active", isActive);
      if (isActive) {
        markAchievementsSeen();
      }
    }

    function closeNavMenu() {
      if (navMenu) navMenu.classList.remove("active");
    }

    function showCancelModal() {
      if (cancelMembershipModal) cancelMembershipModal.classList.add("active");
      closeNavMenu();
    }

    async function cancelMembershipAndSignOut() {
      const user = firebaseAuth.currentUser;
      const uid = user?.uid;
      const passId = (memberProfile?.passCode || currentPassCode || "").toUpperCase();
      if (passId) {
        removeMemberDirectoryEntry(passId);
        localStorage.removeItem(`passcode_${uid || "unknown"}`);
      }
      if (uid) {
        localStorage.removeItem(`membership_${uid}`);
        if (localStorage.getItem(PENDING_MEMBERSHIP_STORAGE_KEY) === uid) {
          localStorage.removeItem(PENDING_MEMBERSHIP_STORAGE_KEY);
        }
      }
      ["betaSkipActive", "staffSession", "ceoSession"].forEach(key => localStorage.removeItem(key));
      exitBetaPassMode();
      onboardingMembershipFlow = false;
      forceMembershipScreen = false;
      ceoSession = false;
      isCeoAccount = false;
      ceoPreviewTier = null;
      stopCeoMessagesListener();
      stopCloseOutReportsListener();
      updateCeoPassUI();
      pendingMembershipTier = null;
      resetPaymentForm();
      resetSupportForm();
      memberProfile = null;
      memberDocRef = null;
      currentPassCode = null;
      document.body.classList.remove("ceo-active");
      applyAccentTheme("cyan");
      applyBackgroundTheme("default");
      localStorage.removeItem(ACCENT_KEY);
      localStorage.removeItem(BG_KEY);
      try {
        await signOut(firebaseAuth);
      } catch (err) {
        console.warn("Cancel sign-out skipped:", err);
      }
      closeCancelModal();
      applyRememberedEmailToForm();
      showScreen("landing");
    }

    function closeCancelModal() {
      if (cancelMembershipModal) cancelMembershipModal.classList.remove("active");
    }

    function showNeonSuccess(element, message, duration = 7200, clearAfter = false) {
      if (!element) return;
      if (message) element.textContent = message;
      element.classList.add("visible");
      const activeTimer = successTimers.get(element);
      if (activeTimer) clearTimeout(activeTimer);
      const timeout = setTimeout(() => {
        element.classList.remove("visible");
        if (clearAfter) element.textContent = "";
      }, duration);
      successTimers.set(element, timeout);
    }

    logoutLink.addEventListener("click", async () => {
      const currentUid = firebaseAuth.currentUser?.uid;
      try {
        await signOut(firebaseAuth);
      } catch (err) {
        console.warn("Sign-out skipped (probably no auth user):", err);
      }
      clearPassRealtime();
      clearGlobalRealtime();
      resetInMemoryCaches();
      ["betaSkipActive", "staffSession", "ceoSession"].forEach(key => localStorage.removeItem(key));
      exitBetaPassMode();
      onboardingMembershipFlow = false;
      forceMembershipScreen = false;
      ceoSession = false;
      isCeoAccount = false;
      ceoPreviewTier = null;
      stopCeoMessagesListener();
      stopCloseOutReportsListener();
      updateCeoPassUI();
      pendingMembershipTier = null;
      resetPaymentForm();
      resetSupportForm();
      applyAccentTheme("cyan");
      localStorage.removeItem(ACCENT_KEY);
      localStorage.removeItem(AVATAR_COLOR_KEY);
      applyBackgroundTheme("default");
      localStorage.removeItem(BG_KEY);
      memberProfile = null;
      memberDocRef = null;
      currentPassCode = null;
      document.body.classList.remove("ceo-active");
      if (currentUid) localStorage.removeItem(`passcode_${currentUid}`);
      clearPendingMembershipFlagForUser(currentUid);
      applyRememberedEmailToForm();
      showScreen("landing");
      stopIdleTimer();
      setTimeout(() => {
        window.location.reload();
      }, 150);
    });

    if (navMenuToggle) {
      navMenuToggle.addEventListener("click", () => toggleNavMenu());
    }
    async function softRefresh() {
      if (navMenu) navMenu.classList.remove("open");
      if (firebaseAuth.currentUser) {
        try {
          showPassLoading();
          await handleAuthenticatedUser(firebaseAuth.currentUser);
        } catch (err) {
          console.warn("Soft refresh failed, doing hard reload", err);
          window.location.reload();
        }
      } else {
        window.location.reload();
      }
    }
    if (refreshBtn) {
      refreshBtn.addEventListener("click", () => {
        softRefresh();
      });
    }
    if (landingRefreshBtn) {
      landingRefreshBtn.addEventListener("click", () => {
        window.location.reload();
      });
    }
    if (navItems.length) {
      navItems.forEach(item => {
        item.addEventListener("click", () => {
          const action = item.dataset.nav;
          switch (action) {
            case "support":
              if (supportTrigger) supportTrigger.click();
              break;
            case "rewards":
              if (rewardsTrigger) rewardsTrigger.click();
              break;
            case "review":
              const reviewBtn = document.getElementById("leaveReviewBtn");
              if (reviewBtn) reviewBtn.click();
              break;
            case "cancelMembership":
              showCancelModal();
              break;
            case "about":
              if (aboutModal) aboutModal.classList.add("active");
              break;
            default:
              break;
          }
          closeNavMenu();
        });
      });
    }
    if (accentChips && accentChips.length) {
      accentChips.forEach(chip => {
        chip.addEventListener("click", () => {
          const theme = chip.dataset.accent || "cyan";
          applyAccentTheme(theme);
          closeNavMenu();
        });
      });
    }
    if (accentChips && accentChips.length) {
      accentChips.forEach(chip => {
        chip.addEventListener("click", () => {
          const theme = chip.dataset.accent || "cyan";
          applyAccentTheme(theme);
          closeNavMenu();
        });
      });
    }
    document.addEventListener("click", (e) => {
      if (!navMenu || !navMenuToggle) return;
      if (navMenu.contains(e.target) || navMenuToggle.contains(e.target)) return;
      closeNavMenu();
    });
    const aboutClose = document.getElementById("aboutClose");
    if (aboutClose) {
      aboutClose.addEventListener("click", () => {
        if (aboutModal) aboutModal.classList.remove("active");
      });
    }
    if (aboutModal) {
      aboutModal.addEventListener("click", (e) => {
        if (e.target === aboutModal) aboutModal.classList.remove("active");
      });
    }
    if (cancelMembershipConfirm) {
      cancelMembershipConfirm.addEventListener("click", cancelMembershipAndSignOut);
    }
    if (cancelMembershipAbort) {
      cancelMembershipAbort.addEventListener("click", closeCancelModal);
    }
    if (cancelMembershipClose) {
      cancelMembershipClose.addEventListener("click", closeCancelModal);
    }
    if (cancelMembershipModal) {
      cancelMembershipModal.addEventListener("click", (e) => {
        if (e.target === cancelMembershipModal) closeCancelModal();
      });
    }
    if (rewardsTrigger) {
      rewardsTrigger.addEventListener("click", () => {
        if (rewardsModal) rewardsModal.classList.add("active");
        updateRewardsUI();
      });
    }
    [rewardsClose, rewardsCloseBtn].forEach(btn => {
      if (btn) btn.addEventListener("click", () => {
        if (rewardsModal) rewardsModal.classList.remove("active");
      });
    });
    if (rewardsRedeemBtn) {
      rewardsRedeemBtn.addEventListener("click", () => {
        if (!rewardsProgress.available) {
          if (rewardsError) rewardsError.textContent = "Keep redeeming to unlock rewards.";
          return;
        }
      const code = showRedemptionQr("Reward: shot perk");
      const entry = {
        code,
        perk: "Reward: shot perk",
        member: passUserName.textContent,
        ceo: isCeoActive(),
        perkKey: "reward_shot",
          passId: (currentPassCode || "").toUpperCase(),
          status: "pending",
          timestamp: new Date().toISOString(),
        };
        addRedemptionLogEntry(entry);
        showNeonSuccess(rewardsSuccess, "Reward ready for staff to redeem.", 3200);
        rewardsProgress.available = false;
        rewardsProgress.rewardType = null;
        rewardsProgress.count = 0;
        saveRewardsProgress(rewardsProgress);
        updateRewardsUI();
        if (rewardsModal) rewardsModal.classList.remove("active");
      });
    }

    // Staff alert/deal actions (expire/duplicate)
    if (alertPreview) {
      alertPreview.addEventListener("click", async (e) => {
        const expireBtn = e.target.closest("[data-expire-alert]");
        if (!staffSession) return;
        if (expireBtn) {
          const id = expireBtn.dataset.expireAlert;
          const useLocalCache = allowLocalCache();
          if (useLocalCache) {
            tonightAlerts = tonightAlerts.map(alert =>
              alert.id === id ? { ...alert, expiresAt: Date.now() - 1000 } : alert
            );
            saveAlertsToStorage(tonightAlerts);
            refreshAlertsTicker();
            renderStaffAlertPreview();
            return;
          }
          if (!db) return;
          try {
            await setDoc(doc(db, "alerts", id), {
              expiresAt: Timestamp.fromDate(new Date(Date.now() - 1000)),
              updatedAt: serverTimestamp(),
            }, { merge: true });
            await refreshTonightAlerts();
          } catch (err) {
            console.error("Failed to expire alert", err);
          }
        }
      });
    }
    if (vipDealPreview) {
      vipDealPreview.addEventListener("click", async (e) => {
        const expireBtn = e.target.closest("[data-expire-vipdeal]");
        if (!staffSession) return;
        if (expireBtn) {
          const id = expireBtn.dataset.expireVipdeal;
          const useLocalCache = allowLocalCache();
          if (useLocalCache) {
            if (vipDealsCache[id]) {
              vipDealsCache[id].expiresAt = new Date(Date.now() - 1000).toISOString();
              saveVipDealsToStorage(vipDealsCache);
              renderVipDealForMember();
              renderStaffVipDeal();
            }
            return;
          }
          if (!db) return;
          try {
            await setDoc(doc(db, "vipDeals", id), {
              expiresAt: Timestamp.fromDate(new Date(Date.now() - 1000)),
              updatedAt: serverTimestamp(),
            }, { merge: true });
            await refreshVipDeals();
          } catch (err) {
            console.error("Failed to expire VIP deal", err);
          }
        }
      });
    }

    function nameFromEmail(email) {
      if (!email) return "FoCo Member";
      const beforeAt = email.split("@")[0];
      return beforeAt.replace(/[\.\_\-]/g, " ").replace(/\b\w/g, c => c.toUpperCase());
    }

    function preferredMemberName(user) {
      const email = (user?.email || "").toLowerCase();
      if (isCeoActive() || memberProfile?.ceo || email === "ceo@gmail.com") {
        return "FoCo CEO";
      }
      if (memberProfile?.legalName?.trim()) return memberProfile.legalName.trim();
      if (user?.displayName?.trim()) return user.displayName.trim();
      return nameFromEmail(user?.email || "");
    }
    function preferredUsername() {
      const passId = (memberProfile?.passCode || currentPassCode || "").toUpperCase();
      const directory = allowLocalCache() ? loadMemberDirectory() : {};
      const ledger = allowLocalCache() ? loadPointsLedger() : {};
      const fromProfile = (memberProfile?.username || "").trim();
      const fromDirectory = (directory[passId]?.username || "").trim();
      const fromLedger = (ledger[passId]?.username || "").trim();
      const email = (firebaseAuth.currentUser?.email || "").toLowerCase();
      const fallback = nameFromEmail(firebaseAuth.currentUser?.email || "").replace(/\s+/g, "");
      const isCeoUser = isCeoActive() || email === "ceo@gmail.com" || passId === CEO_PASS_ID || memberProfile?.ceo;
      const chosen = isCeoUser ? "Foco CEO" : (fromProfile || fromDirectory || fromLedger || fallback);
      if (memberProfile && !memberProfile.username && chosen) {
        memberProfile.username = chosen;
      }
      return chosen;
    }
    function isLikelyEmail(value) {
      if (!value) return false;
      return /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(value.trim());
    }
    function resolveUsernameToEmail(input) {
      if (!input) return null;
      if (isLikelyEmail(input)) return input.trim();
      const cleaned = input.trim().replace(/^@/, "");
      if (!cleaned) return null;
      const target = input.trim().toLowerCase();
      if (!target) return null;
      const mapped = lookupUsernameEmail(target);
      if (mapped) return mapped;
      // Check current profile first
      if (memberProfile?.username?.trim().toLowerCase() === target && firebaseAuth.currentUser?.email) {
        return firebaseAuth.currentUser.email;
      }
      // Check points ledger
      const ledger = loadPointsLedger();
      for (const entry of Object.values(ledger)) {
        if ((entry.username || "").trim().toLowerCase() === target && entry.email) {
          return entry.email;
        }
      }
      // Check member directory cache
      const directory = loadMemberDirectory();
      for (const key of Object.keys(directory)) {
        const entry = directory[key] || {};
        if ((entry.username || "").trim().toLowerCase() === target && entry.email) {
          return entry.email;
        }
      }
      return null;
    }
    function canQueryMembersDirectory() {
      return isCeoAccount || (!!staffSession && !!staffSession.venue);
    }
    async function resolveUsernameToEmailCloud(input) {
      if (!db || !input) return null;
      const target = input.trim().replace(/^@/, "").toLowerCase();
      if (!target) return null;
      try {
        const unameDoc = await getDoc(doc(db, "usernames", target));
        if (unameDoc.exists()) {
          const data = unameDoc.data() || {};
          if (data.email) return data.email;
          if (data.uid && canQueryMembersDirectory()) {
            const memberSnap = await getDoc(doc(db, "members", data.uid));
            const mdata = memberSnap.exists() ? memberSnap.data() : {};
            if (mdata?.email) return mdata.email;
          }
        }
      } catch (err) {
        console.warn("Username cloud lookup failed", err);
      }
      if (!canQueryMembersDirectory()) {
        return null;
      }
      try {
        const qMembers = query(collection(db, "members"), where("username", "==", target));
        const snap = await getDocs(qMembers);
        const first = snap.docs[0];
        if (first) {
          const data = first.data() || {};
          if (data.email) return data.email;
        }
      } catch (err) {
        console.warn("Member username query failed", err);
      }
      return null;
    }
    const BANNED_USER_WORDS = ["hate","kill","murder","bomb","terror","racist","nazi","kkk","lynch","violence","threat","harm","attack","shoot","slur"];
    function loadUsernameMap() {
      try {
        return JSON.parse(localStorage.getItem(USERNAME_EMAIL_MAP) || "{}");
      } catch (err) {
        return {};
      }
    }
    function saveUsernameMap(map) {
      localStorage.setItem(USERNAME_EMAIL_MAP, JSON.stringify(map || {}));
    }
    function saveUsernameMapEntry(username, email) {
      if (!username || !email) return;
      const map = loadUsernameMap();
      const key = username.trim().toLowerCase();
      map[key] = email;
      saveUsernameMap(map);
      if (db && firebaseAuth?.currentUser) {
        try {
          const unameDoc = doc(db, "usernames", key);
          setDoc(unameDoc, {
            email,
            uid: firebaseAuth.currentUser.uid,
            passCode: (memberProfile?.passCode || currentPassCode || "").toUpperCase(),
            updatedAt: serverTimestamp()
          }, { merge: true }).catch(err => console.warn("Username map save failed", err));
        } catch (err) {
          console.warn("Username map save failed", err);
        }
      }
    }
    function lookupUsernameEmail(username) {
      if (!username) return null;
      const map = loadUsernameMap();
      return map[username.trim().toLowerCase()] || null;
    }
    function loadVenueRatings() {
      try {
        return JSON.parse(localStorage.getItem(VENUE_RATINGS_KEY) || "{}");
      } catch (err) {
        return {};
      }
    }
    function saveVenueRatings(data) {
      localStorage.setItem(VENUE_RATINGS_KEY, JSON.stringify(data || {}));
    }
    function loadUserVenueRatings() {
      try {
        return JSON.parse(localStorage.getItem(VENUE_USER_RATINGS_KEY) || "{}");
      } catch (err) {
        return {};
      }
    }
    function saveUserVenueRatings(data) {
      localStorage.setItem(VENUE_USER_RATINGS_KEY, JSON.stringify(data || {}));
    }
    function validateUsername(name) {
      if (!name) return { ok: false, message: "Username required." };
      const trimmed = name.trim();
      if (trimmed.length < 3 || trimmed.length > 10) return { ok: false, message: "Use 3-10 characters (spaces allowed)." };
      if (!/^[A-Za-z0-9_ ]+$/.test(trimmed)) return { ok: false, message: "Only letters, numbers, underscore, and spaces allowed." };
      const lower = trimmed.toLowerCase();
      if (BANNED_USER_WORDS.some(word => lower.includes(word))) {
        return { ok: false, message: "That username isnâ€™t allowed." };
      }
      return { ok: true, value: trimmed };
    }

    function initialsFromName(name) {
      const parts = name.trim().split(" ");
      if (parts.length === 1) return parts[0].slice(0, 2).toUpperCase();
      return (parts[0][0] + parts[1][0]).toUpperCase();
    }
    function renderPassIdentity(user = firebaseAuth.currentUser) {
      if (!user) return;
      const email = user.email || "";
      const displayName = preferredMemberName(user);
      if (passUserName) passUserName.textContent = displayName;
      if (avatarInitials) avatarInitials.textContent = initialsFromName(displayName);
      if (!memberProfile) memberProfile = {};
      if (displayName && !memberProfile.legalName) {
        memberProfile.legalName = displayName;
        updateMemberProfile({ legalName: displayName });
      }
      if (userMiniDisplay) {
        userMiniDisplay.textContent = `@${preferredUsername()}`;
      }
      if (userUsername) {
        userUsername.textContent = `@${preferredUsername()}`;
      }
      // Persist username/email into directory for login-by-username resolution
      if (currentPassCode) {
        const uname = preferredUsername();
        const emailValue = user.email || "";
        setMemberDirectoryEntry(currentPassCode, {
          username: uname,
          email: emailValue
        });
        if (uname && emailValue) {
          saveUsernameMapEntry(uname, emailValue);
        }
      }
      loadVibeForCurrentPass();
      if (userUsername) {
        userUsername.textContent = `@${preferredUsername()}`;
      }
      let joinedAt = memberProfile.memberSince;
      if (!joinedAt) {
        joinedAt = new Date().toISOString();
        memberProfile.memberSince = joinedAt;
        updateMemberProfile({ memberSince: joinedAt });
      }
      if (memberSinceText) {
        memberSinceText.textContent = new Date(joinedAt).toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric"
        });
      }
      const hasBlackCard = isCeoAccount || (memberProfile?.passCode && isBlackCardHolder(memberProfile.passCode));
      if (expiryText) {
        if (hasBlackCard || isFreeMember()) {
          expiryText.textContent = "Never expires";
        } else {
          expiryText.textContent = "Dec 31, 2025";
        }
      }
      loadAvatarColor();
      loadAvatarFlair();
      loadBackgroundTheme();
      const directoryEntry = allowLocalCache()
        ? (loadMemberDirectory()[(currentPassCode || "").toUpperCase()] || {})
        : {};
      const tagline = memberProfile?.tagline || directoryEntry.tagline;
      if (tagline && userTaglineEl) {
        userTaglineEl.textContent = tagline;
      } else if (userTaglineEl) {
        userTaglineEl.textContent = "Tap to add your vibe.";
      }
      renderAchievementsList();
    }
    function toInputDateValue(date) {
      const local = new Date(date.getTime() - date.getTimezoneOffset() * 60000);
      return local.toISOString().slice(0, 16);
    }
    function formatMST(value, opts = {}) {
      const d = value instanceof Date ? value : new Date(value);
      if (!d || Number.isNaN(d.getTime())) return "";
      return d.toLocaleString("en-US", {
        timeZone: "America/Denver",
        month: "short",
        day: "numeric",
        hour: "numeric",
        minute: "2-digit",
        ...opts
      });
    }

    async function loadMemberProfileForUser(user) {
      if (!user) {
        memberProfile = null;
        memberDocRef = null;
        return null;
      }
      if (!db) {
        memberDocRef = null;
        if (allowLocalCache()) {
          memberProfile = buildLocalProfile(user);
          return memberProfile;
        }
        memberProfile = null;
        return null;
      }
      memberDocRef = doc(db, "members", user.uid);
      try {
        const snap = await getDoc(memberDocRef);
        if (snap.exists()) {
          memberProfile = snap.data();
        } else {
        memberProfile = {
          tier: null,
          passCode: generateRedemptionCode(),
          extraVouchers: { ...EXTRA_DEFAULTS },
          perks: { tier: "standard", remaining: getDefaultPerkState("standard") },
          memberSince: new Date().toISOString(),
        };
        await setDoc(memberDocRef, memberProfile);
        }
      } catch (err) {
        console.warn("Failed to load member profile:", err);
        memberDocRef = null;
        if (allowLocalCache()) {
          memberProfile = buildLocalProfile(user);
          return memberProfile;
        }
        memberProfile = null;
        return null;
      }
      // If local cache marks this pass free, apply immediately
      if (allowLocalCache() && isPassLocallyFree(memberProfile.passCode)) {
        memberProfile.freeMembership = true;
        memberProfile.tier = "free";
        memberProfile.validUntil = "never";
        memberProfile.perks = { tier: "free", remaining: getDefaultPerkState("free") };
      }
      // If a free membership doc exists for this pass, force the flag locally
      try {
        const code = (memberProfile.passCode || "").toUpperCase();
        if (code && db) {
          const freeSnap = await getDoc(doc(db, "freeMemberships", code));
          if (freeSnap.exists() && freeSnap.data()?.active !== false) {
            memberProfile.freeMembership = true;
            memberProfile.revoked = false;
            memberProfile.tier = "free";
            memberProfile.validUntil = "never";
            memberProfile.perks = { tier: "free", remaining: getDefaultPerkState("free") };
            setMemberDirectoryEntry(code, memberProfile);
          }
        }
      } catch (err) {
        console.warn("Free membership lookup failed", err);
      }
      if (memberProfile.memberSince?.toDate) {
        memberProfile.memberSince = memberProfile.memberSince.toDate().toISOString();
      }
      if (!memberProfile.memberSince) {
        memberProfile.memberSince = new Date().toISOString();
        updateMemberProfile({ memberSince: memberProfile.memberSince });
      }
      if (!memberProfile.extraVouchers) memberProfile.extraVouchers = { ...EXTRA_DEFAULTS };
      if (!memberProfile.perks) {
        memberProfile.perks = { tier: memberProfile.tier || "standard", remaining: getDefaultPerkState(memberProfile.tier || "standard") };
        updateMemberProfile({ perks: memberProfile.perks });
      }
      // Normalize free membership from doc/cache
      if (memberProfile.freeMembership) {
        memberProfile.tier = "free";
        memberProfile.perks = { tier: "free", remaining: getDefaultPerkState("free") };
        memberProfile.validUntil = "never";
        updateMemberProfile({ freeMembership: true, tier: "free", perks: memberProfile.perks, validUntil: "never" });
      }
      if (memberProfile.freeMembership) {
        memberProfile.tier = "free";
        memberProfile.perks = { tier: "free", remaining: getDefaultPerkState("free") };
        memberProfile.validUntil = "never";
        updateMemberProfile({ freeMembership: true, tier: "free", perks: memberProfile.perks, validUntil: "never" });
        if (allowLocalCache() && user.uid) localStorage.setItem(`membership_${user.uid}`, "free");
      }
      // If not marked free yet, double-check the shared freeMemberships doc by pass code
      if (!memberProfile.freeMembership && memberProfile.passCode && db) {
        try {
          const code = memberProfile.passCode.toUpperCase();
          const snap = await getDoc(doc(db, "freeMemberships", code));
          if (snap.exists() && snap.data()?.active !== false) {
            memberProfile.freeMembership = true;
            memberProfile.tier = "free";
            memberProfile.validUntil = "never";
            memberProfile.perks = { tier: "free", remaining: getDefaultPerkState("free") };
            updateMemberProfile({ freeMembership: true, tier: "free", perks: memberProfile.perks, validUntil: "never" });
            setMemberDirectoryEntry(code, memberProfile);
            if (allowLocalCache() && user.uid) localStorage.setItem(`membership_${user.uid}`, "free");
          }
        } catch (err) {
          console.warn("freeMemberships doc check failed", err);
        }
      }
      if (!memberProfile.passCode) {
        memberProfile.passCode = generateRedemptionCode();
        updateMemberProfile({ passCode: memberProfile.passCode });
      }
      if (!memberProfile.name) {
        const fallbackName = user.displayName || nameFromEmail(user.email || "");
        if (fallbackName) {
          memberProfile.name = fallbackName;
          updateMemberProfile({ name: fallbackName });
        }
      }
      if (memberProfile.tagline && userTaglineEl) {
        userTaglineEl.textContent = memberProfile.tagline;
      } else if (userTaglineEl) {
        userTaglineEl.textContent = "Tap to add your vibe.";
      }
      persistLocalProfileUpdates({
        tier: memberProfile.tier,
        passCode: memberProfile.passCode,
        memberSince: memberProfile.memberSince,
      });
      cachePassProfile(memberProfile.passCode, memberProfile, user.uid);
      return memberProfile;
    }

    async function updateMemberProfile(updates) {
      if (!updates) return;
      memberProfile = { ...(memberProfile || {}), ...updates };
      persistLocalProfileUpdates(updates);
      if (!memberDocRef || !db) return;
      try {
        await setDoc(memberDocRef, updates, { merge: true });
        if (memberProfile?.passCode) {
          cachePassProfile(memberProfile.passCode, memberProfile, memberDocRef.id);
        }
      } catch (err) {
        console.warn("Failed to update member profile:", err);
      }
    }
    function parseCurrency(value) {
      if (!value) return 0;
      const cleaned = String(value).replace(/[^\d\.\-]/g, "");
      const parsed = parseFloat(cleaned);
      return Number.isFinite(parsed) ? parsed : 0;
    }
    function formatCurrency(value) {
      const num = Number(value) || 0;
      return `$${num.toFixed(2)}`;
    }
    function parseReceiptItems(text) {
      return text.split(/\r?\n/)
        .map(line => line.trim())
        .filter(Boolean)
        .map(line => {
          const match = line.match(/^(.*?)(?:[-|]+)?\s*\$?([0-9]+(?:\.[0-9]{1,2})?)$/);
          if (match) {
            return { label: match[1].trim() || "Item", amount: parseFloat(match[2]) };
          }
          return { label: line, amount: 0 };
        });
    }

    function showReceipt(lines, noteText, metadata = {}) {
      if (!receiptOverlay || !receiptSummary) return;
      receiptSummary.innerHTML = lines.map(line => `
        <li>
          <span>${line.label}</span>
          <span>${line.value}</span>
        </li>
      `).join("");
      if (receiptNote && noteText) receiptNote.textContent = noteText;
      receiptOverlay.classList.add("active");
      if (metadata?.type) {
        const entry = {
          id: metadata.orderId || `PUR-${Date.now().toString().slice(-6)}`,
          title: metadata.title || "In-app purchase",
          detail: metadata.detail || "",
          method: metadata.method || "Card",
          total: metadata.total || "",
          timestamp: new Date().toISOString(),
        };
        appendPurchaseReceipt(entry);
      }
    }
    function hideReceipt() {
      if (!receiptOverlay) return;
      receiptOverlay.classList.remove("active");
    }
    function presentReceiptForTier(tier, methodLabel, meta = {}) {
      const info = membershipPlanInfo[tier] || membershipPlanInfo.standard;
      const orderId = `FO-${Date.now().toString().slice(-6)}`;
      showReceipt([
        { label: "Order #", value: orderId },
        { label: "Processed", value: formatMST(new Date()) },
        { label: "Plan", value: info.label },
        { label: "Method", value: methodLabel },
        { label: "Total", value: info.price }
      ], `Charged via ${methodLabel}. Auto-renews monthly.`, {
        type: "membership",
        tier,
        method: methodLabel,
        title: `${info.label} membership`,
        detail: info.price,
        orderId,
        ...meta
      });
    }

    paymentForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      paymentError.textContent = "";
      paymentSuccess.classList.remove("visible");
      if (!pendingMembershipTier) {
        paymentError.textContent = "Select a membership first.";
        return;
      }
      if (!stripeInstance || !stripeElements || !stripeClientSecret) {
        paymentError.textContent = "Payment not ready. Please tap your plan again or wait a moment.";
        return;
      }
      const name = cardNameInput?.value?.trim() || undefined;
      paymentSubmitBtn.disabled = true;
      const originalText = paymentSubmitBtn.textContent;
      paymentSubmitBtn.textContent = "Processingâ€¦";
      try {
        const { error, paymentIntent } = await stripeInstance.confirmPayment({
          elements: stripeElements,
          confirmParams: {
            payment_method_data: {
              billing_details: {
                name,
                email: firebaseAuth.currentUser?.email || undefined
              }
            }
          },
          redirect: "if_required"
        });
        if (error) {
          paymentError.textContent = error.message || "Payment failed. Please try again.";
          paymentSubmitBtn.disabled = false;
          paymentSubmitBtn.textContent = originalText;
          return;
        }
        if (paymentIntent && paymentIntent.status === "succeeded") {
          paymentSuccess.textContent = "Membership Active!";
          paymentSuccess.classList.add("visible");
          try {
            const fn = httpsCallable(functionsClient, "confirmMembershipActivation");
            await fn({ paymentIntentId: paymentIntent.id });
          } catch (err) {
            console.warn("confirmMembershipActivation failed", err);
          }
          const tierToActivate = pendingMembershipTier || paymentIntent.metadata?.tier || "standard";
          pendingMembershipTier = null;
          presentReceiptForTier(tierToActivate, "Card");
          completeMembership(tierToActivate, { force: true });
          showScreen("pass");
        } else {
          paymentError.textContent = "Payment incomplete. Please try again.";
        }
      } catch (err) {
        console.warn("confirmPayment error", err);
        paymentError.textContent = "Payment failed. Please try again.";
      } finally {
        paymentSubmitBtn.disabled = false;
        paymentSubmitBtn.textContent = originalText;
      }
    });

    skipPaymentBtn.addEventListener("click", () => {
      const tierToActivate = pendingMembershipTier || "vip";
      pendingMembershipTier = null;
      resetPaymentForm();
      completeMembership(tierToActivate, { force: true });
    });

    if (venuesTrigger) {
      venuesTrigger.addEventListener("click", () => {
        closeVenueDetail();
        showScreen("venues");
      });
    }
    if (venuesBackBtn) {
      venuesBackBtn.addEventListener("click", async () => {
        closeVenueDetail();
        await syncFreeFlagForCurrentPass();
        showScreen("pass");
      });
    }
    const membershipBackBtn = document.getElementById("membershipBackBtn");
    if (membershipBackBtn) {
      membershipBackBtn.addEventListener("click", () => {
        showScreen("landing");
      });
    }
    if (supportTrigger) {
      supportTrigger.addEventListener("click", () => {
        resetSupportForm();
        showScreen("support");
      });
    }
    supportBackBtn.addEventListener("click", () => {
      showScreen("pass");
    });
    supportForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      supportError.textContent = "";
      supportSuccess.classList.remove("visible");
      const first = supportFirstName.value.trim();
      const last = supportLastName.value.trim();
      const phone = supportPhone.value.trim();
      const message = supportMessage.value.trim();
      const userEmail = firebaseAuth.currentUser?.email || "unknown@focoafterdark.com";
      if (!first || !last || !phone || !message) {
        supportError.textContent = "Please complete all support fields.";
        return;
      }
      supportError.textContent = "Sendingâ€¦";
      try {
        const resp = await fetch("https://formsubmit.co/ajax/focoafterdark@gmail.com", {
          method: "POST",
          headers: { "Content-Type": "application/json", Accept: "application/json" },
          body: JSON.stringify({
            name: `${first} ${last}`,
            email: userEmail,
            phone,
            message: `[FoCo Support]\nFrom: ${first} ${last}\nEmail: ${userEmail}\nPhone: ${phone}\n\n${message}`,
            formsubmit_account: "focoafterdark@gmail.com",
            _subject: "FoCo After Dark â€¢ Support Request",
            _template: "table"
          })
        });
        if (!resp.ok) {
          throw new Error(`Send failed with status ${resp.status}`);
        }
        const data = await resp.json().catch(() => ({}));
        if (data.success !== "true") {
          throw new Error("Send failed");
        }
        supportError.textContent = "";
        supportSuccess.classList.add("visible");
        setTimeout(() => {
          supportSuccess.classList.remove("visible");
          showScreen("pass");
        }, 1800);
      } catch (err) {
        console.warn("Support send failed:", err);
        supportError.textContent = "Could not send. Please try again in a moment.";
      }
    });

    const membershipPlanInfo = {
      standard: { label: "Standard", price: `$${MEMBERSHIP_FEES.standard.toFixed(2)} / month` },
      vip: { label: "VIP", price: `$${MEMBERSHIP_FEES.vip.toFixed(2)} / month` },
    };
    let stripeInstance = null;
    let stripeElements = null;
    let stripeClientSecret = null;
    let stripePaymentElement = null;
    let voucherStripeInstance = null;
    let voucherElements = null;
    let voucherClientSecret = null;
    let voucherPaymentComplete = false;
    let voucherHasCardOnFile = false;

    async function prepareStripePayment(tier) {
      if (!functionsClient) {
        paymentError.textContent = "Payments unavailable right now.";
        return;
      }
      paymentError.textContent = "";
      if (!firebaseAuth.currentUser && !betaPassMode) {
        paymentError.textContent = "Please sign in first.";
        showScreen("auth");
        return;
      }
      stripeClientSecret = null;
      if (paymentElementContainer) paymentElementContainer.innerHTML = "";
      if (paymentSubmitBtn) {
        paymentSubmitBtn.disabled = true;
        paymentSubmitBtn.textContent = "Preparingâ€¦";
      }
      if (paymentSavedCard) paymentSavedCard.style.display = "none";
      try {
        const fn = httpsCallable(functionsClient, "createMembershipPaymentIntent");
        const resp = await fn({ tier });
        const data = resp?.data || {};
        if (data.free) {
          pendingMembershipTier = tier;
          completeMembership(tier, { force: true });
          showToast("Membership activated");
          showScreen("pass");
          return;
        }
        if (!data.clientSecret || !data.publishableKey) {
          throw new Error("Missing client secret or publishable key");
        }
        stripeInstance = Stripe(data.publishableKey);
        stripeClientSecret = data.clientSecret;
        const elementsOptions = {
          clientSecret: stripeClientSecret,
          wallets: { applePay: "auto", googlePay: "auto" }
        };
        stripeElements = stripeInstance.elements(elementsOptions);
        const paymentElementOptions = { layout: "tabs", paymentMethodOrder: ["card"] };
        stripePaymentElement = stripeElements.create("payment", paymentElementOptions);
        stripePaymentElement.mount("#paymentElement");
        if (paymentSubmitBtn) {
          paymentSubmitBtn.disabled = false;
          paymentSubmitBtn.textContent = "Start Membership";
        }
      } catch (err) {
        console.warn("prepareStripePayment failed", err);
        const msg = err?.message || "Could not start payment. Please try again.";
        paymentError.textContent = msg;
        if (paymentSubmitBtn) {
          paymentSubmitBtn.disabled = false;
          paymentSubmitBtn.textContent = "Start Membership";
        }
      }
    }

    function resetVoucherPaymentState() {
      if (voucherPaymentError) voucherPaymentError.textContent = "";
      voucherClientSecret = null;
      voucherStripeInstance = null;
      voucherElements = null;
      voucherPaymentComplete = false;
      voucherHasCardOnFile = false;
      if (voucherPaymentElement) voucherPaymentElement.innerHTML = "";
      if (voucherChargeOnFile) {
        voucherChargeOnFile.disabled = false;
        voucherChargeOnFile.textContent = "Continue";
      }
      if (voucherSavedCard) voucherSavedCard.style.display = "none";
    }

    function formatPaymentError(err, fallback) {
      const code = (err?.code || "").toString().toLowerCase();
      if (code === "internal") return fallback;
      if (code === "failed-precondition") return err?.message || fallback;
      return err?.message || fallback;
    }

    async function prepareVoucherPayment(pack) {
      if (!functionsClient) {
        if (voucherPaymentError) voucherPaymentError.textContent = "Payments unavailable right now.";
        return;
      }
      if (!firebaseAuth.currentUser) {
        if (voucherPaymentError) voucherPaymentError.textContent = "Please sign in first.";
        showScreen("auth");
        return;
      }
      resetVoucherPaymentState();
      if (voucherChargeOnFile) voucherChargeOnFile.disabled = true;
      try {
        const fn = httpsCallable(functionsClient, "createVoucherPaymentIntent");
        const resp = await fn({ packId: pack.id });
        const data = resp?.data || {};
        if (!data.clientSecret || !data.publishableKey) {
          throw new Error("Payment could not start.");
        }
        voucherStripeInstance = Stripe(data.publishableKey);
        voucherClientSecret = data.clientSecret;
        const elementsOptions = {
          clientSecret: voucherClientSecret,
          wallets: { applePay: "auto", googlePay: "auto" }
        };
        voucherElements = voucherStripeInstance.elements(elementsOptions);
        const paymentElementOptions = { layout: "tabs", paymentMethodOrder: ["card"] };
        const element = voucherElements.create("payment", paymentElementOptions);
        element.on("change", (event) => {
          voucherPaymentComplete = !!event.complete;
        });
        element.mount("#voucherPaymentElement");
        if (voucherChargeOnFile) {
          voucherHasCardOnFile = !!memberProfile?.defaultPaymentMethodId;
          voucherChargeOnFile.style.display = "";
          voucherChargeOnFile.disabled = false;
          voucherChargeOnFile.textContent = "Continue";
        }
        if (voucherSavedCard) {
          if (voucherHasCardOnFile) {
            voucherSavedCard.textContent = "Card on file ready. Enter a new card below to use a different one.";
            voucherSavedCard.style.display = "block";
          } else {
            voucherSavedCard.style.display = "none";
          }
        }
      } catch (err) {
        console.warn("prepareVoucherPayment failed", err);
        if (voucherPaymentError) {
          voucherPaymentError.textContent = formatPaymentError(err, "Could not start payment. Please try again.");
        }
        if (voucherChargeOnFile) {
          voucherChargeOnFile.disabled = false;
          voucherChargeOnFile.textContent = "Continue";
        }
      }
    }

    async function confirmVoucherPurchaseIntent(paymentIntentId, methodLabel) {
      if (!functionsClient) {
        if (voucherPaymentError) voucherPaymentError.textContent = "Payments unavailable right now.";
        return;
      }
      if (!paymentIntentId) {
        if (voucherPaymentError) voucherPaymentError.textContent = "Payment failed. Please try again.";
        return;
      }
      try {
        const fn = httpsCallable(functionsClient, "confirmVoucherPurchase");
        const resp = await fn({ paymentIntentId });
        const data = resp?.data || {};
        if (!data.ok) throw new Error("Payment incomplete.");
        const pack = data.pack || pendingVoucherPack;
        if (data.extraVouchers) {
          extraVouchers = sanitizeExtraVouchers(data.extraVouchers, { allowUnlimited: isCeoActive() });
          if (memberProfile) memberProfile.extraVouchers = { ...extraVouchers };
          persistMemberState({ extraVouchers: memberProfile?.extraVouchers || extraVouchers });
        } else if (pack) {
          adjustExtraVouchers(pack.perk || pack.id, pack.amount);
        }
        renderRedemptionOptions();
        if (creditInfo && pack) {
          creditInfo.textContent = `${pack.amount} ${pack.label || pack.perk} vouchers added.`;
        }
        voucherModal.classList.remove("active");
        const orderId = `FO-${Date.now().toString().slice(-6)}`;
        if (pack) {
          showReceipt([
            { label: "Order #", value: orderId },
            { label: "Processed", value: formatMST(new Date()) },
            { label: "Pack", value: `+${pack.amount} ${pack.label || pack.perk} vouchers` },
            { label: "Method", value: methodLabel },
            { label: "Total", value: pack.priceLabel || pack.price || "" }
          ], `Charged via ${methodLabel}.`, {
            type: "voucher",
            pack: pack.id,
            amount: pack.amount,
            method: methodLabel,
            title: `Voucher add-on (${pack.label || pack.perk})`,
            detail: pack.priceLabel || pack.price || "",
            orderId
          });
        }
        pendingVoucherPack = null;
      } catch (err) {
        console.warn("confirmVoucherPurchase failed", err);
        if (voucherPaymentError) voucherPaymentError.textContent = formatPaymentError(err, "Payment failed. Please try again.");
      }
    }

    async function chargeVoucherOnFile(pack) {
      if (!functionsClient) {
        if (voucherPaymentError) voucherPaymentError.textContent = "Payments unavailable right now.";
        return;
      }
      if (!firebaseAuth.currentUser) {
        if (voucherPaymentError) voucherPaymentError.textContent = "Please sign in first.";
        return;
      }
      if (!pack) return;
      const original = voucherChargeOnFile?.textContent || "Continue";
      if (voucherChargeOnFile) {
        voucherChargeOnFile.disabled = true;
        voucherChargeOnFile.textContent = "Chargingâ€¦";
      }
      if (voucherPaymentError) voucherPaymentError.textContent = "";
      try {
        const fn = httpsCallable(functionsClient, "chargeVoucherOnFile");
        const resp = await fn({ packId: pack.id });
        const data = resp?.data || {};
        if (data.requiresAction && data.clientSecret) {
          const stripe = voucherStripeInstance || Stripe(data.publishableKey);
          const { error, paymentIntent } = await stripe.confirmCardPayment(data.clientSecret);
          if (error) throw error;
          if (!paymentIntent || paymentIntent.status !== "succeeded") {
            throw new Error("Payment incomplete.");
          }
          await confirmVoucherPurchaseIntent(paymentIntent.id, "Card on file");
          return;
        }
        if (data.paymentIntentId) {
          await confirmVoucherPurchaseIntent(data.paymentIntentId, "Card on file");
          return;
        }
        throw new Error("Payment failed. Please try again.");
      } catch (err) {
        console.warn("chargeVoucherOnFile failed", err);
        if (voucherPaymentError) {
          voucherPaymentError.textContent = err?.code === "failed-precondition"
            ? "No card on file. Enter a card below to continue."
            : formatPaymentError(err, "Payment failed. Please try again.");
        }
      } finally {
        if (voucherChargeOnFile) {
          voucherChargeOnFile.disabled = false;
          voucherChargeOnFile.textContent = original;
        }
      }
    }

    async function chargeVoucherWithElement(pack) {
      if (!voucherStripeInstance || !voucherElements || !voucherClientSecret) {
        if (voucherPaymentError) voucherPaymentError.textContent = "Payment not ready. Try again.";
        return;
      }
      const originalText = voucherChargeOnFile?.textContent || "Continue";
      if (voucherChargeOnFile) {
        voucherChargeOnFile.disabled = true;
        voucherChargeOnFile.textContent = "Processingâ€¦";
      }
      try {
        const { error, paymentIntent } = await voucherStripeInstance.confirmPayment({
          elements: voucherElements,
          confirmParams: { return_url: window.location.href },
          redirect: "if_required"
        });
        if (error) {
          if (voucherPaymentError) voucherPaymentError.textContent = error.message || "Payment failed. Try again.";
          return;
        }
        if (paymentIntent?.status === "succeeded") {
          await confirmVoucherPurchaseIntent(paymentIntent.id, "Card");
          return;
        }
        if (voucherPaymentError) voucherPaymentError.textContent = "Payment incomplete. Please try again.";
      } catch (err) {
        console.warn("Voucher element payment failed", err);
        if (voucherPaymentError) voucherPaymentError.textContent = "Payment failed. Please try again.";
      } finally {
        if (voucherChargeOnFile) {
          voucherChargeOnFile.disabled = false;
          voucherChargeOnFile.textContent = originalText;
        }
      }
    }

    async function chargeMembershipOnFile(tier) {
      if (!functionsClient) {
        showToast("Payments unavailable right now.");
        return false;
      }
      if (!firebaseAuth.currentUser) {
        showScreen("auth");
        return false;
      }
      try {
        const fn = httpsCallable(functionsClient, "chargeMembershipOnFile");
        const resp = await fn({ tier });
        const data = resp?.data || {};
        if (data.free) {
          pendingMembershipTier = null;
          completeMembership(tier, { force: true });
          return true;
        }
        if (data.requiresAction && data.clientSecret) {
          const stripe = Stripe(data.publishableKey);
          const { error, paymentIntent } = await stripe.confirmCardPayment(data.clientSecret);
          if (error) throw error;
          if (paymentIntent && paymentIntent.status === "succeeded") {
            try {
              const confirmFn = httpsCallable(functionsClient, "confirmMembershipActivation");
              await confirmFn({ paymentIntentId: paymentIntent.id });
            } catch (err) {
              console.warn("confirmMembershipActivation failed", err);
            }
            pendingMembershipTier = null;
            presentReceiptForTier(tier, "Card on file");
            completeMembership(tier, { force: true });
            return true;
          }
          throw new Error("Payment incomplete.");
        }
        if (data.ok) {
          pendingMembershipTier = null;
          presentReceiptForTier(tier, "Card on file");
          completeMembership(tier, { force: true });
          return true;
        }
        throw new Error("Payment failed. Please try again.");
      } catch (err) {
        console.warn("chargeMembershipOnFile failed", err);
        if (err?.code === "failed-precondition") {
          showToast("Add a card to continue.");
          pendingMembershipTier = tier;
          updatePaymentSummary(tier);
          resetPaymentForm();
          prepareStripePayment(tier);
          showScreen("payment");
          return false;
        }
        showToast("Membership update failed.");
        return false;
      }
    }

    const venuesInfo = {
      bar_district: {
        name: "The Bar District",
        address: "151 S College Ave, Fort Collins, CO 80524",
        phone: "(970) 690-5789",
      },
      bondi_beach: {
        name: "Bondi Beach Bar & Grill",
        address: "11 Old Town Square #120, Fort Collins, CO 80524",
        phone: "(970) 224-4100",
      },
      rec_room: {
        name: "Rec Room Fort Collins",
        address: "23 Old Town Square #200, Fort Collins, CO 80524",
        phone: "(970) 224-0888",
      },
      road_34: {
        name: "Road 34 Bike Bar",
        address: "1213 W Elizabeth St, Fort Collins, CO 80521",
        phone: "(970) 221-3434",
      },
      pour_brothers: {
        name: "Pour Brothers Community Tavern",
        address: "220 Linden St, Fort Collins, CO 80524",
        phone: "(970) 493-4368",
      },
      lucky_joes: {
        name: "Lucky Joeâ€™s Sidewalk Saloon",
        address: "25 Old Town Square, Fort Collins, CO 80524",
        phone: "(970) 493-2213",
      },
      whiskey: {
        name: "The Whisk(e)y",
        address: "214 S College Ave #2, Fort Collins, CO 80524",
        phone: "None publicly listed",
      },
      yeti: {
        name: "Yeti Bar & Grill",
        address: "23 Old Town Square, Fort Collins, CO 80524",
        phone: "(970) 482-9384",
      },
      drunken_monkey: {
        name: "The Drunken Monkey",
        address: "151 S College Ave, Fort Collins, CO 80524",
        phone: "None publicly listed",
      },
      boot_grill: {
        name: "The Boot Grill",
        address: "130 W Laurel St, Fort Collins, CO 80524",
        phone: "(970) 682-2626",
      },
      trail_head: {
        name: "Trail Head Tavern",
        address: "148 W Mountain Ave, Fort Collins, CO 80524",
        phone: "(970) 221-5757",
      },
      steak_out: {
        name: "Steak-Out Saloon",
        address: "152 W Mountain Ave, Fort Collins, CO 80521",
        phone: "(970) 484-4253",
      },
      mo_jeaux: {
        name: "Mo Jeauxâ€™s Bar & Grill",
        address: "820 City Park Ave, Fort Collins, CO 80521",
        phone: "(970) 482-4200",
      },
      old_town_putt: {
        name: "Old Town Putt (bar + mini golf)",
        address: "244 N College Ave #130, Fort Collins, CO 80524",
        phone: "(970) 682-2922",
      },
      social: {
        name: "Social",
        address: "1 Old Town Square #7, Fort Collins, CO 80524",
        phone: "(970) 670-2024",
      },
      ace_gilletts: {
        name: "Ace Gillettâ€™s Lounge",
        address: "239 S College Ave, Fort Collins, CO 80524",
        phone: "(970) 484-3883",
      },
      elliotts: {
        name: "Elliottâ€™s Martini Bar",
        address: "234 Linden St, Fort Collins, CO 80524",
        phone: "(970) 493-2337",
      },
      tap_handle: {
        name: "Tap and Handle",
        address: "307 S College Ave, Fort Collins, CO 80524",
        phone: "(970) 484-1116",
      },
      bar_louie: {
        name: "Bar Louie",
        address: "3400 S College Ave #500, Fort Collins, CO 80525",
        phone: "(970) 226-2300",
      },
      cb_potts: {
        name: "C.B. & Potts (Collindale)",
        address: "1441 E Horsetooth Rd, Fort Collins, CO 80525",
        phone: "(970) 377-4200",
      },
      intersect: {
        name: "Intersect Brewing",
        address: "2160 W Drake Rd #A1, Fort Collins, CO 80526",
        phone: "(970) 505-8666",
      },
      maxline: {
        name: "Maxline Brewing",
        address: "2724 McClelland Dr #190, Fort Collins, CO 80526",
        phone: "(970) 286-2855",
      },
      odell: {
        name: "Odell Brewing Taproom",
        address: "800 E Lincoln Ave, Fort Collins, CO 80524",
        phone: "(970) 498-9070",
      },
      new_belgium: {
        name: "New Belgium Brewing",
        address: "500 Linden St, Fort Collins, CO 80524",
        phone: "(970) 221-0524",
      },
      equinox: {
        name: "Equinox Brewing",
        address: "133 Remington St, Fort Collins, CO 80524",
        phone: "(970) 484-1368",
      },
    };

    const BETA_PERK_PRIMARY = [
      { label: "Signature Mule", standardQty: 2, vipQty: 4 },
      { label: "Neon Margarita", standardQty: 2, vipQty: 4 },
      { label: "House Lager", standardQty: 2, vipQty: 4 },
      { label: "City Spritz", standardQty: 2, vipQty: 4 },
      { label: "After Dark Old Fashioned", standardQty: 1, vipQty: 2 },
      { label: "Velvet Espresso", standardQty: 1, vipQty: 2 },
      { label: "Glow Shot Flight", standardQty: 1, vipQty: 2 },
      { label: "Midnight Highball", standardQty: 2, vipQty: 4 },
    ];
    const BETA_PERK_SECONDARY = [
      { label: "Late-night Bites", standardQty: 1, vipQty: 2 },
      { label: "Snack Board", standardQty: 1, vipQty: 2 },
      { label: "App Sampler", standardQty: 1, vipQty: 2 },
      { label: "VIP Booth Toast", standardQty: 1, vipQty: 2 },
      { label: "Street Taco Duo", standardQty: 1, vipQty: 2 },
      { label: "After Hours Nachos", standardQty: 1, vipQty: 2 },
      { label: "Signature Slider", standardQty: 1, vipQty: 2 },
      { label: "Nightcap Dessert", standardQty: 1, vipQty: 2 },
    ];

    function getVenueShortName(name = "") {
      let short = String(name || "")
        .replace(/^The\s+/i, "")
        .replace(/\(.*\)/g, "")
        .replace(/\bBar\b/gi, "")
        .replace(/\bGrill\b/gi, "")
        .replace(/\bLounge\b/gi, "")
        .replace(/\bTavern\b/gi, "")
        .replace(/\bSaloon\b/gi, "")
        .replace(/\bTaproom\b/gi, "")
        .replace(/\bBrewing\b/gi, "")
        .replace(/\bCommunity\b/gi, "")
        .replace(/\bBike\b/gi, "")
        .replace(/\s+/g, " ")
        .trim();
      if (!short) short = String(name || "").trim();
      return short || "Venue";
    }

    function buildBetaVenuePerks(venueId) {
      const venueName = getVenueDisplayName(venueId);
      const short = getVenueShortName(venueName);
      const venueIds = Object.keys(venuesInfo || {});
      const baseIndex = venueIds.indexOf(venueId);
      const idx = baseIndex >= 0 ? baseIndex : Math.abs(hashString(venueId)) % BETA_PERK_PRIMARY.length;
      const primary = BETA_PERK_PRIMARY[idx % BETA_PERK_PRIMARY.length];
      const secondary = BETA_PERK_SECONDARY[(idx + 3) % BETA_PERK_SECONDARY.length];
      return [
        {
          id: `beta_${venueId}_1`,
          label: `${short} ${primary.label}`,
          standardQty: primary.standardQty,
          vipQty: primary.vipQty
        },
        {
          id: `beta_${venueId}_2`,
          label: `${secondary.label} at ${short}`,
          standardQty: secondary.standardQty,
          vipQty: secondary.vipQty
        }
      ];
    }

    refreshFeaturedVenuesData();

    function hashString(value = "") {
      let hash = 0;
      for (let i = 0; i < value.length; i++) {
        hash = ((hash << 5) - hash) + value.charCodeAt(i);
        hash |= 0;
      }
      return Math.abs(hash);
    }

    function populateRedeemVenueOptions() {
      if (!redeemVenueSelect) return;
      const venues = Object.entries(venuesInfo || {})
        .map(([id, info]) => ({ id, name: info?.name || id }))
        .filter(item => item.id && item.name)
        .sort((a, b) => a.name.localeCompare(b.name));
      const options = ['<option value="" selected disabled>Select venue</option>'];
      venues.forEach(({ id, name }) => {
        options.push(`<option value="${id}">${name}</option>`);
      });
      if (!isLaunched) {
        options.push('<option value="beta">FoCo Beta Venue</option>');
      }
      redeemVenueSelect.innerHTML = options.join("");
      redeemVenueSelect.value = "";
    }

    function parsePerkQuantity(value) {
      const qty = Number(value);
      if (!Number.isFinite(qty) || qty <= 0) return null;
      return Math.round(qty);
    }

    function normalizeVenuePerks(perks = []) {
      if (!Array.isArray(perks)) return [];
      const normalized = [];
      const seen = new Set();
      perks.forEach((perk, index) => {
        const label = String(perk?.label || "").trim();
        if (!label) return;
        const standardQty = parsePerkQuantity(
          perk?.standardQty ?? perk?.standard ?? perk?.standardCount ?? null
        );
        const vipQty = parsePerkQuantity(
          perk?.vipQty ?? perk?.vip ?? perk?.vipCount ?? null
        );
        const legacyLimit = parsePerkQuantity(perk?.limit ?? perk?.qty ?? perk?.quantity ?? null);
        let resolvedStandard = standardQty || legacyLimit || null;
        let resolvedVip = vipQty || legacyLimit || null;
        if (resolvedStandard && !resolvedVip) resolvedVip = resolvedStandard;
        if (resolvedVip && !resolvedStandard) resolvedStandard = resolvedVip;
        const entry = {
          id: String(perk?.id || `perk_${index}`),
          label
        };
        if (resolvedStandard) entry.standardQty = resolvedStandard;
        if (resolvedVip) entry.vipQty = resolvedVip;
        const key = label.toLowerCase();
        if (seen.has(key)) return;
        seen.add(key);
        normalized.push(entry);
      });
      return normalized;
    }

    function getVenuePerksForVenue(venueId) {
      if (!venueId) return [];
      const cached = venuePerksCache[venueId];
      if (Array.isArray(cached) && cached.length) return cached;
      if (!useCloudProfile()) return buildDefaultVenuePerks();
      if (!isLaunched) {
        return buildBetaVenuePerks(venueId);
      }
      return [];
    }

    function makeVenuePerkId() {
      return `perk_${Math.random().toString(36).slice(2, 10)}`;
    }

    function buildStaffPerkRow(perk = {}) {
      const row = document.createElement("div");
      row.className = "staff-perk-row";
      row.dataset.id = perk.id || makeVenuePerkId();
      row.innerHTML = `
        <div class="perk-field">
          <label>Perk name</label>
          <input class="staff-perk-label" type="text" placeholder="e.g. Margarita" />
        </div>
        <div class="perk-field">
          <label>Standard qty (per month)</label>
          <input class="staff-perk-standard" type="number" min="1" step="1" placeholder="e.g. 2" />
        </div>
        <div class="perk-field">
          <label>VIP qty (per month)</label>
          <input class="staff-perk-vip" type="number" min="1" step="1" placeholder="e.g. 4" />
        </div>
        <button type="button" class="perk-remove" title="Remove perk">âœ•</button>
      `;
      const labelInput = row.querySelector(".staff-perk-label");
      const standardInput = row.querySelector(".staff-perk-standard");
      const vipInput = row.querySelector(".staff-perk-vip");
      const removeBtn = row.querySelector(".perk-remove");
      if (labelInput) labelInput.value = perk.label || "";
      if (standardInput && Number.isFinite(perk.standardQty)) {
        standardInput.value = String(perk.standardQty);
      }
      if (vipInput && Number.isFinite(perk.vipQty)) {
        vipInput.value = String(perk.vipQty);
      }
      if (removeBtn) {
        removeBtn.addEventListener("click", async () => {
          const label = row.querySelector(".staff-perk-label")?.value?.trim() || "this perk";
          const ok = confirm(`Remove ${label}? This removes it from member profiles until re-added.`);
          if (!ok) return;
          row.remove();
          clearStaffPerksNotices();
          await saveStaffPerks();
        });
      }
      return row;
    }

    function renderStaffPerksEditor(perks = []) {
      if (!staffPerksList) return;
      staffPerksList.innerHTML = "";
      const normalized = normalizeVenuePerks(perks);
      if (!normalized.length) {
        staffPerksList.innerHTML = '<p class="small" style="color:#cbd5f5;text-align:left;">No perks yet. Add one to publish.</p>';
        return;
      }
      normalized.forEach(perk => {
        staffPerksList.appendChild(buildStaffPerkRow(perk));
      });
    }

    function clearStaffPerksNotices() {
      if (staffPerksError) staffPerksError.textContent = "";
      if (staffPerksSuccess) staffPerksSuccess.style.display = "none";
    }

    function collectStaffPerksFromDom() {
      if (!staffPerksList) return [];
      const rows = Array.from(staffPerksList.querySelectorAll(".staff-perk-row"));
      const perks = [];
      let hasDuplicate = false;
      let missingTierValue = false;
      rows.forEach(row => {
        const label = row.querySelector(".staff-perk-label")?.value?.trim() || "";
        const standardQty = parsePerkQuantity(row.querySelector(".staff-perk-standard")?.value);
        const vipQty = parsePerkQuantity(row.querySelector(".staff-perk-vip")?.value);
        if (!label) return;
        const key = label.toLowerCase();
        if (key && perks.some(item => item.label.toLowerCase() === key)) {
          hasDuplicate = true;
          return;
        }
        if (!standardQty || !vipQty) {
          missingTierValue = true;
          return;
        }
        perks.push({
          id: row.dataset.id || makeVenuePerkId(),
          label,
          standardQty,
          vipQty
        });
      });
      if (hasDuplicate) {
        if (staffPerksError) staffPerksError.textContent = "Perk names must be unique.";
        return null;
      }
      if (missingTierValue) {
        if (staffPerksError) staffPerksError.textContent = "Enter Standard and VIP quantities for every perk.";
        return null;
      }
      return perks;
    }

    async function saveStaffPerks() {
      if (!staffSession?.venue) {
        if (staffPerksError) staffPerksError.textContent = "Staff login required.";
        return;
      }
      clearStaffPerksNotices();
      const perks = collectStaffPerksFromDom();
      if (!perks) return;
      const venueId = staffSession.venue;
      const venueName = venuesInfo[venueId]?.name || venueId;
      venuePerksCache[venueId] = perks;
      renderRedemptionOptions();
      if (!db) {
        if (staffPerksSuccess) staffPerksSuccess.style.display = "block";
        return;
      }
      try {
        await ensureFirebaseUser();
        await setDoc(doc(db, "venuePerks", venueId), {
          venueId,
          venueName,
          perks,
          updatedAt: serverTimestamp()
        }, { merge: true });
        if (staffPerksSuccess) {
          staffPerksSuccess.style.display = "block";
          setTimeout(() => {
            if (staffPerksSuccess) staffPerksSuccess.style.display = "none";
          }, 2000);
        }
      } catch (err) {
        console.warn("Failed to save venue perks", err);
        if (staffPerksError) staffPerksError.textContent = "Could not save perks. Try again.";
      }
    }

    function stopStaffPerksListener() {
      if (staffPerksUnsub) {
        staffPerksUnsub();
        staffPerksUnsub = null;
      }
    }

    function startStaffPerksListener(venueId) {
      stopStaffPerksListener();
      if (!venueId) {
        renderStaffPerksEditor([]);
        return;
      }
      if (!db) {
        renderStaffPerksEditor(venuePerksCache[venueId] || []);
        return;
      }
      const ref = doc(db, "venuePerks", venueId);
      staffPerksUnsub = onSnapshot(ref, (snap) => {
        if (snap.exists()) {
          const data = snap.data() || {};
          const perks = normalizeVenuePerks(data.perks || []);
          venuePerksCache[venueId] = perks;
          renderStaffPerksEditor(perks);
        } else {
          venuePerksCache[venueId] = [];
          renderStaffPerksEditor([]);
        }
      }, (err) => {
        console.warn("Failed to listen for venue perks", err);
        renderStaffPerksEditor(venuePerksCache[venueId] || []);
      });
    }

    function stopRedeemPerksListener() {
      if (redeemPerksUnsub) {
        redeemPerksUnsub();
        redeemPerksUnsub = null;
      }
      redeemPerksLoading = false;
      if (redeemPerksHint) redeemPerksHint.style.display = "none";
    }

    function startRedeemVenuePerksListener(venueId) {
      stopRedeemPerksListener();
      if (!venueId) {
        renderRedemptionOptions();
        return;
      }
      if (!db) {
        renderRedemptionOptions();
        return;
      }
      venuePerksCache[venueId] = [];
      redeemPerksLoading = true;
      if (redeemPerksHint) redeemPerksHint.style.display = "block";
      const ref = doc(db, "venuePerks", venueId);
      redeemPerksUnsub = onSnapshot(ref, (snap) => {
        if (snap.exists()) {
          const data = snap.data() || {};
          venuePerksCache[venueId] = normalizeVenuePerks(data.perks || []);
        } else {
          venuePerksCache[venueId] = [];
        }
        redeemPerksLoading = false;
        if (redeemPerksHint) redeemPerksHint.style.display = "none";
        renderRedemptionOptions();
      }, (err) => {
        console.warn("Venue perks listener failed", err);
        redeemPerksLoading = false;
        if (redeemPerksHint) redeemPerksHint.style.display = "none";
        renderRedemptionOptions();
      });
    }

    // Populate CEO venue filter with participating venues
    function initCeoVenueFilter() {
      if (ceoVenueFilter) {
        const options = Object.entries(venuesInfo)
          .map(([id, info]) => `<option value="${id}">${info.name}</option>`)
          .join("");
        ceoVenueFilter.innerHTML = `<option value="all">All venues</option>${options}`;
      }
      if (ceoCloseOutVenue) {
        const options = Object.entries(venuesInfo)
          .map(([id, info]) => `<option value="${id}">${info.name}</option>`)
          .join("");
        ceoCloseOutVenue.innerHTML = `<option value="all">All venues</option>${options}`;
      }
      if (ceoVenueLog) {
        renderCeoVenueLog();
      }
      renderCeoCloseOutReports();
    }
    const venueAliases = {
      district: "bar_district",
      "the bar district": "bar_district",
      bondi: "bondi_beach",
      "bondi beach": "bondi_beach",
      "bondi beach bar": "bondi_beach",
      recroom: "rec_room",
      "rec room": "rec_room",
      "rec room fort collins": "rec_room",
      road34: "road_34",
      "road 34": "road_34",
      "road 34 bike bar": "road_34",
      "pour brothers": "pour_brothers",
      "pour brothers community tavern": "pour_brothers",
      "lucky joes": "lucky_joes",
      "lucky joeâ€™s sidewalk saloon": "lucky_joes",
      whiskey: "whiskey",
      "the whiskey": "whiskey",
      yeti: "yeti",
      "yeti bar": "yeti",
      "yeti bar & grill": "yeti",
      "drunken monkey": "drunken_monkey",
      boot: "boot_grill",
      "boot grill": "boot_grill",
      "trail head": "trail_head",
      "trail head tavern": "trail_head",
      "steak out": "steak_out",
      "steak-out saloon": "steak_out",
      "mo jeauxs": "mo_jeauxs",
      "mo jeauxâ€™s": "mo_jeauxs",
      "old town putt": "old_town_putt",
      social: "social",
      "ace gilletts": "ace_gilletts",
      "elliotts": "elliotts",
      "elliottâ€™s martini bar": "elliotts",
      "tap and handle": "tap_handle",
      tapandhandle: "tap_handle",
      "bar louie": "bar_louie",
      "cb potts": "cb_potts",
      "c.b. & potts": "cb_potts",
      intersect: "intersect",
      maxline: "maxline",
      odell: "odell",
      "new belgium": "new_belgium",
      equinox: "equinox"
    };

    const perkDefaults = {
      standard: { drink: 2, shot: 1, cover: 1 },
      vip: { drink: 4, shot: 3, cover: 2 },
      free: { drink: 999, shot: 999, cover: 999 },
      ceo: { drink: 999, shot: 999, cover: 999 },
    };

    const PERK_TYPES = {
      drink: { label: "Drink perk" },
      shot: { label: "Shot perk" },
      cover: { label: "Line access perk" },
    };

    function buildDefaultVenuePerks() {
      return [{
        id: makeVenuePerkId(),
        label: "",
        standardQty: null,
        vipQty: null
      }];
    }
    function normalizeTierKey(rawTier) {
      if (!rawTier) return null;
      const val = String(rawTier).toLowerCase();
      if (val.includes("ceo")) return "ceo";
      if (val.includes("free")) return "free";
      if (val.includes("vip")) return "vip";
      if (val.includes("standard")) return "standard";
      return null;
    }
    let pendingMembershipTier = null;
    let currentPerkState = null;
    let selectedPerkId = null;
    let selectedVenuePerkId = null;
    let selectedPerkLabel = null;
    let selectedRedeemVenue = "";
    let redemptionLog = [];
    let ceoGeneratedCodes = [];
    let staffPerksUnsub = null;
    let redeemPerksUnsub = null;
    let redeemPerksLoading = false;
    const CLOSE_OUT_KEY = "closeOutReports";
    let closeOutReports = [];
    let pendingCloseOutReport = null;
    const EXTRA_DEFAULTS = { drink: 0, shot: 0, cover: 0 };
    const EXTRA_VERSION = "1";
    let extraVouchers = { ...EXTRA_DEFAULTS };
    let ceoIssuedPasses = [];
    let ceoSentReceipts = [];
    const FREE_NOTICE_PREFIX = "free_notice_";
    const FREE_SEEN_PREFIX = "free_seen_";
    const FREE_REVOKED_PREFIX = "free_revoked_";
    const FREE_MEMBERS_KEY = "free_members_cache";
    const AUTO_CLOSE_OUT_KEY = "autoCloseOutSent";
    const NIGHT_WHEEL_KEY = "nightWheelSpins";
    const POINTS_KEY = "pointsLedger";
    const USERNAME_CHANGE_KEY = "usernameChange";
    const USERNAME_EMAIL_MAP = "usernameEmailMap";
    const VENUE_RATINGS_KEY = "venueRatings";
    const VENUE_USER_RATINGS_KEY = "venueUserRatings";
    const VIBE_KEY = "vibeState";
    const APP_VERSION = "v6";
    function membershipSelected() {
      return Boolean(currentMembershipTier && currentMembershipTier !== "standard_pending");
    }
    let passRealtimeUnsubs = [];
    let globalRealtimeUnsubs = [];
    let ceoReviewsUnsub = null;
    let ceoReviewsCache = [];
    function persistMemberState(partial = {}) {
      if (!db) return;
      const uid = firebaseAuth.currentUser?.uid;
      if (!uid) return;
      const payload = { ...partial };
      if (payload.nightWheel && (payload.nightWheel.then || typeof payload.nightWheel.then === "function")) {
        delete payload.nightWheel;
      }
      if (currentPassCode) payload.passCode = currentPassCode.toUpperCase();
      setDoc(doc(db, "members", uid), payload, { merge: true }).catch(err => console.warn("persistMemberState failed", err));
    }
    function loadVibeMap() {
      if (!allowLocalCache()) return {};
      try {
        return JSON.parse(localStorage.getItem(VIBE_KEY) || "{}");
      } catch (err) {
        return {};
      }
    }
    var VIBES = {
      flirty: { primary: "#f472b6", secondary: "#8b5cf6", glow: "rgba(244,114,182,0.45)", factor: 1.15 },
      blacking: { primary: "#0ea5e9", secondary: "#7c3aed", glow: "rgba(124,58,237,0.45)", factor: 1.6 },
      social: { primary: "#22d3ee", secondary: "#22c55e", glow: "rgba(34,211,238,0.38)", factor: 1.3 },
      casual: { primary: "#fbbf24", secondary: "#38bdf8", glow: "rgba(251,191,36,0.30)", factor: 0.75 }
    };
    var currentVibe = "social";
    const POINT_RULES = {
      redemption: { drink: 10, shot: 12, cover: 15, reward_shot: 8, default: 8 },
      uniqueVenueBonus: 15,
      review: 25,
      upgradeVip: 100
    };
    let autoCloseOutTimer = null;
    let freeMembersCache = [];
    const localFreeMembers = () => {
      if (!allowLocalCache()) return [];
      try { return JSON.parse(localStorage.getItem(FREE_MEMBERS_KEY) || "[]"); } catch (err) { return []; }
    };
    const isPassLocallyFree = (code) => {
      if (!code) return false;
      const upper = code.toUpperCase();
      return localFreeMembers().some(entry => (entry.passCode || "").toUpperCase() === upper);
    };

    async function syncFreeFlagForCurrentPass() {
      const code = (currentPassCode || "").toUpperCase();
      if (!code) return;
      let active = null;
      if (db) {
        try {
          const snap = await getDoc(doc(db, "freeMemberships", code));
          if (snap.exists()) {
            const data = snap.data();
            if (data && data.active !== false) {
              active = { ...data, passCode: code };
            }
          }
        } catch (err) {
          console.warn("Failed to fetch freeMemberships doc", err);
        }
      }
      if (!active) {
        if (allowLocalCache()) {
          const directory = loadMemberDirectory();
          const entry = directory[code];
          if (entry?.freeMembership) active = entry;
        }
      }
      if (active) {
        memberProfile = memberProfile || {};
        memberProfile.freeMembership = true;
        memberProfile.revoked = false;
        memberProfile.tier = "free";
        memberProfile.validUntil = "never";
        memberProfile.perks = { tier: "free", remaining: getDefaultPerkState("free") };
        setMemberDirectoryEntry(code, memberProfile);
        localStorage.setItem(`${FREE_NOTICE_PREFIX}${code}`, "1");
        applyMembershipToPass("free");
        renderRedemptionOptions();
        renderVipDealForMember();
        updateExpiryDisplay();
        showFreeWelcomeToast();
      }
    }
    let demoMode = false;
    const PURCHASE_RECEIPTS_KEY = "purchaseReceipts";
    let purchaseReceipts = loadPurchaseReceipts();
    let vipDealsCache = loadVipDealsFromStorage();
    function incrementRewardsProgress() {
      rewardsProgress.count += 1;
      if (rewardsProgress.count >= 5) {
        rewardsProgress.available = true;
        rewardsProgress.rewardType = "shot";
        rewardsProgress.count = 0;
      }
      saveRewardsProgress(rewardsProgress);
      updateRewardsUI();
    }
    function pruneExpiredVipDeals() {
      const now = Date.now();
      let changed = false;
      Object.entries(vipDealsCache).forEach(([id, deal]) => {
        const expires = deal?.expiresAt?.toMillis
          ? deal.expiresAt.toMillis()
          : deal?.expiresAt
            ? new Date(deal.expiresAt).getTime()
            : null;
        if (expires && expires <= now) {
          delete vipDealsCache[id];
          changed = true;
        }
      });
      if (changed) {
        saveVipDealsToStorage(vipDealsCache);
        renderVipDealForMember();
        renderStaffVipDeal();
      }
    }
    let staffVenueReceipts = [];
    // Deal codes helpers (define before any alert/deal refresh)
    function loadDealCodes() {
      if (memberProfile?.dealCodes) return memberProfile.dealCodes;
      if (!allowLocalCache()) return {};
      try {
        return JSON.parse(localStorage.getItem(DEAL_CODES_KEY) || "{}");
      } catch (err) {
        return {};
      }
    }
    function saveDealCodes(map) {
      if (allowLocalCache()) {
        localStorage.setItem(DEAL_CODES_KEY, JSON.stringify(map || {}));
      }
      persistMemberState({ dealCodes: map || {} });
    }
    function cleanDealCodes() {
      try {
        dealCodes = loadDealCodes();
      } catch (err) {
        dealCodes = {};
      }
    }
    dealCodes = loadDealCodes();
    let currentAccentTheme = "cyan";
    let currentBgTheme = "default";
    let bgUserSelected = false;
    /* accentToBg mapping removed â€” background selection disabled */
    const ACHIEVEMENTS = [
      { id: "firstLogin", label: "First Login", desc: "Log in for the first time.", icon: "ðŸ”‘" },
      { id: "handleSet", label: "Handle Ready", desc: "Set your @username.", icon: "ðŸ·ï¸" },
      { id: "firstPerk", label: "First Perk", desc: "Redeem your first voucher.", icon: "ðŸ¸" },
      { id: "threeVenues", label: "City Explorer", desc: "Redeem perks at 3 venues.", icon: "ðŸ§­" },
      { id: "firstReview", label: "First Review", desc: "Leave your first review.", icon: "ðŸ“" },
      { id: "monthlyStreak", label: "Streak Starter", desc: "Redeem 5 perks in a month.", icon: "ðŸ”¥" },
    ];
    const NIGHT_WHEEL_CHALLENGES = [
      "Start a 10-second dance-off with your crew.",
      "Teach someone a new cheers and use it on the next round.",
      "Compliment the DJ and request a song.",
      "Order the bartenderâ€™s favorite drink and rate it.",
      "High-five five strangers near the bar.",
      "Swap seats with a friend for one round and meet their neighbor.",
      "Leave a 5-star review for the venue before midnight.",
      "Take a group photo with another table (ask first!).",
      "Try a mocktail and convince a friend to taste it.",
      "Tip extra on your next order and say thanks by name.",
      "Offer a sincere compliment to someoneâ€™s outfit.",
      "Challenge a stranger to rock-paper-scissors; loser buys water.",
      "Ask the bartender for a surprise drink and guess the ingredients.",
      "Teach someone a dance move you just made up.",
      "Start a conga line for 15 seconds.",
      "Find someone with the same first letter name and cheers together.",
      "Swap hats/glasses with a friend for one song.",
      "Start a mini sing-along to the chorus of the current song.",
      "Pair up two friends whoâ€™ve never met and introduce them.",
      "Start a two-truths-and-a-dare with your group.",
      "Ask someone their best karaoke song and promise to duet later.",
      "Trade playlists with someone for the next round.",
      "Start a slow-motion toast with everyone at your table.",
      "Challenge your table to only whisper for one minute.",
      "Start a friendly staring contest with a friend; winner picks the drink.",
      "Give someone a random nickname and use it all night (keep it kind).",
      "Ask the DJ to dedicate the next song to your table.",
      "Find someone celebrating and start a quick celebratory cheer.",
      "Teach a new handshake to your group.",
      "Ask someone for their best life advice in one sentence.",
      "Start a photo scavenger hunt: neon sign, disco ball, smiling bartender.",
      "Play â€œwould you ratherâ€ with the person next to you.",
      "Get a group to do a synchronized sip countdown: 3, 2, 1, sip.",
      "Ask a stranger what their hidden talent is (no pressure to show it).",
      "Start a friendly â€œbest laughâ€ contestâ€”loudest wins.",
      "Lead a five-second freeze dance when the beat drops.",
      "Ask someone to show you a magic trick; rate it out of 10.",
      "Challenge a friend to a silent dance battle for 15 seconds.",
      "Get a cheers going with the table on your left and right.",
      "Start a quick pose-off for a photoâ€”best pose wins bragging rights."
    ];
    function getNightWheelVenueSpecial() {
      const venueIds = Object.keys(venuesInfo || {});
      if (!isLaunched && !venueIds.includes("beta")) venueIds.push("beta");
      const entries = venueIds.map((venueId) => {
        const perks = getVenuePerksForVenue(venueId);
        const normalized = normalizeVenuePerks(perks || []);
        if (!normalized.length) return null;
        const venueName = getVenueDisplayName(venueId);
        return { venueId, venueName, perks: normalized };
      }).filter(Boolean);
      if (!entries.length) return null;
      const venuePick = randomFrom(entries);
      const perkPick = randomFrom(venuePick.perks);
      if (!perkPick || !perkPick.label) return null;
      return {
        venueId: venuePick.venueId,
        venueName: venuePick.venueName,
        perkLabel: perkPick.label
      };
    }
    function getAccentPreset(theme = "cyan") {
      const presets = {
        cyan: {
          primary: "#22d3ee",
          secondary: "#22c55e",
          glow: "rgba(34, 211, 238, 0.45)",
          border: "rgba(34, 211, 238, 0.4)",
          surface: "rgba(34, 211, 238, 0.12)",
          shadow: "0 25px 60px rgba(1, 4, 12, 0.75), 0 0 35px rgba(34, 211, 238, 0.35)"
        },
        magenta: {
          primary: "#f472b6",
          secondary: "#8b5cf6",
          glow: "rgba(244, 114, 182, 0.45)",
          border: "rgba(244, 114, 182, 0.4)",
          surface: "rgba(244, 114, 182, 0.12)",
          shadow: "0 25px 60px rgba(1, 4, 12, 0.75), 0 0 35px rgba(244, 114, 182, 0.3)"
        },
        gold: {
          primary: "#fbbf24",
          secondary: "#0ea5e9",
          glow: "rgba(251, 191, 36, 0.42)",
          border: "rgba(251, 191, 36, 0.38)",
          surface: "rgba(251, 191, 36, 0.12)",
          shadow: "0 25px 60px rgba(1, 4, 12, 0.75), 0 0 35px rgba(251, 191, 36, 0.28)"
        },
        jade: {
          primary: "#34d399",
          secondary: "#0ea5e9",
          glow: "rgba(52, 211, 153, 0.45)",
          border: "rgba(52, 211, 153, 0.38)",
          surface: "rgba(52, 211, 153, 0.12)",
          shadow: "0 25px 60px rgba(0, 10, 8, 0.75), 0 0 35px rgba(52, 211, 153, 0.3)"
        },
        electric: {
          primary: "#7c3aed",
          secondary: "#22d3ee",
          glow: "rgba(124, 58, 237, 0.48)",
          border: "rgba(124, 58, 237, 0.42)",
          surface: "rgba(124, 58, 237, 0.14)",
          shadow: "0 25px 60px rgba(10, 6, 24, 0.75), 0 0 38px rgba(124, 58, 237, 0.32)"
        },
        ember: {
          primary: "#f97316",
          secondary: "#f43f5e",
          glow: "rgba(249, 115, 22, 0.48)",
          border: "rgba(249, 115, 22, 0.42)",
          surface: "rgba(249, 115, 22, 0.14)",
          shadow: "0 25px 60px rgba(20, 8, 0, 0.78), 0 0 38px rgba(249, 115, 22, 0.32)"
        },
        ceo: {
          primary: "#ffd700",
          secondary: "#00f7ff",
          glow: "rgba(255, 215, 0, 0.58)",
          border: "rgba(255, 215, 0, 0.6)",
          surface: "rgba(255, 215, 0, 0.18)",
          shadow: "0 30px 70px rgba(0, 0, 0, 0.85), 0 0 50px rgba(0, 247, 255, 0.35)"
        },
      };
      return presets[theme] || presets.cyan;
    }
    function applyAccentTheme(theme = "cyan") {
      const palette = getAccentPreset(theme);
      const root = document.documentElement;
      root.style.setProperty("--accent-cyan", palette.primary);
      root.style.setProperty("--accent-green", palette.secondary);
      root.style.setProperty("--border-strong", palette.border);
      root.style.setProperty("--glow-cyan", palette.glow);
      root.style.setProperty("--accent-magenta", palette.primary);
      root.style.setProperty("--accent-primary-live", palette.primary);
      root.style.setProperty("--accent-secondary-live", palette.secondary);
      root.style.setProperty("--accent-border-live", palette.border);
      root.style.setProperty("--accent-glow-live", palette.glow);
      root.style.setProperty("--accent-surface-live", palette.surface);
      root.style.setProperty("--accent-shadow-live", palette.shadow);
      document.body.classList.remove("theme-cyan", "theme-magenta", "theme-gold", "theme-jade", "theme-electric", "theme-ember", "theme-ceo");
      document.body.classList.add(`theme-${theme}`);
      currentAccentTheme = theme;
      if (currentPassCode) {
        localStorage.setItem(ACCENT_KEY, theme);
        setMemberDirectoryEntry(currentPassCode, { accent: theme });
        persistMemberState({ accent: theme });
      } else {
        localStorage.removeItem(ACCENT_KEY);
      }
      accentChips.forEach(chip => chip.classList.toggle("active", chip.dataset.accent === theme));
      // Background auto-apply disabled (users no longer choose background options)
    }
    function loadAccentTheme() {
      if (!currentPassCode) {
        localStorage.removeItem(ACCENT_KEY);
        applyAccentTheme("cyan");
        return;
      }
      if (memberProfile?.accent) {
        applyAccentTheme(memberProfile.accent);
        return;
      }
      if (!allowLocalCache()) {
        applyAccentTheme("cyan");
        return;
      }
      const local = localStorage.getItem(ACCENT_KEY);
      let fromProfile = null;
      const directory = loadMemberDirectory();
      const entry = directory[(currentPassCode || "").toUpperCase()];
      if (entry?.accent) fromProfile = entry.accent;
      applyAccentTheme(fromProfile || local || "cyan");
      loadBackgroundTheme();
    }
    function applyBackgroundTheme(theme = "default") {
      const allowed = ["default", "mesh", "grid", "bokeh"];
      const next = allowed.includes(theme) ? theme : "default";
      document.body.classList.remove("bg-default", "bg-mesh", "bg-grid", "bg-bokeh");
      document.body.classList.add(`bg-${next}`);
      currentBgTheme = next;
      if (currentPassCode) {
        localStorage.setItem(BG_KEY, next);
        setMemberDirectoryEntry(currentPassCode, { bgTheme: next });
      } else {
        localStorage.removeItem(BG_KEY);
      }
      // No UI bg buttons to toggle anymore.
    }

    function getWeekToken() {
      const now = new Date();
      const jan1 = new Date(now.getFullYear(), 0, 1);
      const dayMs = 24 * 60 * 60 * 1000;
      const week = Math.ceil((((now - jan1) / dayMs) + jan1.getDay() + 1) / 7);
      return `${now.getFullYear()}-W${week}`;
    }
    function getMonthToken() {
      const now = new Date();
      const m = String(now.getMonth() + 1).padStart(2, "0");
      return `${now.getFullYear()}-${m}`;
    }
    function getMonthTokenFromDate(date) {
      const parsed = date instanceof Date ? date : new Date(date);
      if (Number.isNaN(parsed.getTime())) return getMonthToken();
      const m = String(parsed.getMonth() + 1).padStart(2, "0");
      return `${parsed.getFullYear()}-${m}`;
    }
    function normalizeNightWheelState(state) {
      if (!state || typeof state !== "object" || Array.isArray(state)) return {};
      if (state.then || typeof state.then === "function") return {}; // strip promises
      const clean = {};
      Object.entries(state).forEach(([k, v]) => {
        if (!v || typeof v !== "object" || Array.isArray(v) || (v.then || typeof v.then === "function")) return;
        const period = typeof v.period === "string" ? v.period : (typeof v.week === "string" ? v.week : "");
        const spins = Number.isFinite(v.spins) ? v.spins : 0;
        clean[k.toUpperCase()] = { period, spins };
      });
      return clean;
    }
    function loadNightWheelState() {
      const fromProfile = normalizeNightWheelState(memberProfile?.nightWheel || {});
      if (Object.keys(fromProfile).length) return fromProfile;
      if (!allowLocalCache()) return {};
      try {
        const parsed = JSON.parse(localStorage.getItem(NIGHT_WHEEL_KEY) || "{}");
        return normalizeNightWheelState(parsed);
      } catch (err) {
        return {};
      }
    }
    function saveNightWheelState(state) {
      const clean = normalizeNightWheelState(state);
      if (allowLocalCache()) {
        localStorage.setItem(NIGHT_WHEEL_KEY, JSON.stringify(clean));
      }
      persistMemberState({ nightWheel: clean });
    }
    function getNightWheelEntry(passId) {
      if (!passId) return null;
      const state = loadNightWheelState();
      const key = passId.toUpperCase();
      return state[key] || null;
    }
    function setNightWheelEntry(passId, entry) {
      if (!passId) return;
      const state = loadNightWheelState();
      const period = typeof entry?.period === "string" ? entry.period : getWeekToken();
      const spins = Number.isFinite(entry?.spins) ? entry.spins : 0;
      state[passId.toUpperCase()] = { period, spins };
      saveNightWheelState(state);
    }
    function getNightWheelAllowance() {
      const isFreeTier = currentMembershipTier === "free";
      if (isCeoActive() || isFreeMember() || isFreeTier) return Infinity;
      if (currentMembershipTier === "vip") return 4; // per month
      return 2; // standard per month
    }
    function getNightWheelRemaining() {
      const allowance = getNightWheelAllowance();
      if (allowance === Infinity) return Infinity;
      const code = (currentPassCode || "").toUpperCase();
      const entry = getNightWheelEntry(code);
      const periodKey = (currentMembershipTier === "vip" || currentMembershipTier === "standard")
        ? getMonthToken()
        : getWeekToken();
      const activePeriod = entry?.period || entry?.week || "";
      if (!entry || activePeriod !== periodKey) return allowance;
      return Math.max(0, allowance - (entry.spins || 0));
    }
    function saveVibeState(code, vibe) {
      if (!code || !vibe) return;
      setMemberDirectoryEntry(code, { vibe });
      if (allowLocalCache()) {
        const all = loadVibeMap();
        all[code] = vibe;
        localStorage.setItem(VIBE_KEY, JSON.stringify(all));
      }
      persistMemberState({ vibe });
    }
    function loadVibeState(code) {
      if (!code) return null;
      if (memberProfile?.vibe) return memberProfile.vibe;
      if (!allowLocalCache()) return null;
      const all = loadVibeMap();
      if (all[code]) return all[code];
      const directory = loadMemberDirectory();
      return (directory[code] || {}).vibe || null;
    }
    function applyVibeStyle(vibeName) {
      const vibe = VIBES[vibeName] || VIBES.social;
      currentVibe = vibeName || "social";
      if (pulseBand) {
        pulseBand.style.setProperty("--vibe-primary", vibe.primary);
        pulseBand.style.setProperty("--vibe-secondary", vibe.secondary);
        pulseBand.style.setProperty("--vibe-glow", vibe.glow);
      }
      if (vibeButtons && vibeButtons.length) {
        vibeButtons.forEach(btn => btn.classList.toggle("active", btn.dataset.vibe === currentVibe));
      }
      if (pulsePrimary) {
        pulsePrimary.textContent = `Vibe: ${currentVibe === "blacking" ? "Blacking Out" : currentVibe[0].toUpperCase() + currentVibe.slice(1)}`;
      }
    }
    function setVibe(vibeName) {
      const code = (currentPassCode || "").toUpperCase();
      applyVibeStyle(vibeName);
      saveVibeState(code, vibeName);
      if (memberProfile) memberProfile.vibe = vibeName;
      updatePulseBand();
    }
    function setRadarGraffiti(name) {
      if (!radarGraffiti) return;
      radarGraffiti.textContent = name || "Live Floor";
    }
    function loadStaffAccent(venueId) {
      if (!venueId) return null;
      return localStorage.getItem(`${STAFF_ACCENT_PREFIX}${venueId}`) || null;
    }
    const staffPortalScreen = document.getElementById("staffPortalScreen");
    const STAFF_ACCENT_PRESETS = {
      magenta: {
        primary: "#c084fc",
        secondary: "#f0abfc",
        border: "rgba(192,132,252,0.35)",
        glow: "rgba(192,132,252,0.22)"
      },
      gold: {
        primary: "#f2d08a",
        secondary: "#d9b45f",
        border: "rgba(242,208,138,0.4)",
        glow: "rgba(242,208,138,0.22)"
      },
      jade: {
        primary: "#6ee7b7",
        secondary: "#34d399",
        border: "rgba(110,231,183,0.35)",
        glow: "rgba(110,231,183,0.22)"
      },
      ember: {
        primary: "#fca5a5",
        secondary: "#fdba74",
        border: "rgba(252,165,165,0.35)",
        glow: "rgba(252,165,165,0.22)"
      }
    };
    function getStaffAccentPreset(theme) {
      return STAFF_ACCENT_PRESETS[theme] || STAFF_ACCENT_PRESETS.magenta;
    }
    function boostGlowAlpha(color, target = 0.75) {
      if (!color || typeof color !== "string") return color;
      const match = color.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([0-9.]+)\)/i);
      if (!match) return color;
      const alpha = Math.min(0.9, Math.max(target, parseFloat(match[4]) || target));
      return `rgba(${match[1]}, ${match[2]}, ${match[3]}, ${alpha})`;
    }
    function applyStaffAccent(theme) {
      const palette = getStaffAccentPreset(theme);
      if (staffPortalScreen && palette) {
        const strongGlow = boostGlowAlpha(palette.glow, 0.5);
        const strongBorder = boostGlowAlpha(palette.border, 0.45);
        staffPortalScreen.style.setProperty("--staff-primary", palette.primary);
        staffPortalScreen.style.setProperty("--staff-secondary", palette.secondary);
        staffPortalScreen.style.setProperty("--staff-border", palette.border);
        staffPortalScreen.style.setProperty("--staff-glow", palette.glow);
        staffPortalScreen.style.setProperty("--staff-glow-strong", strongGlow);
        staffPortalScreen.style.setProperty("--staff-border-strong", strongBorder);
        staffPortalScreen.style.setProperty("--staff-surface", "rgba(6,10,22,0.94)");
        staffPortalScreen.style.setProperty("--staff-text", "#e2e8f0");
        staffPortalScreen.style.setProperty("--staff-muted", "#94a3b8");
        if (radarGraffiti) {
          radarGraffiti.style.color = palette.primary;
          radarGraffiti.style.textShadow = `0 0 12px ${palette.glow}, 0 0 28px rgba(99,102,241,0.45), 0 0 48px rgba(8,47,73,0.8)`;
          radarGraffiti.style.filter = `drop-shadow(0 0 12px ${palette.glow})`;
        }
      }
      if (staffAccentButtons && staffAccentButtons.length) {
        staffAccentButtons.forEach(btn => {
          btn.classList.toggle("active", btn.dataset.staffAccent === theme);
          const btnPalette = getStaffAccentPreset(btn.dataset.staffAccent);
          if (btnPalette) {
            const outline = boostGlowAlpha(btnPalette.border, 0.55);
            btn.style.background = `linear-gradient(120deg, ${btnPalette.primary}, ${btnPalette.secondary})`;
            btn.style.borderColor = btnPalette.border;
            btn.style.outline = `2px solid ${outline}`;
            btn.style.outlineOffset = "2px";
            btn.style.color = "#001018";
            btn.style.boxShadow = btn.dataset.staffAccent === theme
              ? `0 10px 24px ${btnPalette.glow}`
              : "0 6px 14px rgba(0,0,0,0.25)";
          }
        });
      }
    }
    function setStaffAccent(theme, venueId) {
      if (!theme || !venueId) return;
      localStorage.setItem(`${STAFF_ACCENT_PREFIX}${venueId}`, theme);
      applyStaffAccent(theme);
    }
    function loadVibeForCurrentPass() {
      const code = (currentPassCode || "").toUpperCase();
      const saved = (allowLocalCache() ? loadVibeState(code) : null) || memberProfile?.vibe || "social";
      applyVibeStyle(saved);
    }
    function updateNightWheelUI() {
      if (!nightWheelRemaining || !nightWheelResult) return;
      const remaining = getNightWheelRemaining();
      const isVip = currentMembershipTier === "vip";
      const isStd = currentMembershipTier === "standard";
      const periodLabel = remaining === Infinity ? "" : "this month";
      if (remaining === Infinity) {
        nightWheelRemaining.textContent = "Unlimited spins (CEO / CEO-issued / Free)";
      } else {
        nightWheelRemaining.textContent = `${remaining} spin${remaining === 1 ? "" : "s"} left ${periodLabel}`;
      }
      if (!nightWheelResult.dataset.hasResult) {
        nightWheelResult.textContent = "Ready when you are.";
      }
      if (nightWheelSpinBtn) {
        nightWheelSpinBtn.disabled = remaining === 0;
      }
      updateQuickStrip();
    }
    function randomFrom(list = []) {
      if (!list.length) return "";
      return list[Math.floor(Math.random() * list.length)];
    }
    function spinNightWheel() {
      const remaining = getNightWheelRemaining();
      if (remaining === 0) {
        showToast("No spins left this month.");
        return;
      }
      const selection = getNightWheelVenueSpecial();
      if (!selection) {
        showToast("No venue specials posted yet.");
        return;
      }
      const bar = selection.venueName;
      const special = selection.perkLabel;
      const challenge = randomFrom(NIGHT_WHEEL_CHALLENGES);
      const code = (currentPassCode || "").toUpperCase();
      const entry = getNightWheelEntry(code) || {};
      const period = (currentMembershipTier === "vip" || currentMembershipTier === "standard")
        ? getMonthToken()
        : getWeekToken();
      const spins = (entry.period === period || entry.week === period ? (entry.spins || 0) : 0) + 1;
      setNightWheelEntry(code, { period, spins });
      nightWheelResult.innerHTML = `
        <strong style="color:#a5f3fc;">Bar:</strong> ${bar}<br/>
        <strong style="color:#fbbf24;">Special:</strong> ${special}<br/>
        <strong style="color:#f472b6;">Challenge:</strong> ${challenge}
      `;
      nightWheelResult.dataset.hasResult = "1";
      burstConfetti(['#22d3ee', '#f472b6', '#fbbf24']);
      addPoints(20, "Night Wheel spin");
      updateNightWheelUI();
    }
    function openUsernameModal() {
      if (!usernameModal) return;
      usernameEditError.textContent = "";
      const current = preferredUsername();
      if (usernameEditInput) {
        usernameEditInput.value = current;
        usernameEditInput.focus();
        usernameEditInput.select();
      }
      usernameModal.classList.add("active");
    }
    function closeUsernameModal() {
      if (usernameModal) usernameModal.classList.remove("active");
      if (usernameEditError) usernameEditError.textContent = "";
    }
    function hasUnlimitedUsernameChanges() {
      return isCeoActive() || isCeoAccount || memberProfile?.ceo || isFreeMember();
    }
    function usernameChangeCountsKey(code) {
      return `${USERNAME_CHANGE_KEY}_${code}`;
    }
    function normalizeUsernameChangeCounts(raw) {
      if (!raw) return {};
      if (typeof raw === "string") {
        const parsed = new Date(raw);
        if (!Number.isNaN(parsed.getTime())) {
          return { [getMonthTokenFromDate(parsed)]: 1 };
        }
        try {
          raw = JSON.parse(raw);
        } catch (_) {
          return {};
        }
      }
      if (Array.isArray(raw)) {
        return raw.reduce((acc, stamp) => {
          const token = getMonthTokenFromDate(stamp);
          acc[token] = (acc[token] || 0) + 1;
          return acc;
        }, {});
      }
      if (typeof raw === "object") {
        return Object.entries(raw).reduce((acc, [key, value]) => {
          const count = Number(value);
          if (Number.isFinite(count) && count > 0) acc[key] = count;
          return acc;
        }, {});
      }
      return {};
    }
    function loadUsernameChangeCounts(code) {
      if (!code) return {};
      const counts = normalizeUsernameChangeCounts(memberProfile?.usernameChangeCounts);
      const raw = localStorage.getItem(usernameChangeCountsKey(code));
      const localCounts = normalizeUsernameChangeCounts(raw);
      Object.entries(localCounts).forEach(([key, value]) => {
        counts[key] = Math.max(Number(counts[key] || 0), Number(value || 0));
      });
      return counts;
    }
    function getUsernameChangesThisMonth(code) {
      const counts = loadUsernameChangeCounts(code);
      return Number(counts[getMonthToken()] || 0);
    }
    function usernameChangeLimitMessage(code) {
      const remaining = Math.max(0, 2 - getUsernameChangesThisMonth(code));
      if (!remaining) return "You can change your username twice per month.";
      return `You can change your username ${remaining} more time${remaining === 1 ? "" : "s"} this month.`;
    }
    function recordUsernameChange(code) {
      if (!code) return null;
      const counts = loadUsernameChangeCounts(code);
      const token = getMonthToken();
      counts[token] = Number(counts[token] || 0) + 1;
      localStorage.setItem(usernameChangeCountsKey(code), JSON.stringify(counts));
      return counts;
    }
    async function applyUsernameChange(code, finalName) {
      const changeCounts = recordUsernameChange(code);
      const updates = {
        username: finalName,
        usernameChangedAt: new Date().toISOString()
      };
      if (changeCounts) updates.usernameChangeCounts = changeCounts;
      memberProfile = { ...(memberProfile || {}), ...updates };
      if (userUsername) userUsername.textContent = `@${finalName}`;
      if (userMiniDisplay) userMiniDisplay.textContent = `@${finalName}`;
      setMemberDirectoryEntry(code, { username: finalName, email: firebaseAuth.currentUser?.email || "" });
      setPointsForPass(code, getPointsForPass(code));
      if (firebaseAuth.currentUser?.email) {
        saveUsernameMapEntry(finalName, firebaseAuth.currentUser.email);
        if (db) {
          const unameDoc = doc(db, "usernames", finalName.trim().toLowerCase());
          setDoc(unameDoc, {
            email: firebaseAuth.currentUser.email,
            uid: firebaseAuth.currentUser.uid || "",
            updatedAt: serverTimestamp()
          }, { merge: true }).catch(err => console.warn("Username map save failed", err));
        }
      }
      updatePointsUI();
      evaluateAchievements();
      await updateMemberProfile(updates);
    }
    async function saveUsernameFromModal() {
      const code = (currentPassCode || "").toUpperCase();
      if (!code) return;
      if (!canChangeUsername(code)) {
        usernameEditError.textContent = usernameChangeLimitMessage(code);
        return;
      }
      const next = (usernameEditInput?.value || "").trim();
      const check = validateUsername(next);
      if (!check.ok) {
        if (usernameEditError) usernameEditError.textContent = check.message;
        return;
      }
      const finalName = check.value;
      const current = preferredUsername();
      if (isUsernameTaken(finalName) && finalName.toLowerCase() !== current.toLowerCase()) {
        if (usernameEditError) usernameEditError.textContent = "Username already taken. Try another.";
        return;
      }
      await applyUsernameChange(code, finalName);
      closeUsernameModal();
      showToast("Username updated.");
    }
    function canChangeUsername(code) {
      if (!code) return true;
      if (hasUnlimitedUsernameChanges()) return true;
      return getUsernameChangesThisMonth(code) < 2;
    }
    function isUsernameTaken(candidate) {
      if (!candidate) return false;
      const check = candidate.trim().toLowerCase();
      if (!check) return false;
      const ledger = loadPointsLedger();
      const takenInLedger = Object.values(ledger).some(entry => (entry.username || "").toLowerCase() === check);
      if (takenInLedger) return true;
      const directory = loadMemberDirectory();
      return Object.values(directory).some(entry => (entry.username || "").toLowerCase() === check);
    }
    async function handleUsernameEdit() {
      const code = (currentPassCode || "").toUpperCase();
      if (!code) return;
      if (!canChangeUsername(code)) {
        showToast(usernameChangeLimitMessage(code));
        return;
      }
      const current = preferredUsername();
      const next = prompt("Choose a unique username (3-10 chars, letters/numbers/underscore/space)", current);
      if (!next) return;
      const cleaned = next.trim();
      const check = validateUsername(cleaned);
      if (!check.ok) {
        showToast(check.message);
        return;
      }
      const finalName = check.value;
      if (isUsernameTaken(finalName) && finalName.toLowerCase() !== current.toLowerCase()) {
        showToast("Username already taken. Try another.");
        return;
      }
      await applyUsernameChange(code, finalName);
      showToast("Username updated.");
    }
    function loadBackgroundTheme() {
      if (!currentPassCode) {
        localStorage.removeItem(BG_KEY);
        applyBackgroundTheme("default");
        bgUserSelected = false;
        return;
      }
      if (memberProfile?.bgTheme) {
        bgUserSelected = true;
        applyBackgroundTheme(memberProfile.bgTheme);
        return;
      }
      if (!allowLocalCache()) {
        bgUserSelected = false;
        applyBackgroundTheme("default");
        return;
      }
      const localBg = localStorage.getItem(BG_KEY);
      let fromProfile = null;
      const directory = loadMemberDirectory();
      const entry = directory[(currentPassCode || "").toUpperCase()];
      if (entry?.bgTheme) fromProfile = entry.bgTheme;
      const chosen = fromProfile || localBg || "default";
      bgUserSelected = Boolean(fromProfile || localBg);
      applyBackgroundTheme(chosen);
    }

    function loadPointsLedger() {
      if (useCloudProfile()) return {};
      try {
        return JSON.parse(localStorage.getItem(POINTS_KEY) || "{}");
      } catch (err) {
        return {};
      }
    }
    function seedPointsFromDirectory(passId) {
      if (useCloudProfile()) return null;
      const code = (passId || "").toUpperCase();
      if (!code) return null;
      const directory = loadMemberDirectory();
      const cached = directory[code];
      if (cached && Number.isFinite(cached.points)) {
        const ledger = loadPointsLedger();
        ledger[code] = {
          points: cached.points,
          venues: cached.venuesVisited || {},
          username: cached.username || preferredUsername(),
          tier: cached.tier || currentMembershipTier || "standard"
        };
        savePointsLedger(ledger);
        return ledger[code];
      }
      return null;
    }
    function savePointsLedger(ledger) {
      if (useCloudProfile()) return;
      localStorage.setItem(POINTS_KEY, JSON.stringify(ledger || {}));
    }
    function getPointsForPass(passId) {
      if (!passId) return 0;
      const key = (passId || "").toUpperCase();
      if (useCloudProfile()) {
        if (key === (currentPassCode || "").toUpperCase()) {
          return Number(memberProfile?.points) || 0;
        }
        return 0;
      }
      if (key === (currentPassCode || "").toUpperCase() && Number.isFinite(memberProfile?.points)) {
        return memberProfile.points;
      }
      const ledger = loadPointsLedger();
      if (ledger[key] && Number.isFinite(ledger[key].points)) {
        return ledger[key].points;
      }
      // seed from directory if ledger missing
      const directory = loadMemberDirectory();
      const cached = directory[key];
      if (cached && Number.isFinite(cached.points)) {
        ledger[key] = {
          points: cached.points,
          venues: cached.venuesVisited || {},
          username: cached.username || preferredUsername(),
          tier: cached.tier || currentMembershipTier || "standard"
        };
        savePointsLedger(ledger);
        return cached.points;
      }
      return 0;
    }
    function labelForTier(tier) {
      if (!tier) return "Member";
      const t = tier.toLowerCase();
      if (t === "vip") return "VIP";
      if (t === "free") return "Free";
      if (t === "ceo") return "CEO";
      return "Member";
    }
    function setPointsForPass(passId, points, opts = {}) {
      if (!passId) return;
      if (useCloudProfile()) {
        const key = passId.toUpperCase();
        if (key === (currentPassCode || "").toUpperCase()) {
          const incoming = Math.max(0, points);
          memberProfile = memberProfile || {};
          memberProfile.points = incoming;
          if (!opts.skipPersist) {
            persistMemberState({ points: incoming, tier: currentMembershipTier, pointsUpdatedAt: serverTimestamp() });
          }
          updatePointsUI();
        }
        return;
      }
      const ledger = loadPointsLedger();
      const key = passId.toUpperCase();
      const entry = ledger[key] || { points: 0, venues: {} };
      const incoming = Math.max(0, points);
      const next = opts.forceLower ? incoming : Math.max(entry.points || 0, incoming);
      entry.points = next;
      entry.username = preferredUsername();
      entry.tier = currentMembershipTier || entry.tier || "standard";
      entry.email = firebaseAuth.currentUser?.email || entry.email || "";
      ledger[key] = entry;
      savePointsLedger(ledger);
      setMemberDirectoryEntry(key, { points: entry.points, venuesVisited: entry.venues, username: entry.username, tier: entry.tier, email: entry.email });
      if (entry.username && entry.email) saveUsernameMapEntry(entry.username, entry.email);
      if (!opts.skipPersist) {
        persistMemberState({ points: entry.points, tier: entry.tier, pointsUpdatedAt: serverTimestamp() });
      }
    }
    function addPoints(points, reason = "", meta = {}) {
      const code = (currentPassCode || "").toUpperCase();
      if (!code || !Number.isFinite(points) || points <= 0) return;
      if (useCloudProfile()) {
        const current = Number(memberProfile?.points) || 0;
        const next = current + points;
        const venuesVisited = { ...(memberProfile?.venuesVisited || {}) };
        if (meta.venue) {
          venuesVisited[meta.venue.toLowerCase()] = true;
        }
        memberProfile = memberProfile || {};
        memberProfile.points = next;
        memberProfile.venuesVisited = venuesVisited;
        persistMemberState({
          points: next,
          tier: currentMembershipTier,
          venuesVisited,
          pointsUpdatedAt: serverTimestamp()
        });
        updatePointsUI();
        if (reason) {
          showToast(`+${points} pts Â· ${reason}`);
        }
        return;
      }
      const ledger = loadPointsLedger();
      const entry = ledger[code] || { points: 0, venues: {} };
      entry.points += points;
      if (meta.venue) {
        entry.venues = entry.venues || {};
        entry.venues[meta.venue.toLowerCase()] = true;
      }
      entry.username = preferredUsername();
      entry.tier = currentMembershipTier || entry.tier || "standard";
      entry.email = firebaseAuth.currentUser?.email || entry.email || "";
      ledger[code] = entry;
      savePointsLedger(ledger);
      setMemberDirectoryEntry(code, { points: entry.points, venuesVisited: entry.venues, username: entry.username, name: memberProfile?.legalName || memberProfile?.name, tier: entry.tier, email: entry.email });
      if (entry.username && entry.email) saveUsernameMapEntry(entry.username, entry.email);
      persistMemberState({ points: entry.points, tier: entry.tier, pointsUpdatedAt: serverTimestamp() });
      updatePointsUI();
      if (reason) {
        showToast(`+${points} pts Â· ${reason}`);
      }
    }
    function getPointsEntry(passId) {
      const key = (passId || "").toUpperCase();
      if (useCloudProfile() && key === (currentPassCode || "").toUpperCase()) {
        return {
          points: Number(memberProfile?.points) || 0,
          venues: memberProfile?.venuesVisited || {},
          username: preferredUsername(),
          tier: currentMembershipTier || memberProfile?.tier || "standard"
        };
      }
      const ledger = loadPointsLedger();
      return ledger[key] || { points: 0, venues: {}, username: preferredUsername(), tier: currentMembershipTier || "standard" };
    }
    function pointsForRedemption(entry) {
      const perkKey = entry?.perkKey || entry?.perk || "default";
      const key = perkKey.toLowerCase();
      const base = POINT_RULES.redemption[key] || POINT_RULES.redemption.default;
      let total = base;
      if (entry?.venue) {
        const passEntry = getPointsEntry(currentPassCode);
        const visited = passEntry.venues || {};
        if (!visited[entry.venue.toLowerCase()]) {
          total += POINT_RULES.uniqueVenueBonus;
        }
      }
      return total;
    }
    function resetInMemoryCaches() {
      try {
        Object.keys(passDirectoryCache || {}).forEach(k => delete passDirectoryCache[k]);
      } catch (_) {}
    }
    function countVerifiedForPass(passCode) {
      const code = (passCode || "").toUpperCase();
      return redemptionLog.filter(e => (e.passId || "").toUpperCase() === code && (e.status === "verified" || e.status === "approved" || e.status === "confirmed")).length;
    }

    function updatePointsUI() {
      if (!pointsBalance) return;
      const code = (currentPassCode || "").toUpperCase();
      const points = getPointsForPass(code);
      pointsBalance.textContent = `${points} pts`;
      if (userUsername) {
        userUsername.textContent = `@${preferredUsername()}`;
      }
      updateQuickStrip();
    }

    function updateQuickStrip() {
      if (quickStatus && statusPill) quickStatus.textContent = statusPill.textContent || "Status";
      if (quickPoints && pointsBalance) quickPoints.textContent = pointsBalance.textContent || "0 pts";
      if (quickSpins && nightWheelRemaining) quickSpins.textContent = nightWheelRemaining.textContent || "Spins left";
    }
    function ensurePointsEntry() {
      const code = (currentPassCode || "").toUpperCase();
      if (!code) return;
      if (useCloudProfile()) {
        updatePointsUI();
        return;
      }
      const ledger = loadPointsLedger();
      const directory = loadMemberDirectory();
      const cached = directory[code] || {};
      const cloudPoints = Number.isFinite(memberProfile?.points) ? memberProfile.points : null;
      const ledgerEntry = ledger[code] || {};
      const sourcePoints = cloudPoints !== null ? cloudPoints : (Number.isFinite(ledgerEntry.points) ? ledgerEntry.points : (Number.isFinite(cached.points) ? cached.points : 0));
      const forceLower = cloudPoints !== null;
      setPointsForPass(code, sourcePoints, { skipPersist: true, forceLower });
      updatePointsUI();
    }
    function showFreeStatus(message, success = true) {
      if (!freeMemberStatus) return;
      freeMemberStatus.textContent = message;
      freeMemberStatus.style.color = success ? "#a7f3d0" : "#f97373";
      freeMemberStatus.style.display = "block";
      setTimeout(() => {
        if (freeMemberStatus) freeMemberStatus.style.display = "none";
      }, 3200);
    }

    function renderFreeMembersList(list = []) {
      if (!freeMembersList) return;
      if (!list.length) {
        freeMembersList.innerHTML = '<p style="color:#94a3b8;font-size:12px;">No free memberships issued yet.</p>';
        return;
      }
      freeMembersList.innerHTML = list.map(item => {
        const when = item.freeGrantedAt
          ? formatMST(item.freeGrantedAt)
          : "Granted";
        return `
          <div class="ceo-issued-item" style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div>
              <div class="ceo-issued-code">${item.passCode}</div>
              <div class="ceo-issued-meta">${item.name || "Member"} Â· ${when}</div>
            </div>
            <button class="btn btn-secondary" data-revoke-free="${item.passCode}" style="padding:6px 10px;">Revoke</button>
          </div>
        `;
      }).join("");
      freeMembersList.querySelectorAll("[data-revoke-free]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.revokeFree;
          setFreeMembershipForPass(id, false);
        });
      });
    }

    async function refreshFreeMembersList() {
      if (!freeMembersList) return;
      if (!isCeoAccount) {
        freeMembersList.innerHTML = '<p style="color:#94a3b8;font-size:12px;">CEO only.</p>';
        return;
      }
      freeMembersList.innerHTML = '<p style="color:#94a3b8;font-size:12px;">Loadingâ€¦</p>';
      let list = [];
      if (db) {
        try {
          await ensureFirebaseUser();
          const snap = await getDocs(query(collection(db, "members"), where("freeMembership", "==", true)));
          snap.forEach(docSnap => {
            const data = docSnap.data() || {};
            list.push({
              passCode: (data.passCode || docSnap.id || "").toUpperCase(),
              name: data.name || data.legalName || "Member",
              freeGrantedAt: data.freeGrantedAt?.toMillis ? data.freeGrantedAt.toMillis() : data.freeGrantedAt
            });
          });
        } catch (err) {
          console.warn("Failed to fetch free members from Firestore", err);
        }
      }
      if (!list.length && allowLocalCache()) {
        const directory = loadMemberDirectory();
        list = Object.values(directory)
          .filter(entry => entry.freeMembership)
          .map(entry => ({
            passCode: (entry.passCode || "").toUpperCase(),
            name: entry.name || "Member",
            freeGrantedAt: entry.freeGrantedAt
          }));
      }
      // Merge with local persistent cache (beta/local only)
      if (allowLocalCache()) {
        const locals = loadLocalFreeMembers();
        const mergedMap = {};
        [...list, ...locals].forEach(item => {
          if (!item.passCode) return;
          mergedMap[item.passCode] = mergedMap[item.passCode] || item;
        });
        const merged = Object.values(mergedMap);
        saveLocalFreeMembers(merged);
        freeMembersCache = merged;
        renderFreeMembersList(merged);
        return;
      }
      freeMembersCache = list;
      renderFreeMembersList(list);
    }

    function loadLocalFreeMembers() {
      if (!allowLocalCache()) return [];
      try {
        return JSON.parse(localStorage.getItem(FREE_MEMBERS_KEY) || "[]");
      } catch (err) {
        return [];
      }
    }
    function saveLocalFreeMembers(list) {
      if (!allowLocalCache()) return;
      localStorage.setItem(FREE_MEMBERS_KEY, JSON.stringify(list || []));
    }

    async function setFreeMembershipForPass(passId, enabled) {
      const code = (passId || "").trim().toUpperCase();
      if (!code) {
        showFreeStatus("Enter a Pass ID.", false);
        return;
      }
      let profile = null;
      let docRef = null;
      let freeDocRef = null;
      if (db) {
        try {
          const qSnap = await getDocs(query(collection(db, "members"), where("passCode", "==", code)));
          if (!qSnap.empty) {
            const docSnap = qSnap.docs[0];
            docRef = docSnap.ref;
            profile = docSnap.data() || {};
          }
          // Fallback: some profiles may store passId instead of passCode
          if (!docRef) {
            const altSnap = await getDocs(query(collection(db, "members"), where("passId", "==", code)));
            if (!altSnap.empty) {
              const docSnap = altSnap.docs[0];
              docRef = docSnap.ref;
              profile = docSnap.data() || {};
            }
          }
          freeDocRef = doc(db, "freeMemberships", code);
        } catch (err) {
          console.warn("Free membership lookup failed (continuing with local fallback):", err);
        }
      }
      if (!profile) {
        const directory = loadMemberDirectory();
        if (directory[code]) profile = directory[code];
      }
      if (!profile && code === (currentPassCode || "").toUpperCase() && memberProfile) {
        profile = { ...memberProfile };
      }
      if (!profile && !docRef) {
        showFreeStatus("Member not found.", false);
        return;
      }
      const targetTier = enabled ? "free" : (profile?.tier && profile.tier !== "free" ? profile.tier : "standard");
      const perkState = { tier: targetTier, remaining: getDefaultPerkState(targetTier) };
      const updates = enabled
        ? { freeMembership: true, revoked: false, tier: targetTier, perks: perkState, validUntil: "never", freeGrantedAt: serverTimestamp ? serverTimestamp() : new Date().toISOString() }
        : { freeMembership: false, revoked: true, tier: null, perks: null, validUntil: null };
      try {
        if (docRef) {
          await setDoc(docRef, updates, { merge: true });
        }
        if (freeDocRef) {
          await setDoc(freeDocRef, { ...updates, active: enabled, passCode: code }, { merge: true });
        }
      } catch (err) {
        console.warn("Failed to update Firestore free membership (continuing local):", err);
      }
      if (enabled) {
        const localUpdates = {
          freeMembership: true,
          revoked: false,
          tier: targetTier,
          perks: perkState,
          validUntil: "never",
          freeGrantedAt: new Date().toISOString()
        };
        setMemberDirectoryEntry(code, localUpdates);
        localStorage.setItem(`${FREE_NOTICE_PREFIX}${code}`, "1");
        localStorage.removeItem(`${FREE_REVOKED_PREFIX}${code}`);
        const locals = loadLocalFreeMembers().filter(f => f.passCode !== code);
        locals.push({ passCode: code, name: profile?.name || profile?.legalName || "Member", freeGrantedAt: localUpdates.freeGrantedAt });
        saveLocalFreeMembers(locals);
      } else {
        setMemberDirectoryEntry(code, { freeMembership: false, revoked: true, tier: null, perks: null, validUntil: null });
        localStorage.setItem(`${FREE_REVOKED_PREFIX}${code}`, "1");
        localStorage.removeItem(`${FREE_NOTICE_PREFIX}${code}`);
        const locals = loadLocalFreeMembers().filter(f => f.passCode !== code);
        saveLocalFreeMembers(locals);
      }
      if (memberProfile && (currentPassCode || "").toUpperCase() === code) {
        if (enabled) {
          memberProfile = { ...memberProfile, ...updates };
          currentMembershipTier = targetTier;
          ensurePerkState(targetTier);
          applyMembershipToPass(targetTier);
          renderRedemptionOptions();
          renderVipDealForMember();
          if (firebaseAuth.currentUser?.uid && allowLocalCache()) {
            localStorage.setItem(`membership_${firebaseAuth.currentUser.uid}`, targetTier);
          }
          // Force toast immediately for current session
          sessionStorage.removeItem(`${FREE_SEEN_PREFIX}${code}`);
          showToast("CEO issued a never-expiring membership. Unlimited perks activated.");
        } else {
          // revoke current user: clear caches and sign out
          removeMemberDirectoryEntry(code);
          localStorage.removeItem(`membership_${firebaseAuth.currentUser?.uid}`);
          localStorage.removeItem(`passcode_${firebaseAuth.currentUser?.uid}`);
          try { await signOut(firebaseAuth); } catch (err) { console.warn("Signout failed after revoke", err); }
        }
      }
      showFreeStatus(enabled ? "Free membership granted." : "Free membership revoked.", true);
      refreshFreeMembersList();
    }

    function processFreeFlags(passId) {
      const code = (passId || "").toUpperCase();
      if (!code) return;
      const revokedKey = `${FREE_REVOKED_PREFIX}${code}`;
      if (localStorage.getItem(revokedKey) || memberProfile?.revoked) {
        localStorage.removeItem(revokedKey);
        showToast("Membership revoked. Please create a new account to continue.");
        try {
          removeMemberDirectoryEntry(code);
          localStorage.removeItem(`membership_${firebaseAuth.currentUser?.uid || ""}`);
          localStorage.removeItem(`passcode_${firebaseAuth.currentUser?.uid || ""}`);
          signOut(firebaseAuth);
        } catch (err) {
          console.warn("Failed to sign out after revoke", err);
        }
        return;
      }
      const noticeKey = `${FREE_NOTICE_PREFIX}${code}`;
      const seenKey = `${FREE_SEEN_PREFIX}${code}`;
      if (isFreeMember() && (localStorage.getItem(noticeKey) || (!localStorage.getItem(seenKey) && memberProfile?.freeMembership))) {
        localStorage.removeItem(noticeKey);
        localStorage.setItem(seenKey, "1");
        showToast("CEO issued a never-expiring membership. Unlimited perks activated.");
      }
    }

    function showFreeWelcomeToast() {
      const code = (memberProfile?.passCode || currentPassCode || "").toUpperCase();
      if (!code || !isFreeMember()) return;
      const seenKey = `${FREE_SEEN_PREFIX}${code}`;
      if (sessionStorage.getItem(seenKey)) return;
      sessionStorage.setItem(seenKey, "1");
      showToast("CEO issued a never-expiring membership. Unlimited perks activated.");
    }

    if (accentChips && accentChips.length) {
      accentChips.forEach(chip => {
        chip.addEventListener("click", () => {
          const theme = chip.dataset.accent || "cyan";
          applyAccentTheme(theme);
        });
      });
    }
    if (nightWheelSpinBtn) {
      nightWheelSpinBtn.addEventListener("click", spinNightWheel);
    }
    if (editUsernameBtn) {
      editUsernameBtn.addEventListener("click", () => {
        const code = (currentPassCode || "").toUpperCase();
        if (!canChangeUsername(code)) {
          showToast(usernameChangeLimitMessage(code));
          return;
        }
        openUsernameModal();
      });
    }
    if (vibeButtons && vibeButtons.length) {
      vibeButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          const vibe = btn.dataset.vibe || "social";
          setVibe(vibe);
        });
      });
    }
    if (usernameClose) usernameClose.addEventListener("click", closeUsernameModal);
    if (usernameCancel) usernameCancel.addEventListener("click", closeUsernameModal);
    if (usernameModal) {
      usernameModal.addEventListener("click", (e) => {
        if (e.target === usernameModal) closeUsernameModal();
      });
    }
    if (usernameSave) {
      usernameSave.addEventListener("click", saveUsernameFromModal);
    }
    if (venueStars) {
      venueStars.querySelectorAll("button[data-star]").forEach(btn => {
        btn.addEventListener("click", () => {
          const stars = parseInt(btn.dataset.star, 10);
          if (!stars) return;
          const venueId = venueDetailModal?.dataset.venueId;
          submitVenueRating(venueId, stars);
        });
      });
    }
    renderVenueButtons();
    // Background selection removed; no UI controls remain for choosing background themes.

    let currentAvatarColor = AVATAR_COLORS[0];
    const AVATAR_FLAIRS = ["â˜…", "âš¡", "â™«", "ðŸ”¥", "â™¥", "ðŸ‘‘"];
    let currentAvatarFlair = "";
    function applyAvatarColor(color = AVATAR_COLORS[0], opts = {}) {
      if (!avatarInitials) return;
      const chosen = color || AVATAR_COLORS[0];
      const prev = currentAvatarColor;
      currentAvatarColor = chosen;
      avatarInitials.style.background = `radial-gradient(circle at 30% 30%, ${chosen}, #0b172a)`;
      avatarInitials.style.boxShadow = `0 0 20px ${chosen}55`;
      avatarInitials.dataset.color = chosen;
      if (allowLocalCache()) {
        localStorage.setItem(AVATAR_COLOR_KEY, chosen);
        if (currentPassCode) {
          setMemberDirectoryEntry(currentPassCode, { avatarColor: chosen });
        }
      }
      if (memberProfile) memberProfile.avatarColor = chosen;
      if (opts.persist !== false && chosen !== prev) {
        persistMemberState({ avatarColor: chosen });
      }
    }
    function applyAvatarFlair(flair = "", opts = {}) {
      if (!avatarInitials) return;
      const next = flair || "";
      const prev = currentAvatarFlair || "";
      currentAvatarFlair = next;
      avatarInitials.dataset.flair = next;
      if (currentPassCode && allowLocalCache()) {
        setMemberDirectoryEntry(currentPassCode, { avatarFlair: next });
      }
      if (memberProfile) memberProfile.avatarFlair = next;
      if (opts.persist !== false && next !== prev) {
        persistMemberState({ avatarFlair: next });
      }
      if (allowLocalCache()) {
        // ensure flair is only for this profile in directory
        const directory = loadMemberDirectory();
        const key = (currentPassCode || "").toUpperCase();
        if (key) {
          const entry = directory[key] || {};
          entry.avatarFlair = next;
          saveMemberDirectory(directory);
        }
      }
    }
    function loadAvatarColor() {
      let chosen = memberProfile?.avatarColor || AVATAR_COLORS[0];
      if (!allowLocalCache()) {
        applyAvatarColor(chosen, { persist: false });
        return;
      }
      if (currentPassCode) {
        const entry = loadMemberDirectory()[(currentPassCode || "").toUpperCase()];
        if (entry?.avatarColor) chosen = entry.avatarColor;
      } else {
        localStorage.removeItem(AVATAR_COLOR_KEY);
      }
      const cachedLocal = localStorage.getItem(AVATAR_COLOR_KEY);
      if (cachedLocal && currentPassCode) chosen = cachedLocal;
      const directory = loadMemberDirectory();
      if (currentPassCode && directory[(currentPassCode || "").toUpperCase()]?.avatarColor) {
        chosen = directory[(currentPassCode || "").toUpperCase()].avatarColor;
      }
      applyAvatarColor(chosen, { persist: false });
    }
    function loadAvatarFlair() {
      let flair = memberProfile?.avatarFlair || "";
      if (!allowLocalCache()) {
        applyAvatarFlair(flair, { persist: false });
        return;
      }
      if (currentPassCode) {
        const entry = loadMemberDirectory()[(currentPassCode || "").toUpperCase()];
        if (entry?.avatarFlair) flair = entry.avatarFlair;
      }
      applyAvatarFlair(flair, { persist: false });
      if (currentPassCode && allowLocalCache()) {
        const state = loadMemberDirectory();
        const entry = state[(currentPassCode || "").toUpperCase()] || {};
        entry.avatarFlair = flair;
        setMemberDirectoryEntry(currentPassCode, entry);
      }
    }
    if (avatarInitials) {
      avatarInitials.style.cursor = "pointer";
      avatarInitials.title = "Tap to change color and emoji";
      avatarInitials.addEventListener("click", () => {
        const idx = AVATAR_COLORS.findIndex(c => c === currentAvatarColor);
        const nextColor = AVATAR_COLORS[(idx + 1) % AVATAR_COLORS.length];
        applyAvatarColor(nextColor);
        const current = currentAvatarFlair || "";
        const input = prompt("Pick an emoji for your avatar (1 character):", current);
        if (input === null) return;
        const chosen = (input.trim() || "").slice(0, 2); // basic trim to first glyph
        applyAvatarFlair(chosen);
      });
    } else {
      localStorage.removeItem(AVATAR_COLOR_KEY);
    }
    if (userTaglineEl) {
      userTaglineEl.addEventListener("click", () => {
        const current = (memberProfile?.tagline || "").trim();
        const input = prompt("Set your tagline (60 chars max):", current || "");
        if (input === null) return;
        const trimmed = input.trim().slice(0, 60);
        if (!trimmed) {
          userTaglineEl.textContent = "Tap to add your vibe.";
          updateMemberProfile({ tagline: "" });
          setMemberDirectoryEntry(currentPassCode, { tagline: "" });
          return;
        }
        userTaglineEl.textContent = trimmed;
        updateMemberProfile({ tagline: trimmed });
        setMemberDirectoryEntry(currentPassCode, { tagline: trimmed });
      });
    }

    renderStaffVipDeal();
    renderVipDealForMember();
    pruneExpiredVipDeals();
    refreshVipDeals();
    refreshTonightAlerts();
    renderStaffAlertPreview();
    setInterval(pruneExpiredVipDeals, 60000);

    const voucherPacks = {
      standard: [
        { id: "drink", amount: 2, price: "$6.00" },
        { id: "shot", amount: 4, price: "$5.00" },
        { id: "cover", amount: 3, price: "$20.00", label: "Line access" },
      ],
      vip: [
        { id: "drink", amount: 4, price: "$10.00" },
        { id: "shot", amount: 4, price: "$5.00" },
        { id: "cover", amount: 3, price: "$15.00", label: "Line access" },
      ]
    };
    let currentPendingRedemptions = {};
    const MEMBER_DIRECTORY_KEY = "memberDirectory";
    const REVIEWS_KEY = "focoReviews";
    const ALERTS_STORAGE_KEY = "tonightAlertsCache";
    const VIP_DEALS_STORAGE_KEY = "vipDealsCache";
    const passDirectoryCache = {};
    const PASS_CACHE_TTL = 2 * 60 * 1000;
    let selectedReviewStars = 0;
    let profileBadgeState = { reviews: false, streak: false };

    function isCeoActive() {
      return ceoSession && !ceoPreviewTier;
    }

    function loadMemberDirectory() {
      if (!allowLocalCache()) return {};
      try {
        return JSON.parse(localStorage.getItem(MEMBER_DIRECTORY_KEY) || "{}");
      } catch (err) {
        return {};
      }
    }

    function saveMemberDirectory(directory) {
      if (!allowLocalCache()) return;
      localStorage.setItem(MEMBER_DIRECTORY_KEY, JSON.stringify(directory));
    }

    function setMemberDirectoryEntry(passId, data) {
      if (!passId) return null;
      if (!allowLocalCache()) {
        return { ...(data || {}), updatedAt: new Date().toISOString() };
      }
      const directory = loadMemberDirectory();
      const key = passId.toUpperCase();
      directory[key] = {
        ...(directory[key] || {}),
        ...data,
        updatedAt: new Date().toISOString(),
      };
      saveMemberDirectory(directory);
      return directory[key];
    }

    function cachePassProfile(passId, profile = {}, docId = null) {
      if (!passId) return;
      const sanitized = { ...profile };
      delete sanitized._docId;
      const stored = setMemberDirectoryEntry(passId.toUpperCase(), sanitized);
      const key = passId.toUpperCase();
      passDirectoryCache[key] = {
        profile: { ...stored },
        docId: docId || passDirectoryCache[key]?.docId || null,
        fetchedAt: Date.now(),
      };
    }

    function removeMemberDirectoryEntry(passId) {
      if (!passId) return;
      const key = passId.toUpperCase();
      if (allowLocalCache()) {
        const directory = loadMemberDirectory();
        delete directory[key];
        saveMemberDirectory(directory);
      }
      delete passDirectoryCache[key];
    }

    function loadPurchaseReceipts() {
      if (memberProfile?.purchaseReceipts) return memberProfile.purchaseReceipts;
      if (!allowLocalCache()) return [];
      try {
        return JSON.parse(localStorage.getItem(PURCHASE_RECEIPTS_KEY) || "[]");
      } catch (err) {
        return [];
      }
    }
    function savePurchaseReceipts(items) {
      if (allowLocalCache()) {
        localStorage.setItem(PURCHASE_RECEIPTS_KEY, JSON.stringify(items || []));
      }
      persistMemberState({ purchaseReceipts: items || [] });
    }
    function appendPurchaseReceipt(entry) {
      purchaseReceipts.unshift(entry);
      purchaseReceipts = purchaseReceipts.slice(0, 50);
      savePurchaseReceipts(purchaseReceipts);
      renderCeoPurchaseReceipts();
    }
    function renderCeoPurchaseReceipts(container) {
      const target = container || ceoAnalyticsContent?.querySelector("#ceoPurchaseReceipts");
      if (!target) return;
      if (!purchaseReceipts.length) {
        target.innerHTML = '<p style="color:#94a3b8;">No in-app purchase receipts yet.</p>';
        return;
      }
      target.innerHTML = purchaseReceipts.slice(0, 8).map(entry => `
        <div class="ceo-log-row">
          <strong>${entry.title}</strong>
          <div>${entry.detail}</div>
          <div style="color:#94a3b8;">${entry.method || "Card"} Â· ${formatMST(entry.timestamp)}</div>
        </div>
      `).join("");
    }

    function renderStaffReceipts() {}
    function renderStaffSentReceipts() {}
    async function refreshStaffCeoReceipts() { return; }

    async function refreshVipDeals() {
      if (!db) return;
      if (appLocked && !isCeoAccount) return;
      if (useCloudProfile()) {
        attachGlobalRealtime();
        return;
      }
      try {
        const snapshot = await getDocs(collection(db, "vipDeals"));
        applyVipDealsSnapshot(snapshot);
        saveVipDealsToStorage(vipDealsCache);
      } catch (err) {
        console.warn("Failed to fetch VIP deals:", err);
        renderVipDealForMember();
        renderStaffVipDeal();
      }
    }
    function getActiveVipDeals() {
      const now = Date.now();
      return Object.values(vipDealsCache)
        .filter(deal => {
          if (!deal.expiresAt) return true;
          const expires = deal.expiresAt.toMillis ? deal.expiresAt.toMillis() : new Date(deal.expiresAt).getTime();
          return expires > now;
        })
        .sort((a, b) => {
          const aTime = a.expiresAt?.toMillis ? a.expiresAt.toMillis() : new Date(a.expiresAt || Date.now()).getTime();
          const bTime = b.expiresAt?.toMillis ? b.expiresAt.toMillis() : new Date(b.expiresAt || Date.now()).getTime();
          return aTime - bTime;
        });
    }
    function renderVipDealForMember() {
      if (!vipMemberDeal) return;
      const isVip = hasVipAccess();
      const deals = getActiveVipDeals();
      if (!isVip || !deals.length) {
        vipMemberDeal.style.display = "none";
        vipMemberDeal.innerHTML = "";
        return;
      }
      deals.sort((a, b) => {
        const aTime = a.expiresAt?.toMillis ? a.expiresAt.toMillis() : new Date(a.expiresAt || Date.now()).getTime();
        const bTime = b.expiresAt?.toMillis ? b.expiresAt.toMillis() : new Date(b.expiresAt || Date.now()).getTime();
        return aTime - bTime;
      });
      vipMemberDeal.innerHTML = deals.map(deal => {
        const venueName = venuesInfo[deal.venueId]?.name || deal.meta || "FoCo venue";
        return `
          <div class="vip-deal-row">
            <strong>VIP â€¢ ${venueName}</strong>
            <span>${deal.title}</span>
            <span style="color:#fde68a;">${deal.detail}</span>
            ${deal.meta ? `<span style="color:#93c5fd;font-size:10px;letter-spacing:0.12em;text-transform:uppercase;">${deal.meta}</span>` : ""}
          </div>
        `;
      }).join("");
      vipMemberDeal.style.display = "";
    }

    async function refreshTonightAlerts() {
      if (!db) {
        refreshAlertsTicker();
        renderStaffAlertPreview();
        return;
      }
      if (appLocked && !isCeoAccount) return;
      if (useCloudProfile()) {
        attachGlobalRealtime();
        return;
      }
      try {
        await ensureFirebaseUser();
        const snapshot = await getDocs(collection(db, "alerts"));
        applyAlertsSnapshot(snapshot);
        saveAlertsToStorage(tonightAlerts);
      } catch (err) {
        console.warn("Failed to fetch alerts:", err);
      }
    }

    function renderStaffAlertPreview() {
      if (!alertPreview) return;
      if (!staffSession) {
        alertPreview.textContent = "Log in to post alerts for your venue.";
        if (alertTitleInput) alertTitleInput.value = "";
        if (alertDetailInput) alertDetailInput.value = "";
        if (alertMetaInput) alertMetaInput.value = "";
        if (alertExpiresInput) alertExpiresInput.value = "";
        renderStaffDealCodes();
        return;
      }
      // Auto-fill meta with current venue if empty
      const venueName = venuesInfo[staffSession.venue]?.name || "FoCo venue";
      if (alertMetaInput && !alertMetaInput.value) {
        alertMetaInput.value = venueName;
      }
      if (alertAudience && !alertAudience.value) {
        alertAudience.value = "all";
      }
      const now = Date.now();
      if (alertExpiresInput && !alertExpiresInput.value) {
        const defaultDate = new Date();
        defaultDate.setHours(23, 59, 0, 0);
        alertExpiresInput.value = toInputDateValue(defaultDate);
      }
      const venueAlerts = tonightAlerts.filter(alert =>
        alert.venueId === staffSession.venue && (!alert.expiresAt || alert.expiresAt > now)
      );
      const expired = tonightAlerts.filter(alert =>
        alert.venueId === staffSession.venue && alert.expiresAt && alert.expiresAt <= now
      );
      if (!venueAlerts.length && !expired.length) {
        alertPreview.textContent = "No alerts scheduled yet.";
        renderStaffDealCodes();
        updateStaffKpis(0, false);
        return;
      }
      const activeHtml = venueAlerts.map(alert => {
        const expires = alert.expiresAt ? formatMST(alert.expiresAt) : "No expiry";
        return `
          <div class="log-row">
            <strong>${alert.title || alert.venueName}</strong><br/>
            <span>${alert.detail || ""}</span><br/>
            <span style="color:#94a3b8;">${alert.meta || alert.venueName || ""}</span><br/>
            <span style="color:#93c5fd;font-size:11px;">Expires ${expires}</span>
            <div class="log-meta" style="margin-top:4px;">
              <button class="btn btn-secondary" data-expire-alert="${alert.id}">Expire now</button>
            </div>
          </div>
        `;
      }).join("");
      const expiredHtml = expired.map(alert => {
        const expires = alert.expiresAt ? formatMST(alert.expiresAt) : "Expired";
        return `
          <div class="log-row muted">
            <strong>${alert.title || alert.venueName}</strong><br/>
            <span style="color:#94a3b8;">${alert.meta || alert.venueName || ""}</span><br/>
            <span style="color:#93c5fd;font-size:11px;">Expired ${expires}</span>
            <div class="log-meta" style="margin-top:4px;"></div>
          </div>
        `;
      }).join("");
      alertPreview.innerHTML = `
        ${activeHtml || '<p style="color:#cbd5f5;">No active alerts.</p>'}
        ${expired.length ? `<div style="margin-top:10px;"><strong style="color:#fca5a5;">Expired</strong>${expiredHtml}</div>` : ""}
      `;
      updateStaffKpis(venueAlerts.length, !!vipDealsCache[staffSession.venue]);
    }
    function renderStaffVipDeal() {
      if (!vipDealPreview) return;
      if (!staffSession) {
        vipDealPreview.textContent = "Log in to set a VIP deal for your venue.";
        if (vipDealTitle) vipDealTitle.value = "";
        if (vipDealDetail) vipDealDetail.value = "";
        if (vipDealMeta) vipDealMeta.value = "";
        if (vipDealExpires) vipDealExpires.value = "";
        return;
      }
      const deal = vipDealsCache[staffSession.venue];
      if (!deal) {
        vipDealPreview.textContent = "No VIP deal set for this venue yet.";
        if (vipDealTitle) vipDealTitle.value = "";
        if (vipDealDetail) vipDealDetail.value = "";
        if (vipDealMeta) vipDealMeta.value = "";
        if (vipDealExpires) {
          const defaultDate = new Date();
          defaultDate.setHours(defaultDate.getHours() + 4);
          vipDealExpires.value = toInputDateValue(defaultDate);
        }
        return;
      }
      const expiresDate = deal.expiresAt?.toDate ? deal.expiresAt.toDate() : new Date(deal.expiresAt);
      const expired = expiresDate && expiresDate.getTime() <= Date.now();
      vipDealPreview.innerHTML = `
        <div class="log-row ${expired ? "muted" : ""}">
          <strong>${deal.title}</strong><br/>
          <span>${deal.detail}</span><br/>
          <span style="color:#94a3b8;">${deal.meta || deal.venueName || ""}</span><br/>
          <span style="color:#93c5fd;font-size:11px;">${expired ? "Expired" : "Expires"} ${formatMST(expiresDate)}</span>
          <div class="log-meta" style="margin-top:4px;">
            ${expired ? "" : `<button class="btn btn-secondary" data-expire-vipdeal="${staffSession.venue}">Expire now</button>`}
          </div>
        </div>
      `;
      if (vipDealTitle) vipDealTitle.value = deal.title;
      if (vipDealDetail) vipDealDetail.value = deal.detail;
      if (vipDealMeta) vipDealMeta.value = deal.meta || "";
      if (vipDealExpires && expiresDate) vipDealExpires.value = toInputDateValue(expiresDate);
    }

    async function lookupMemberProfile(passId, options = {}) {
      if (!passId) return null;
      const key = passId.toUpperCase();
      const cached = passDirectoryCache[key];
      const freshEnough = cached && (Date.now() - cached.fetchedAt < PASS_CACHE_TTL);
      if (cached && freshEnough && (!options.requireDoc || cached.docId)) {
        return { ...cached.profile, _docId: cached.docId };
      }
      if (db) {
        try {
          const q = query(collection(db, "members"), where("passCode", "==", key));
          const snapshot = await getDocs(q);
          if (!snapshot.empty) {
            const docSnap = snapshot.docs[0];
            const data = docSnap.data() || {};
            const profile = {
              ...data,
              passCode: data.passCode || key,
            };
            cachePassProfile(key, profile, docSnap.id);
            return { ...profile, _docId: docSnap.id };
          }
        } catch (err) {
          console.warn("Failed to fetch member profile from Firestore:", err);
        }
      }
      const directory = loadMemberDirectory();
      const fallback = directory[key];
      if (fallback) {
        return { ...fallback };
      }
      if (key === CEO_PASS_ID) {
        return { name: "FoCo CEO", tier: "vip", ceo: true, blackCard: true, passCode: CEO_PASS_ID };
      }
      return null;
    }

    function isBlackCardHolder(passId) {
      if (!passId) return false;
      const key = passId.toUpperCase();
      return localStorage.getItem(`issued_black_${key}`) === "true" ||
        localStorage.getItem(`issued_black_${passId}`) === "true";
    }

    function markBlackCard(passId) {
      if (!passId) return;
      localStorage.setItem(`issued_black_${passId.toUpperCase()}`, "true");
    }

    function seedCeoProfile() {
      setMemberDirectoryEntry(CEO_PASS_ID, {
        name: "FoCo CEO",
        tier: "vip",
        status: "active",
        ceo: true,
        blackCard: true,
      });
      markBlackCard(CEO_PASS_ID);
    }
    seedCeoProfile();

    function recordCurrentMemberProfile() {
      if (!currentPassCode) return;
      const passId = currentPassCode.toUpperCase();
      const tier = ceoPreviewTier || currentMembershipTier || "standard";
      const profileName = passUserName?.textContent || "FoCo Member";
      const blackCard = isCeoAccount || isBlackCardHolder(passId);
      cachePassProfile(passId, {
        name: profileName,
        tier,
        status: "active",
        ceo: isCeoAccount,
        blackCard,
        freeMembership: isFreeMember(),
      }, firebaseAuth.currentUser?.uid || memberDocRef?.id || null);
    }

    function recordExternalMemberProfile(passId, profile) {
      if (!passId) return;
      cachePassProfile(passId.toUpperCase(), profile, null);
    }

    function getPendingStorageKey(passId) {
      return passId ? `pending_${passId.toUpperCase()}` : null;
    }

    function loadPendingForPass(passId) {
      const key = getPendingStorageKey(passId);
      if (!key || useCloudProfile()) return {};
      try {
        const raw = JSON.parse(localStorage.getItem(key) || "{}");
        return raw && typeof raw === "object" ? { ...raw } : {};
      } catch (err) {
        return {};
      }
    }

    function savePendingForPass(passId, data) {
      const key = getPendingStorageKey(passId);
      if (!key) return;
      if (useCloudProfile()) return;
      localStorage.setItem(key, JSON.stringify(data || {}));
    }

    function syncPendingForCurrentPass() {
      if (!currentPassCode) {
        currentPendingRedemptions = {};
        return;
      }
      if (useCloudProfile()) {
        const pass = currentPassCode.toUpperCase();
        const pending = {};
        redemptionLog.forEach(entry => {
          if ((entry.passId || "").toUpperCase() !== pass) return;
          if (entry.status !== "pending") return;
          const key = entry.venuePerkId || entry.perkKey;
          if (!key) return;
          pending[key] = (pending[key] || 0) + 1;
        });
        currentPendingRedemptions = pending;
        return;
      }
      currentPendingRedemptions = loadPendingForPass(currentPassCode);
    }

    function adjustPendingForPass(passId, perkId, delta) {
      if (!passId || !perkId) return {};
      if (useCloudProfile()) {
        if (typeof currentPendingRedemptions[perkId] !== "number") {
          currentPendingRedemptions[perkId] = 0;
        }
        currentPendingRedemptions[perkId] = Math.max(0, currentPendingRedemptions[perkId] + delta);
        if (currentPassCode && passId.toUpperCase() === currentPassCode.toUpperCase()) {
          renderRedemptionOptions();
        }
        return currentPendingRedemptions;
      }
      const pending = loadPendingForPass(passId);
      if (typeof pending[perkId] !== "number") pending[perkId] = 0;
      pending[perkId] = Math.max(0, pending[perkId] + delta);
      savePendingForPass(passId, pending);
      if (currentPassCode && passId.toUpperCase() === currentPassCode.toUpperCase()) {
        currentPendingRedemptions = pending;
        renderRedemptionOptions();
      }
      return pending;
    }

    function incrementPendingForCurrent(perkId) {
      if (!currentPassCode || !perkId) return;
      currentPendingRedemptions = adjustPendingForPass(currentPassCode, perkId, 1);
    }

    function decrementPendingForPass(passId, perkId) {
      if (!passId || !perkId) return;
      adjustPendingForPass(passId, perkId, -1);
    }

    function getDefaultPerkState(tier) {
      const template = perkDefaults[tier] || {};
      return Object.keys(template).reduce((acc, key) => {
        acc[key] = template[key];
        return acc;
      }, {});
    }
    function clampPerkRemaining(tier, stored) {
      const defaults = getDefaultPerkState(tier);
      Object.keys(defaults).forEach(id => {
        const limit = defaults[id];
        const value = Number(stored.remaining[id]);
        if (!Number.isFinite(value) || value < 0) {
          stored.remaining[id] = limit;
        } else {
          stored.remaining[id] = Math.min(value, limit);
        }
      });
    }

    function ensurePerkState(tier) {
      const defaults = getDefaultPerkState(tier);
      if (memberProfile && memberProfile.perks) {
        currentPerkState = memberProfile.perks;
        clampPerkRemaining(tier, currentPerkState);
        return;
      }
      if (betaPassMode) {
        let stored = null;
        try {
          stored = JSON.parse(localStorage.getItem("perks_beta"));
        } catch (err) {
          stored = null;
        }
        if (!stored || stored.tier !== tier) {
          stored = { tier, remaining: { ...defaults } };
        } else {
          clampPerkRemaining(tier, stored);
        }
        currentPerkState = stored;
        localStorage.setItem("perks_beta", JSON.stringify(stored));
        return;
      }
      currentPerkState = { tier, remaining: { ...defaults } };
      if (memberProfile) {
        memberProfile.perks = currentPerkState;
      }
    }

    function snapshotPerksFromProfile(profile) {
      const tier = profile?.perks?.tier || profile?.tier || "standard";
      const defaults = getDefaultPerkState(tier);
      const storedRemaining = profile?.perks?.remaining || profile?.perks || {};
      const normalized = { ...defaults };
      Object.keys(normalized).forEach(key => {
        const value = Number(storedRemaining[key]);
        if (Number.isFinite(value) && value >= 0) {
          normalized[key] = value;
        }
      });
      return { tier, remaining: normalized };
    }

    async function decrementFirestorePerkBalance(profile, perkId, passCode) {
      if (!db || !profile?._docId) return;
      try {
        const perksSnapshot = snapshotPerksFromProfile(profile);
        const extras = sanitizeExtraVouchers(profile.extraVouchers || {}, { allowUnlimited: false });
        let changed = false;
        if ((perksSnapshot.remaining[perkId] || 0) > 0) {
          perksSnapshot.remaining[perkId] -= 1;
          changed = true;
        } else if ((extras[perkId] || 0) > 0) {
          extras[perkId] -= 1;
          changed = true;
        }
        if (!changed) return;
        const ref = doc(db, "members", profile._docId);
        await setDoc(ref, {
          perks: perksSnapshot,
          extraVouchers: extras,
          updatedAt: serverTimestamp(),
        }, { merge: true });
        cachePassProfile(passCode || profile.passCode, {
          ...profile,
          perks: perksSnapshot,
          extraVouchers: extras,
        }, profile._docId);
      } catch (err) {
        console.warn("Failed to decrement Firestore perk balance:", err);
      }
    }

    function savePerkState() {
      if (!currentPerkState) return;
      if (memberProfile && firebaseAuth.currentUser) {
        updateMemberProfile({ perks: currentPerkState });
        persistMemberState({ perks: currentPerkState });
      } else if (betaPassMode) {
        localStorage.setItem("perks_beta", JSON.stringify(currentPerkState));
      }
    }

    function getTierQtyForPerk(perk, tierKey) {
      if (!perk || !tierKey) return 0;
      if (tierKey === "vip") return parsePerkQuantity(perk.vipQty) || 0;
      if (tierKey === "standard") return parsePerkQuantity(perk.standardQty) || 0;
      if (tierKey === "ceo" || tierKey === "free") return Infinity;
      return 0;
    }

    function getVenuePerkUsage(perkId, passId, venueId) {
      if (!perkId || !passId) return { pending: 0, verified: 0, total: 0 };
      const pass = String(passId).toUpperCase();
      let pending = 0;
      let verified = 0;
      redemptionLog.forEach(entry => {
        if ((entry.passId || "").toUpperCase() !== pass) return;
        const entryPerkId = entry.venuePerkId || entry.perkKey;
        if (!entryPerkId || entryPerkId !== perkId) return;
        const entryVenue = entry.requestedVenue || entry.venue || null;
        if (venueId && entryVenue && entryVenue !== venueId) return;
        if (entry.status === "pending") pending += 1;
        if (entry.status === "verified") verified += 1;
      });
      if (currentPassCode && pass === currentPassCode.toUpperCase()) {
        const localPending = currentPendingRedemptions[perkId] || 0;
        if (localPending > pending) pending = localPending;
      }
      return { pending, verified, total: pending + verified };
    }

    function getRemainingFor(perkId) {
      if (isCeoActive() || isFreeMember()) return 999;
      const venueId = redeemVenueSelect ? redeemVenueSelect.value : selectedRedeemVenue;
      const tier = normalizeTierKey(currentMembershipTier)
        || normalizeTierKey(memberProfile?.tier)
        || null;
      if (venueId && perkId && tier) {
        const config = getVenuePerksForVenue(venueId);
        const perk = config.find(item => item.id === perkId);
        if (perk) {
          const qty = getTierQtyForPerk(perk, tier);
          if (!qty) return 0;
          const passId = (currentPassCode || memberProfile?.passCode || "").toUpperCase();
          const usage = getVenuePerkUsage(perkId, passId, venueId);
          return Math.max(0, qty - usage.total);
        }
      }
      const base = currentPerkState?.remaining?.[perkId] ?? 0;
      const pending = currentPendingRedemptions[perkId] || 0;
      return Math.max(0, base + (extraVouchers[perkId] || 0) - pending);
    }

    function adjustExtraVouchers(perkId, delta) {
      if (typeof extraVouchers[perkId] !== "number") extraVouchers[perkId] = 0;
      extraVouchers[perkId] = Math.max(0, extraVouchers[perkId] + delta);
      if (!isCeoActive() && !isFreeMember()) {
        extraVouchers[perkId] = Math.min(extraVouchers[perkId], 50);
      }
      updateExtraVoucherUI();
      saveExtraVouchers();
    }

    function saveExtraVouchers() {
      if (memberProfile && firebaseAuth.currentUser) {
        memberProfile.extraVouchers = { ...extraVouchers };
        updateMemberProfile({ extraVouchers: memberProfile.extraVouchers });
        persistMemberState({ extraVouchers: memberProfile.extraVouchers });
      }
      if (betaPassMode) {
        localStorage.setItem("extra_beta", JSON.stringify(extraVouchers));
        localStorage.setItem("extraVersion_beta", EXTRA_VERSION);
      }
    }

    function loadExtraVouchers() {
      if (memberProfile?.extraVouchers) {
        extraVouchers = sanitizeExtraVouchers(memberProfile.extraVouchers, { allowUnlimited: isCeoActive() });
      } else if (betaPassMode) {
        const version = localStorage.getItem("extraVersion_beta");
        if (version !== EXTRA_VERSION) {
          extraVouchers = { ...EXTRA_DEFAULTS };
          saveExtraVouchers();
        } else {
          try {
            const parsed = JSON.parse(localStorage.getItem("extra_beta") || "null");
            extraVouchers = sanitizeExtraVouchers(parsed);
          } catch (err) {
            extraVouchers = { ...EXTRA_DEFAULTS };
            saveExtraVouchers();
          }
        }
      } else {
        extraVouchers = { ...EXTRA_DEFAULTS };
      }
      updateExtraVoucherUI();
      if (currentMembershipTier) {
        renderRedemptionOptions();
      }
      updateExpiryDisplay();
    }

    function updateExtraVoucherUI() {
      if (buyDrinksBtn) {
        buyDrinksBtn.textContent = "Add more vouchers";
      }
    }
    function updateExpiryDisplay() {
      if (!expiryText) return;
      const code = currentPassCode;
      const hasBlackCard = isCeoAccount || (code ? isBlackCardHolder(code) : false);
      if (hasBlackCard || isFreeMember() || memberProfile?.validUntil === "never") {
        expiryText.textContent = "Never expires";
        return;
      }
      const uid = firebaseAuth.currentUser?.uid;
      const billing = uid ? loadBilling(uid) : {};
      const now = new Date();
      let validUntil = null;
      if (billing?.nextRenewal) {
        validUntil = new Date(billing.nextRenewal);
      } else if (memberProfile?.validUntil) {
        validUntil = new Date(memberProfile.validUntil);
      } else if (memberProfile?.memberSince) {
        validUntil = oneMonthFrom(new Date(memberProfile.memberSince));
      } else {
        validUntil = oneMonthFrom(now);
      }
      if (!validUntil || Number.isNaN(validUntil.getTime()) || validUntil < now) {
        validUntil = oneMonthFrom(now);
      }
      const iso = validUntil.toISOString();
      memberProfile = memberProfile || {};
      memberProfile.validUntil = iso;
      if (code) {
        setMemberDirectoryEntry(code, { validUntil: iso });
      }
      if (uid) {
        const bill = loadBilling(uid) || {};
        bill.nextRenewal = iso;
        saveBilling(uid, bill);
      }
      expiryText.textContent = validUntil.toLocaleDateString("en-US", {
        month: "short",
        day: "numeric",
        year: "numeric"
      });
    }

    function grantMemberVouchers(passId, perkId, amount) {
      const normalized = passId?.trim().toUpperCase();
      if (!normalized || !EXTRA_DEFAULTS.hasOwnProperty(perkId) || amount <= 0) {
        return false;
      }
      const entry = setMemberDirectoryEntry(normalized, {});
      const extras = sanitizeExtraVouchers(entry.extraVouchers || {}, { allowUnlimited: true });
      extras[perkId] = (extras[perkId] || 0) + amount;
      setMemberDirectoryEntry(normalized, { extraVouchers: extras });
      if ((currentPassCode || "").toUpperCase() === normalized) {
        extraVouchers = sanitizeExtraVouchers(extras, { allowUnlimited: isCeoActive() });
        renderRedemptionOptions();
        saveExtraVouchers();
      }
      return true;
    }

    function ensurePassCode() {
      const user = firebaseAuth.currentUser;
      if (isCeoAccount) {
        currentPassCode = CEO_PASS_ID;
        return;
      }
      if (memberProfile?.passCode) {
        currentPassCode = memberProfile.passCode;
        persistLocalPassCode(currentPassCode);
        return;
      }
      if (!betaPassMode && user && allowLocalCache()) {
        const stored = localStorage.getItem(`passcode_${user.uid}`);
        if (stored) {
          currentPassCode = stored;
          return;
        }
      }
      if (betaPassMode) {
        const existing = localStorage.getItem("passcode_beta");
        if (existing) {
          currentPassCode = existing;
          return;
        }
      }
      currentPassCode = generateRedemptionCode();
      if (memberProfile && user) {
        updateMemberProfile({ passCode: currentPassCode });
      }
      if (betaPassMode) {
        localStorage.setItem("passcode_beta", currentPassCode);
      } else if (user && allowLocalCache()) {
        localStorage.setItem(`passcode_${user.uid}`, currentPassCode);
      }
    }

    function stopStaffRedemptionListener() {
      staffRedemptionUnsubs.forEach(unsub => {
        try { if (typeof unsub === "function") unsub(); } catch (_) { /* ignore */ }
      });
      staffRedemptionUnsubs = [];
    }
    function startStaffRedemptionListener(venueId) {
      stopStaffRedemptionListener();
      if (!db || !venueId) return;
      let venueEntries = [];
      let requestedEntries = [];
      const toIso = (ts) => {
        if (!ts) return new Date().toISOString();
        if (ts.toDate) return ts.toDate().toISOString();
        return new Date(ts).toISOString();
      };
      const mapEntries = (snap) => snap.docs.map(docSnap => {
        const data = docSnap.data() || {};
        return {
          code: (data.code || docSnap.id || "").toUpperCase(),
          perk: data.perk || data.perkKey || "Perk",
          perkKey: data.perkKey || null,
          venuePerkId: data.venuePerkId || null,
          venuePerkLabel: data.venuePerkLabel || null,
          member: data.member || "FoCo member",
          passId: (data.passId || "").toUpperCase(),
          venue: data.venue || null,
          requestedVenue: data.requestedVenue || null,
          ceo: !!data.ceo,
          status: data.status || "pending",
          timestamp: toIso(data.timestamp),
          verifiedAt: toIso(data.verifiedAt || data.timestamp),
        };
      }).filter(entry => entry.code);
      const mergeAndRender = () => {
        const byCode = {};
        [...venueEntries, ...requestedEntries].forEach(entry => {
          const key = entry.code.toUpperCase();
          const existing = byCode[key];
          if (!existing) {
            byCode[key] = entry;
            return;
          }
          if (existing.status !== "verified" && entry.status === "verified") {
            byCode[key] = entry;
            return;
          }
          if (entry.verifiedAt && !existing.verifiedAt) {
            byCode[key] = entry;
          }
        });
        redemptionLog = Object.values(byCode).sort((a, b) => {
          return new Date(b.timestamp || b.verifiedAt || 0) - new Date(a.timestamp || a.verifiedAt || 0);
        });
        renderStaffVenueLog();
        updateStaffRadar();
      };
      try {
        const qVenue = query(
          collection(db, "redemptions"),
          where("venue", "==", venueId),
          orderBy("timestamp", "desc"),
          limit(200)
        );
        staffRedemptionUnsubs.push(onSnapshot(qVenue, (snap) => {
          venueEntries = mapEntries(snap);
          mergeAndRender();
        }, (err) => {
          console.warn("Staff redemptions listener failed", err);
        }));
      } catch (err) {
        console.warn("Staff redemptions listener failed", err);
      }
      try {
        const qRequested = query(
          collection(db, "redemptions"),
          where("requestedVenue", "==", venueId),
          orderBy("timestamp", "desc"),
          limit(200)
        );
        staffRedemptionUnsubs.push(onSnapshot(qRequested, (snap) => {
          requestedEntries = mapEntries(snap);
          mergeAndRender();
        }, (err) => {
          console.warn("Staff requested redemptions listener failed", err);
        }));
      } catch (err) {
        console.warn("Staff requested redemptions listener failed", err);
      }
    }

    async function performBetaReset(options = {}) {
      if (!db) throw new Error("No database");
      await ensureFirebaseUser();
      const user = firebaseAuth.currentUser;
      const email = (user?.email || "").toLowerCase();
      const isCeoUser = isCeoActive() || email === "ceo@gmail.com" || (currentPassCode || "").toUpperCase() === CEO_PASS_ID;
      if (!isCeoUser) throw new Error("CEO only");

      const opts = {
        members: options.members !== false,
        redemptions: options.redemptions !== false,
        alerts: options.alerts !== false,
        vipDeals: options.vipDeals !== false,
        closeouts: options.closeouts !== false,
        freeMemberships: options.freeMemberships !== false,
        anonUsers: options.anonUsers === true
      };

      // Helper: archive redemptions instead of delete (client delete not allowed by rules)
      async function archiveRedemptions() {
        if (!opts.redemptions) return;
        try {
          const snap = await getDocs(collection(db, "redemptions"));
          for (const docSnap of snap.docs) {
            try {
              await updateDoc(docSnap.ref, { betaArchived: true });
            } catch (err) {
              console.warn("Archive redemption failed", docSnap.id, err);
            }
          }
        } catch (err) {
          console.warn("Archive redemptions snapshot failed", err);
        }
      }

      async function deleteAllInCollection(name) {
        if ((name === "vipDeals" && !opts.vipDeals) ||
            (name === "alerts" && !opts.alerts) ||
            (name === "closeOutReports" && !opts.closeouts)) {
          return;
        }
        try {
          const snap = await getDocs(collection(db, name));
          for (const docSnap of snap.docs) {
            try {
              await deleteDoc(docSnap.ref);
            } catch (err) {
              console.warn(`Delete ${name}/${docSnap.id} failed`, err);
            }
          }
        } catch (err) {
          console.warn(`Delete collection ${name} failed`, err);
        }
      }

      async function resetMembers() {
        if (!opts.members) return;
        try {
          const snap = await getDocs(collection(db, "members"));
          for (const docSnap of snap.docs) {
            const data = docSnap.data() || {};
            const isCeo = data.ceo === true ||
              (data.passCode || "").toUpperCase() === CEO_PASS_ID ||
              (data.email || "").toLowerCase() === "ceo@gmail.com" ||
              docSnap.id === user?.uid;
            if (isCeo) continue;
            const resetPayload = {
              points: 0,
              tier: "standard",
              freeMembership: false,
              extraVouchers: {},
              rewards: {},
              badges: {},
              streak: 0,
              totalSavings: 0,
              venuesVisited: 0,
              redemptions: 0,
              nightWheel: { spinsLeft: 1, lastSpin: null },
              vibe: null,
              accent: null,
              memberSince: new Date().toISOString()
            };
            try {
              await updateDoc(docSnap.ref, resetPayload);
            } catch (err) {
              console.warn("Reset member failed", docSnap.id, err);
            }
          }
        } catch (err) {
          console.warn("Reset members snapshot failed", err);
        }
      }

      async function resetFreeMemberships() {
        if (!opts.freeMemberships) return;
        try {
          const snap = await getDocs(collection(db, "freeMemberships"));
          for (const docSnap of snap.docs) {
            const id = docSnap.id.toUpperCase();
            if (id === CEO_PASS_ID) continue;
            try {
              await deleteDoc(docSnap.ref);
            } catch (err) {
              console.warn("Delete freeMembership failed", docSnap.id, err);
            }
          }
        } catch (err) {
          console.warn("Reset free memberships failed", err);
        }
      }

      async function purgeAnonymousAccounts() {
        if (!opts.anonUsers) return;
        if (!functionsClient) {
          throw new Error("Functions client unavailable");
        }
        const callable = httpsCallable(functionsClient, "purgeAnonymousUsers");
        await callable({ limit: 1000 });
      }

      // Execute in sequence to reduce load on Firestore
      await archiveRedemptions();
      await deleteAllInCollection("vipDeals");
      await deleteAllInCollection("alerts");
      await deleteAllInCollection("closeOutReports");
      await resetFreeMemberships();
      await purgeAnonymousAccounts();
      await resetMembers();

      // Local/cache cleanup
      redemptionLog = [];
      saveRedemptionLog();
      clearGlobalRealtime();
      clearPassRealtime();
      localStorage.clear();
      sessionStorage.clear();
      applyStatsToUi({ total: 0, venuesVisited: 0, avg: 0 });
    }

    function sanitizeExtraVouchers(source, options = {}) {
      const allowUnlimited = Boolean(options.allowUnlimited);
      const result = { ...EXTRA_DEFAULTS };
      Object.keys(result).forEach(key => {
        const value = Number(source?.[key]);
        if (!Number.isFinite(value) || value < 0) {
          result[key] = 0;
        } else if (allowUnlimited) {
          result[key] = value;
        } else {
          result[key] = Math.min(value, 50);
        }
      });
      return result;
    }

    function applyExternalBonuses() {
      if (!currentPassCode) return;
      const drinkKey = `bonus_drink_${currentPassCode}`;
      const shotKey = `bonus_shot_${currentPassCode}`;
      const drinkBonus = parseInt(localStorage.getItem(drinkKey) || "0", 10);
      const shotBonus = parseInt(localStorage.getItem(shotKey) || "0", 10);
      if (drinkBonus > 0 || shotBonus > 0) {
        if (drinkBonus > 0) {
          extraVouchers.drink = Math.min((extraVouchers.drink || 0) + drinkBonus, isCeoActive() ? 999 : 50);
          localStorage.removeItem(drinkKey);
        }
        if (shotBonus > 0) {
          extraVouchers.shot = Math.min((extraVouchers.shot || 0) + shotBonus, isCeoActive() ? 999 : 50);
          localStorage.removeItem(shotKey);
        }
        saveExtraVouchers();
        renderRedemptionOptions();
      }
    }

    function updatePassCodeDisplay() {
      ensurePassCode();
      syncPendingForCurrentPass();
      if (passCodeText && currentPassCode) {
        passCodeText.textContent = `Pass ID: ${currentPassCode}`;
      }
      if (passIdTop && currentPassCode) {
        passIdTop.textContent = `Pass ID: ${currentPassCode}`;
      }
      updatePulseBand();
      if (passQrImage && currentPassCode) {
        const baseOrigin = window.location.origin && window.location.origin.startsWith("http")
          ? window.location.origin
          : "https://foco-after-dark.web.app";
        const verifyUrl = `${baseOrigin}?verify=${encodeURIComponent(currentPassCode)}`;
        passQrImage.src = `https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${encodeURIComponent(verifyUrl)}`;
        passQrImage.alt = `FoCo After Dark pass ${currentPassCode}`;
        setOfflineReadyStatus(true, "QR cached for instant scans.");
      }
      applyExternalBonuses();
      updateExpiryDisplay();
      recordCurrentMemberProfile();
    }
    function ensureCeoCardCode() {
      return CEO_PASS_ID;
    }


    function renderRedemptionOptions() {
      const tier = normalizeTierKey(currentMembershipTier)
        || normalizeTierKey(memberProfile?.tier)
        || (isCeoActive() ? "ceo" : (isFreeMember() ? "free" : null))
        || (firebaseAuth.currentUser ? "standard" : null);
      if (!tier) {
        if (creditInfo) creditInfo.textContent = "Select a membership to redeem perks.";
        if (redemptionOptionsGrid) redemptionOptionsGrid.innerHTML = "";
        if (redeemVoucherBalance) redeemVoucherBalance.textContent = "";
        if (voucherBalanceNote) voucherBalanceNote.textContent = "";
        return;
      }
      if (!redemptionOptionsGrid) return;
      const voucherBalance = getVoucherBalanceForTier(tier);
      updateVoucherBalanceUI();
      if (!voucherBalance.unlimited && voucherBalance.remaining <= 0) {
        redemptionOptionsGrid.innerHTML = "";
        selectedPerkId = null;
        selectedVenuePerkId = null;
        selectedPerkLabel = null;
        creditInfo.textContent = VOUCHER_LIMIT_MESSAGE;
        return;
      }
      const ceoActive = isCeoActive();
      const freeActive = isFreeMember();
      const unlimitedAccess = ceoActive || freeActive;
      const venueId = redeemVenueSelect ? redeemVenueSelect.value : selectedRedeemVenue;
      if (!venueId) {
        redemptionOptionsGrid.innerHTML = "";
        selectedPerkId = null;
        selectedVenuePerkId = null;
        selectedPerkLabel = null;
        creditInfo.textContent = "Select a venue to see available perks.";
        return;
      }
      const config = getVenuePerksForVenue(venueId);
      if (!config.length) {
        redemptionOptionsGrid.innerHTML = "";
        selectedPerkId = null;
        selectedVenuePerkId = null;
        selectedPerkLabel = null;
        creditInfo.textContent = "No perks available for this venue yet.";
        return;
      }
      const perksForTier = unlimitedAccess
        ? config
        : config.filter(perk => getTierQtyForPerk(perk, tier) > 0);
      if (!perksForTier.length) {
        redemptionOptionsGrid.innerHTML = "";
        selectedPerkId = null;
        selectedVenuePerkId = null;
        selectedPerkLabel = null;
        creditInfo.textContent = "No perks available for your membership tier yet.";
        return;
      }
      const passId = (currentPassCode || memberProfile?.passCode || "").toUpperCase();
      redemptionOptionsGrid.innerHTML = perksForTier.map(perk => {
        const usage = getVenuePerkUsage(perk.id, passId, venueId);
        const tierQty = getTierQtyForPerk(perk, tier);
        const remaining = unlimitedAccess ? Infinity : Math.max(0, tierQty - usage.total);
        const disabled = unlimitedAccess ? "" : (remaining <= 0 ? "disabled" : "");
        const displayLabel = perk.label;
        return `
          <button type="button" class="perk-option ${disabled}" data-perk="${perk.id}" data-label="${displayLabel}" data-venue-perk="${perk.id}">
            <span class="perk-label">${displayLabel}</span>
            <span class="perk-remaining">${unlimitedAccess ? "Unlimited" : `${remaining} left`}</span>
          </button>
        `;
      }).join("\n");
      selectedPerkId = null;
      selectedVenuePerkId = null;
      selectedPerkLabel = null;
      const guidance = unlimitedAccess ? "Unlimited perks available. Select a venue perk to redeem." : "Select a venue perk to redeem.";
      creditInfo.textContent = guidance;
    }

    let pendingVoucherPack = null;

    function openVoucherModal() {
      if (!voucherModal || !voucherOptions) return;
      pendingVoucherPack = null;
      if (voucherPaymentForm) voucherPaymentForm.reset();
      resetVoucherPaymentState();
      voucherStepPayment.style.display = "none";
      voucherStepPacks.style.display = "block";
      const packs = voucherPacks[currentMembershipTier] || [];
      voucherOptions.innerHTML = packs.map(pack => {
        let label = "";
        if (pack.id === "drink") {
          label = `+${pack.amount} drink perk vouchers`;
        } else if (pack.id === "shot") {
          label = `+${pack.amount} shot perk vouchers`;
        } else if (pack.id === "cover") {
          label = `+${pack.amount} ${pack.label || "Line access"} vouchers`;
        } else {
          label = `+${pack.amount} ${pack.id} vouchers`;
        }
        return `
        <div class="perk-row" style="justify-content:space-between;background:rgba(15,23,42,0.8);padding:10px;border-radius:12px;border:1px solid rgba(148,163,184,0.3);margin-bottom:8px;">
          <div style="text-align:left;">
            <strong style="display:block;font-size:13px;">${label}</strong>
            <span style="font-size:12px;color:#9ca3af;">${pack.price}</span>
          </div>
          <button class="btn btn-primary" type="button" data-perk="${pack.id}" data-amount="${pack.amount}" data-price="${pack.price}" style="width:auto;padding:6px 12px;font-size:11px;">
            Purchase
          </button>
        </div>
      `;
      }).join("\n") || "<p style='color:#94a3b8;'>No add-ons available.</p>";
      voucherModal.classList.add("active");
      voucherOptions.querySelectorAll("button[data-perk]").forEach(btn => {
        btn.addEventListener("click", () => {
          const packId = btn.dataset.perk;
          const packMeta = packs.find(p => p.id === packId) || {};
          pendingVoucherPack = {
            id: packId,
            perk: packId,
            amount: parseInt(btn.dataset.amount, 10),
            price: btn.dataset.price,
            label: packMeta.label || packId
          };
          const packLabel = pendingVoucherPack.label || pendingVoucherPack.perk;
          voucherPaymentTitle.textContent = `Add ${pendingVoucherPack.amount} ${packLabel} vouchers`;
          voucherPaymentCopy.textContent = `We'll charge ${pendingVoucherPack.price}. Securely handled by Stripe.`;
          voucherStepPacks.style.display = "none";
          voucherStepPayment.style.display = "block";
          prepareVoucherPayment(pendingVoucherPack);
        });
      });
    }

    function loadRedemptionLog() {
      if (useCloudProfile()) {
        redemptionLog = [];
        refreshMemberStats();
        return;
      }
      try {
        redemptionLog = JSON.parse(localStorage.getItem("redemptionLog") || "[]");
      } catch (err) {
        redemptionLog = [];
      }
      if (memberProfile?.redemptionBackup) {
        redemptionLog = memberProfile.redemptionBackup.concat(redemptionLog || []);
      }
      refreshMemberStats();
    }
    function loadCloseOutReports() {
      if (useCloudProfile()) {
        if (isCeoAccount) {
          attachCloseOutReportsRealtime();
        } else {
          closeOutReports = Array.isArray(memberProfile?.closeOutReports)
            ? memberProfile.closeOutReports
            : [];
          renderCeoCloseOutReports();
        }
        return;
      }
      try {
        closeOutReports = JSON.parse(localStorage.getItem(CLOSE_OUT_KEY) || "[]");
      } catch (err) {
        closeOutReports = [];
      }
      if (memberProfile?.closeOutReports) {
        closeOutReports = memberProfile.closeOutReports;
      }
      renderCeoCloseOutReports();
    }
    function saveCloseOutReports() {
      if (allowLocalCache()) {
        localStorage.setItem(CLOSE_OUT_KEY, JSON.stringify(closeOutReports.slice(0, 200)));
      }
      persistMemberState({ closeOutReports: closeOutReports.slice(0, 200) });
      renderCeoCloseOutReports();
    }
    function loadAutoCloseOutState() {
      if (useCloudProfile()) {
        return memberProfile?.autoCloseOut || {};
      }
      try {
        return JSON.parse(localStorage.getItem(AUTO_CLOSE_OUT_KEY) || "{}");
      } catch (err) {
        return {};
      }
    }
    function saveAutoCloseOutState(state) {
      if (allowLocalCache()) {
        localStorage.setItem(AUTO_CLOSE_OUT_KEY, JSON.stringify(state || {}));
      }
      persistMemberState({ autoCloseOut: state || {} });
    }
    function hasSentAutoCloseOutToday(venueId) {
      if (!venueId) return false;
      const state = loadAutoCloseOutState();
      const today = new Date().toISOString().slice(0, 10);
      return state[venueId] === today;
    }
    function markAutoCloseOutSent(venueId) {
      if (!venueId) return;
      const state = loadAutoCloseOutState();
      const today = new Date().toISOString().slice(0, 10);
      state[venueId] = today;
      saveAutoCloseOutState(state);
    }
    function msUntilNext3am() {
      const now = new Date();
      const target = new Date();
      target.setHours(3, 0, 0, 0);
      if (target <= now) {
        target.setDate(target.getDate() + 1);
      }
      return target.getTime() - now.getTime();
    }
    async function attemptAutoCloseOut() {
      if (!staffSession) return;
      const venueId = staffSession.venue;
      if (hasSentAutoCloseOutToday(venueId)) return;
      let report = buildCloseOutReport();
      if (!report) {
        const venueName = venuesInfo[venueId]?.name || venueId || "Venue";
        report = {
          id: `auto-close-${venueId}-${Date.now()}`,
          venue: venueId,
          venueName,
          generatedAt: new Date().toISOString(),
          range: "today",
          totals: { verified: 0, pending: 0, uniqueMembers: 0, byPerk: {} },
          items: []
        };
      }
      const sent = await sendCloseOutEmail(report);
      persistCloseOutReport(report);
      renderCeoCloseOutReports();
      if (sent) {
        markAutoCloseOutSent(venueId);
      }
    }
    function scheduleAutoCloseOut() {
      if (autoCloseOutTimer) {
        clearTimeout(autoCloseOutTimer);
      }
      autoCloseOutTimer = setTimeout(async () => {
        try {
          await attemptAutoCloseOut();
        } finally {
          scheduleAutoCloseOut();
        }
      }, msUntilNext3am());
    }
    function loadCeoGeneratedCodes() {
      try {
        ceoGeneratedCodes = JSON.parse(localStorage.getItem("ceoGeneratedCodes") || "[]");
      } catch (err) {
        ceoGeneratedCodes = [];
      }
    }
    function saveCeoGeneratedCodes() {
      localStorage.setItem("ceoGeneratedCodes", JSON.stringify(ceoGeneratedCodes.slice(0, 100)));
    }
    loadCeoGeneratedCodes();
    // Render any persisted CEO codes into the UI container
    setTimeout(() => {
      try { renderCeoIssued(); } catch (e) { /* ignore if DOM not ready */ }
    }, 60);

    function saveRedemptionLog() {
      if (useCloudProfile()) return;
      localStorage.setItem("redemptionLog", JSON.stringify(redemptionLog.slice(0, 50)));
      persistMemberState({ redemptionBackup: redemptionLog.slice(0, 50) });
    }

    function addRedemptionLogEntry(entry, opts = {}) {
      redemptionLog.unshift(entry);
      saveRedemptionLog();
      renderStaffVenueLog();
      renderCeoRedemptionLog();
      renderCeoVerifiedVenueLog();
      renderCeoVenueLog();
      refreshMemberStats();
      updateRedeemAwaitState();
      if (!opts.skipSync) {
        syncRedemptionToCloud(entry);
      }
      const pts = pointsForRedemption(entry);
      addPoints(pts, "Redemption", { venue: (entry.venue || "").toLowerCase() });
      const passCode = (entry.passId || currentPassCode || "").toUpperCase();
      if (passCode) {
        const vouchersUsed = countVerifiedForPass(passCode);
        setMemberDirectoryEntry(passCode, {
          vouchersUsed,
          lastCheckin: {
            venue: entry.venue || "Venue",
            perk: entry.perk || entry.perkKey || "Perk",
            timestamp: entry.timestamp || new Date().toISOString(),
            vibe: memberProfile?.vibe || currentVibe || "social"
          }
        });
      }
    }

    function radarStatusLabel(count, hotCount) {
      if (count === 0) return "Calm radar";
      if (count <= 2) return hotCount ? "Warm buzz" : "Quiet glow";
      if (count <= 4) return "Vibe rising";
      if (count <= 7) return "Bar is buzzing";
      if (count <= 10) return "Floor in surge";
      return "Electric rush";
    }

    function updateStaffRadar() {
      if (!staffRadarCount && !staffRadarMood && !radarPings && !radarList) return;
      if (!staffSession) {
        if (staffRadarCount) staffRadarCount.textContent = "Radar idle";
        if (staffRadarMood) staffRadarMood.textContent = "Log in to monitor floor";
        if (radarPings) radarPings.innerHTML = "";
        if (radarList) radarList.innerHTML = '<span class="radar-empty">No scans in last 30m.</span>';
        return;
      }
      const venueId = (staffSession.venue || "").toLowerCase();
      const now = Date.now();
      const recent = redemptionLog.filter(entry => {
        const matchesVenue = venueId ? ((entry.venue || "").toLowerCase() === venueId) : true;
        if (!matchesVenue) return false;
        const ts = new Date(entry.timestamp || entry.createdAt || now).getTime();
        return now - ts <= 60 * 60 * 1000;
      }).sort((a, b) => new Date(b.timestamp || b.createdAt || 0) - new Date(a.timestamp || a.createdAt || 0));
      const hot = recent.filter(entry => now - new Date(entry.timestamp || now).getTime() <= 7 * 60 * 1000);
        if (staffRadarCount) staffRadarCount.textContent = `${recent.length} scans Â· last hour`;
        if (staffRadarMood) staffRadarMood.textContent = radarStatusLabel(recent.length, hot.length);
      const power = Math.min(1, (recent.length + hot.length * 0.5) / 10);
      if (staffRadarEl) {
        const hue = Math.max(160, Math.min(205, 185 - power * 25));
        const sweepOpacity = 0.45 + power * 0.45;
        const gridOpacity = 0.18 + power * 0.25;
        const pingGlow = 0.55 + power * 0.35;
        staffRadarEl.style.setProperty("--radar-hue", hue.toFixed(1));
        staffRadarEl.style.setProperty("--radar-sweep-opacity", sweepOpacity.toFixed(2));
        staffRadarEl.style.setProperty("--radar-grid-opacity", gridOpacity.toFixed(2));
        staffRadarEl.style.setProperty("--radar-ping-glow", pingGlow.toFixed(2));
        staffRadarEl.style.boxShadow = `0 24px 50px rgba(0,0,0,0.5), 0 0 ${24 + power * 26}px rgba(103,232,249,${0.25 + power * 0.35})`;
      }
      if (radarPings) {
        radarPings.innerHTML = recent.slice(0, 8).map((entry, idx) => {
          const seed = (new Date(entry.timestamp || now).getTime() + idx * 97) % 360;
          const radius = 18 + (idx * 7);
          const left = 50 + Math.cos(seed * Math.PI / 180) * radius;
          const top = 50 + Math.sin(seed * Math.PI / 180) * radius;
          const delay = (idx * 0.14).toFixed(2);
          const glow = Math.min(0.95, 0.45 + (recent.length * 0.04) + power * 0.2);
          return `<span style="left:${left}%;top:${top}%;animation-delay:${delay}s;opacity:${glow};"></span>`;
        }).join("");
      }
      if (radarList) {
        if (!recent.length) {
          radarList.innerHTML = '<span class="radar-empty">No scans in last hour.</span>';
        } else {
          radarList.innerHTML = recent.slice(0, 6).map(entry => {
            const time = formatTimeLabel(entry.timestamp || now);
            const code = (entry.code || "CODE").toUpperCase();
            return `<span class="radar-chip"><strong>${code}</strong>${entry.perk || entry.perkKey || "Perk"} â€¢ ${time}</span>`;
          }).join("");
        }
      }
    }
    function updateStreakBadge(entries = []) {
      if (!currentPassCode) return;
      const now = new Date();
      const month = now.getMonth();
      const year = now.getFullYear();
      const recent = entries.filter(e => {
        if (e.status !== "verified") return false;
        const ts = new Date(e.timestamp || e.verifiedAt || Date.now());
        return ts.getMonth() === month && ts.getFullYear() === year;
      });
      const state = getBadgeStateForCurrentPass();
      const count = recent.length;
      const streakUnlocked = count >= 5;
      setBadgeStateForCurrentPass({
        ...state,
        streak: streakUnlocked,
        streakCount: count
      });
    }

    function mergeRedemptionLogEntries(entries = []) {
      if (!entries.length) return;
      if (useCloudProfile()) {
        const byCode = {};
        entries.forEach(e => {
          const key = (e.code || "").toUpperCase();
          if (key) byCode[key] = e;
        });
        redemptionLog = Object.values(byCode).sort((a, b) => {
          return new Date(b.timestamp || b.verifiedAt || 0) - new Date(a.timestamp || a.verifiedAt || 0);
        });
        syncPendingForCurrentPass();
        evaluateAchievements();
        renderStaffVenueLog();
        renderCeoRedemptionLog();
        renderCeoVerifiedVenueLog();
        renderCeoVenueLog();
        refreshMemberStats();
        updateRedeemAwaitState();
        return;
      }
      const byCode = {};
      redemptionLog.forEach(e => {
        const key = (e.code || "").toUpperCase();
        if (key) byCode[key] = e;
      });
      entries.forEach(e => {
        const key = (e.code || "").toUpperCase();
        if (key) byCode[key] = e;
      });
      redemptionLog = Object.values(byCode).sort((a, b) => {
        return new Date(b.timestamp || b.verifiedAt || 0) - new Date(a.timestamp || a.verifiedAt || 0);
      });
      syncPendingForCurrentPass();
      saveRedemptionLog();
      evaluateAchievements();
      renderStaffVenueLog();
      renderCeoRedemptionLog();
      renderCeoVerifiedVenueLog();
      renderCeoVenueLog();
      refreshMemberStats();
      updateRedeemAwaitState();
    }

    const storedCeoPasses = localStorage.getItem("ceoIssued");
    if (storedCeoPasses) {
      try {
        ceoIssuedPasses = JSON.parse(storedCeoPasses);
      } catch (err) {
        ceoIssuedPasses = [];
      }
    }

    const staffLogRange = document.getElementById("staffLogRange");
    if (staffLogRange) {
      staffLogRange.addEventListener("change", () => {
        renderStaffVenueLog();
      });
    }
    if (ceoVenueFilter) {
      ceoVenueFilter.addEventListener("change", () => renderCeoVenueLog());
    }
    if (ceoVenueRange) {
      ceoVenueRange.addEventListener("change", () => renderCeoVenueLog());
    }
    function renderCeoIssued() {
      if (!ceoIssuedList) return;
      ceoIssuedList.innerHTML = "";
      if (!ceoGeneratedCodes || ceoGeneratedCodes.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'ceo-issued-item';
        empty.textContent = 'No CEO codes generated yet.';
        ceoIssuedList.appendChild(empty);
        return;
      }
      ceoGeneratedCodes.forEach((entry) => {
        const item = document.createElement('div');
        item.className = 'ceo-issued-item';

        const left = document.createElement('div');
        left.style.display = 'flex';
        left.style.alignItems = 'center';

        const code = document.createElement('div');
        code.className = 'ceo-issued-code';
        code.textContent = entry.code;

        const meta = document.createElement('div');
        meta.className = 'ceo-issued-meta';
        const when = formatMST(entry.timestamp || Date.now());
        meta.textContent = `${entry.perk} Â· ${when}`;

        left.appendChild(code);
        left.appendChild(meta);

        const actions = document.createElement('div');
        actions.className = 'ceo-issued-actions';

        const copyBtn = document.createElement('button');
        copyBtn.className = 'btn btn-secondary';
        copyBtn.textContent = 'Copy';
        copyBtn.type = 'button';
        copyBtn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(entry.code);
            copyBtn.textContent = 'Copied';
            setTimeout(() => (copyBtn.textContent = 'Copy'), 1200);
          } catch (err) {
            copyBtn.textContent = 'Copy';
          }
        });

        const shareBtn = document.createElement('button');
        shareBtn.className = 'btn btn-primary';
        shareBtn.type = 'button';
        shareBtn.textContent = 'Share';
        shareBtn.addEventListener('click', () => {
          const shareText = `${entry.code} â€” ${entry.perk}`;
          if (navigator.share) {
            navigator.share({ text: shareText }).catch(() => {});
          } else {
            navigator.clipboard.writeText(shareText).then(() => {
              shareBtn.textContent = 'Copied';
              setTimeout(() => (shareBtn.textContent = 'Share'), 1200);
            }).catch(() => {});
          }
        });

        actions.appendChild(copyBtn);
        actions.appendChild(shareBtn);

        item.appendChild(left);
        item.appendChild(actions);

        ceoIssuedList.appendChild(item);
      });
    }
    function renderCeoVerifiedVenueLog() {
      // Section removed
    }

    function renderCeoVenueLog() {
      if (!ceoVenueLog) return;
      const venueId = ceoVenueFilter?.value || "all";
      const range = ceoVenueRange?.value || "month";
      const now = Date.now();
      const windowMap = {
        day: 24 * 60 * 60 * 1000,
        week: 7 * 24 * 60 * 60 * 1000,
        month: 31 * 24 * 60 * 60 * 1000,
        year: 365 * 24 * 60 * 60 * 1000
      };
      let entries = redemptionLog.filter(e => e.status === "verified");
      if (venueId !== "all") {
        entries = entries.filter(e => (e.venue || "").toLowerCase() === venueId.toLowerCase());
      }
      if (range !== "all") {
        const win = windowMap[range];
        if (win) {
          entries = entries.filter(e => {
            const ts = new Date(e.timestamp).getTime();
            return (now - ts) <= win;
          });
        }
      }
      if (!entries.length) {
        ceoVenueLog.innerHTML = '<p style="color:#94a3b8;">No redemptions for this filter.</p>';
        return;
      }
      // Group by venue + date label for readability
      const groups = {};
      entries.forEach(e => {
        const venueIdKey = (e.venue || "pending").toLowerCase();
        const venueName = venuesInfo[venueIdKey]?.name || e.venue || "Pending venue";
        const date = new Date(e.timestamp);
        const label = range === "year"
          ? date.toLocaleDateString("en-US", { month: "short", year: "numeric" })
          : date.toLocaleDateString("en-US", { month: "short", day: "numeric" });
        const key = `${venueIdKey}__${label}`;
        if (!groups[key]) groups[key] = { venue: venueName, label, items: [] };
        groups[key].items.push(e);
      });
      const sorted = Object.values(groups).sort((a, b) => {
        const ta = new Date(a.items[0].timestamp).getTime();
        const tb = new Date(b.items[0].timestamp).getTime();
        return tb - ta;
      });
      ceoVenueLog.innerHTML = sorted.map(group => {
        const entriesHtml = group.items.map(entry => {
          const label = entry.perk || entry.perkKey || "Perk";
          const member = entry.member || entry.passId || "FoCo member";
          const date = formatMST(entry.timestamp);
          return `
            <div class="log-row">
              <strong>${entry.code} Â· ${label}</strong>
              <div>${member}</div>
              <div class="log-meta">
                <span>${date}</span>
                <span class="status-pill-sm verified">verified</span>
              </div>
            </div>
          `;
        }).join("");
        return `
          <div class="log-group">
            <div class="staff-ticker-header" style="margin:6px 0;">${group.venue} â€¢ ${group.label}</div>
            ${entriesHtml}
          </div>
        `;
      }).join("");
    }
    function getStoredReviews() {
      try {
        return JSON.parse(localStorage.getItem(REVIEWS_KEY) || "[]");
      } catch (err) {
        return [];
      }
    }
    function saveReviews(reviews) {
      localStorage.setItem(REVIEWS_KEY, JSON.stringify(reviews.slice(0, 50)));
    }
    function normalizeReviewEntry(review = {}) {
      const ts = review.timestamp?.toDate
        ? review.timestamp.toDate()
        : review.timestamp
          ? new Date(review.timestamp)
          : null;
      const timestampMs = Number.isFinite(review.timestampMs)
        ? review.timestampMs
        : ts
          ? ts.getTime()
          : 0;
      return {
        ...review,
        timestampMs
      };
    }
    function mergeReviews(primary = [], fallback = []) {
      const merged = new Map();
      [...primary, ...fallback].forEach(item => {
        const review = normalizeReviewEntry(item);
        const key = review.id
          || review.docId
          || `${review.timestampMs}|${(review.member || "").toLowerCase()}|${review.stars || 0}|${(review.notes || "").trim()}`;
        if (!merged.has(key)) merged.set(key, review);
      });
      return Array.from(merged.values()).sort((a, b) => (b.timestampMs || 0) - (a.timestampMs || 0));
    }

    function setReviewStars(amount) {
      selectedReviewStars = amount;
      reviewStars.forEach(star => {
        const value = parseInt(star.dataset.star, 10);
        star.classList.toggle("filled", value <= amount);
      });
    }
    function renderCeoReviews(reviewsOverride) {
      if (!ceoReviewList) return;
      const reviews = Array.isArray(reviewsOverride)
        ? reviewsOverride
        : mergeReviews(ceoReviewsCache, getStoredReviews());
      if (!reviews.length) {
        ceoReviewList.innerHTML = '<p style="color:#94a3b8;">No reviews yet.</p>';
        if (ceoReviewAverage) ceoReviewAverage.textContent = "Recent reviews avg: â€“";
        return;
      }
      const avg = reviews.reduce((sum, r) => sum + (Number(r.stars) || 0), 0) / reviews.length;
      if (ceoReviewAverage) {
        ceoReviewAverage.textContent = `Recent reviews avg: ${avg.toFixed(1)}â˜… (${reviews.length} review${reviews.length === 1 ? "" : "s"})`;
      }
      ceoReviewList.innerHTML = reviews.map(review => `
        <div class="review-card">
          <strong>${review.stars} â˜… Â· ${review.member || "FoCo member"}</strong>
          <span>${formatMST(review.timestamp || review.timestampMs)}</span>
          <p style="margin-top:6px;font-size:13px;line-height:1.4;color:#e2e8f0;">${review.notes || "No additional comments."}</p>
        </div>
      `).join("\n");
      updateCeoMetrics(reviews);
    }

    function clearCeoReviewsRealtime() {
      if (ceoReviewsUnsub) {
        try { ceoReviewsUnsub(); } catch (_) {}
        ceoReviewsUnsub = null;
      }
      ceoReviewsCache = [];
    }
    function attachCeoReviewsRealtime() {
      if (!db || !isCeoAccount) return;
      clearCeoReviewsRealtime();
      try {
        const q = query(collection(db, "reviews"), orderBy("timestampMs", "desc"));
        ceoReviewsUnsub = onSnapshot(q, (snap) => {
          ceoReviewsCache = snap.docs.map(docSnap => {
            const data = docSnap.data() || {};
            return normalizeReviewEntry({
              ...data,
              id: docSnap.id
            });
          }).sort((a, b) => (b.timestampMs || 0) - (a.timestampMs || 0));
          renderCeoReviews(ceoReviewsCache);
        }, (err) => console.warn("CEO reviews realtime failed", err));
      } catch (err) {
        console.warn("CEO reviews realtime failed", err);
      }
    }

    function renderStaffDealCodes() {
      if (!staffDealCodeList) return;
      cleanDealCodes();
      if (!staffSession) {
        staffDealCodeList.innerHTML = '<p style="color:#94a3b8;">Log in to generate codes for tonightâ€™s deals.</p>';
        return;
      }
      const now = Date.now();
      const activeAlerts = tonightAlerts
        .filter(alert => alert.venueId === staffSession.venue && (!alert.expiresAt || alert.expiresAt > now))
        .sort((a, b) => (a.expiresAt || Number.MAX_SAFE_INTEGER) - (b.expiresAt || Number.MAX_SAFE_INTEGER));
      if (!activeAlerts.length) {
        staffDealCodeList.innerHTML = '<p style="color:#94a3b8;">No active deals to generate codes for.</p>';
        return;
      }
      staffDealCodeList.innerHTML = activeAlerts.map(alert => {
        const expiresText = alert.expiresAt ? formatMST(alert.expiresAt) : "No expiry";
        const codesForAlert = Object.entries(dealCodes || {}).filter(([, val]) => val.alertId === alert.id && val.venue === staffSession.venue);
        const codesLine = codesForAlert.length
          ? `<span style="color:#34d399;">Codes: ${codesForAlert.map(([c]) => c).join(", ")}</span>`
          : '<span style="color:#94a3b8;">No codes yet</span>';
        return `
          <div class="log-row">
            <strong>${alert.title || "Tonight's deal"}</strong><br/>
            <span style="color:#cbd5f5;">${alert.detail || ""}</span><br/>
            <span style="color:#93c5fd;font-size:11px;">Expires ${expiresText}</span>
            <div class="log-meta" style="margin-top:6px;gap:10px;align-items:center;">
              <button class="btn btn-primary" data-gen-deal="${alert.id}">Generate code</button>
              ${codesLine}
            </div>
          </div>
        `;
      }).join("");
    }

    function updateStaffKpis(alertCount = 0, vipActive = false) {
      if (kpiAlerts?.querySelector("span")) kpiAlerts.querySelector("span").textContent = alertCount;
      if (kpiVip?.querySelector("span")) {
        const span = kpiVip.querySelector("span");
        span.textContent = vipActive ? "Live" : "Inactive";
        span.style.color = vipActive ? "#22d3ee" : "#94a3b8";
      }
      if (kpiScans?.querySelector("span") && staffRadarCount) {
        kpiScans.querySelector("span").textContent = staffRadarCount.textContent || "0";
      }
    }

    function generateVenueDealCode(alert) {
      if (!alert || !alert.id) return "";
      const code = generateRedemptionCode();
      dealCodes = dealCodes || {};
      dealCodes[code] = {
        alertId: alert.id,
        venue: alert.venueId || staffSession?.venue || null,
        perk: alert.title || "Tonight's deal",
        timestamp: new Date().toISOString()
      };
      saveDealCodes(dealCodes);
      return code;
    }

    // Initialize CEO venue filter once everything is ready
    initCeoVenueFilter();

    function getBadgeStateForCurrentPass() {
      if (!currentPassCode) return { reviews: false, streak: false, reviewsCount: 0 };
      const key = currentPassCode.toUpperCase();
      const state = badgeDirectory[key] || {};
      return {
        reviews: !!state.reviews,
        streak: !!state.streak,
        reviewsCount: state.reviewsCount || 0
      };
    }
    function setBadgeStateForCurrentPass(updates = {}) {
      if (!currentPassCode) return;
      const key = currentPassCode.toUpperCase();
      const prev = badgeDirectory[key] || {};
      badgeDirectory[key] = { ...prev, ...updates };
      saveBadgeDirectory(badgeDirectory);
      renderProfileBadges();
    }
    function getAchievementStateForCurrentPass() {
      if (!currentPassCode) return {};
      const key = currentPassCode.toUpperCase();
      const state = achievementState[key] || {};
      const entry = loadMemberDirectory()[key] || {};
      const fromProfile = entry.achievements || {};
      return { ...state, ...fromProfile };
    }
    function setAchievementStateForCurrentPass(updates = {}) {
      if (!currentPassCode) return;
      const key = currentPassCode.toUpperCase();
      const prev = achievementState[key] || {};
      achievementState[key] = { ...prev, ...updates };
      saveAchievementState(achievementState);
      setMemberDirectoryEntry(key, { achievements: achievementState[key] });
      renderAchievementsList();
    }
    function renderAchievementsList() {
      if (!achievementsList) return;
      const state = getAchievementStateForCurrentPass();
      const hasNew = !!state.hasNew;
      if (achievementsNewPill) {
        achievementsNewPill.classList.toggle("active", hasNew);
      }
      achievementsList.innerHTML = ACHIEVEMENTS.map(item => {
        const unlocked = !!state[item.id];
        return `<div class="achievement ${unlocked ? "unlocked" : ""}">
          <div class="achievement-icon">${item.icon}</div>
          <div>
            <div style="font-weight:600;">${item.label}</div>
            <div style="font-size:11px;color:#94a3b8;">${item.desc}</div>
          </div>
        </div>`;
      }).join("");
    }
    function evaluateAchievements(entriesOverride) {
      if (!currentPassCode) return;
      const key = currentPassCode.toUpperCase();
      const entry = getAchievementStateForCurrentPass();
      const reviewCount = (badgeDirectory[key]?.reviewsCount) || 0;
      const loginCount = Number(memberProfile?.loginCount || 0);
      const usernameChangeCounts = loadUsernameChangeCounts(key);
      const totalUsernameChanges = Object.values(usernameChangeCounts).reduce((sum, val) => sum + (Number(val) || 0), 0);
      const entries = entriesOverride || redemptionLog;
      const matchPass = (e) => {
        const pid = (e.passId || e.passcode || e.passCode || "").toUpperCase();
        return pid === key;
      };
      const verified = entries.filter(e => e.status === "verified" && matchPass(e));
      const verifiedCount = verified.length;
      const uniqueVenues = new Set(verified.map(e => (e.venue || "").toLowerCase())).size;
      const currentMonth = getMonthToken();
      const monthlyRedemptions = verified.filter(e => {
        const stamp = e.timestamp || e.verifiedAt || Date.now();
        return getMonthTokenFromDate(stamp) === currentMonth;
      }).length;
      const updates = { ...entry };
      let newUnlocked = !!updates.hasNew;
      if (loginCount >= 1) updates.firstLogin = true;
      if (totalUsernameChanges >= 1 || memberProfile?.usernameChangedAt) updates.handleSet = true;
      if (verifiedCount >= 1) updates.firstPerk = true;
      if (uniqueVenues >= 3) updates.threeVenues = true;
      if (reviewCount >= 1) updates.firstReview = true;
      if (monthlyRedemptions >= 5) updates.monthlyStreak = true;
      ACHIEVEMENTS.forEach(item => {
        if (updates[item.id] && !entry[item.id]) newUnlocked = true;
      });
      if (newUnlocked) updates.hasNew = true;
      setAchievementStateForCurrentPass(updates);
    }
    function markAchievementsSeen() {
      const state = getAchievementStateForCurrentPass();
      if (!state.hasNew) return;
      setAchievementStateForCurrentPass({ hasNew: false });
    }
    function renderProfileBadges() {
      if (!profileBadges) return;
      const state = getBadgeStateForCurrentPass();
      const badges = [];
      if (state.reviews) {
        badges.push('<span class="pill badge review">Top Reviewer</span>');
      }
      profileBadges.innerHTML = badges.join("") || "";
      profileBadges.style.display = badges.length ? "flex" : "none";
    }

    function computeAnalyticsSnapshot() {
      const directory = loadMemberDirectory();
      const members = Object.entries(directory).map(([passId, data]) => ({ passId, ...(data || {}) }));
      const tierCounts = { standard: 0, vip: 0, ceo: 0 };
      members.forEach(member => {
        const tier = member.tier?.toLowerCase() || "standard";
        if (tierCounts[tier] !== undefined) tierCounts[tier] += 1;
      });
      const totalMembers = Math.max(1, members.length);
      const verified = redemptionLog.filter(entry => entry.status === "verified");
      const valueMap = { drink: 3, shot: 1, cover: 8 };
      const perkCounts = { drink: 0, shot: 0, cover: 0 };
      const perkLabels = {
        drink: PERK_TYPES?.drink?.label || "Drink perk",
        shot: PERK_TYPES?.shot?.label || "Shot perk",
        cover: PERK_TYPES?.cover?.label || "Line access perk"
      };
      const hourBuckets = {};
      const nightlyBuckets = {};
      const memberRedemptionCounts = {};
      const tierValueTotals = { standard: 0, vip: 0 };
      const tierRedeemCounts = { standard: 0, vip: 0 };
      verified.forEach(entry => {
        const perkText = (entry.perk || "").toLowerCase();
        let perkKey = entry.perkKey || "";
        if (!perkKey) {
          if (perkText.includes("line access")) {
            perkKey = "cover";
          } else if (perkText.includes("shot")) {
            perkKey = "shot";
          } else if (perkText.includes("drink")) {
            perkKey = "drink";
          }
        }
        if (!perkKey) perkKey = "drink";
        if (perkCounts[perkKey] !== undefined) perkCounts[perkKey] += 1;
        const passId = (entry.passId || "").toUpperCase();
        const memberTier = directory[passId]?.tier || "standard";
        const tierKey = memberTier.toLowerCase();
        if (tierValueTotals[tierKey] !== undefined) {
          tierValueTotals[tierKey] += valueMap[perkKey] || 3;
          tierRedeemCounts[tierKey] += 1;
        }
        if (!memberRedemptionCounts[passId]) memberRedemptionCounts[passId] = 0;
        memberRedemptionCounts[passId] += 1;
        const date = new Date(entry.timestamp);
        const hour = date.getHours();
        hourBuckets[hour] = (hourBuckets[hour] || 0) + 1;
        const dateKey = date.toLocaleDateString();
        nightlyBuckets[dateKey] = (nightlyBuckets[dateKey] || 0) + 1;
      });
      const returningMembers = Object.values(memberRedemptionCounts).filter(count => count > 1).length;
      const memberReturnRate = members.length ? Math.round((returningMembers / members.length) * 100) : 0;
      const totalValue = Object.keys(perkCounts).reduce((sum, key) => sum + (perkCounts[key] * (valueMap[key] || 0)), 0);
      const estRevenue = tierCounts.standard * 5.0 + tierCounts.vip * 10.0;
      const roi = totalValue ? Math.round(((estRevenue - totalValue) / totalValue) * 100) : 0;
      const peakHours = Object.entries(hourBuckets)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3)
        .map(([hour, count]) => `${hour}:00 (${count})`);
      const nightlyTrends = Object.entries(nightlyBuckets)
        .sort((a, b) => new Date(b[0]) - new Date(a[0]))
        .slice(0, 5)
        .map(([dateKey, count]) => `${dateKey}: ${count}`);
      const avgTabStandard = tierRedeemCounts.standard ? (tierValueTotals.standard / tierRedeemCounts.standard) : 0;
      const avgTabVip = tierRedeemCounts.vip ? (tierValueTotals.vip / tierRedeemCounts.vip) : 0;
      return {
        demographics: [
          `VIP: ${Math.round((tierCounts.vip / totalMembers) * 100)}% (${tierCounts.vip})`,
          `Standard: ${Math.round((tierCounts.standard / totalMembers) * 100)}% (${tierCounts.standard})`,
          `Black Card / CEO: ${tierCounts.ceo}`
        ],
        peakTimes: peakHours,
        nightlyTrends,
        roi: `Estimated revenue $${estRevenue.toFixed(2)} vs perks cost $${totalValue.toFixed(2)} (${roi}% ROI)`,
        memberReturnRate,
        avgTabs: {
          standard: avgTabStandard.toFixed(2),
          vip: avgTabVip.toFixed(2)
        },
        perkPopularity: Object.entries(perkCounts).map(([key, count]) => `${perkLabels[key] || key}: ${count}`),
      };
    }

    function renderCeoAnalytics() {
      if (!ceoAnalyticsContent) return;
      const snapshot = computeAnalyticsSnapshot();
      const venueOptions = Object.entries(venuesInfo).map(([id, info]) => `<option value="${id}">${info.name}</option>`).join("");
      ceoAnalyticsContent.innerHTML = `
        <div class="analytics-grid">
          <div class="analytics-section">
            <h5>Customer demographics</h5>
            <ul>${snapshot.demographics.map(item => `<li>${item}</li>`).join("")}</ul>
          </div>
          <div class="analytics-section">
            <h5>Peak-times heat map</h5>
            <ul>${(snapshot.peakTimes.length ? snapshot.peakTimes : ["No redemptions yet."]).map(item => `<li>${item}</li>`).join("")}</ul>
          </div>
          <div class="analytics-section">
            <h5>Nightly redemption trends</h5>
            <ul>${(snapshot.nightlyTrends.length ? snapshot.nightlyTrends : ["No redemptions yet."]).map(item => `<li>${item}</li>`).join("")}</ul>
          </div>
          <div class="analytics-section">
            <h5>ROI reports</h5>
            <ul><li>${snapshot.roi}</li></ul>
          </div>
          <div class="analytics-section">
            <h5>Member return rate</h5>
            <ul><li>${snapshot.memberReturnRate}% of members have redeemed more than once</li></ul>
          </div>
          <div class="analytics-section">
            <h5>Average tab size comparison</h5>
            <ul>
              <li>Standard: $${snapshot.avgTabs.standard}</li>
              <li>VIP: $${snapshot.avgTabs.vip}</li>
            </ul>
          </div>
          <div class="analytics-section">
            <h5>Breakdown of perk popularity</h5>
            <ul>${snapshot.perkPopularity.map(item => `<li>${item}</li>`).join("")}</ul>
          </div>
        </div>
        <div class="analytics-section">
          <h5>In-app purchase receipts</h5>
          <div id="ceoPurchaseReceipts">No in-app purchase receipts yet.</div>
        </div>
      `;
      renderCeoPurchaseReceipts();
    }

    function getDemoRedemptions() {
      const now = Date.now();
      return [
        { code: "QK1234", perk: "Drink perk voucher", perkKey: "drink", member: "Avery W.", status: "verified", timestamp: new Date(now - 1000 * 60 * 30).toISOString(), venue: "bar_district" },
        { code: "LM4321", perk: "Shot perk voucher", perkKey: "shot", member: "Noah L.", status: "verified", timestamp: new Date(now - 1000 * 60 * 50).toISOString(), venue: "social" },
        { code: "YX9988", perk: "Line access voucher", perkKey: "cover", member: "Priya S.", status: "verified", timestamp: new Date(now - 1000 * 60 * 80).toISOString(), venue: "rec_room" },
        { code: "DJ3412", perk: "Drink perk voucher", perkKey: "drink", member: "Mateo R.", status: "pending", timestamp: new Date(now - 1000 * 60 * 15).toISOString(), venue: "social" },
        { code: "TR5522", perk: "Shot perk voucher", perkKey: "shot", member: "Charlotte H.", status: "verified", timestamp: new Date(now - 1000 * 60 * 120).toISOString(), venue: "odell" }
      ];
    }

    function seedDemoData(skipBackup = false) {
      if (!skipBackup && !localStorage.getItem("redemptionLog_backup")) {
        localStorage.setItem("redemptionLog_backup", localStorage.getItem("redemptionLog") || "[]");
      }
      localStorage.setItem("redemptionLog", JSON.stringify(getDemoRedemptions()));
      loadRedemptionLog();
      renderStaffVenueLog();
      renderCeoRedemptionLog();
      renderCeoReviews();
      updateCeoMetrics();
    }

    function updateDemoUI() {}

    function updateCeoMetrics(reviewsOverride) {
      if (!metricTodayRedemptions || !metricActiveVenues || !metricLatestRating) return;
      const today = new Date().toDateString();
      const todayCount = redemptionLog.filter(entry => new Date(entry.timestamp).toDateString() === today).length;
      const uniqueVenues = new Set(redemptionLog.filter(entry => entry.venue).map(entry => entry.venue));
      const reviews = Array.isArray(reviewsOverride)
        ? reviewsOverride
        : mergeReviews(ceoReviewsCache, getStoredReviews());
      const avgRating = reviews.length
        ? (reviews.reduce((sum, r) => sum + (Number(r.stars) || 0), 0) / reviews.length)
        : null;
      metricTodayRedemptions.textContent = todayCount;
      metricActiveVenues.textContent = uniqueVenues.size;
      metricLatestRating.textContent = avgRating ? `${avgRating.toFixed(1)}â˜…` : "â€“";
    }

    // CEO sessions should rely on Firebase auth, not local storage shortcuts.

    const RED_COLLECTION = "redemptions";
    const redemptionsCol = db ? collection(db, RED_COLLECTION) : null;
    const getRedemptionRef = (code) => db && code ? doc(db, RED_COLLECTION, code.toUpperCase()) : null;

    function toTimestamp(value) {
      try {
        return Timestamp.fromDate(new Date(value));
      } catch (err) {
        return serverTimestamp();
      }
    }

    let lastCloudSyncError = null;

    function cloudSyncFailureMessage() {
      if (lastCloudSyncError === "auth") {
        return "Cloud sync failed. Enable Anonymous Auth in Firebase Auth > Sign-in method.";
      }
      if (lastCloudSyncError === "permission-denied") {
        return "Cloud sync blocked by Firestore rules.";
      }
      return "Cloud sync failed. Check connection and try again.";
    }

    async function syncRedemptionToCloud(entry) {
      lastCloudSyncError = null;
      if (!db || !entry || !entry.code) return false;
      const user = await ensureFirebaseUser();
      if (!user) {
        lastCloudSyncError = "auth";
        return false;
      }
      const ref = getRedemptionRef(entry.code);
      if (!ref) return false;
      const passId = (entry.passId || "").toUpperCase();
      const payload = {
        code: entry.code.toUpperCase(),
        perk: entry.perk || entry.perkKey || "Perk",
        perkKey: entry.perkKey || null,
        venuePerkId: entry.venuePerkId || null,
        venuePerkLabel: entry.venuePerkLabel || null,
        passId: passId || undefined,
        member: entry.member || null,
        venue: entry.venue || null,
        requestedVenue: entry.requestedVenue || null,
        ceo: !!entry.ceo,
        status: entry.status || "pending",
        timestamp: entry.timestamp ? toTimestamp(entry.timestamp) : serverTimestamp(),
        verifiedAt: entry.verifiedAt ? toTimestamp(entry.verifiedAt) : null,
      };
      try {
        await setDoc(ref, payload, { merge: true });
        return true;
      } catch (err) {
        lastCloudSyncError = err?.code || "write";
        console.warn("Failed to sync redemption to cloud", err);
        return false;
      }
    }

    async function fetchCloudRedemption(code) {
      if (!db || !code) return null;
      await ensureFirebaseUser();
      const ref = getRedemptionRef(code);
      if (!ref) return null;
      try {
        const snap = await withTimeout(getDoc(ref));
        if (!snap.exists()) return null;
        const data = snap.data();
        const toIso = (ts) => {
          if (!ts) return null;
          if (ts.toDate) return ts.toDate().toISOString();
          return new Date(ts).toISOString();
        };
        return {
          code: (data.code || code).toUpperCase(),
          perk: data.perk || data.perkKey || "Perk",
          perkKey: data.perkKey || null,
          venuePerkId: data.venuePerkId || null,
          venuePerkLabel: data.venuePerkLabel || null,
          passId: (data.passId || "").toUpperCase(),
          member: data.member || "FoCo member",
          venue: data.venue || null,
          requestedVenue: data.requestedVenue || null,
          ceo: !!data.ceo,
          status: data.status || "pending",
          timestamp: toIso(data.timestamp) || new Date().toISOString(),
          verifiedAt: toIso(data.verifiedAt),
        };
      } catch (err) {
        console.warn("Failed to fetch cloud redemption", err);
        return null;
      }
    }

    function renderStaffVenueLog() {
      if (!staffSession) {
        updateStaffRadar();
        return;
      }
      const venueId = (staffSession.venue || "").toLowerCase();
      const allEntries = redemptionLog.filter(item => {
        return (item.venue || "").toLowerCase() === venueId;
      });
      const rangeSelect = document.getElementById("staffLogRange");
      const range = rangeSelect?.value || "all";
      const toMstDate = (value) => new Date(new Date(value).toLocaleString("en-US", { timeZone: "America/Denver" }));
      const nowMst = toMstDate(Date.now());
      let filtered = allEntries;
      let start = null;
      let end = null;
      if (range !== "all") {
        if (range === "day") {
          start = new Date(nowMst.getFullYear(), nowMst.getMonth(), nowMst.getDate());
          end = new Date(start.getFullYear(), start.getMonth(), start.getDate() + 1, 0, 0, 0, 0);
          end.setMilliseconds(end.getMilliseconds() - 1);
        } else if (range === "week") {
          start = new Date(nowMst.getFullYear(), nowMst.getMonth(), nowMst.getDate());
          start.setDate(start.getDate() - 6);
          end = new Date(nowMst.getFullYear(), nowMst.getMonth(), nowMst.getDate(), 23, 59, 59, 999);
        } else if (range === "month") {
          start = new Date(nowMst.getFullYear(), nowMst.getMonth(), 1);
          end = new Date(nowMst.getFullYear(), nowMst.getMonth() + 1, 0, 23, 59, 59, 999);
        } else if (range === "year") {
          start = new Date(nowMst.getFullYear(), 0, 1);
          end = new Date(nowMst.getFullYear(), 11, 31, 23, 59, 59, 999);
        }
      }
      if (start && end) {
        filtered = allEntries.filter(entry => {
          const ts = toMstDate(entry.timestamp || Date.now()).getTime();
          return ts >= start.getTime() && ts <= end.getTime();
        });
      }
      filtered = filtered.slice().sort((a, b) => {
        const ta = new Date(a.timestamp || Date.now()).getTime();
        const tb = new Date(b.timestamp || Date.now()).getTime();
        return tb - ta;
      });
      const groupBy = (range === "year" || range === "all") ? "month" : "day";
      const buckets = {};
      filtered.forEach(entry => {
        const d = toMstDate(entry.timestamp || Date.now());
        const key = groupBy === "month"
          ? d.toLocaleDateString("en-US", { month: "short", year: "numeric" })
          : d.toLocaleDateString("en-US", { month: "short", day: "numeric" });
        const ts = d.getTime();
        if (!buckets[key]) {
          buckets[key] = { label: key, items: [], latest: ts };
        }
        buckets[key].items.push(entry);
        if (ts > buckets[key].latest) buckets[key].latest = ts;
      });
      const grouped = Object.values(buckets).sort((a, b) => b.latest - a.latest);

      const targetLog = staffVenueLog;
      if (targetLog) {
        if (!filtered.length) {
          targetLog.innerHTML = '<p style="color:#94a3b8;">No redemptions for this range yet.</p>';
        } else {
          const rangeLabel = {
            all: "All time",
            day: "Today",
            week: "This week",
            month: "This month",
            year: "This year"
          }[range] || "All time";
          const renderEntry = (entry) => {
            const date = formatMST(entry.timestamp);
            const venueText = entry.venue ? `<span style="color:#94a3b8;">Venue: ${entry.venue}</span>` : "<span style='color:#94a3b8;'>Venue: Pending</span>";
            const label = entry.perk
              ? entry.perk
              : entry.perkKey === "reward_shot"
                ? "Reward: shot perk"
                : (entry.perkKey || "Perk");
            const statusAttrs = entry.status === "pending"
              ? `data-code="${entry.code}" data-pass="${entry.passId || ""}" data-perk="${entry.perkKey || ""}"`
              : "";
            return `
              <div class="log-row">
                <strong>${entry.code} Â· ${label}</strong>
                <div>${entry.member || "FoCo member"}</div>
                ${venueText}
                <div class="log-meta">
                  <span>${date}</span>
                  <span class="status-pill-sm ${entry.status}" ${statusAttrs}>${entry.status}</span>
                </div>
              </div>
            `;
          };

          targetLog.innerHTML = `
            <div style="color:#9fb3d9;font-size:12px;margin:4px 0 8px;">
              ${rangeLabel} Â· ${filtered.length} total
            </div>
            ${grouped.map(group => {
              return `
                <div class="log-group">
                  <div class="staff-ticker-header" style="margin:10px 0 6px 0;">${group.label} Â· ${group.items.length}</div>
                  ${group.items.map(renderEntry).join("")}
                </div>
              `;
            }).join("")}
          `;
        }
      }
      if (staffVenueMonthlyLog) {
        const now = new Date();
        const month = now.getMonth();
        const year = now.getFullYear();
        const monthEntries = allEntries.filter(entry => {
          const d = new Date(entry.timestamp);
          return d.getMonth() === month && d.getFullYear() === year;
        });
        if (!monthEntries.length) {
          staffVenueMonthlyLog.innerHTML = '<p style="color:#94a3b8;">No redemptions recorded this month.</p>';
        } else {
          const total = monthEntries.length;
          staffVenueMonthlyLog.innerHTML = `<p style="color:#cbd5f5;font-weight:600;">${total} redemptions this month</p>` + monthEntries.map(entry => {
            const date = new Date(entry.timestamp).toLocaleDateString("en-US", { month: "short", day: "numeric" });
            const label = entry.perk
              ? entry.perk
              : entry.perkKey === "reward_shot"
                ? "Reward: shot perk"
                : (entry.perkKey || "Perk");
            return `
              <div class="log-row">
                <strong>${label}</strong>
                <div>${entry.member || "FoCo member"}</div>
                <div class="log-meta">
                  <span>${date}</span>
                  <span class="status-pill-sm ${entry.status}">${entry.status}</span>
                </div>
              </div>
            `;
          }).join("\n");
        }
      }
      updateStaffRadar();
      renderCeoRedemptionLog();
    }
    function getCloseOutWindow() {
      const start = new Date();
      start.setHours(0, 0, 0, 0);
      const end = new Date(start.getTime());
      end.setHours(26, 0, 0, 0); // through 2 a.m. next day
      return { start: start.getTime(), end: end.getTime() };
    }
    function buildCloseOutReport() {
      if (!staffSession) return null;
      const venueId = staffSession.venue;
      const window = getCloseOutWindow();
      const entries = redemptionLog.filter(entry => {
        const matchVenue = entry.venue === venueId;
        if (!matchVenue) return false;
        const tsDate = new Date(entry.timestamp || Date.now());
        const ts = Number.isNaN(tsDate.getTime()) ? Date.now() : tsDate.getTime();
        return ts >= window.start && ts <= window.end;
      });
      const verified = entries.filter(e => e.status === "verified");
      const pending = entries.filter(e => e.status !== "verified");
      const byPerk = {};
      verified.forEach(e => {
        const label = e.perk || e.perkKey || "Perk";
        byPerk[label] = (byPerk[label] || 0) + 1;
      });
      const topPerk = Object.entries(byPerk).sort((a, b) => b[1] - a[1])[0]?.[0] || "None";
      const hourly = {};
      verified.forEach(e => {
        const d = new Date(e.timestamp || Date.now());
        const hr = d.getHours();
        hourly[hr] = (hourly[hr] || 0) + 1;
      });
      const peakHour = Object.entries(hourly).sort((a, b) => b[1] - a[1])[0];
      const uniqueMembers = new Set(verified.map(e => e.member || e.passId || e.code));
      return {
        id: `close-${venueId}-${Date.now()}`,
        venue: venueId,
        venueName: venuesInfo[venueId]?.name || venueId,
        generatedAt: new Date().toISOString(),
        range: "today",
        windowLabel: `Window: ${formatMST(window.start)} â€” ${formatMST(window.end)}`,
        totals: {
          verified: verified.length,
          pending: pending.length,
          uniqueMembers: uniqueMembers.size,
          byPerk,
          topPerk,
          peakHour: peakHour ? `${peakHour[0]}:00 (${peakHour[1]} scans)` : "n/a"
        },
        items: entries.map(e => ({
          code: e.code,
          perk: e.perk || e.perkKey || "Perk",
          member: e.member || "FoCo member",
          status: e.status || "pending",
          timestamp: e.timestamp || new Date().toISOString()
        }))
      };
    }

    function buildCloseOutSummaryHtml(report) {
      if (!report) return "";
      const totals = report.totals || {};
      const perkLines = Object.entries(totals.byPerk || {})
        .map(([perk, count]) => `<li>${perk}: ${count}</li>`)
        .join("") || "<li>No perks redeemed yet.</li>";
      const items = (report.items || [])
        .sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0))
        .map(item => `<li><strong>${item.code || "â€”"}</strong> Â· ${item.perk || "Perk"} Â· ${formatMST(item.timestamp || Date.now(), { hour: "2-digit", minute: "2-digit" })}</li>`)
        .join("") || "<li>No redemptions yet.</li>";
      return `
        <div style="background:rgba(10,16,32,0.85);border:1px solid rgba(148,163,184,0.3);border-radius:16px;padding:12px;">
          <div style="color:#cbd5f5;font-weight:700;font-size:15px;margin-bottom:6px;">${report.venueName || "Venue"}</div>
          <div style="color:#94a3b8;font-size:12px;margin-bottom:4px;">Generated: ${formatMST(report.generatedAt)}</div>
          <div style="color:#94a3b8;font-size:12px;margin-bottom:10px;">${report.windowLabel || "Window: 12aâ€“2a"}</div>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;margin-bottom:10px;color:#e2e8f0;font-size:13px;">
            <div><strong>${totals.verified || 0}</strong><br/><span style="color:#94a3b8;">Verified</span></div>
            <div><strong>${totals.pending || 0}</strong><br/><span style="color:#94a3b8;">Pending</span></div>
            <div><strong>${totals.uniqueMembers || 0}</strong><br/><span style="color:#94a3b8;">Unique guests</span></div>
            <div><strong>${totals.topPerk || "None"}</strong><br/><span style="color:#94a3b8;">Top perk</span></div>
            <div><strong>${totals.peakHour || "n/a"}</strong><br/><span style="color:#94a3b8;">Peak hour</span></div>
          </div>
          <div style="margin-bottom:8px;">
            <strong style="color:#e2e8f0;">By perk</strong>
            <ul style="margin:6px 0 0 18px;color:#94a3b8;">${perkLines}</ul>
          </div>
          <div>
            <strong style="color:#e2e8f0;">Tonightâ€™s redemptions</strong>
            <ul style="margin:6px 0 0 18px;color:#94a3b8;max-height:220px;overflow:auto;">${items}</ul>
          </div>
        </div>
      `;
    }

    function sanitizePdfText(text) {
      const ascii = String(text || "").replace(/[^\x20-\x7E]/g, " ");
      return ascii.replace(/\\/g, "\\\\").replace(/\(/g, "\\(").replace(/\)/g, "\\)");
    }
    function wrapPdfLine(line, maxLen) {
      const out = [];
      let text = line;
      while (text.length > maxLen) {
        out.push(text.slice(0, maxLen));
        text = text.slice(maxLen);
      }
      if (text.length) out.push(text);
      return out;
    }
    function buildCloseOutPdfLines(report) {
      const totals = report.totals || {};
      const lines = [
        "FoCo After Dark Close-out",
        `Venue: ${report.venueName || report.venue || "Venue"}`,
        `Generated (MT): ${formatMST(report.generatedAt)}`,
        report.windowLabel || "Window: last 24 hours",
        "",
        `Verified: ${totals.verified || 0}  Pending: ${totals.pending || 0}  Unique guests: ${totals.uniqueMembers || 0}`,
        `Top perk: ${totals.topPerk || "None"}  Peak hour: ${totals.peakHour || "n/a"}`,
        "",
        "By perk:"
      ];
      Object.entries(totals.byPerk || {}).forEach(([perk, count]) => {
        lines.push(`- ${perk}: ${count}`);
      });
      if (!Object.keys(totals.byPerk || {}).length) {
        lines.push("- No perks redeemed.");
      }
      lines.push("");
      lines.push("Redemptions:");
      const items = (report.items || []).slice(0, 60);
      if (!items.length) {
        lines.push("- No redemptions yet.");
      } else {
        items.forEach(item => {
          const stamp = formatMST(item.timestamp || Date.now(), { hour: "2-digit", minute: "2-digit" });
          lines.push(`- ${item.code || "â€”"} Â· ${item.perk || "Perk"} Â· ${stamp}`);
        });
      }
      return lines.flatMap(line => wrapPdfLine(sanitizePdfText(line), 90));
    }
    function buildSimplePdf(lines) {
      const fontSize = 11;
      const leading = 14;
      const maxLines = 60;
      const contentLines = lines.slice(0, maxLines);
      const content = [
        "BT",
        `/F1 ${fontSize} Tf`,
        `${leading} TL`,
        "50 780 Td",
        ...contentLines.map((line, idx) => (idx === 0 ? `(${line}) Tj` : `T* (${line}) Tj`)),
        "ET"
      ].join("\n");
      const objects = [];
      objects.push("1 0 obj << /Type /Catalog /Pages 2 0 R >> endobj");
      objects.push("2 0 obj << /Type /Pages /Kids [3 0 R] /Count 1 >> endobj");
      objects.push("3 0 obj << /Type /Page /Parent 2 0 R /MediaBox [0 0 612 792] /Contents 4 0 R /Resources << /Font << /F1 5 0 R >> >> >> endobj");
      objects.push(`4 0 obj << /Length ${content.length} >> stream\n${content}\nendstream endobj`);
      objects.push("5 0 obj << /Type /Font /Subtype /Type1 /BaseFont /Helvetica >> endobj");
      let pdf = "%PDF-1.4\n";
      const offsets = [0];
      objects.forEach(obj => {
        offsets.push(pdf.length);
        pdf += `${obj}\n`;
      });
      const xrefOffset = pdf.length;
      pdf += `xref\n0 ${objects.length + 1}\n0000000000 65535 f \n`;
      offsets.slice(1).forEach(offset => {
        pdf += `${String(offset).padStart(10, "0")} 00000 n \n`;
      });
      pdf += `trailer << /Size ${objects.length + 1} /Root 1 0 R >>\nstartxref\n${xrefOffset}\n%%EOF`;
      return pdf;
    }
    function downloadCloseOutReport(report) {
      if (!report) return;
      const lines = buildCloseOutPdfLines(report);
      const pdf = buildSimplePdf(lines);
      const blob = new Blob([pdf], { type: "application/pdf" });
      const url = URL.createObjectURL(blob);
      const stamp = formatMST(report.generatedAt || Date.now(), { month: "2-digit", day: "2-digit" }).replace(/[^\d]/g, "");
      const venueName = (report.venueName || report.venue || "venue").toLowerCase().replace(/[^a-z0-9]+/g, "-");
      const filename = `closeout-${venueName}-${stamp || Date.now()}.pdf`;
      const link = document.createElement("a");
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
    }

    function renderStaffCloseOutSummary(report) {
      if (!staffCloseOutSummary || !report) return;
      staffCloseOutSummary.innerHTML = buildCloseOutSummaryHtml(report);
    }

    async function sendCloseOutEmail(report) {
      if (!report) return false;
      const summary = [
        `Venue: ${report.venueName}`,
        `Generated: ${formatMST(report.generatedAt)}`,
        `${report.windowLabel || ""}`,
        `Verified: ${report.totals.verified || 0}`,
        `Pending: ${report.totals.pending || 0}`,
        `Unique guests: ${report.totals.uniqueMembers || 0}`,
        `Top perk: ${report.totals.topPerk || "None"}`,
        `Peak hour: ${report.totals.peakHour || "n/a"}`,
      ].join("\n");
      const lines = report.items.slice(0, 50).map(item => `${item.code} Â· ${item.perk} Â· ${formatMST(item.timestamp)}`);
      const message = `[Close Out Report]\n${summary}\n\nBreakdown:\n${lines.join("\n")}`;
      try {
        // Send via FormSubmit (same endpoint that already works for support)
        const resp = await fetch("https://formsubmit.co/ajax/focoafterdark@gmail.com", {
          method: "POST",
          headers: { "Content-Type": "application/json", Accept: "application/json" },
          body: JSON.stringify({
            name: `${report.venueName} close-out`,
            email: "reports@focoafterdark.com",
            message,
            formsubmit_account: "focoafterdark@gmail.com",
            _subject: `FoCo Nightlife Â· Close-out ${report.venueName}`,
            _template: "table"
          })
        });
        const data = await resp.json().catch(() => ({}));
        return resp.ok && data.success === "true";
      } catch (err) {
        console.warn("Close-out email failed", err);
        return false;
      }
    }

    function openStaffCloseOut() {
      staffCloseOutStatus.textContent = "";
      if (!staffSession) {
        staffCloseOutSummary.innerHTML = '<p style="color:#94a3b8;">Log in as venue staff to close out.</p>';
        if (staffCloseOutModal) staffCloseOutModal.classList.add("active");
        return;
      }
      const report = buildCloseOutReport();
      pendingCloseOutReport = report;
      if (!report) {
        staffCloseOutSummary.innerHTML = '<p style="color:#94a3b8;">No redemptions yet for this window (12aâ€“2a).</p>';
      } else {
        renderStaffCloseOutSummary(report);
      }
      if (staffCloseOutModal) staffCloseOutModal.classList.add("active");
    }

    function persistCloseOutReport(report) {
      if (!report) return;
      const exists = closeOutReports.some(r => r.id === report.id);
      if (!exists) {
        closeOutReports.unshift(report);
        saveCloseOutReports();
      } else {
        saveCloseOutReports();
      }
      persistMemberState({ closeOutReports: closeOutReports.slice(0, 200) });
    }
    async function persistCloseOutReportToCloud(report) {
      if (!report || !db) return;
      try {
        const generatedAt = report.generatedAt
          ? Timestamp.fromDate(new Date(report.generatedAt))
          : serverTimestamp();
        const payload = {
          ...report,
          generatedAt,
          source: "staff"
        };
        await addDoc(collection(db, "closeOutReports"), payload);
      } catch (err) {
        console.warn("Close-out cloud save failed", err);
      }
    }
    function renderCeoRedemptionLog() {
      if (!ceoRedemptionList) return;
      if (!redemptionLog.length) {
        ceoRedemptionList.innerHTML = '<p style="color:#94a3b8;">No redemptions yet.</p>';
        return;
      }
      ceoRedemptionList.innerHTML = redemptionLog.map(entry => {
        const date = formatMST(entry.timestamp);
        const venueText = entry.venue ? `<span style="color:#94a3b8;">Venue: ${entry.venue}</span>` : "<span style='color:#94a3b8;'>Venue pending</span>";
        const tierText = entry.perk
          ? entry.perk
          : entry.perkKey === "reward_shot"
            ? "Reward: shot perk"
            : (entry.perkKey || "Perk");
        const statusLabel = entry.status === "verified" ? "verified" : "pending";
        return `
          <div class="log-row">
            <strong>${entry.code} Â· ${tierText}</strong>
            <div>${entry.member || "FoCo member"}</div>
            ${venueText}
            <div class="log-meta">
              <span>${date}</span>
              <span class="status-pill-sm ${statusLabel}">${statusLabel}</span>
            </div>
          </div>
        `;
      }).join("\n");
      updateCeoMetrics();
    }
    function renderCeoCloseOutReports() {
      if (!ceoCloseOutList) return;
      if (!closeOutReports.length) {
        ceoCloseOutList.innerHTML = '<p style="color:#94a3b8;">No close-out reports yet.</p>';
        return;
      }
      const venueFilter = ceoCloseOutVenue?.value || "all";
      const range = ceoCloseOutRange?.value || "month";
      const now = Date.now();
      const windowMap = {
        day: 24 * 60 * 60 * 1000,
        week: 7 * 24 * 60 * 60 * 1000,
        month: 31 * 24 * 60 * 60 * 1000,
        year: 365 * 24 * 60 * 60 * 1000,
      };
      const filtered = closeOutReports.filter(report => {
        const matchesVenue = venueFilter === "all" || report.venue === venueFilter;
        if (!matchesVenue) return false;
        if (range === "all") return true;
        const windowMs = windowMap[range];
        if (!windowMs) return true;
        const ts = new Date(report.generatedAt).getTime();
        return (now - ts) <= windowMs;
      });
      if (!filtered.length) {
        ceoCloseOutList.innerHTML = '<p style="color:#94a3b8;">No reports for this filter.</p>';
        return;
      }
      ceoCloseOutList.innerHTML = filtered.map(report => {
        const when = formatMST(report.generatedAt);
        const venueName = report.venue === "all"
          ? "All venues"
          : (venuesInfo[report.venue]?.name || report.venue || "Venue");
        const totals = report.totals || {};
        return `
          <div class="log-row ceo-closeout-row" data-report-id="${report.id}">
            <strong>${venueName}</strong>
            <div style="color:#cbd5f5;">Close-out Â· ${when}</div>
            <div class="log-meta" style="gap:12px;">
              <span>Verified: ${totals.verified || 0}</span>
              <span>Pending: ${totals.pending || 0}</span>
              <span>Unique guests: ${totals.uniqueMembers || 0}</span>
              ${totals.topPerk ? `<span>Top perk: ${totals.topPerk}</span>` : ""}
              ${totals.peakHour ? `<span>Peak hour: ${totals.peakHour}</span>` : ""}
            </div>
            <div style="display:flex;gap:10px;align-items:center;margin-top:6px;flex-wrap:wrap;">
              <span style="color:#94a3b8;font-size:12px;">Tap to view details</span>
              <button type="button" class="btn btn-secondary closeout-download" data-report-download="${report.id}">Download PDF</button>
            </div>
          </div>
        `;
      }).join("\n");
    }
    function openCeoCloseOutModal(report) {
      if (!ceoCloseOutModal || !ceoCloseOutContent || !report) return;
      ceoCloseOutContent.innerHTML = buildCloseOutSummaryHtml(report);
      ceoCloseOutModal.classList.add("active");
    }
    function closeCeoCloseOutModal() {
      if (!ceoCloseOutModal) return;
      ceoCloseOutModal.classList.remove("active");
      if (ceoCloseOutContent) ceoCloseOutContent.innerHTML = "";
    }
    function resolveVenueId(input) {
      const norm = (input || "").trim().toLowerCase();
      if (!norm) return "";
      if (venueAliases[norm]) return venueAliases[norm];
      if (venuesInfo[norm]) return norm;
      const found = Object.entries(venuesInfo).find(([, info]) => {
        const name = (info.name || "").toLowerCase();
        return name === norm || name.includes(norm);
      });
      return found ? found[0] : norm;
    }
    function getUserRatingKey() {
      return firebaseAuth.currentUser?.uid || (currentPassCode || "").toUpperCase();
    }
    function getVenueAverage(venueId) {
      if (!venueId) return null;
      const ratings = loadVenueRatings();
      const entry = ratings[venueId];
      if (!entry || !entry.count) return null;
      return (entry.total || 0) / entry.count;
    }
    function getTopRatedVenueId() {
      const ratings = loadVenueRatings();
      let best = null;
      Object.entries(ratings).forEach(([vid, data]) => {
        if (!data || !data.count) return;
        const avg = (data.total || 0) / data.count;
        if (!best || avg > best.avg) {
          best = { vid, avg };
        }
      });
      return best ? best.vid : null;
    }
    function renderVenueButtons() {
      venueButtons.forEach(btn => {
        const vid = btn.dataset.venue;
        const avg = getVenueAverage(vid);
        let label = btn.textContent.split("â˜…")[0].trim();
        btn.innerHTML = `<span>${label}</span>` + (avg ? `<span class="venue-rating-pill">â˜… ${avg.toFixed(1)}</span>` : "");
      });
    }
    function submitVenueRating(venueId, stars) {
      if (!venueId || !stars) return;
      const ratings = loadVenueRatings();
      const userRatings = loadUserVenueRatings();
      const userKey = getUserRatingKey();
      const prev = (userRatings[userKey] || {})[venueId] || 0;
      const entry = ratings[venueId] || { total: 0, count: 0 };
      if (prev) {
        entry.total -= prev;
        entry.count = Math.max(0, entry.count - 1);
      }
      entry.total += stars;
      entry.count += 1;
      ratings[venueId] = entry;
      userRatings[userKey] = userRatings[userKey] || {};
      userRatings[userKey][venueId] = stars;
      saveVenueRatings(ratings);
      saveUserVenueRatings(userRatings);
      renderVenueButtons();
      renderFeaturedVenuesGrid();
      renderPassFeaturedGrid();
      const avg = getVenueAverage(venueId);
      if (venueDetailRating) {
        if (avg) {
          venueDetailRating.style.display = "inline-flex";
          venueDetailRating.textContent = `â˜… ${avg.toFixed(1)} (${entry.count})`;
        } else {
          venueDetailRating.style.display = "none";
        }
      }
      showToast("Thanks for rating!");
    }

    let staffGateVerified = false;
    let staffGateCodeValue = "";

    function openStaffGate() {
      if (!staffGateOverlay) return;
      staffGateVerified = false;
      staffGateCodeValue = "";
      staffGateOverlay.classList.add("active");
      if (staffGateError) staffGateError.textContent = "";
      if (staffGateCode) {
        staffGateCode.value = "";
        staffGateCode.focus();
      }
    }

    function closeStaffGate() {
      if (!staffGateOverlay) return;
      staffGateOverlay.classList.remove("active");
      if (staffGateError) staffGateError.textContent = "";
    }

    function confirmStaffGate() {
      if (!staffGateCode) return;
      const entered = staffGateCode.value.trim();
      if (!entered) {
        if (staffGateError) staffGateError.textContent = "Enter the staff access code.";
        return;
      }
      staffGateCodeValue = entered;
      staffGateVerified = true;
      closeStaffGate();
      if (staffVenueInput) staffVenueInput.focus();
    }

    function applyStaffSession(venueId) {
      const resolved = resolveVenueId(venueId);
      if (!resolved) return { success: false, message: "Enter a venue code." };
      staffSession = { venue: resolved, at: new Date().toISOString() };
      localStorage.setItem("staffSession", JSON.stringify(staffSession));
      persistMemberState({ staffSession });
      const venueExists = venuesInfo[resolved];
      const venueName = venueExists ? venuesInfo[resolved].name : (resolved === "beta" ? "FoCo Beta Venue" : "Your venue");
      staffVenueLabel.textContent = venueName;
      if (staffPortalTitle) staffPortalTitle.innerHTML = `<span>${venueName}</span> Dashboard`;
      if (staffPortalTagline) staffPortalTagline.textContent = `Live perks, redemptions, and alerts for ${venueName}.`;
      renderStaffVenueLog();
      renderStaffVipDeal();
      refreshStaffCeoReceipts();
      return { success: true, venueId: resolved };
    }
    async function handlePendingScanVerification() {
      if (!pendingScanVerify || !staffSession) return;
      const code = pendingScanVerify;
      if (scanPortalAlert) {
        scanPortalAlert.style.display = "";
        scanPortalAlert.textContent = `Verifying pass ${code}â€¦`;
      }
      setPendingScan(null, { autoVerify: false });
      const venueId = staffSession.venue;
      const result = await verifyPassId(code, venueId, { label: "Pass verification (QR)" });
      if (!result.success) {
        if (verifyError) verifyError.textContent = result.message;
      } else {
        if (verifyError) verifyError.textContent = "";
        showNeonSuccess(verifySuccess, `Verified ${code}`, 4200);
        logStaffVerification(result.entry);
      }
      updatePendingScanAlerts();
    }

    // Do not auto-reuse staff sessions after logout; require explicit login each time.
    const storedStaff = null;

    function stopStaffMessagesListener() {
      if (staffMessagesUnsub) {
        staffMessagesUnsub();
        staffMessagesUnsub = null;
      }
      renderStaffMessages([]);
    }
    function stopCloseOutReportsListener() {
      if (closeOutReportsUnsub) {
        closeOutReportsUnsub();
        closeOutReportsUnsub = null;
      }
    }
    function attachCloseOutReportsRealtime() {
      if (!db || !isCeoAccount) return;
      stopCloseOutReportsListener();
      const q = query(
        collection(db, "closeOutReports"),
        orderBy("generatedAt", "desc"),
        limit(200)
      );
      closeOutReportsUnsub = onSnapshot(q, (snap) => {
        const reports = [];
        snap.forEach(docSnap => {
          const data = docSnap.data() || {};
          const generatedAt = data.generatedAt?.toDate ? data.generatedAt.toDate().toISOString() : data.generatedAt;
          const venueName = data.venueName || (data.venue === "all"
            ? "All venues"
            : (venuesInfo[data.venue]?.name || data.venue || "Venue"));
          let totals = data.totals;
          if (!totals && data.summary) {
            totals = {
              verified: data.summary.scansToday || 0,
              pending: 0,
              uniqueMembers: data.summary.uniqueGuests || 0,
              topPerk: data.summary.topPerk || "None",
              peakHour: data.summary.peakHour || "n/a",
              byPerk: data.summary.byPerk || {}
            };
          }
          reports.push({
            id: docSnap.id,
            ...data,
            generatedAt: generatedAt || new Date().toISOString(),
            venueName,
            totals: totals || {},
            items: data.items || [],
            windowLabel: data.windowLabel || (data.summary ? "Window: last 24 hours" : data.windowLabel)
          });
        });
        closeOutReports = reports;
        renderCeoCloseOutReports();
      }, (err) => {
        console.warn("closeOutReports realtime failed", err);
      });
    }
    function startStaffMessagesListener(venueId) {
      if (!venueId || !db) return;
      stopStaffMessagesListener();
      const q = query(
        collection(db, "staffMessages"),
        where("venueId", "==", venueId)
      );
      staffMessagesUnsub = onSnapshot(q, (snap) => {
        const msgs = [];
        snap.forEach((docSnap) => {
          const data = docSnap.data() || {};
          if (data.deletedByStaff) return;
          msgs.push({ id: docSnap.id, ...data });
        });
        renderStaffMessages(msgs);
      }, () => {
        renderStaffMessages([]);
      });
    }
    function stopCeoMessagesListener() {
      if (ceoMessagesUnsub) {
        ceoMessagesUnsub();
        ceoMessagesUnsub = null;
      }
      renderCeoMessages([]);
    }
    function startCeoMessagesListener() {
      if (!isCeoAccount || !db) return;
      stopCeoMessagesListener();
      const q = query(
        collection(db, "staffMessages"),
        orderBy("createdAt", "desc"),
        limit(50)
      );
      ceoMessagesUnsub = onSnapshot(q, (snap) => {
        const msgs = [];
        snap.forEach((docSnap) => {
          const data = docSnap.data() || {};
          if (data.deletedByCeo) return;
          msgs.push({ id: docSnap.id, ...data });
        });
        renderCeoMessages(msgs);
      }, () => renderCeoMessages([]));
    }

    async function processStaffLogin() {
      staffLoginError.textContent = "";
      if (!staffGateVerified) {
        openStaffGate();
        staffLoginError.textContent = "Enter staff access code to continue.";
        return;
      }
      const venue = staffVenueInput.value.trim();
      const pass = staffPassInput.value.trim();
      if (!venue || !pass) {
        staffLoginError.textContent = "Enter your venue code and passphrase.";
        return;
      }
      if (!functionsClient) {
        staffLoginError.textContent = "Staff login is unavailable. Try again shortly.";
        return;
      }
      let venueId = resolveVenueId(venue);
      let token = null;
      let fallbackEmail = null;
      try {
        const fn = httpsCallable(functionsClient, "getStaffLoginToken");
        const resp = await fn({
          accessCode: staffGateCodeValue,
          venue: venueId || venue,
          passphrase: pass
        });
        const data = resp?.data || {};
        token = data.token || null;
        venueId = data.venueId || venueId || venue;
        fallbackEmail = data.fallback && data.email ? data.email : null;
        if (!token && !fallbackEmail) throw new Error("Staff login is unavailable.");
      } catch (err) {
        console.warn("getStaffLoginToken failed", err);
        const code = err?.code || "";
        if (code.includes("permission-denied")) {
          staffLoginError.textContent = "Invalid staff access code or passphrase.";
        } else if (code.includes("failed-precondition")) {
          staffLoginError.textContent = err?.message || "Staff login is not configured yet.";
        } else if (code.includes("not-found")) {
          staffLoginError.textContent = "Unknown venue code. Use 'beta' to demo.";
        } else {
          staffLoginError.textContent = err?.message || "Staff login failed. Try again.";
        }
        return;
      }
      if (fallbackEmail) {
        try {
          await signInWithEmailAndPassword(firebaseAuth, fallbackEmail, pass);
        } catch (err) {
          console.warn("Staff fallback sign-in failed", err);
          staffLoginError.textContent = "Staff auth failed. Try again.";
          return;
        }
      } else {
        try {
          await signInWithCustomToken(firebaseAuth, token);
        } catch (err) {
          console.warn("Staff token sign-in failed", err);
          staffLoginError.textContent = "Staff auth failed. Try again.";
          return;
        }
      }
      const result = applyStaffSession(venueId);
      if (!result.success) {
        staffLoginError.textContent = result.message;
        return;
      }
      const venueName = venuesInfo[venueId]?.name || (venueId === "beta" ? "FoCo Beta Venue" : "Your venue");
      if (staffVenueChip) staffVenueChip.textContent = venueName;
      if (staffVenueLabel) staffVenueLabel.textContent = venueName;
      if (staffPortalTitle) staffPortalTitle.innerHTML = `<span>${venueName}</span> Dashboard`;
      if (staffPortalTagline) staffPortalTagline.textContent = `Live perks, redemptions, and alerts for ${venueName}.`;
      setRadarGraffiti(venueName);
      const staffAccent = loadStaffAccent(venueId) || "magenta";
      applyStaffAccent(staffAccent);
      staffVenueInput.value = "";
      staffPassInput.value = "";
      staffGateCodeValue = "";
      staffGateVerified = false;
      localStorage.removeItem(ACCENT_KEY);
      attachGlobalRealtime();
      renderStaffVenueLog();
      renderStaffVipDeal();
      renderStaffAlertPreview();
      renderStaffDealCodes();
      startStaffPerksListener(venueId);
      refreshStaffCeoReceipts();
      updateStaffKpis(tonightAlerts.filter(a => a.venueId === venueId).length, !!vipDealsCache[venueId]);
      scheduleAutoCloseOut();
      showScreen("staffPortal");
      if (verifyCodeInput) verifyCodeInput.focus();
      handlePendingScanVerification();
      startIdleTimer();
      loadBackgroundTheme();
      updateStaffCloseoutStamp();
      startStaffMessagesListener(venueId);
    }

    staffLoginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      processStaffLogin();
    });
    if (staffLoginSubmit) {
      staffLoginSubmit.addEventListener("click", (e) => {
        e.preventDefault();
        processStaffLogin();
      });
    }
    if (staffGateAccept) {
      staffGateAccept.addEventListener("click", () => {
        confirmStaffGate();
      });
    }
    if (staffGateCode) {
      staffGateCode.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          confirmStaffGate();
        }
      });
    }
    if (staffGateCancel) {
      staffGateCancel.addEventListener("click", () => {
        staffGateVerified = false;
        closeStaffGate();
        showScreen("landing");
      });
    }

    const handleStaffLogout = () => {
      staffSession = null;
      localStorage.removeItem("staffSession");
      staffGateVerified = false;
      if (memberProfile) {
        memberProfile.staffSession = null;
      }
      stopStaffMessagesListener();
      setRadarGraffiti("Live Floor");
      staffVenueReceipts = [];
      renderStaffSentReceipts();
      renderStaffVipDeal();
      renderStaffAlertPreview();
      applyStaffAccent("magenta");
      stopStaffPerksListener();
      if (staffPerksList) staffPerksList.innerHTML = "";
      if (staffAccentButtons && staffAccentButtons.length) {
        staffAccentButtons.forEach(btn => btn.classList.remove("active"));
      }
      if (autoCloseOutTimer) {
        clearTimeout(autoCloseOutTimer);
        autoCloseOutTimer = null;
      }
      stopStaffRedemptionListener();
      showScreen("landing");
      stopIdleTimer();
      if (autoCloseOutTimer) {
        clearTimeout(autoCloseOutTimer);
        autoCloseOutTimer = null;
      }
    };

    if (staffLogoutLink) {
      staffLogoutLink.addEventListener("click", handleStaffLogout);
    }
    const staffLogoutTop = document.getElementById("staffLogoutTop");
    if (staffLogoutTop) {
      staffLogoutTop.addEventListener("click", handleStaffLogout);
    }
      if (staffAccentButtons && staffAccentButtons.length) {
        staffAccentButtons.forEach(btn => {
          btn.addEventListener("click", () => {
            if (!staffSession) return;
            const theme = btn.dataset.staffAccent;
            setStaffAccent(theme, staffSession.venue);
          });
        });
      }
      if (staffAddPerkBtn) {
        staffAddPerkBtn.addEventListener("click", () => {
          if (!staffPerksList) return;
          clearStaffPerksNotices();
          if (!staffPerksList.querySelector(".staff-perk-row")) {
            staffPerksList.innerHTML = "";
          }
          staffPerksList.appendChild(buildStaffPerkRow({}));
        });
      }
      if (staffSavePerksBtn) {
        staffSavePerksBtn.addEventListener("click", () => {
          saveStaffPerks();
        });
      }

    if (landingStaffLogin) {
      landingStaffLogin.addEventListener("click", () => {
        if (staffSession) {
          const venueName = venuesInfo[staffSession.venue]?.name || "Your venue";
          if (staffVenueChip) staffVenueChip.textContent = venueName;
          attachGlobalRealtime();
          renderStaffVenueLog();
          refreshStaffCeoReceipts();
          startStaffPerksListener(staffSession.venue);
          startStaffRedemptionListener(staffSession.venue);
          showScreen("staffPortal");
        } else {
          showScreen("staffLogin");
        }
      });
    }

    staffLoginBack.addEventListener("click", () => {
      showScreen("landing");
    });

    // Alert audience pills + detail counter
    if (alertAudiencePills && alertAudience) {
      const setActiveAudience = (value) => {
        Array.from(alertAudiencePills.querySelectorAll("button")).forEach(btn => {
          btn.classList.toggle("active", btn.dataset.audience === value);
        });
      };
      alertAudiencePills.addEventListener("click", (e) => {
        const pill = e.target.closest("[data-audience]");
        if (!pill) return;
        const value = pill.dataset.audience;
        alertAudience.value = value;
        setActiveAudience(value);
      });
      // initialize active state based on hidden value (defaults to "all")
      setActiveAudience(alertAudience.value || "all");
    }
    if (alertDetailInput && alertDetailCount) {
      const syncDetailCount = () => {
        const max = 140;
        if (alertDetailInput.value.length > max) {
          alertDetailInput.value = alertDetailInput.value.slice(0, max);
        }
        alertDetailCount.textContent = `${alertDetailInput.value.length}/${max}`;
      };
      alertDetailInput.addEventListener("input", syncDetailCount);
      syncDetailCount();
    }
    function closeStaffCloseOutModal() {
      if (pendingCloseOutReport) {
        persistCloseOutReport(pendingCloseOutReport);
      }
      if (staffCloseOutModal) staffCloseOutModal.classList.remove("active");
      staffCloseOutStatus.textContent = "";
      pendingCloseOutReport = null;
    }
    if (staffCloseOutBtn) {
      staffCloseOutBtn.addEventListener("click", () => {
        openStaffCloseOut();
      });
    }
    if (staffCloseOutDone) {
      staffCloseOutDone.addEventListener("click", closeStaffCloseOutModal);
    }
    if (staffCloseOutDoneFooter) {
      staffCloseOutDoneFooter.addEventListener("click", closeStaffCloseOutModal);
    }
    if (staffCloseOutSend) {
      staffCloseOutSend.addEventListener("click", async () => {
        const report = pendingCloseOutReport || buildCloseOutReport();
        if (!report) {
          staffCloseOutStatus.textContent = "No redemptions to close out.";
          return;
        }
        staffCloseOutStatus.textContent = "Sending reportâ€¦";
        const sent = await sendCloseOutEmail(report);
        persistCloseOutReport(report);
        await persistCloseOutReportToCloud(report);
        renderCeoCloseOutReports();
        if (sent) {
          markAutoCloseOutSent(staffSession?.venue);
        }
        staffCloseOutStatus.textContent = sent ? "Report sent to focoafterdark@gmail.com." : "Report saved locally. Email delivery failed.";
      });
    }
    if (staffVenueLog) {
      staffVenueLog.addEventListener("click", async (e) => {
        const pill = e.target.closest(".status-pill-sm.pending");
        if (!pill) return;
        const code = pill.dataset.code;
        if (!code) return;
        const venueId = staffSession ? staffSession.venue : null;
        const result = await verifyCode(code, venueId);
        if (!result.success) {
          verifyError.textContent = result.message;
        } else {
          verifyError.textContent = "";
          showNeonSuccess(verifySuccess, "Voucher verified.", 4600);
          logStaffVerification(result.entry);
          if (lastVerifiedLine) {
            const ts = formatMST(result.entry.timestamp || Date.now());
            lastVerifiedLine.textContent = `Last verified: ${result.entry.code} â€¢ ${ts}`;
            lastVerifiedLine.style.display = "block";
          }
        }
      });
    }
    if (staffDealCodeList) {
      staffDealCodeList.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-gen-deal]");
        if (!btn || !staffSession) return;
        const alertId = btn.dataset.genDeal;
        const alert = tonightAlerts.find(a => a.id === alertId);
        if (!alert) return;
        const code = generateVenueDealCode(alert);
        renderStaffDealCodes();
        showNeonSuccess(verifySuccess, `Deal code ${code} generated.`, 4200);
      });
    }
    if (buyDrinksBtn) {
      buyDrinksBtn.addEventListener("click", openVoucherModal);
    }
    voucherCancel.addEventListener("click", () => {
      pendingVoucherPack = null;
      resetVoucherPaymentState();
      voucherModal.classList.remove("active");
    });
    voucherModal.addEventListener("click", (e) => {
      if (e.target === voucherModal) {
        pendingVoucherPack = null;
        resetVoucherPaymentState();
        voucherModal.classList.remove("active");
      }
    });
    if (voucherBackBtn) {
      voucherBackBtn.addEventListener("click", () => {
        pendingVoucherPack = null;
        resetVoucherPaymentState();
        voucherStepPayment.style.display = "none";
        voucherStepPacks.style.display = "block";
      });
    }
    function isCeoCredentials(email, password) {
      return email.trim().toLowerCase() === "ceo@gmail.com" && password.trim().toUpperCase() === "CEOCEO";
    }
    function enterCeoPortal() {
      ceoSession = true;
      isCeoAccount = true;
      ceoPreviewTier = null;
      localStorage.setItem("ceoSession", "true");
      extraVouchers = { drink: 999, shot: 999, cover: 999 };
      saveExtraVouchers();
      applyMembershipToPass("vip");
      updateCeoPassUI();
      if (userMiniDisplay) userMiniDisplay.textContent = "@FoCoCEO";
      passUserName.textContent = "FoCo CEO";
      avatarInitials.textContent = "CEO";
      passTierText.textContent = "VIP CEO Black Card";
      renderCeoIssued();
      attachCeoReviewsRealtime();
      renderCeoReviews();
      showScreen("pass");
      startIdleTimer();
      document.body.classList.add("ceo-active");
      loadAccentTheme();
      loadBackgroundTheme();
    }

    ceoPassButton.addEventListener("click", () => {
      const code = ensureCeoCardCode();
      ceoCardCode.textContent = code;
      ceoCardModal.classList.add("active");
    });
    ceoCardClose.addEventListener("click", () => ceoCardModal.classList.remove("active"));
    ceoCardModal.addEventListener("click", (e) => {
      if (e.target === ceoCardModal) ceoCardModal.classList.remove("active");
    });
    ceoPortalBack.addEventListener("click", () => {
      showScreen("pass");
    });
    if (ceoPortalShortcut) {
      ceoPortalShortcut.addEventListener("click", () => {
        renderCeoIssued();
        showScreen("ceoPortal");
      });
    }
    if (ceoGenButtons && ceoGenButtons.length) {
      ceoGenButtons.forEach(btn => {
        btn.addEventListener("click", async () => {
          const perkId = btn.dataset.ceoGenPerk;
          const labelMap = {
            shot: "Shot perk voucher",
            drink: "Drink perk voucher",
            cover: "Line access voucher",
            free_drink: "Free drink voucher"
          };
          // Try server-side generation first (callable function). If it fails, fallback to local generation.
          let usedCode = null;
          try {
            // 1) Try Firebase Functions callable if available
            if (functionsClient) {
              await ensureFirebaseUser();
              const fn = httpsCallable(functionsClient, 'generateCeoVoucher');
              const resp = await fn({ perk: perkId });
              if (resp && resp.data && resp.data.code) {
                usedCode = String(resp.data.code).toUpperCase();
                ceoGeneratedCodes.unshift({
                  code: usedCode,
                  perkKey: `ceo_${perkId}`,
                  perk: `CEO issued: ${labelMap[perkId] || "Voucher"}`,
                  timestamp: new Date().toISOString()
                });
                saveCeoGeneratedCodes();
                renderCeoIssued();
                if (ceoGenSuccess) {
                  ceoGenSuccess.style.display = "block";
                  ceoGenSuccess.textContent = `Code ${usedCode} Â· ${labelMap[perkId] || "Voucher"} ready to share.`;
                  setTimeout(() => { ceoGenSuccess.style.display = "none"; }, 4200);
                }
                // Visual reward
                burstConfetti();
                // flash latest list item
                setTimeout(() => {
                  const first = ceoIssuedList && ceoIssuedList.firstElementChild;
                  if (first) {
                    first.classList.add('pop');
                    setTimeout(() => first.classList.remove('pop'), 900);
                  }
                }, 80);
                return;
              }
            }
            // 2) Try external server endpoint if configured
            if (window.SERVER_API_ORIGIN) {
              await ensureFirebaseUser();
              const user = firebaseAuth.currentUser;
              const token = user ? await user.getIdToken() : null;
              const resp = await fetch(`${window.SERVER_API_ORIGIN.replace(/\/$/, '')}/generateCeoVoucher`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': token ? `Bearer ${token}` : ''
                },
                body: JSON.stringify({ perk: perkId })
              });
              if (resp.ok) {
                const data = await resp.json();
                if (data && data.code) {
                  usedCode = String(data.code).toUpperCase();
                  ceoGeneratedCodes.unshift({
                    code: usedCode,
                    perkKey: `ceo_${perkId}`,
                    perk: `CEO issued: ${labelMap[perkId] || "Voucher"}`,
                    timestamp: new Date().toISOString()
                  });
                  saveCeoGeneratedCodes();
                  renderCeoIssued();
                  if (ceoGenSuccess) {
                    ceoGenSuccess.style.display = "block";
                    ceoGenSuccess.textContent = `Code ${usedCode} Â· ${labelMap[perkId] || "Voucher"} ready to share.`;
                    setTimeout(() => { ceoGenSuccess.style.display = "none"; }, 4200);
                  }
                  // Visual reward
                  burstConfetti();
                  setTimeout(() => {
                    const first = ceoIssuedList && ceoIssuedList.firstElementChild;
                    if (first) {
                      first.classList.add('pop');
                      setTimeout(() => first.classList.remove('pop'), 900);
                    }
                  }, 80);
                  return;
                }
              } else {
                console.warn('Server endpoint returned', resp.status);
              }
            }
          } catch (err) {
            console.warn('generateCeoVoucher function failed, falling back to local generation', err);
          }
          // Fallback local generation (offline or function failure)
          const fallback = generateRedemptionCode();
          const fallbackCode = fallback.toUpperCase();
          ceoGeneratedCodes.unshift({
            code: fallbackCode,
            perkKey: `ceo_${perkId}`,
            perk: `CEO issued: ${labelMap[perkId] || "Voucher"}`,
            timestamp: new Date().toISOString()
          });
          saveCeoGeneratedCodes();
          renderCeoIssued();
          if (ceoGenSuccess) {
            ceoGenSuccess.style.display = "block";
            ceoGenSuccess.textContent = `Code ${fallbackCode} Â· ${labelMap[perkId] || "Voucher"} (offline fallback)`;
            setTimeout(() => { ceoGenSuccess.style.display = "none"; }, 4200);
          }
          // Visual reward for fallback
          burstConfetti();
          setTimeout(() => {
            const first = ceoIssuedList && ceoIssuedList.firstElementChild;
            if (first) {
              first.classList.add('pop');
              setTimeout(() => first.classList.remove('pop'), 900);
            }
          }, 80);
        });
      });
    }
    if (refreshFreeMembers) {
      refreshFreeMembers.addEventListener("click", refreshFreeMembersList);
      refreshFreeMembersList();
    }
    if (grantFreeBtn) {
      grantFreeBtn.addEventListener("click", () => {
        const value = freePassIdInput?.value || "";
        setFreeMembershipForPass(value, true);
      });
    }
    if (revokeFreeBtn) {
      revokeFreeBtn.addEventListener("click", () => {
        const value = freePassIdInput?.value || "";
        setFreeMembershipForPass(value, false);
      });
    }
    if (manageBillingBtn) {
      manageBillingBtn.addEventListener("click", async () => {
        if (!functionsClient) {
          showToast("Billing not available right now.");
          return;
        }
        showToast("Opening billing portalâ€¦");
        try {
          const callable = httpsCallable(functionsClient, "createBillingPortalSession");
          const resp = await callable({ returnUrl: window.location.href });
          if (resp?.data?.url) {
            window.location.href = resp.data.url;
          } else {
            showToast("Billing portal unavailable.");
          }
        } catch (err) {
          console.warn("Billing portal error", err);
          showToast("Billing portal failed. Try again later.");
        }
      });
    }
    if (ceoPreviewStandardBtn) {
      ceoPreviewStandardBtn.addEventListener("click", () => startCeoPreview("standard"));
    }
    if (ceoPreviewVipBtn) {
      ceoPreviewVipBtn.addEventListener("click", () => startCeoPreview("vip"));
    }
    if (ceoPreviewReturnBtn) {
      ceoPreviewReturnBtn.addEventListener("click", endCeoPreview);
    }
    if (betaResetBtn && ceoResetCard) {
      betaResetBtn.addEventListener("click", async () => {
        const confirmText = prompt("Type RESET to wipe all beta data (non-CEO stats, deals, alerts, redemptions history). CEO is preserved.");
        if ((confirmText || "").trim().toUpperCase() !== "RESET") {
          return;
        }
        showToast("Wiping beta dataâ€¦");
        try {
          const toggles = Array.from(document.querySelectorAll(".beta-reset-toggle"));
          const selected = {};
          toggles.forEach(t => {
            const key = t.dataset.key;
            if (key) selected[key] = t.checked;
          });
          await performBetaReset(selected);
          showToast("Beta data cleared. Reloadingâ€¦");
          setTimeout(() => window.location.reload(), 900);
        } catch (err) {
          console.warn("Beta reset failed", err);
          showToast("Beta reset failed. Check console/logs.");
        }
      });
    }
    const betaResetSelectAll = document.getElementById("betaResetSelectAll");
    const betaResetSmart = document.getElementById("betaResetSmart");
    if (betaResetSelectAll) {
      betaResetSelectAll.addEventListener("click", () => {
        document.querySelectorAll(".beta-reset-toggle").forEach(cb => cb.checked = true);
      });
    }
    if (betaResetSmart) {
      betaResetSmart.addEventListener("click", () => {
        // "AI smart select": keep alerts/deals if youâ€™re mid-campaign; default wipes stats + redemptions + closeouts + freeMemberships
        document.querySelectorAll(".beta-reset-toggle").forEach(cb => {
          const key = cb.dataset.key;
          cb.checked = ["members","redemptions","closeouts","freeMemberships"].includes(key);
        });
      });
    }

    function appendCeoChat(role, text) {
      if (!ceoChatHistory) return;
      const el = document.createElement("div");
      el.style.padding = "8px";
      el.style.borderRadius = "10px";
      el.style.background = role === "user" ? "rgba(34,211,238,0.08)" : "rgba(148,163,184,0.12)";
      el.style.border = "1px solid rgba(148,163,184,0.2)";
      el.innerText = text;
      ceoChatHistory.appendChild(el);
      ceoChatHistory.scrollTop = ceoChatHistory.scrollHeight;
    }

    if (ceoChatSend && ceoChatInput && ceoChatCard) {
      ceoChatSend.addEventListener("click", async () => {
        const prompt = ceoChatInput.value.trim();
        if (!prompt) return;
        appendCeoChat("user", prompt);
        ceoChatInput.value = "";
        ceoChatSend.disabled = true;
        ceoChatSend.textContent = "Thinkingâ€¦";
        try {
          const fn = httpsCallable(functionsClient, "ceoChat");
          const resp = await fn({ prompt });
          const reply = resp?.data?.reply || "No reply.";
          appendCeoChat("assistant", reply);
          if (ceoChatHistory) ceoChatHistory.scrollTop = ceoChatHistory.scrollHeight;
        } catch (err) {
          console.warn("ceoChat failed", err);
          const msg = err?.message || "AI is unavailable right now.";
          appendCeoChat("assistant", msg);
        } finally {
          ceoChatSend.disabled = false;
          ceoChatSend.textContent = "Send";
        }
      });
    }
    if (ceoChatPresetRollout && ceoChatInput && ceoChatCard) {
      ceoChatPresetRollout.addEventListener("click", () => {
        ceoChatInput.value = "Give me a launch checklist for pushing a production web update to all users (PWA/home screen) with zero downtime and post-deploy validation steps.";
      });
    }
    if (ceoChatPresetIssues && ceoChatInput && ceoChatCard) {
      ceoChatPresetIssues.addEventListener("click", () => {
        ceoChatInput.value = "Help me triage live production issues: what logs, Firestore collections, and user states should I check first?";
      });
    }

    function applyLaunchModeUI() {
      const hideBeta = isLaunched === true;
      const elements = [
        document.getElementById("skipPaymentBtn"),
        document.getElementById("onboardingSkip"),
        document.getElementById("ceoBetaSwitcher"),
        document.getElementById("staffBetaHint"),
        document.getElementById("skipLoginBeta")
      ];
      elements.forEach(el => {
        if (!el) return;
        el.style.display = hideBeta ? "none" : "";
      });
      // Update top-level body class for any CSS hooks
      document.body.classList.toggle("live-mode", hideBeta);
      if (hideBeta && betaPassMode) {
        exitBetaPassMode();
        localStorage.removeItem("betaSkipActive");
        showScreen("landing");
      }
      if (hideBeta && isBetaAccount) {
        signOut(firebaseAuth).catch(() => {});
        showScreen("landing");
      }
      if (ceoSystemHealthCard) {
        ceoSystemHealthCard.style.display = isCeoAccount ? "" : "none";
      }
    }

    function applyAppLockState() {
      const locked = appLocked === true;
      const isCeo = isCeoAccount === true;
      const shouldBlock = locked && !isCeo;
      if (!locked) {
        appLockOverride = false;
      }
      if (appLockOverlay) {
        appLockOverlay.classList.toggle("active", shouldBlock && !appLockOverride);
      }
      if (ceoAppLockStatus) {
        const stamp = appLockedAt?.toDate
          ? appLockedAt.toDate()
          : (appLockedAt ? new Date(appLockedAt) : null);
        const stampText = stamp
          ? `Locked ${stamp.toLocaleString("en-US", { timeZone: "America/Denver" })}`
          : "No lock activity yet.";
        ceoAppLockStatus.textContent = locked ? `App is locked. ${stampText}` : "App is unlocked.";
      }
      if (ceoAppLockToggle) {
        ceoAppLockToggle.textContent = locked ? "Unlock app" : "Lock app";
        ceoAppLockToggle.classList.toggle("btn-danger", !locked);
        ceoAppLockToggle.classList.toggle("btn-secondary", locked);
      }
      if (shouldBlock && !appLockOverride) {
        if (firebaseAuth?.currentUser && !appLockSignoutPending) {
          appLockSignoutPending = true;
          signOut(firebaseAuth).catch(() => {}).finally(() => {
            appLockSignoutPending = false;
          });
        }
        detachRealtime();
        showScreen("landing");
      }
    }

    function stopHealthWatch() {
      if (ceoHealthUnsub) {
        try { ceoHealthUnsub(); } catch (_) {}
        ceoHealthUnsub = null;
      }
    }
    function watchSettingsDoc() {
      if (!db) return;
      if (settingsUnsub) {
        settingsUnsub();
        settingsUnsub = null;
      }
      if (settingsPollTimer) {
        clearInterval(settingsPollTimer);
        settingsPollTimer = null;
      }
      const ref = doc(db, "settings", "app");
      settingsUnsub = onSnapshot(ref, (snap) => {
        const data = snap.exists() ? snap.data() : {};
        isLaunched = !!data.launched;
        appLocked = !!data.appLocked;
        appLockedAt = data.appLockedAt || null;
        if (isLaunched && betaPassMode) {
          exitBetaPassMode();
          localStorage.removeItem("betaSkipActive");
        }
        refreshFeaturedVenuesData();
        applyLaunchModeUI();
        applyAppLockState();
        const serverVersion = data.version || null;
        if (serverVersion && serverVersion !== BUILD_VERSION) {
          showToast("New update available. Reloadingâ€¦");
          setTimeout(() => location.reload(), 1200);
        }
        if (data.lastCloseoutEmail && staffCloseoutStamp) {
          const ts = data.lastCloseoutEmail.toDate ? data.lastCloseoutEmail.toDate() : new Date(data.lastCloseoutEmail);
          staffCloseoutStamp.textContent = `Last close-out email: ${ts.toLocaleString("en-US", { timeZone: "America/Denver" })}`;
        }
      }, (err) => {
        console.warn("Settings listener failed", err);
      });
    }

    let appStatsUnsub = null;
    let recountMembersAttempted = false;
    async function maybeRecountMembers() {
      if (recountMembersAttempted) return;
      if (!functionsClient || !isCeoAccount) return;
      recountMembersAttempted = true;
      try {
        const fn = httpsCallable(functionsClient, "recountMembers");
        const res = await fn();
        const count = Number(res?.data?.membersCount || 0);
        if (currentUsersCount && Number.isFinite(count)) {
          currentUsersCount.textContent = count.toLocaleString();
        }
      } catch (err) {
        recountMembersAttempted = false;
        console.warn("recountMembers failed", err);
      }
    }
    function watchAppStatsDoc() {
      if (!db || !currentUsersCount) return;
      if (appStatsUnsub) {
        appStatsUnsub();
        appStatsUnsub = null;
      }
      const ref = doc(db, "settings", "appStats");
      appStatsUnsub = onSnapshot(ref, (snap) => {
        const data = snap.exists() ? snap.data() : {};
        const count = Number(data.membersCount || 0);
        currentUsersCount.textContent = count.toLocaleString();
        if ((!snap.exists() || count === 0) && isCeoAccount) {
          maybeRecountMembers();
        }
      }, (err) => {
        console.warn("App stats listener failed", err);
      });
    }

    async function checkVersionOnLaunch(options = {}) {
      const { forceReload = false } = options;
      try {
        const resp = await fetch(`/version.json?v=${Date.now()}`, { cache: "no-store" });
        if (!resp.ok) return;
        const data = await resp.json();
        const serverVersion = (data?.version || "").toString();
        if (serverVersion && serverVersion !== BUILD_VERSION) {
          if (typeof showToast === "function") {
            showToast("New update available. Reloadingâ€¦");
          }
          setTimeout(() => {
            const url = new URL(window.location.href);
            url.searchParams.set("v", serverVersion);
            window.location.replace(url.toString());
          }, 600);
          return;
        }
        if (forceReload) {
          if (typeof showToast === "function") {
            showToast("Refreshing to check for updatesâ€¦", 1200);
          }
          setTimeout(() => {
            const url = new URL(window.location.href);
            url.searchParams.set("r", Date.now().toString());
            window.location.replace(url.toString());
          }, 500);
        }
      } catch (err) {
        console.warn("Version check failed", err);
      }
    }

    function refreshOnLaunch() {
      const key = "launch_refresh_once";
      try {
        if (sessionStorage.getItem(key)) return;
        sessionStorage.setItem(key, "1");
      } catch (_) {}
      if (navigator.serviceWorker?.getRegistration) {
        navigator.serviceWorker.getRegistration()
          .then(reg => reg?.update())
          .catch(() => {});
      }
      checkVersionOnLaunch({ forceReload: true });
    }

    async function loadLaunchMode() {
      if (!functionsClient || !isCeoAccount) return;
      try {
        const fn = httpsCallable(functionsClient, "getLaunchMode");
        const resp = await fn({});
        const data = resp?.data || {};
        isLaunched = !!data.launched;
        if (ceoLaunchStatus) {
          ceoLaunchStatus.textContent = isLaunched ? "Live mode (beta features hidden)" : "Beta mode (testing enabled)";
        }
        applyLaunchModeUI();
      } catch (err) {
        console.warn("launchMode load failed", err);
        if (ceoLaunchStatus) ceoLaunchStatus.textContent = "Could not load mode.";
      }
    }

    if (ceoLaunchToggle) {
      ceoLaunchToggle.addEventListener("click", async () => {
        if (!functionsClient) return;
        ceoLaunchToggle.disabled = true;
        ceoLaunchToggle.textContent = "Updatingâ€¦";
        try {
          const fn = httpsCallable(functionsClient, "setLaunchMode");
          const resp = await fn({ launched: !isLaunched });
          const data = resp?.data || {};
          isLaunched = !!data.launched;
          if (ceoLaunchStatus) {
            ceoLaunchStatus.textContent = isLaunched ? "Live mode (beta features hidden)" : "Beta mode (testing enabled)";
          }
          applyLaunchModeUI();
          // Force refresh and logout so the new mode applies immediately
          if (firebaseAuth?.currentUser) {
            try { await signOut(firebaseAuth); } catch (err) { console.warn("Signout after toggle failed", err); }
          }
          setTimeout(() => location.reload(), 400);
        } catch (err) {
          console.warn("setLaunchMode failed", err);
          showToast("Could not update launch mode");
        } finally {
          ceoLaunchToggle.disabled = false;
          ceoLaunchToggle.textContent = "Toggle";
        }
      });
    }

    if (ceoAppLockToggle) {
      ceoAppLockToggle.addEventListener("click", async () => {
        if (!functionsClient) return;
        if (!firebaseAuth?.currentUser) {
          showToast("Sign in as CEO to lock or unlock the app.");
          return;
        }
        const nextLocked = !appLocked;
        const promptText = nextLocked ? "Enter CEO app lock code to lock the app" : "Enter CEO app lock code to unlock the app";
        const code = window.prompt(promptText, "");
        if (!code) return;
        ceoAppLockToggle.disabled = true;
        ceoAppLockToggle.textContent = "Updatingâ€¦";
        try {
          await firebaseAuth.currentUser.getIdToken(true);
          const fn = httpsCallable(functionsClient, "setAppLock");
          const resp = await fn({ locked: nextLocked, code });
          appLocked = !!resp?.data?.appLocked;
          appLockOverride = false;
          applyAppLockState();
        } catch (err) {
          console.warn("setAppLock failed", err);
          const errCode = err?.code || err?.message || "";
          if (errCode.includes("failed-precondition")) {
            showToast("App lock code is not configured yet.");
          } else if (errCode.includes("permission-denied") || errCode.includes("unauthenticated")) {
            showToast("Only the CEO can lock or unlock the app.");
          } else if (errCode) {
            showToast(`Could not update app lock (${errCode})`);
          } else {
            showToast("Could not update app lock");
          }
        } finally {
          ceoAppLockToggle.disabled = false;
          applyAppLockState();
        }
      });
    }

    if (appLockCeoAccess) {
      appLockCeoAccess.addEventListener("click", async () => {
        const entered = window.prompt("Enter CEO access password", "");
        if (!entered) {
          showToast("Password required.");
          return;
        }
        if (!functionsClient) {
          showToast("CEO access is unavailable right now.");
          return;
        }
        try {
          const fn = httpsCallable(functionsClient, "verifyCeoAccess");
          const resp = await fn({ code: entered.trim() });
          if (!resp?.data?.ok) throw new Error("Invalid");
        } catch (err) {
          const errCode = err?.code || err?.message || "";
          if (errCode.includes("failed-precondition")) {
            showToast("CEO access password is not configured yet.");
          } else {
            showToast("Incorrect password.");
          }
          return;
        }
        appLockOverride = true;
        if (appLockOverlay) appLockOverlay.classList.remove("active");
        authMode = "login";
        updateAuthModeText();
        if (authEmail) authEmail.value = "ceo@gmail.com";
        showScreen("auth");
        setTimeout(() => {
          if (!isCeoAccount && appLocked) {
            appLockOverride = false;
            applyAppLockState();
          }
        }, 90000);
      });
    }

    async function loadCeoMembersSummary() {
      if (!functionsClient || !isCeoAccount || !ceoMembersCard) return;
      if (ceoMembersTotals) ceoMembersTotals.textContent = "Loadingâ€¦";
      if (ceoMembersList) ceoMembersList.innerHTML = "";
      try {
        const fn = httpsCallable(functionsClient, "getMembersSummary");
        const resp = await fn({ limit: 1500 });
        const data = resp?.data || {};
        const counts = data.counts || {};
        let users = data.users || [];
        // Deduplicate by uid just in case
        if (users.length > 1) {
          const seen = new Set();
          users = users.filter(u => {
            if (!u?.uid) return true;
            if (seen.has(u.uid)) return false;
            seen.add(u.uid);
            return true;
          });
        }
        const filter = document.querySelector(".ceo-reset-card [data-ceo-filter].active");
        const filterKey = filter ? filter.getAttribute("data-ceo-filter") : "all";
        users = users.filter(u => {
          if (filterKey === "vip") return (u.tier || "").toLowerCase() === "vip";
          if (filterKey === "paused") return !!u.paused;
          if (filterKey === "past_due") return (u.paymentStatus || "").toLowerCase() === "past_due";
          return true;
        });
        const tierCounts = counts.tier || {};
        const genderCounts = counts.gender || {};
        const statusCounts = counts.status || {};
        const total = counts.total || 0;
        if (ceoMembersTotals) {
          ceoMembersTotals.textContent = `Members: ${total} Â· VIP: ${tierCounts.vip || 0} Â· Standard: ${tierCounts.standard || 0} Â· Free: ${tierCounts.free || 0} Â· Paused: ${counts.paused || 0}`;
        }
        if (ceoMembersList) {
          const rows = users.slice(0, 30).map(u => {
            const since = u.createdAt ? new Date(u.createdAt).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" }) : "";
            const status = u.paused ? "Paused" : (u.paymentStatus || "â€”");
            const cls = u.paused ? "pill danger" : "pill ghost";
            const displayName = u.username || u.passCode || u.uid || "Member";
            const idLine = u.uid ? `UID: ${u.uid}` : "";
            return `
              <div class="ceo-member-row">
                <div class="ceo-member-meta">
                  <div class="ceo-member-name">${displayName}</div>
                  <div class="ceo-member-sub">${idLine} ${idLine ? "Â·" : ""} ${u.tier || "â€”"} Â· ${u.gender || "â€”"} Â· ${since}</div>
                </div>
                <div class="ceo-member-actions">
                  <span class="${cls}">${status}</span>
                  <button type="button" class="btn btn-secondary" style="padding:6px 10px;font-size:11px;border-radius:10px;" data-member-uid="${u.uid}" data-member-paused="${u.paused ? "1" : "0"}">
                    ${u.paused ? "Unpause" : "Pause"}
                  </button>
                </div>
              </div>
            `;
          });
          ceoMembersList.innerHTML = rows.join("") || `<div class="meta-note">No members found.</div>`;
        }
      } catch (err) {
        console.warn("ceo members summary failed", err);
        const msg = err?.message || "Could not load members.";
        if (ceoMembersTotals) ceoMembersTotals.textContent = msg;
      }
    }

    if (ceoMembersRefresh) {
      ceoMembersRefresh.addEventListener("click", loadCeoMembersSummary);
    }
    document.querySelectorAll('[data-ceo-filter]').forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll('[data-ceo-filter]').forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        loadCeoMembersSummary();
      });
    });

    function startHealthWatch() {
      if (!db || !isCeoAccount || !ceoSystemHealth) return;
      stopHealthWatch();
      const ref = doc(db, "settings", "health");
      ceoHealthUnsub = onSnapshot(ref, async (snap) => {
        let data = snap.exists() ? snap.data() : {};
        if (!snap.exists()) {
          try {
            await setDoc(ref, { lastCloseoutEmail: new Date() }, { merge: true });
            data = { lastCloseoutEmail: new Date() };
          } catch (seedErr) {
            console.warn("Could not seed health doc", seedErr);
          }
        }
        const lastEmail = data.lastCloseoutEmail;
        const version = data.version || "";
        const currentVersion = (window.APP_VERSION || "").toString();
        let status = "unknown";
        let color = "#fbbf24";
        if (lastEmail) {
          const ts = lastEmail.toDate ? lastEmail.toDate() : new Date(lastEmail);
          const ageHours = (Date.now() - ts.getTime()) / 3600000;
          if (ageHours < 30) {
            status = "green";
            color = "#22c55e";
          } else if (ageHours < 48) {
            status = "yellow";
            color = "#fbbf24";
          } else {
            status = "red";
            color = "#ef4444";
          }
          const versionNote = version && currentVersion && version !== currentVersion ? ` Â· Version behind (${version} vs ${currentVersion})` : "";
          ceoSystemHealth.textContent = `Close-out email: ${ts.toLocaleString("en-US", { timeZone: "America/Denver" })} Â· Status ${status}${versionNote}`;
        } else {
          ceoSystemHealth.textContent = "Close-out email: unknown";
        }
        ceoSystemHealth.style.color = color;
      }, (err) => {
        console.warn("Health watch failed", err);
        ceoSystemHealth.textContent = "Health status unavailable";
        ceoSystemHealth.style.color = "#fbbf24";
      });
    }
    if (ceoMembersList) {
      ceoMembersList.addEventListener("click", async (e) => {
        const btn = e.target.closest("button[data-member-uid]");
        if (!btn) return;
        const uid = btn.getAttribute("data-member-uid");
        const paused = btn.getAttribute("data-member-paused") === "1";
        btn.disabled = true;
        btn.textContent = paused ? "Unpausingâ€¦" : "Pausingâ€¦";
        try {
          const fn = httpsCallable(functionsClient, "setMemberPaused");
          await fn({ uid, paused: !paused });
          await loadCeoMembersSummary();
        } catch (err) {
          console.warn("setMemberPaused failed", err);
          showToast("Could not update member.");
        } finally {
          btn.disabled = false;
          btn.textContent = paused ? "Unpause" : "Pause";
        }
      });
    }
    if (paymentBackBtn) {
      paymentBackBtn.addEventListener("click", () => {
        pendingMembershipTier = null;
        resetPaymentForm();
        showScreen("membership");
      });
    }
    if (ceoRedemptionBtn) {
      ceoRedemptionBtn.addEventListener("click", () => {
        renderCeoRedemptionLog();
        ceoRedemptionModal.classList.add("active");
      });
    }
    if (ceoCloseOutVenue) {
      ceoCloseOutVenue.addEventListener("change", renderCeoCloseOutReports);
    }
    if (ceoCloseOutRange) {
      ceoCloseOutRange.addEventListener("change", renderCeoCloseOutReports);
    }
    if (ceoCloseOutList) {
      ceoCloseOutList.addEventListener("click", (e) => {
        const downloadBtn = e.target.closest("[data-report-download]");
        if (downloadBtn) {
          const rid = downloadBtn.getAttribute("data-report-download");
          const report = closeOutReports.find(item => item.id === rid);
          if (report) downloadCloseOutReport(report);
          e.stopPropagation();
          return;
        }
        const row = e.target.closest("[data-report-id]");
        if (!row) return;
        const reportId = row.getAttribute("data-report-id");
        const report = closeOutReports.find(item => item.id === reportId);
        if (report) openCeoCloseOutModal(report);
      });
    }
    if (ceoCloseOutClose) {
      ceoCloseOutClose.addEventListener("click", closeCeoCloseOutModal);
    }
    if (ceoCloseOutModal) {
      ceoCloseOutModal.addEventListener("click", (e) => {
        if (e.target === ceoCloseOutModal) closeCeoCloseOutModal();
      });
    }
    if (ceoReviewBtn) {
      ceoReviewBtn.addEventListener("click", () => {
        attachCeoReviewsRealtime();
        renderCeoReviews();
        ceoReviewsModal.classList.add("active");
      });
    }
    if (ceoPortalReviewsBtn) {
      ceoPortalReviewsBtn.addEventListener("click", () => {
        attachCeoReviewsRealtime();
        renderCeoReviews();
        ceoReviewsModal.classList.add("active");
      });
    }
    if (ceoRedemptionClose) {
      ceoRedemptionClose.addEventListener("click", () => ceoRedemptionModal.classList.remove("active"));
    }
    if (ceoRedemptionModal) {
      ceoRedemptionModal.addEventListener("click", (e) => {
        if (e.target === ceoRedemptionModal) ceoRedemptionModal.classList.remove("active");
      });
    }
    if (leaveReviewBtn) {
      leaveReviewBtn.addEventListener("click", () => {
        if (!currentMembershipTier || isCeoActive()) return;
        reviewModal.classList.add("active");
        selectedReviewStars = 0;
        setReviewStars(0);
        reviewNotes.value = "";
        reviewSuccess.classList.remove("visible");
      });
    }
    if (reviewClose) {
      reviewClose.addEventListener("click", () => reviewModal.classList.remove("active"));
    }
    if (reviewModal) {
      reviewModal.addEventListener("click", (e) => {
        if (e.target === reviewModal) reviewModal.classList.remove("active");
      });
    }
    if (ceoReviewsClose) {
      ceoReviewsClose.addEventListener("click", () => ceoReviewsModal.classList.remove("active"));
    }
    if (ceoReviewsModal) {
      ceoReviewsModal.addEventListener("click", (e) => {
        if (e.target === ceoReviewsModal) ceoReviewsModal.classList.remove("active");
      });
    }
    if (ceoAnalyticsBtn) {
      ceoAnalyticsBtn.addEventListener("click", () => {
        renderCeoAnalytics();
        ceoAnalyticsModal.classList.add("active");
      });
    }
    // Demo mode controls removed
    if (ceoAnalyticsClose) {
      ceoAnalyticsClose.addEventListener("click", () => ceoAnalyticsModal.classList.remove("active"));
    }
    if (ceoAnalyticsModal) {
      ceoAnalyticsModal.addEventListener("click", (e) => {
        if (e.target === ceoAnalyticsModal) ceoAnalyticsModal.classList.remove("active");
      });
    }

    function startCeoPreview(tier) {
      if (!isCeoAccount) return;
      ceoPreviewTier = tier;
      extraVouchers = { ...EXTRA_DEFAULTS };
      updateExtraVoucherUI();
      currentPerkState = null;
      applyMembershipToPass(tier);
      updateCeoPassUI();
    }

    function endCeoPreview() {
      if (!isCeoAccount) return;
      ceoPreviewTier = null;
      extraVouchers = { drink: 999, shot: 999, cover: 999 };
      updateExtraVoucherUI();
      currentPerkState = null;
      applyMembershipToPass("vip");
      updateCeoPassUI();
    }

    if (voucherChargeOnFile) {
      voucherChargeOnFile.addEventListener("click", async () => {
        if (!pendingVoucherPack) {
          if (voucherPaymentError) voucherPaymentError.textContent = "Select a voucher pack first.";
          return;
        }
        if (voucherHasCardOnFile && !voucherPaymentComplete) {
          await chargeVoucherOnFile(pendingVoucherPack);
        } else {
          await chargeVoucherWithElement(pendingVoucherPack);
        }
      });
    }
    if (voucherPaymentForm) {
      voucherPaymentForm.addEventListener("submit", (e) => e.preventDefault());
    }

    function showVenueDetail(venueId) {
      if (!venueId || !venueDetailModal) return;
      const info = venuesInfo[venueId];
      if (!info) return;
      venueDetailName.textContent = info.name;
      venueDetailAddress.textContent = info.address;
      venueDetailPhone.textContent = info.phone;
      if (info.hours) {
        venueDetailHours.textContent = info.hours;
        venueDetailHours.style.display = "";
      } else {
        venueDetailHours.textContent = "";
        venueDetailHours.style.display = "none";
      }
      venueDetailModal.dataset.venueId = venueId;
      const avg = getVenueAverage(venueId);
      if (venueDetailRating) {
        if (avg) {
          const ratings = loadVenueRatings()[venueId];
          venueDetailRating.style.display = "inline-flex";
          venueDetailRating.textContent = `â˜… ${avg.toFixed(1)}${ratings?.count ? ` (${ratings.count})` : ""}`;
        } else {
          venueDetailRating.style.display = "none";
        }
      }
      venueDetailModal.classList.add("active");
      venueButtons.forEach(btn => {
        btn.classList.toggle("active", btn.dataset.venue === venueId);
      });
    }

    if (redemptionOptionsGrid) {
      redemptionOptionsGrid.addEventListener("click", (e) => {
        const button = e.target.closest(".perk-option");
        if (!button || button.classList.contains("disabled")) return;
        redemptionOptionsGrid.querySelectorAll(".perk-option").forEach(btn => btn.classList.remove("selected"));
        button.classList.add("selected");
        selectedPerkId = button.dataset.perk;
        selectedVenuePerkId = button.dataset.venuePerk || null;
        selectedPerkLabel = button.dataset.label || "Perk";
        const remaining = getRemainingFor(selectedPerkId);
        const remainingText = (isCeoActive() || isFreeMember())
          ? "Unlimited"
          : (remaining === 1 ? "1 left" : `${remaining} left`);
        creditInfo.textContent = `${selectedPerkLabel} â€¢ ${remainingText}`;
      });
    }

    loadRedemptionLog();
    loadCloseOutReports();
    renderCeoRedemptionLog();
    renderCeoReviews();
    updateCeoMetrics();
    loadAccentTheme();
    updateDemoUI();
    if (demoMode) {
      seedDemoData(true);
      updateDemoUI();
    }

    venueButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        showVenueDetail(btn.dataset.venue);
      });
    });

    function closeVenueDetail() {
      if (venueDetailModal) venueDetailModal.classList.remove("active");
      venueButtons.forEach(btn => btn.classList.remove("active"));
    }

    function openTierModal() {
      if (!currentMembershipTier) return;
      const targetTier = currentMembershipTier === "vip" ? "standard" : "vip";
      const actionLabel = targetTier === "vip" ? "Upgrade to VIP" : "Downgrade to Standard";
      tierModalTitle.textContent = `Current: ${currentMembershipTier.toUpperCase()}`;
      tierModalCopy.textContent = targetTier === "vip"
        ? "Unlock extra vouchers, more perks, and VIP-only offers."
        : "Downgrading removes VIP perks next cycle. Confirm to continue.";
      tierModalAction.textContent = actionLabel;
      tierModalAction.dataset.targetTier = targetTier;
      tierModal.classList.add("active");
    }

    function closeTierModal() {
      tierModal.classList.remove("active");
      tierModalAction.dataset.targetTier = "";
    }

    if (venueDetailClose) {
      venueDetailClose.addEventListener("click", closeVenueDetail);
    }
    if (venueDetailModal) {
      venueDetailModal.addEventListener("click", (e) => {
        if (e.target === venueDetailModal) closeVenueDetail();
      });
    }
    tierModalCancel.addEventListener("click", closeTierModal);
    tierModal.addEventListener("click", (e) => {
      if (e.target === tierModal) closeTierModal();
    });

    async function verifyCode(code, venueId) {
      if (!code) return { success: false, message: "Enter a code." };
      const codeUpper = code.toUpperCase();
      const entry = redemptionLog.find(item => item.code.toUpperCase() === codeUpper);
      if (!entry) {
        if (dealCodes && dealCodes[codeUpper]) {
          const info = dealCodes[codeUpper];
          const newEntry = {
            code: codeUpper,
            perk: info.perk || "Tonight's deal",
            perkKey: "deal",
            passId: "DEAL",
            venue: info.venue || venueId || null,
            status: "verified",
            verifiedAt: new Date().toISOString(),
            timestamp: info.timestamp || new Date().toISOString(),
            member: "Tonight's deal",
          };
          const synced = await syncRedemptionToCloud(newEntry);
          if (!synced) {
            return { success: false, message: cloudSyncFailureMessage() };
          }
          addRedemptionLogEntry(newEntry, { skipSync: true });
          return { success: true, entry: newEntry };
        }
        const generated = ceoGeneratedCodes.find(item => item.code === codeUpper);
        if (generated) {
          const newEntry = {
            code: generated.code,
            perk: generated.perk,
            ceo: true,
            perkKey: generated.perkKey,
            passId: "CEO",
            venue: venueId || null,
            status: "verified",
            verifiedAt: new Date().toISOString(),
            timestamp: generated.timestamp || new Date().toISOString(),
            member: "CEO issued",
          };
          ceoGeneratedCodes = ceoGeneratedCodes.filter(item => item.code !== generated.code);
          saveCeoGeneratedCodes();
          const synced = await syncRedemptionToCloud(newEntry);
          if (!synced) {
            return { success: false, message: cloudSyncFailureMessage() };
          }
          addRedemptionLogEntry(newEntry, { skipSync: true });
          return { success: true, entry: newEntry };
        }
        let cloud = null;
        try {
          cloud = await fetchCloudRedemption(codeUpper);
        } catch (err) {
          return { success: false, message: "Couldnâ€™t reach cloud. Check connection and try again." };
        }
        if (cloud) {
          cloud.status = "verified";
          cloud.verifiedAt = new Date().toISOString();
          if (venueId) cloud.venue = venueId;
          const synced = await syncRedemptionToCloud(cloud);
          if (!synced) {
            return { success: false, message: cloudSyncFailureMessage() };
          }
          addRedemptionLogEntry(cloud, { skipSync: true });
          return { success: true, entry: cloud };
        }
        return { success: false, message: "Code not found. Ask member to refresh their pass." };
      }
      if (!entry.passId) {
        try {
          const cloudLookup = await fetchCloudRedemption(codeUpper);
          if (cloudLookup?.passId) entry.passId = cloudLookup.passId;
          if (!entry.perk && cloudLookup?.perk) entry.perk = cloudLookup.perk;
          if (!entry.perkKey && cloudLookup?.perkKey) entry.perkKey = cloudLookup.perkKey;
          if (!entry.member && cloudLookup?.member) entry.member = cloudLookup.member;
          if (!entry.timestamp && cloudLookup?.timestamp) entry.timestamp = cloudLookup.timestamp;
        } catch (_) {}
      }
      if (entry.status === "verified") return { success: false, message: "Already verified earlier." };
      const updatedEntry = { ...entry };
      updatedEntry.status = "verified";
      updatedEntry.verifiedAt = new Date().toISOString();
      if (venueId) updatedEntry.venue = venueId;
      if (entry.perkKey === "reward_shot") {
        updatedEntry.perk = "Reward: shot perk";
        updatedEntry.perkKey = "reward_shot";
      }
      const synced = await syncRedemptionToCloud(updatedEntry);
      if (!synced) {
        return { success: false, message: cloudSyncFailureMessage() };
      }
      Object.assign(entry, updatedEntry);
      if (entry.ceo && entry.passId === "CEO") {
        saveRedemptionLog();
        renderStaffVenueLog();
        refreshMemberStats();
        renderCeoVerifiedVenueLog();
        return { success: true, entry };
      }
      await finalizeEntryRedemption(entry);
      saveRedemptionLog();
      incrementRewardsProgress();
      renderRedemptionOptions();
      renderStaffVenueLog();
      renderCeoVerifiedVenueLog();
      refreshMemberStats();
      return { success: true, entry };
    }

    async function verifyPassId(passId, venueId, options = {}) {
      if (!passId) return { success: false, message: "Scan didnâ€™t include a pass ID." };
      let profile = null;
      try {
        profile = await lookupMemberProfile(passId);
      } catch (err) {
        console.warn("Failed to lookup member for pass scan:", err);
        return { success: false, message: "Couldnâ€™t check this pass. Try again." };
      }
      if (!profile) return { success: false, message: "No active pass found. Ask member to refresh their app." };
      const entry = {
        code: passId,
        perk: options.label || "Pass verification",
        perkKey: "pass",
        member: profile.name || `FoCo member (${passId})`,
        passId,
        venue: venueId || null,
        status: "verified",
        timestamp: new Date().toISOString(),
      };
      addRedemptionLogEntry(entry);
      renderCeoVerifiedVenueLog();
      return { success: true, entry, profile };
    }

    async function finalizeEntryRedemption(entry) {
      if (!entry) return;
      if (entry.passId) {
        const perkId = entry.venuePerkId || entry.perkKey;
        if (perkId) {
          decrementPendingForPass(entry.passId, perkId);
        }
        if (entry.venuePerkId) return;
        if (entry.perkKey) {
          await applyPerkDeductionForPass(entry.passId, entry.perkKey);
        }
      }
    }

    function deductFromStoredExtras(storageKey, perkId) {
      if (!storageKey || !perkId) return;
      const key = `extra_${storageKey}`;
      let extras = {};
      try {
        extras = JSON.parse(localStorage.getItem(key) || "{}");
      } catch (err) {
        extras = {};
      }
      if (typeof extras[perkId] !== "number") extras[perkId] = 0;
      if (extras[perkId] > 0) {
        extras[perkId] -= 1;
        localStorage.setItem(key, JSON.stringify(extras));
      }
    }

    function deductFromCurrentPerks(perkId) {
      if (!perkId) return;
      if (!currentPerkState) ensurePerkState(currentMembershipTier);
      const baseRemaining = currentPerkState?.remaining?.[perkId] ?? 0;
      if (baseRemaining > 0) {
        currentPerkState.remaining[perkId] = baseRemaining - 1;
        savePerkState();
      } else {
        adjustExtraVouchers(perkId, -1);
      }
      renderRedemptionOptions();
    }

    async function applyPerkDeductionForPass(passId, perkId) {
      if (!passId || !perkId) return;
      const normalized = passId.toUpperCase();
      // If we have an accent stored for this pass, apply it when we touch the profile
      const dirEntry = loadMemberDirectory()[normalized];
      if (dirEntry?.accent) {
        applyAccentTheme(dirEntry.accent);
      }
      if (dirEntry?.avatarFlair) {
        applyAvatarFlair(dirEntry.avatarFlair);
      }
      if (normalized === (currentPassCode || "").toUpperCase()) {
        deductFromCurrentPerks(perkId);
        return;
      }
      if (normalized === CEO_PASS_ID) return;
      const profile = await lookupMemberProfile(normalized, { requireDoc: Boolean(db) });
      if (!profile) return;
      if (profile.ceo || profile.blackCard) return;
      if (db && profile._docId) {
        await decrementFirestorePerkBalance(profile, perkId, normalized);
        return;
      }
      if (profile?.perks?.remaining) {
        if (typeof profile.perks.remaining[perkId] !== "number") {
          profile.perks.remaining[perkId] = 0;
        }
        if (profile.perks.remaining[perkId] > 0) {
          profile.perks.remaining[perkId] -= 1;
          cachePassProfile(normalized, profile, profile._docId || null);
          setMemberDirectoryEntry(normalized, { lastDeducted: new Date().toISOString() });
          return;
        }
      }
      if (profile?.extraVouchers) {
        if (typeof profile.extraVouchers[perkId] !== "number") {
          profile.extraVouchers[perkId] = 0;
        }
        if (profile.extraVouchers[perkId] > 0) {
          profile.extraVouchers[perkId] -= 1;
          cachePassProfile(normalized, profile, profile._docId || null);
          return;
        }
      }
      if (profile?.perkStorageKey) {
        let stored = null;
        try {
          stored = JSON.parse(localStorage.getItem(profile.perkStorageKey));
        } catch (err) {
          stored = null;
        }
        if (stored?.remaining) {
          if (typeof stored.remaining[perkId] !== "number") stored.remaining[perkId] = 0;
          if (stored.remaining[perkId] > 0) {
            stored.remaining[perkId] -= 1;
            localStorage.setItem(profile.perkStorageKey, JSON.stringify(stored));
            setMemberDirectoryEntry(normalized, { lastDeducted: new Date().toISOString() });
            return;
          }
        }
      }
      if (profile?.membershipStorageKey) {
        deductFromStoredExtras(profile.membershipStorageKey, perkId);
      }
    }

    verifyForm.addEventListener("submit", async (e) => {
      e.preventDefault();
        verifyError.textContent = "";
        verifySuccess.classList.remove("visible");
        const code = verifyCodeInput.value.trim();
        const venueId = staffSession ? staffSession.venue : null;
        const result = await verifyCode(code, venueId);
        if (!result.success) {
          verifyError.textContent = result.message;
          if (verifyCodeInput) verifyCodeInput.focus();
          return;
        }
        showNeonSuccess(verifySuccess, "Voucher verified.", 4600);
        logStaffVerification(result.entry);
        if (lastVerifiedLine) {
          const ts = formatMST(result.entry.timestamp || Date.now());
          lastVerifiedLine.textContent = `Last verified: ${result.entry.code} â€¢ ${ts}`;
          lastVerifiedLine.classList.add("visible");
        }
        verifyCodeInput.value = "";
        if (verifyCodeInput) verifyCodeInput.focus();
      });

    if (staffMessageForm) {
      staffMessageForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (staffMessageError) staffMessageError.textContent = "";
        if (staffMessageSuccess) staffMessageSuccess.style.display = "none";
        const body = staffMessageInput?.value?.trim();
        if (!staffSession) {
          if (staffMessageError) staffMessageError.textContent = "Staff login required.";
          return;
        }
        if (!body) {
          if (staffMessageError) staffMessageError.textContent = "Type a message first.";
          return;
        }
        try {
          await ensureFirebaseUser();
          const nowTs = Timestamp.now();
          const docRef = await addDoc(collection(db, "staffMessages"), {
            venueId: staffSession.venue,
            venueName: venuesInfo[staffSession.venue]?.name || "Your venue",
            staffUid: firebaseAuth.currentUser?.uid || null,
            message: body,
            createdAt: nowTs,
            createdAtServer: serverTimestamp(),
            reply: "",
            repliedAt: null,
            readByCeo: false,
            readByStaff: true,
            deletedByCeo: false,
            deletedByStaff: false
          });
          renderStaffMessages([
            {
              id: docRef.id,
              venueId: staffSession.venue,
              venueName: venuesInfo[staffSession.venue]?.name || "Your venue",
              staffUid: firebaseAuth.currentUser?.uid || null,
              message: body,
              createdAt: nowTs,
              createdAtServer: nowTs,
              reply: "",
              repliedAt: null,
              readByCeo: false,
              readByStaff: true,
              deletedByCeo: false,
              deletedByStaff: false
            },
            ...staffMessagesCache
          ]);
          startStaffMessagesListener(staffSession.venue);
          if (staffMessageInput) staffMessageInput.value = "";
          if (staffMessageSuccess) {
            staffMessageSuccess.textContent = "Message sent.";
            staffMessageSuccess.style.display = "block";
          }
        } catch (err) {
          console.warn("Staff message send failed", err);
          if (staffMessageError) staffMessageError.textContent = err?.message || "Could not send message.";
        }
      });
    }
    if (staffDeleteSelectedBtn) {
      staffDeleteSelectedBtn.addEventListener("click", async () => {
        if (staffMessageError) staffMessageError.textContent = "";
        if (!staffSession) {
          if (staffMessageError) staffMessageError.textContent = "Staff login required.";
          return;
        }
        const ids = getSelectedStaffMessageIds();
        if (!ids.length) return;
        try {
          await ensureFirebaseUser();
          await Promise.all(ids.map(id => updateDoc(doc(db, "staffMessages", id), { deletedByStaff: true })));
          startStaffMessagesListener(staffSession.venue);
        } catch (err) {
          console.warn("Staff delete messages failed", err);
          if (staffMessageError) staffMessageError.textContent = "Could not delete messages.";
        }
      });
    }
    if (staffClearMessagesBtn) {
      staffClearMessagesBtn.addEventListener("click", async () => {
        if (staffMessageError) staffMessageError.textContent = "";
        if (!staffSession) {
          if (staffMessageError) staffMessageError.textContent = "Staff login required.";
          return;
        }
        const ids = staffMessagesCache.filter(msg => !msg.deletedByStaff).map(msg => msg.id);
        if (!ids.length) return;
        try {
          await ensureFirebaseUser();
          await Promise.all(ids.map(id => updateDoc(doc(db, "staffMessages", id), { deletedByStaff: true })));
          startStaffMessagesListener(staffSession.venue);
        } catch (err) {
          console.warn("Staff clear messages failed", err);
          if (staffMessageError) staffMessageError.textContent = "Could not clear messages.";
        }
      });
    }

    if (ceoReplyForm) {
      ceoReplyForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (ceoReplyError) ceoReplyError.textContent = "";
        if (ceoReplySuccess) ceoReplySuccess.style.display = "none";
        const reply = ceoReplyInput?.value?.trim();
        const targetId = ceoReplyTarget?.value || ceoMessagesCache[0]?.id;
        if (!isCeoAccount) {
          if (ceoReplyError) ceoReplyError.textContent = "CEO login required.";
          return;
        }
        if (!targetId) {
          if (ceoReplyError) ceoReplyError.textContent = "Select a message to reply.";
          return;
        }
        if (!reply) {
          if (ceoReplyError) ceoReplyError.textContent = "Enter a reply.";
          return;
        }
        try {
          const ref = doc(db, "staffMessages", targetId);
          await updateDoc(ref, {
            reply,
            repliedAt: Timestamp.now(),
            readByCeo: true,
            readByStaff: false,
            deletedByCeo: false
          });
          if (ceoReplyInput) ceoReplyInput.value = "";
          if (ceoReplySuccess) {
            ceoReplySuccess.textContent = "Reply sent.";
            ceoReplySuccess.style.display = "block";
          }
        } catch (err) {
          console.warn("CEO reply failed", err);
          if (ceoReplyError) ceoReplyError.textContent = err?.message || "Reply failed.";
        }
      });
    }

    if (ceoClearMessages) {
      ceoClearMessages.addEventListener("click", async () => {
        if (!isCeoAccount || !ceoMessagesCache.length) return;
        try {
          await Promise.all(
            ceoMessagesCache.map(msg => updateDoc(doc(db, "staffMessages", msg.id), { deletedByCeo: true }))
          );
          renderCeoMessages([]);
        } catch (err) {
          console.warn("Clear messages failed", err);
        }
      });
    }

    reviewStars.forEach(star => {
      star.addEventListener("click", () => {
        const value = parseInt(star.dataset.star, 10);
        setReviewStars(value);
      });
    });
    if (submitReviewBtn) {
      submitReviewBtn.addEventListener("click", () => {
        if (!currentMembershipTier || isCeoActive()) return;
        if (selectedReviewStars <= 0) {
          reviewSuccess.textContent = "Tap a star rating first.";
          reviewSuccess.classList.add("visible");
          return;
        }
        const reviewEntry = {
          stars: selectedReviewStars,
          notes: reviewNotes.value.trim(),
          member: passUserName.textContent,
          tier: currentMembershipTier,
          timestamp: new Date().toISOString(),
          timestampMs: Date.now(),
          passCode: (currentPassCode || "").toUpperCase(),
          uid: firebaseAuth.currentUser?.uid || "",
          email: firebaseAuth.currentUser?.email || "",
          username: preferredUsername()
        };
        const reviews = getStoredReviews();
        reviews.unshift(reviewEntry);
        saveReviews(reviews);
        if (db) {
          addDoc(collection(db, "reviews"), {
            ...reviewEntry,
            timestamp: serverTimestamp()
          }).catch(err => console.warn("Failed to save review to cloud", err));
        }
        reviewNotes.value = "";
        setReviewStars(0);
        reviewSuccess.textContent = "Thanks for the review!";
        reviewSuccess.classList.add("visible");
        renderCeoReviews(reviews);
        const badgeState = getBadgeStateForCurrentPass();
        const newCount = (badgeState.reviewsCount || 0) + 1;
        setBadgeStateForCurrentPass({
          reviewsCount: newCount,
          reviews: badgeState.reviews || newCount >= 3
        });
        evaluateAchievements();
        addPoints(POINT_RULES.review, "Review");
        setTimeout(() => {
          reviewModal.classList.remove("active");
          reviewSuccess.classList.remove("visible");
        }, 1600);
      });
    }

    if (memberIdForm) {
      memberIdForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        memberIdError.textContent = "";
        memberIdResult.classList.remove("visible");
        const passId = memberIdInput.value.trim().toUpperCase();
        if (!passId) {
          memberIdError.textContent = "Enter a member ID.";
          return;
        }
        // Instant path for CEO lookup to avoid async delay
        if (passId === CEO_PASS_ID) {
          showNeonSuccess(memberIdResult, "Verified FoCo Founder & CEO Â· Adrian White", 7600, true);
          memberIdResult.scrollIntoView({ behavior: "smooth", block: "center" });
          memberIdInput.value = "";
          return;
        }
        const profile = await lookupMemberProfile(passId);
        if (!profile) {
          memberIdError.textContent = "Pass ID not found. Ask the member to refresh their app.";
          return;
        }
        const tierLabel = profile.tier ? profile.tier.toUpperCase() : "MEMBER";
        let creatorNote = "";
        if (passId === CEO_PASS_ID) {
          creatorNote = " Black Card holder issued by the CEO.";
        } else if (profile.blackCard || isBlackCardHolder(passId)) {
          creatorNote = " CEO issued Black Card member.";
        }
        const memberLabel = passId === CEO_PASS_ID
          ? "Adrian White Â· Founder & CEO"
          : profile.name
            ? `${profile.name} (${passId})`
            : `FoCo member (${passId})`;
        const message = passId === CEO_PASS_ID
          ? "Verified FoCo Founder & CEO Â· Dree White"
          : `Verified ${tierLabel} pass for ${memberLabel}.${creatorNote}`;
        showNeonSuccess(memberIdResult, message, 7600, true);
        memberIdResult.scrollIntoView({ behavior: "smooth", block: "center" });
        setTimeout(() => {
          memberIdInput.value = "";
        }, 600);
      });
    }

    function generateRedemptionCode() {
      const alphabet = "23456789ABCDEFGHJKLMNPQRSTUVWXYZ";
      let code = "";
      for (let i = 0; i < 6; i++) {
        code += alphabet[Math.floor(Math.random() * alphabet.length)];
      }
      return code;
    }

    let pendingRedeemCode = null;
    let pendingRedeemPerk = null;
    let pendingRedeemVenue = null;
    function getVenueDisplayName(venueId) {
      if (!venueId) return "";
      const key = String(venueId).toLowerCase();
      if (key === "beta") return "FoCo Beta Venue";
      return venuesInfo?.[key]?.name || venueId;
    }
    let redeemPendingTimer = null;
    let redeemWatchUnsub = null;
    function updateRedeemAwaitState() {
      if (!redeemSuccess || !redeemSuccessTitle) return;
      if (!pendingRedeemCode) {
        if (redeemSuccessBack) {
          redeemSuccessBack.disabled = false;
          redeemSuccessBack.style.display = "";
        }
        if (redeemPendingClose) redeemPendingClose.style.display = "none";
        if (redeemVenueHint) redeemVenueHint.style.display = "none";
        return;
      }
      const entry = redemptionLog.find(e => (e.code || "").toUpperCase() === pendingRedeemCode);
      const venueId = entry?.venue || entry?.requestedVenue || pendingRedeemVenue;
      if (redeemVenueHint) {
        if (venueId) {
          redeemVenueHint.textContent = `Redeeming at ${getVenueDisplayName(venueId)}`;
          redeemVenueHint.style.display = "block";
        } else {
          redeemVenueHint.style.display = "none";
        }
      }
      const status = (entry?.status || "pending").toLowerCase();
      if (status === "verified") {
        redeemSuccessTitle.textContent = `${pendingRedeemPerk || "Perk"} verified`;
        if (redeemStatusLine) redeemStatusLine.textContent = "Verified by staff. Enjoy your perk!";
        if (redeemSuccessBack) {
          redeemSuccessBack.disabled = false;
          redeemSuccessBack.style.display = "";
        }
        if (redeemPendingClose) redeemPendingClose.style.display = "none";
        if (redeemPendingTimer) {
          clearTimeout(redeemPendingTimer);
          redeemPendingTimer = null;
        }
        showToast("Voucher verified!");
        redeemSuccess.classList.remove("active");
        stopConfettiLoop();
        pendingRedeemCode = null;
        pendingRedeemPerk = null;
        pendingRedeemVenue = null;
        if (redeemWatchUnsub) {
          try { redeemWatchUnsub(); } catch (_) {}
          redeemWatchUnsub = null;
        }
        return;
      } else {
        redeemSuccessTitle.textContent = `${pendingRedeemPerk || "Perk"} pending`;
        if (redeemStatusLine) redeemStatusLine.textContent = "Waiting for venue verificationâ€¦";
        if (redeemSuccessBack) {
          redeemSuccessBack.disabled = true;
          redeemSuccessBack.style.display = "none";
        }
      }
    }

    function watchPendingRedeem(code) {
      if (!db || !code) return;
      if (redeemWatchUnsub) {
        try { redeemWatchUnsub(); } catch (_) {}
        redeemWatchUnsub = null;
      }
      const ref = getRedemptionRef(code);
      if (!ref) return;
      redeemWatchUnsub = onSnapshot(ref, (snap) => {
        if (!snap.exists()) return;
        const data = snap.data() || {};
        const toIso = (ts) => {
          if (!ts) return new Date().toISOString();
          if (ts.toDate) return ts.toDate().toISOString();
          return new Date(ts).toISOString();
        };
        const entry = {
          code: (data.code || code).toUpperCase(),
          perk: data.perk || data.perkKey || "Perk",
          perkKey: data.perkKey || null,
          venuePerkId: data.venuePerkId || null,
          venuePerkLabel: data.venuePerkLabel || null,
          passId: (data.passId || currentPassCode || "").toUpperCase(),
          member: data.member || passUserName?.textContent || "FoCo member",
          venue: data.venue || null,
          requestedVenue: data.requestedVenue || null,
          ceo: !!data.ceo,
          status: data.status || "pending",
          timestamp: toIso(data.timestamp),
          verifiedAt: toIso(data.verifiedAt || data.timestamp),
        };
        mergeRedemptionLogEntries([entry]);
      });
    }

    function showRedemptionQr(perkLabel, providedCode, requestedVenueId) {
      const code = providedCode || generateRedemptionCode();
      redeemCodeDisplay.textContent = code;
      if (redeemSuccessTitle) {
        redeemSuccessTitle.textContent = `${perkLabel} pending`;
      }
      pendingRedeemCode = code.toUpperCase();
      pendingRedeemPerk = perkLabel;
      pendingRedeemVenue = requestedVenueId || null;
      if (redeemVenueHint) {
        if (pendingRedeemVenue) {
          redeemVenueHint.textContent = `Redeeming at ${getVenueDisplayName(pendingRedeemVenue)}`;
          redeemVenueHint.style.display = "block";
        } else {
          redeemVenueHint.style.display = "none";
        }
      }
      if (redeemStatusLine) redeemStatusLine.textContent = "Waiting for venue verificationâ€¦";
      if (redeemSuccessBack) {
        redeemSuccessBack.disabled = true;
        redeemSuccessBack.style.display = "none";
      }
      if (redeemPendingClose) redeemPendingClose.style.display = "none";
      if (redeemPendingTimer) clearTimeout(redeemPendingTimer);
      redeemPendingTimer = setTimeout(() => {
        if (pendingRedeemCode && redeemPendingClose) {
          redeemPendingClose.style.display = "inline-flex";
        }
      }, 5000);
      redeemSuccess.classList.add("active");
      startConfettiLoop();
      updateRedeemAwaitState();
      watchPendingRedeem(code.toUpperCase());
      return code;
    }
    function attachCopyHandlers() {
      const toast = (msg) => {
        if (!verifySuccess) return;
        verifySuccess.textContent = msg;
        verifySuccess.classList.add("visible");
        setTimeout(() => verifySuccess.classList.remove("visible"), 1400);
      };
      if (passCodeText) {
        passCodeText.addEventListener("click", async () => {
          const text = (currentPassCode || "").trim();
          if (!text) return;
          try {
            await navigator.clipboard.writeText(text);
            toast("Pass ID copied!");
          } catch (err) {
            toast("Copied!");
          }
        });
      }
      if (passIdTop) {
        passIdTop.addEventListener("click", async () => {
          const text = (currentPassCode || "").trim();
          if (!text) return;
          try {
            await navigator.clipboard.writeText(text);
            toast("Pass ID copied!");
          } catch (err) {
            toast("Copied!");
          }
        });
      }
      if (redeemCodeDisplay) {
        redeemCodeDisplay.addEventListener("click", async () => {
          const text = redeemCodeDisplay.textContent.trim();
          if (!text) return;
          try {
            await navigator.clipboard.writeText(text);
            toast("Code copied!");
          } catch (err) {
            toast("Copied!");
          }
        });
      }
    }

    function updatePaymentSummary(tier) {
      const info = membershipPlanInfo[tier] || membershipPlanInfo.standard;
      paymentPlanLabel.textContent = info.label;
      paymentPlanPrice.textContent = info.price;
      paymentSuccess.classList.remove("visible");
      paymentError.textContent = "";
    }

    function resetPaymentForm() {
      if (paymentForm) paymentForm.reset();
      paymentError.textContent = "";
      paymentSuccess.classList.remove("visible");
      stripeClientSecret = null;
      stripeElements = null;
      stripeInstance = null;
      if (paymentElementContainer) paymentElementContainer.innerHTML = "";
    }

    function resetSupportForm() {
      if (supportForm) supportForm.reset();
      supportError.textContent = "";
      supportSuccess.classList.remove("visible");
    }

    function configureWalletState() {}

    async function enterBetaPassMode() {
      if (isLaunched) {
        showToast("Beta mode is disabled in live launch.");
        return;
      }
      localStorage.removeItem("betaSkipActive");
      betaPassMode = false;
      pendingMembershipTier = null;
      resetPaymentForm();
      resetSupportForm();
      if (!functionsClient) {
        console.warn("Functions unavailable, using beta fallback.");
      }
      const code = prompt("Enter beta access code");
      if (code === null) return;
      const trimmed = code.trim();
      if (!trimmed) {
        showToast("Enter the beta access code.");
        return;
      }
      const normalized = trimmed.toLowerCase();
      const fallbackPassword = `${normalized}${normalized}`;
      showToast("Connecting beta demoâ€¦");
      try {
        if (functionsClient) {
          const fn = httpsCallable(functionsClient, "getBetaLoginToken");
          const resp = await fn({ code: trimmed });
          const token = resp?.data?.token;
          if (token) {
            await signInWithCustomToken(firebaseAuth, token);
            return;
          }
        }
        throw new Error("Beta login unavailable.");
      } catch (err) {
        if (normalized !== BETA_FALLBACK_CODE) {
          console.warn("Beta login failed", err);
          showToast("Beta login failed. Check code and try again.");
          return;
        }
        try {
          if (firebaseAuth.currentUser) {
            await signOut(firebaseAuth);
          }
          try {
            await signInWithEmailAndPassword(firebaseAuth, BETA_FALLBACK_EMAIL, fallbackPassword);
            return;
          } catch (primaryErr) {
            if (primaryErr?.code === "auth/wrong-password" || primaryErr?.code === "auth/invalid-credential") {
              await signInWithEmailAndPassword(firebaseAuth, BETA_FALLBACK_EMAIL, normalized);
              return;
            }
            if (primaryErr?.code === "auth/user-not-found") {
              await createUserWithEmailAndPassword(firebaseAuth, BETA_FALLBACK_EMAIL, fallbackPassword);
              return;
            }
            throw primaryErr;
          }
        } catch (fallbackErr) {
          console.warn("Beta login fallback failed", fallbackErr);
          showToast("Beta login failed. Check code and try again.");
        }
      }
    }

    function exitBetaPassMode() {
      betaPassMode = false;
      localStorage.removeItem("betaSkipActive");
      configureWalletState(null);
      currentPerkState = null;
      selectedPerkId = null;
    }

    function getMembershipStorageKey() {
      if (useCloudProfile()) return null;
      if (betaPassMode) return "membership_beta";
      const user = firebaseAuth.currentUser;
      if (user) return `membership_${user.uid}`;
      return null;
    }

    function getPerkStateStorageKey() {
      if (betaPassMode) return "perks_beta";
      return null;
    }

    function getPendingTierKey(uid) {
      return uid ? `pendingTier_${uid}` : null;
    }

    function loadPendingTier(uid) {
      try {
        if (useCloudProfile()) return memberProfile?.pendingTier || null;
        const key = getPendingTierKey(uid);
        if (!key) return null;
        return JSON.parse(localStorage.getItem(key) || "null");
      } catch (err) {
        return null;
      }
    }

    function savePendingTier(uid, data) {
      const key = getPendingTierKey(uid);
      if (!key || !data) return;
      if (useCloudProfile()) {
        updateMemberProfile({ pendingTier: data });
        return;
      }
      localStorage.setItem(key, JSON.stringify(data));
    }

    function clearPendingTier(uid) {
      const key = getPendingTierKey(uid);
      if (useCloudProfile()) {
        updateMemberProfile({ pendingTier: null });
        return;
      }
      if (key) localStorage.removeItem(key);
    }

    function applyPendingTierIfDue() {
      const user = firebaseAuth.currentUser;
      if (!user) return;
      const pending = loadPendingTier(user.uid);
      if (!pending || !pending.toTier || !pending.effective) return;
      const now = new Date();
      const eff = new Date(pending.effective);
      if (now >= eff) {
        completeMembership(pending.toTier, { force: true });
        clearPendingTier(user.uid);
        showToast(`Membership switched to ${pending.toTier.toUpperCase()}`);
      }
    }

    function completeMembership(tier, options = {}) {
      const storageKey = getMembershipStorageKey();
      const user = firebaseAuth.currentUser;
      const currentTier = memberProfile?.tier || (allowLocalCache() && user?.uid ? localStorage.getItem(`membership_${user.uid}`) : null);
      const isNew = !currentTier;
      const sameTier = currentTier && currentTier === tier;

      // New signup or forced apply: set immediately
      if (isNew || options.force) {
        if (storageKey) {
          localStorage.setItem(storageKey, tier);
        }
        if (memberProfile && user) {
          updateMemberProfile({ tier });
        }
        loadExtraVouchers();
        applyMembershipToPass(tier);
        renderPassIdentity(user);
        onboardingMembershipFlow = false;
        forceMembershipScreen = false;
        clearPendingMembershipFlagForUser(user?.uid);
        clearPendingTier(user?.uid);
        showScreen("pass");
        return;
      }

      // No change requested
      if (sameTier) {
        showScreen("pass");
        return;
      }

      // Schedule change for 1st of next month
      const effective = nextMonthStart(new Date()).toISOString();
      savePendingTier(user?.uid, { toTier: tier, effective });
      showToast(`Your plan will switch to ${tier.toUpperCase()} on the 1st`);
      showScreen("pass");
    }

    function updateCeoPassUI() {
      const ceoActive = isCeoActive();
      if (ceoPassBanner) {
        ceoPassBanner.classList.toggle("active", isCeoAccount);
      }
      if (memberActionButtons) {
        memberActionButtons.style.display = ceoActive ? "none" : "";
      }
      if (ceoBetaSwitcher) {
        ceoBetaSwitcher.classList.toggle("active", isCeoAccount);
      }
      if (ceoResetCard) {
        ceoResetCard.style.display = isCeoAccount ? "" : "none";
      }
      if (ceoChatCard) {
        ceoChatCard.style.display = isCeoAccount ? "" : "none";
      }
      if (ceoPreviewLabel) {
        ceoPreviewLabel.textContent = ceoPreviewTier
          ? `Previewing ${ceoPreviewTier.toUpperCase()} (beta)`
          : "Live CEO view";
      }
      if (ceoRedemptionBtn) {
        ceoRedemptionBtn.style.display = isCeoAccount ? "" : "none";
      }
      if (ceoReviewBtn) {
        ceoReviewBtn.style.display = isCeoAccount ? "" : "none";
      }
      if (ceoAnalyticsBtn) {
        ceoAnalyticsBtn.style.display = isCeoAccount ? "" : "none";
      }
      if (ceoPitchToggle) {
        ceoPitchToggle.style.display = isCeoAccount ? "" : "none";
      }
      if (ceoMembersCard) {
        ceoMembersCard.style.display = isCeoAccount ? "" : "none";
        if (isCeoAccount) loadCeoMembersSummary();
      }
      if (ceoLaunchCard) {
        ceoLaunchCard.style.display = isCeoAccount ? "" : "none";
        if (isCeoAccount) loadLaunchMode();
      }
      if (ceoAppLockCard) {
        ceoAppLockCard.style.display = isCeoAccount ? "" : "none";
      }
      if (ceoSystemHealthCard) {
        ceoSystemHealthCard.style.display = isCeoAccount ? "" : "none";
        if (isCeoAccount) startHealthWatch();
      } else {
        stopHealthWatch();
      }
      if (isCeoAccount) {
        appLockOverride = false;
      }
      applyAppLockState();
      applyLaunchModeUI();
    }

    function openRedeemModal() {
      populateRedeemVenueOptions();
      venuePerksCache = {};
      selectedRedeemVenue = "";
      selectedPerkId = null;
      selectedVenuePerkId = null;
      selectedPerkLabel = null;
      stopRedeemPerksListener();
      renderRedemptionOptions();
      redeemModal.classList.add("active");
    }

    function closeRedeemModal() {
      redeemModal.classList.remove("active");
    }

    redeemTrigger.addEventListener("click", () => {
      const tier = normalizeTierKey(currentMembershipTier)
        || normalizeTierKey(memberProfile?.tier)
        || (isCeoActive() ? "ceo" : (isFreeMember() ? "free" : null))
        || (firebaseAuth.currentUser ? "standard" : null);
      if (!tier) return;
      if (!currentMembershipTier) currentMembershipTier = tier;
      openRedeemModal();
    });

    if (redeemVenueSelect) {
      redeemVenueSelect.addEventListener("change", () => {
        selectedRedeemVenue = redeemVenueSelect.value || "";
        selectedPerkId = null;
        selectedVenuePerkId = null;
        selectedPerkLabel = null;
        startRedeemVenuePerksListener(selectedRedeemVenue);
        renderRedemptionOptions();
      });
    }

    redeemClose.addEventListener("click", closeRedeemModal);
    redeemConfirm.addEventListener("click", async () => {
      if (!selectedPerkId || !selectedPerkLabel) {
        creditInfo.textContent = "Select a perk to redeem.";
        return;
      }
      const requestedVenue = redeemVenueSelect ? redeemVenueSelect.value : "";
      if (redeemVenueSelect && !requestedVenue) {
        creditInfo.textContent = "Select a venue before redeeming.";
        return;
      }
      const voucherBalance = getVoucherBalanceForTier(getVoucherTier());
      if (!voucherBalance.unlimited && voucherBalance.remaining <= 0) {
        creditInfo.textContent = VOUCHER_LIMIT_MESSAGE;
        return;
      }
      ensurePassCode();
      const activePassId = (memberProfile?.passCode || currentPassCode || "").toUpperCase();
      if (!activePassId) {
        creditInfo.textContent = "Pass ID missing. Refresh your pass and try again.";
        return;
      }
      const ceoActive = isCeoActive();
      const freeActive = isFreeMember();
      const unlimited = ceoActive || freeActive;
      const available = unlimited ? Infinity : getRemainingFor(selectedPerkId);
      if (!unlimited && available <= 0) {
        creditInfo.textContent = "No redemptions left for this perk.";
        return;
      }
      const perkLabel = ceoActive ? `Executive ${selectedPerkLabel}` : selectedPerkLabel;
      if (!unlimited) {
        incrementPendingForCurrent(selectedPerkId);
      }
      renderRedemptionOptions();
      const code = generateRedemptionCode();
      const rewardLabel = selectedPerkId === "reward_shot" ? "Reward: shot perk" : perkLabel;
      const entry = {
        code,
        perk: rewardLabel,
        member: passUserName.textContent,
        ceo: isCeoActive(),
        perkKey: selectedPerkId === "reward_shot" ? "reward_shot" : "venue_perk",
        venuePerkId: selectedVenuePerkId || null,
        venuePerkLabel: selectedPerkLabel || null,
        passId: activePassId,
        requestedVenue: requestedVenue || null,
        status: "pending",
        timestamp: new Date().toISOString(),
      };
      const synced = await syncRedemptionToCloud(entry);
      if (!synced) {
        if (!unlimited) {
          decrementPendingForPass(activePassId, selectedPerkId);
          renderRedemptionOptions();
        }
        creditInfo.textContent = cloudSyncFailureMessage();
        return;
      }
      addRedemptionLogEntry(entry, { skipSync: true });
      closeRedeemModal();
      showRedemptionQr(perkLabel, code, requestedVenue);
    });
    redeemModal.addEventListener("click", (e) => {
      if (e.target === redeemModal) closeRedeemModal();
    });
    redeemSuccessBack.addEventListener("click", () => {
      redeemSuccess.classList.remove("active");
      stopConfettiLoop();
      pendingRedeemCode = null;
      pendingRedeemPerk = null;
      pendingRedeemVenue = null;
      if (redeemVenueHint) redeemVenueHint.style.display = "none";
      if (redeemPendingTimer) {
        clearTimeout(redeemPendingTimer);
        redeemPendingTimer = null;
      }
      if (redeemWatchUnsub) {
        try { redeemWatchUnsub(); } catch (_) {}
        redeemWatchUnsub = null;
      }
    });
    if (redeemPendingClose) {
      redeemPendingClose.addEventListener("click", () => {
        redeemSuccess.classList.remove("active");
        stopConfettiLoop();
        pendingRedeemCode = null;
        pendingRedeemPerk = null;
        pendingRedeemVenue = null;
        if (redeemVenueHint) redeemVenueHint.style.display = "none";
        if (redeemPendingTimer) {
          clearTimeout(redeemPendingTimer);
          redeemPendingTimer = null;
        }
        if (redeemWatchUnsub) {
          try { redeemWatchUnsub(); } catch (_) {}
          redeemWatchUnsub = null;
        }
      });
    }

    // Membership selection buttons
    document.querySelectorAll(".select-membership").forEach(btn => {
      btn.addEventListener("click", () => {
        const tier = btn.dataset.tier;
        const user = firebaseAuth.currentUser;
        if (!user && !betaPassMode) {
          showScreen("auth");
          return;
        }
        pendingMembershipTier = tier;
        updatePaymentSummary(tier);
        resetPaymentForm();
        prepareStripePayment(tier);
        showScreen("payment");
      });
    });
    if (statusPill) {
      statusPill.addEventListener("click", () => {
        if (!currentMembershipTier || isCeoActive() || isFreeMember()) return;
        openTierModal();
      });
    }
    tierModalAction.addEventListener("click", async () => {
      const targetTier = tierModalAction.dataset.targetTier;
      if (!targetTier) {
        closeTierModal();
        return;
      }
      closeTierModal();
      if (isBetaAccount || betaPassMode) {
        completeMembership(targetTier, { force: true });
        showToast(`Membership switched to ${targetTier.toUpperCase()}`);
        return;
      }
      await chargeMembershipOnFile(targetTier);
    });

    function applyMembershipToPass(tier) {
      if (!tier) return;
      const previousTier = currentMembershipTier;
      // Force CEO overrides
      if (isCeoActive() || memberProfile?.ceo === true || (memberProfile?.email || "").toLowerCase() === "ceo@gmail.com") {
        tier = "ceo";
        if (memberProfile) memberProfile.freeMembership = true;
      } else if (memberProfile?.freeMembership) {
        tier = "free";
      }
      currentMembershipTier = tier;
      if (memberProfile && !ceoPreviewTier) {
        const freeFlag = tier === "free";
        const updates = { tier, freeMembership: freeFlag };
        if (memberProfile.tier !== tier && firebaseAuth.currentUser) {
          updateMemberProfile(updates);
        }
        memberProfile = { ...memberProfile, ...updates };
      }

      if (tier === "ceo") {
        statusPill.classList.add("ceo");
        perksListEl.innerHTML = `
          <li class="perk-row"><span class="perk-dot"></span> Unlimited monthly venue perks</li>
          <li class="perk-row"><span class="perk-dot"></span> VIP-only offers</li>
          <li class="perk-row"><span class="perk-dot"></span> Issue free passes anytime</li>
        `;
        statusPill.textContent = "CEO";
        passTierText.textContent = "CEO Black Card";
        if (expiryText) expiryText.textContent = "Never expires";
      } else if (tier === "standard") {
        statusPill.classList.remove("vip-status", "ceo");
        perksListEl.innerHTML = `
          <li class="perk-row"><span class="perk-dot"></span> Monthly venue perks set by bars</li>
          <li class="perk-row"><span class="perk-dot"></span> Up to 5 voucher redemptions monthly</li>
          <li class="perk-row"><span class="perk-dot"></span> Perks refresh on your billing date</li>
        `;
        statusPill.textContent = "Standard Member";
        passTierText.textContent = "Nightlife Pass â€¢ Standard";
      } else if (tier === "free") {
        statusPill.classList.remove("vip-status", "ceo");
        perksListEl.innerHTML = `
          <li class="perk-row"><span class="perk-dot"></span> Unlimited monthly venue perks</li>
          <li class="perk-row"><span class="perk-dot"></span> Priority access on all nights</li>
          <li class="perk-row"><span class="perk-dot"></span> Never expires</li>
        `;
        statusPill.textContent = "CEO Issued";
        passTierText.textContent = "CEO Issued";
        if (expiryText) expiryText.textContent = "Never expires";
      } else if (tier === "vip") {
        const ceoActive = isCeoActive();
        statusPill.classList.toggle("ceo", ceoActive);
        statusPill.classList.toggle("vip-status", !ceoActive);
        perksListEl.innerHTML = ceoActive ? `
          <li class="perk-row"><span class="perk-dot"></span> Unlimited monthly venue perks</li>
          <li class="perk-row"><span class="perk-dot"></span> VIP-only offers</li>
          <li class="perk-row"><span class="perk-dot"></span> Issue free passes anytime</li>
        ` : `
          <li class="perk-row"><span class="perk-dot"></span> Up to 10 voucher redemptions monthly</li>
          <li class="perk-row"><span class="perk-dot"></span> VIP-only offers</li>
          <li class="perk-row"><span class="perk-dot"></span> Perks refresh on your billing date</li>
        `;
        statusPill.textContent = ceoActive ? "CEO" : "VIP Member";
        passTierText.textContent = ceoActive ? "CEO Black Card" : "Nightlife Pass â€¢ VIP";
      } else {
        statusPill.classList.remove("vip-status", "ceo");
      }
      if (tier === "free") {
        localStorage.setItem(`${FREE_NOTICE_PREFIX}${(currentPassCode || "").toUpperCase()}`, "1");
        showFreeWelcomeToast();
      }
      ensurePerkState(tier);
      updateNightWheelUI();
      renderRedemptionOptions();
      setOfflineReadyStatus(false, "Refreshing passâ€¦");
      updatePassCodeDisplay();
      updateCeoPassUI();
      renderVipDealForMember();
      refreshMemberStats();
      refreshAlertsTicker();
      if (tier === "vip" && previousTier && previousTier !== "vip" && !isCeoActive()) {
        addPoints(POINT_RULES.upgradeVip, "Upgraded to VIP");
      }
    }

    function deferAssetLoading() {
      const img = new Image();
      img.src = "foco-logo.png?v=4";
      document.documentElement.classList.add("assets-ready");
    }
    if ("requestIdleCallback" in window) {
      requestIdleCallback(deferAssetLoading);
    } else {
      setTimeout(deferAssetLoading, 800);
    }

    // Touch haptics + click blip for mobile interactions
    let hapticAudioCtx = null;
    let lastHapticAt = 0;
    function shouldTriggerHaptic(target) {
      if (!target) return false;
      const el = target.closest('button, [role="button"], .btn, .pill-ghost, .linkish, .linkish-btn, .nav-item, .perk-option, .refresh-btn, .venue-btn, .chip');
      if (!el) return false;
      if (el.hasAttribute("disabled") || el.getAttribute("aria-disabled") === "true") return false;
      if (el.dataset && el.dataset.haptic === "off") return false;
      return true;
    }
    function triggerHapticFeedback() {
      const now = Date.now();
      if (now - lastHapticAt < 120) return;
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      if (!AudioCtx) return;
      if (!hapticAudioCtx) {
        hapticAudioCtx = new AudioCtx();
      }
      const doHaptic = () => {
        if (hapticAudioCtx.state !== "running") return;
        lastHapticAt = now;
        if (navigator.vibrate) {
          navigator.vibrate([8, 12, 6]);
        }
        const oscLow = hapticAudioCtx.createOscillator();
        const oscHigh = hapticAudioCtx.createOscillator();
        const gainLow = hapticAudioCtx.createGain();
        const gainHigh = hapticAudioCtx.createGain();
        const t = hapticAudioCtx.currentTime;
        oscLow.type = "sine";
        oscLow.frequency.value = 220;
        oscHigh.type = "sine";
        oscHigh.frequency.value = 660;
        gainLow.gain.setValueAtTime(0, t);
        gainLow.gain.linearRampToValueAtTime(0.05, t + 0.003);
        gainLow.gain.exponentialRampToValueAtTime(0.0008, t + 0.05);
        gainHigh.gain.setValueAtTime(0, t);
        gainHigh.gain.linearRampToValueAtTime(0.02, t + 0.003);
        gainHigh.gain.exponentialRampToValueAtTime(0.0005, t + 0.035);
        oscLow.connect(gainLow).connect(hapticAudioCtx.destination);
        oscHigh.connect(gainHigh).connect(hapticAudioCtx.destination);
        oscLow.start(t);
        oscHigh.start(t);
        oscLow.stop(t + 0.06);
        oscHigh.stop(t + 0.04);
        oscHigh.onended = () => {
          [oscLow, oscHigh, gainLow, gainHigh].forEach(node => {
            try { node.disconnect(); } catch (_) {}
          });
        };
      };
      if (hapticAudioCtx.state === "suspended") {
        hapticAudioCtx.resume().then(doHaptic).catch(() => {});
      } else {
        doHaptic();
      }
    }
    function handleHapticEvent(e) {
      if (!shouldTriggerHaptic(e.target)) return;
      if (e.type === "pointerdown" && e.pointerType && e.pointerType !== "touch") return;
      triggerHapticFeedback();
    }
    if ("PointerEvent" in window) {
      document.addEventListener("pointerdown", handleHapticEvent, { passive: true });
    } else {
      document.addEventListener("touchstart", handleHapticEvent, { passive: true });
    }

  // One-time hooks
  attachCopyHandlers();

  // Listen for auth state changes
  // Start settings watch after everything is defined
  watchSettingsDoc();
  watchAppStatsDoc();
  window.addEventListener("pageshow", refreshOnLaunch);

  onAuthStateChanged(firebaseAuth, async (user) => {
    await handleAuthenticatedUser(user);
    reattachRealtime();
  });

  window.addEventListener("online", () => {
    reattachRealtime();
    if (reconnectBanner) reconnectBanner.style.display = "none";
  });
    </script>
    <script src="https://js.stripe.com/v3"></script>
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("/sw.js").catch(err => console.warn("SW reg failed", err));
        });
        navigator.serviceWorker.addEventListener("controllerchange", () => {
          if (typeof showToast === "function") {
            showToast("Updated version ready. Reloadingâ€¦", 1800);
          }
          setTimeout(() => window.location.reload(), 1800);
        });
      }
    </script>
  </body>
</html>
